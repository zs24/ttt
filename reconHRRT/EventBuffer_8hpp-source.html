<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: EventBuffer.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>EventBuffer.hpp</h1><div class="fragment"><pre>00001 
00011 <span class="preprocessor">#ifndef EVENTBUFFER_HPP</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define EVENTBUFFER_HPP</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#include "EventPacket.hpp"</span>
00014 <span class="preprocessor">#include "array.hpp"</span>
00015 <span class="preprocessor">#include "Utilities.hpp"</span>
00016 
<a name="l00017"></a><a class="code" href="classEventBuffer.html">00017</a> <span class="keyword">class </span><a class="code" href="classEventBuffer.html">EventBuffer</a>
00018 {
00019   <span class="keyword">friend</span> <span class="keyword">class </span>EventBufferTest;
00020 <span class="keyword">private</span>:
00021   <span class="comment">// The static const NUM_BUFFER_EVENTS is used to initialize </span>
00022   <span class="comment">// the actual instance variable numBufferEvents, that keeps track of</span>
00023   <span class="comment">// size.</span>
00024   <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> NUM_BUFFER_EVENTS = 100;   
00025   <span class="keywordtype">int</span> eventArraySize;
00026   <span class="keywordtype">int</span> *numBufferEvents;   <span class="comment">// array that tracks the size of each buffer</span>
00027   <span class="keywordtype">int</span> numBuffers; 
00028    <span class="comment">// The arrays that store the packets</span>
00029   Array2D&lt;EventPacket&gt; eventArray;   
00030   <span class="comment">// Array of current packet indices - for appending;</span>
00031   <a class="code" href="classArray1D.html">Array1D&lt;int&gt;</a> currentPacketIndex;
00032   <span class="comment">// Retrieval index</span>
00033   <a class="code" href="classArray1D.html">Array1D&lt;int&gt;</a> traversalIndex;       
00034   <span class="comment">// Size of each buffer, in bytesr`</span>
00035   <span class="comment">//  int bufferSize;  We no longer need this variable - we'll just</span>
00036   <span class="comment">//  calculate as needed. </span>
00037 
00038 <span class="keyword">public</span>:
00039 
<a name="l00044"></a><a class="code" href="classEventBuffer.html#a0">00044</a>   <a class="code" href="classEventBuffer.html#a0">EventBuffer</a>(<span class="keywordtype">int</span> numBuffers):eventArraySize(NUM_BUFFER_EVENTS), 
00045                               numBuffers(numBuffers)
00046   {
00047     <span class="comment">// Allocates numBuffer arrays, each with NUM_BUFFER_EVENTS events</span>
00048     eventArray.init(eventArraySize, numBuffers);
00049     <span class="comment">// allocate and set to zero.</span>
00050     numBufferEvents = (<span class="keywordtype">int</span> *)calloc(numBuffers,<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
00051     <span class="comment">// bufferSize is no longer an instancre variable</span>
00052     <span class="comment">//bufferSize = numBufferEvents * sizeof(EventPacket);</span>
00053     currentPacketIndex.<a class="code" href="classArray1D.html#a8">init</a>(numBuffers);           
00054      <span class="comment">// initialize to zero</span>
00055     traversalIndex.<a class="code" href="classArray1D.html#a8">init</a>(numBuffers);           
00056     <span class="comment">//init to zero</span>
00057     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numBuffers; i++){
00058       traversalIndex(i)=currentPacketIndex(i) =0;
00059       numBufferEvents[i] = 1;
00060     }
00061   }
00062 
<a name="l00066"></a><a class="code" href="classEventBuffer.html#a1">00066</a>   <a class="code" href="classEventBuffer.html#a1">~EventBuffer</a>()
00067   {
00068     free(numBufferEvents);
00069   };
00070 
<a name="l00078"></a><a class="code" href="classEventBuffer.html#a2">00078</a>   <span class="keywordtype">int</span> <a class="code" href="classEventBuffer.html#a2">appendFixed</a>(<span class="keywordtype">int</span> ibuffer, <a class="code" href="classEventPacket.html">EventPacket</a> &amp;event)
00079   {
00080     eventArray(currentPacketIndex(ibuffer)++,ibuffer)=event;
00081     numBufferEvents[ibuffer]++;
00082     <span class="keywordflow">if</span>(<a class="code" href="classEventBuffer.html#a6">isFull</a>(ibuffer))  
00083       <span class="keywordflow">return</span> 1;   <span class="comment">// buffer is full</span>
00084     <span class="keywordflow">else</span>
00085       <span class="keywordflow">return</span> 0;
00086   };
00087 
<a name="l00096"></a><a class="code" href="classEventBuffer.html#a3">00096</a>   <span class="keywordtype">int</span> <a class="code" href="classEventBuffer.html#a3">appendResizable</a>(<span class="keywordtype">int</span> ibuffer, <a class="code" href="classEventPacket.html">EventPacket</a> &amp;event)
00097   {
00098     eventArray(currentPacketIndex(ibuffer)++,ibuffer)=event;
00099     numBufferEvents[ibuffer]++;
00100     <span class="keywordflow">if</span>(<a class="code" href="classEventBuffer.html#a6">isFull</a>(ibuffer)){
00101       eventArraySize += NUM_BUFFER_EVENTS;
00102       eventArray.reinit(eventArraySize,numBuffers);  
00103       <span class="comment">// Make the buffers bigger</span>
00104     }
00105 
00106     <span class="keywordflow">if</span>(<a class="code" href="classEventBuffer.html#a6">isFull</a>(ibuffer))  
00107                          
00108       <span class="keywordflow">return</span> 1;   <span class="comment">// buffer is full</span>
00109     <span class="keywordflow">else</span>
00110       <span class="keywordflow">return</span> 0;
00111   };
00112 
00113 
<a name="l00122"></a><a class="code" href="classEventBuffer.html#a4">00122</a>   <span class="keywordtype">void</span> <a class="code" href="classEventBuffer.html#a4">sendAndClear</a>(<span class="keywordtype">int</span> ibuffer)
00123   {
00124     <span class="keywordtype">int</span> bufferSize = eventArraySize * <span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>);
00125     <a class="code" href="classUtilities.html#e0">Utilities::mpiSend</a>(ibuffer, &amp;eventArray(0, ibuffer),bufferSize,0);
00126     currentPacketIndex(ibuffer)=0;
00127     numBufferEvents[ibuffer]=1;
00128   };
00129 
<a name="l00137"></a><a class="code" href="classEventBuffer.html#a5">00137</a>   <span class="keywordtype">void</span> <a class="code" href="classEventBuffer.html#a5">receive</a>(<span class="keywordtype">int</span> ibuffer)
00138   {
00139     <span class="keywordtype">int</span> bufferSize = eventArraySize*<span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>);
00140     traversalIndex(ibuffer)=0;
00141     numBufferEvents[ibuffer]=eventArraySize;
00142     <a class="code" href="classUtilities.html#e1">Utilities::mpiRecv</a>(ibuffer, &amp;eventArray(0, ibuffer),bufferSize, 0);
00143   };
00144 
<a name="l00150"></a><a class="code" href="classEventBuffer.html#a6">00150</a>   <span class="keywordtype">bool</span> <a class="code" href="classEventBuffer.html#a6">isFull</a>(<span class="keywordtype">int</span> ibuffer)
00151   {
00152     <span class="keywordflow">return</span>(currentPacketIndex(ibuffer) == eventArraySize);
00153   };
00154 
00155 
<a name="l00162"></a><a class="code" href="classEventBuffer.html#a7">00162</a>   <a class="code" href="classEventPacket.html">EventPacket</a> <a class="code" href="classEventBuffer.html#a7">getNext</a>(<span class="keywordtype">int</span> ibuffer)
00163   {
00164     <a class="code" href="classEventPacket.html">EventPacket</a> event = eventArray(traversalIndex(ibuffer),ibuffer);
00165     traversalIndex(ibuffer)++;
00166     <span class="keywordflow">if</span>( !<a class="code" href="classEventBuffer.html#a10">hasMoreEvents</a>(ibuffer)) traversalIndex(ibuffer)=0 ;    
00167     <span class="comment">// Note:  Not the same as Sentry, changed</span>
00168     <span class="keywordflow">return</span> event;
00169   };
<a name="l00176"></a><a class="code" href="classEventBuffer.html#a8">00176</a>   <a class="code" href="classEventPacket.html">EventPacket</a> <a class="code" href="classEventBuffer.html#a8">getNextCopy</a>(<span class="keywordtype">int</span> ibuffer)
00177   {
00178     <a class="code" href="classEventPacket.html">EventPacket</a> event = eventArray(traversalIndex(ibuffer),ibuffer);
00179     traversalIndex(ibuffer)++;
00180     <span class="comment">//if( !hasMoreEvents(ibuffer)) traversalIndex(ibuffer)=0 ;    </span>
00181     <span class="comment">// Note:  Not the same as Sentry, changed</span>
00182     <span class="keywordflow">return</span> event;
00183   };
00184 
<a name="l00192"></a><a class="code" href="classEventBuffer.html#a9">00192</a>   <a class="code" href="classEventPacket.html">EventPacket</a> <a class="code" href="classEventBuffer.html#a9">peekAhead</a>(<span class="keywordtype">int</span> ibuffer)
00193   {
00194     <span class="keywordflow">if</span>( !<a class="code" href="classEventBuffer.html#a10">hasMoreEvents</a>(ibuffer)) <span class="keywordflow">return</span> NULLEVENT;  
00195     <a class="code" href="classEventPacket.html">EventPacket</a> event = eventArray(traversalIndex(ibuffer),ibuffer);
00196     <span class="comment">// Note:  Not the same as Sentry, changed</span>
00197     <span class="keywordflow">return</span> event;
00198   };
00199 
<a name="l00206"></a><a class="code" href="classEventBuffer.html#a10">00206</a>   <span class="keywordtype">bool</span> <a class="code" href="classEventBuffer.html#a10">hasMoreEvents</a>(<span class="keywordtype">int</span> ibuffer)
00207   {
00208     <span class="keywordflow">return</span> (traversalIndex(ibuffer) &lt; numBufferEvents[ibuffer]);
00209   };
00210 
<a name="l00215"></a><a class="code" href="classEventBuffer.html#a11">00215</a>   <span class="keywordtype">int</span> <a class="code" href="classEventBuffer.html#a11">getNumEvents</a>()
00216   {
00217     <span class="keywordflow">return</span> eventArraySize;
00218   };
00219 
<a name="l00224"></a><a class="code" href="classEventBuffer.html#a12">00224</a>   <span class="keywordtype">int</span> <a class="code" href="classEventBuffer.html#a11">getNumEvents</a>(<span class="keywordtype">int</span> ibuffer)
00225   {
00226     <span class="keywordflow">return</span> numBufferEvents[ibuffer];
00227   }
00228 
<a name="l00233"></a><a class="code" href="classEventBuffer.html#a13">00233</a>   <span class="keywordtype">void</span> <a class="code" href="classEventBuffer.html#a13">rewind</a>(<span class="keywordtype">int</span> ibuffer)
00234   {
00235     traversalIndex(ibuffer)=0;
00236   }
00237 
<a name="l00243"></a><a class="code" href="classEventBuffer.html#a14">00243</a>   <span class="keywordtype">void</span> <a class="code" href="classEventBuffer.html#a14">copy</a>(<span class="keywordtype">int</span> ibuffer, <a class="code" href="classEventBuffer.html">EventBuffer</a>&amp; srcEB, <span class="keywordtype">int</span> iSrc)
00244   {
00245     srcEB.<a class="code" href="classEventBuffer.html#a13">rewind</a>(iSrc);
00246     <a class="code" href="classEventPacket.html">EventPacket</a> event;
00247     <span class="keywordflow">while</span>(srcEB.<a class="code" href="classEventBuffer.html#a10">hasMoreEvents</a>(iSrc)){
00248       <span class="comment">// Just keep calling append to add events, which will cause </span>
00249       <span class="comment">// automatic buffer resizing if necessary</span>
00250       event = srcEB.<a class="code" href="classEventBuffer.html#a8">getNextCopy</a>(iSrc);
00251       <a class="code" href="classEventBuffer.html#a3">appendResizable</a>(ibuffer,event);
00252     }
00253     <a class="code" href="classEventBuffer.html#a13">rewind</a>(ibuffer);
00254   }
00255         
00256   <span class="comment">// Sends out buffer ibuffer to processor target.  Uses the tag</span>
00257   <span class="comment">// field.  This function does NOT assume that the buffer index is</span>
00258   <span class="comment">// the target.  Rather they are two separate parameters.</span>
00259   
00260   <span class="keywordtype">void</span> sendTagged(<span class="keywordtype">int</span> ibuffer, <span class="keywordtype">int</span> target, <span class="keywordtype">int</span> tag)
00261   {
00262     <span class="keywordtype">int</span> bufferSize = numBufferEvents[ibuffer] * <span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>);
00263     <a class="code" href="classUtilities.html#e0">Utilities::mpiSend</a>(target, &amp;eventArray(0,ibuffer), bufferSize,tag);
00264   }
00265   
00266   <span class="comment">// Uses MPI::COMM_WORLD.Probe to first determine the size of the</span>
00267   <span class="comment">// message to be received.  Then it figures out if it needs to make</span>
00268   <span class="comment">// the buffer capacity greater and, if so, do so.  Then it receives</span>
00269   <span class="comment">// the array into the appropriate buffer.  This function does not</span>
00270   <span class="comment">// require that the buffer index be the same as the source</span>
00271   <span class="comment">// processor, as those are separate fields.</span>
00272   <span class="keywordtype">void</span> recvProbed(<span class="keywordtype">int</span> ibuffer, <span class="keywordtype">int</span> source, <span class="keywordtype">int</span> realiz)
00273   {
00274     MPI::Status mpiStatus;
00275     MPI::COMM_WORLD.Probe(source,realiz, mpiStatus);
00276     <span class="keywordtype">int</span> size = mpiStatus.Get_count(MPI::CHAR);
00277     <span class="keywordflow">if</span>(size%<span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>) !=0){
00278       cout&lt;&lt;<span class="stringliteral">"Error in EventBuffer::recvProbed()"</span>
00279           &lt;&lt;<span class="stringliteral">", receiving array of size "</span>&lt;&lt;size
00280           &lt;&lt;<span class="stringliteral">" does not divide evenly by "</span>&lt;&lt;<span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>)
00281           &lt;&lt;endl;
00282       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-2316);
00283     }
00284     numBufferEvents[ibuffer]=size/<span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>);
00285     <span class="keywordflow">while</span>(size&gt;(<span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>)*eventArraySize)){
00286       eventArraySize += NUM_BUFFER_EVENTS;
00287       eventArray.reinit(eventArraySize,numBuffers);
00288     }
00289     <a class="code" href="classUtilities.html#e1">Utilities::mpiRecv</a>(source,&amp;eventArray(0,ibuffer),size,realiz);
00290     <a class="code" href="classEventBuffer.html#a13">rewind</a>(ibuffer);
00291   }
00292 };
00293 
00294 
00295 <span class="preprocessor">#endif //EVENTBUFFER_HPP</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
