<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: FrameInfo.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>FrameInfo.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00002 <span class="preprocessor">#include &lt;sstream&gt;</span>
00003 <span class="preprocessor">#include "FrameInfo.hpp"</span>
00004 <span class="preprocessor">#include "HRRTHouse.hpp"</span>
00005 <span class="preprocessor">#include "Params.hpp"</span>
<a name="l00010"></a><a class="code" href="classFrameInfo.html#a0">00010</a> <span class="keywordtype">void</span> <a class="code" href="classFrameInfo.html#a0">FrameInfo::writeFrameInfo</a>()
00011 {
00012   Params &amp;params = *Params::getInstance();
00013   
00014   string fileName = params.frame.frameDirectory+<span class="stringliteral">"/"</span>+
00015     params.frame.outputFileNameBase+<span class="stringliteral">"."</span>+ params.extensions.frameInfo;
00016   ofstream osFrameInfo(fileName.c_str());
00017   <span class="keywordflow">if</span>(!osFrameInfo){
00018     <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00019     string msg = <span class="stringliteral">"Warning: Error in openning frameInfo file"</span>;
00020     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00021     <span class="keywordflow">return</span>;
00022   }
00023   osFrameInfo &lt;&lt; <span class="stringliteral">"# Total prompts and delays "</span> &lt;&lt; endl;
00024   osFrameInfo&lt;&lt;this-&gt;totalPrompts&lt;&lt;<span class="stringliteral">" "</span>
00025              &lt;&lt;this-&gt;totalDelays&lt;&lt;endl;
00026   osFrameInfo &lt;&lt; <span class="stringliteral">"# Actual frame duration"</span> &lt;&lt; endl;
00027   osFrameInfo&lt;&lt;this-&gt;Duration&lt;&lt;endl;
00028   osFrameInfo&lt;&lt; <span class="stringliteral">"# Frame start time"</span> &lt;&lt; endl;
00029   osFrameInfo&lt;&lt;this-&gt;startTime&lt;&lt;endl;
00030   osFrameInfo &lt;&lt; <span class="stringliteral">"# Number of event accepted and rejected based on scanner geometry"</span> 
00031               &lt;&lt; endl;
00032   osFrameInfo&lt;&lt;this-&gt;nAcceptScanner&lt;&lt;endl&lt;&lt;this-&gt;nRejectScanner&lt;&lt;endl;
00033   osFrameInfo &lt;&lt; <span class="stringliteral">"# Number of event accepted and rejected based on boundary check"</span> 
00034               &lt;&lt; endl;
00035   osFrameInfo&lt;&lt;this-&gt;nAcceptObject&lt;&lt;endl&lt;&lt;this-&gt;nRejectObject&lt;&lt;endl;
00036   osFrameInfo &lt;&lt; <span class="stringliteral">"# Number of bad 64-bit events"</span> 
00037               &lt;&lt; endl;
00038   <span class="keywordtype">float</span> badEvents = (this-&gt;nSkip/2.0) + this-&gt;nBadEvents;
00039   osFrameInfo&lt;&lt;badEvents&lt;&lt;endl;
00040   osFrameInfo &lt;&lt; <span class="stringliteral">"# Missing Singles Tags Fraction &amp; missing TimeTags Fraction"</span> 
00041               &lt;&lt; endl;
00042   osFrameInfo &lt;&lt; this-&gt;badSinglesFraction &lt;&lt; <span class="stringliteral">" "</span> 
00043               &lt;&lt; this-&gt;badTimeTagsFraction &lt;&lt; endl;           
00044   osFrameInfo &lt;&lt; <span class="stringliteral">"# Average motion correction transformation matrix"</span> 
00045               &lt;&lt; endl;
00046     <span class="comment">// matrix is organized by columns, output by top 3 rows</span>
00047    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;3; i++) {
00048     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;4; j++) {
00049      osFrameInfo&lt;&lt;this-&gt;averageXform[i+4*j]&lt;&lt;<span class="stringliteral">" "</span>;
00050     }
00051    }
00052 
00053   osFrameInfo &lt;&lt;endl&lt;&lt;<span class="stringliteral">"# Average Decay Factor"</span>&lt;&lt;endl;
00054   osFrameInfo&lt;&lt;(this-&gt;totalDecayFactor / this-&gt;nAcceptScanner)&lt;&lt;endl;
00055   osFrameInfo &lt;&lt;<span class="stringliteral">"# Average LiveTimeFactor "</span>&lt;&lt;endl;
00056   osFrameInfo&lt;&lt;(this-&gt;totalLiveTimeFactor / this-&gt;nAcceptScanner)&lt;&lt;endl;
00057   osFrameInfo &lt;&lt;<span class="stringliteral">"# Average Livetime_Decay"</span> 
00058               &lt;&lt; endl;
00059   osFrameInfo&lt;&lt;this-&gt;averageLivetimeDecay&lt;&lt;endl;
00060   osFrameInfo &lt;&lt;<span class="stringliteral">"# Randoms Correction Type: (0==fixed, 1=computed, 2=modeled)"</span>
00061               &lt;&lt; endl;
00062   osFrameInfo&lt;&lt;this-&gt;randomsType&lt;&lt;endl;
00063   osFrameInfo &lt;&lt;<span class="stringliteral">"# Randoms Tau actually used"</span>
00064               &lt;&lt; endl;
00065   osFrameInfo&lt;&lt;this-&gt;randomsTau&lt;&lt;endl;
00066   osFrameInfo &lt;&lt;<span class="stringliteral">"# Randoms Tau from params"</span>
00067               &lt;&lt; endl;
00068   osFrameInfo&lt;&lt;this-&gt;randomsTauFixed&lt;&lt;endl;
00069   osFrameInfo &lt;&lt;<span class="stringliteral">"# Randoms Tau computed from delays"</span>
00070               &lt;&lt; endl;
00071   osFrameInfo&lt;&lt;this-&gt;randomsTauComputed&lt;&lt;endl;
00072   osFrameInfo &lt;&lt;<span class="stringliteral">"# Randoms Tau from empirical model"</span>
00073               &lt;&lt; endl;
00074   osFrameInfo&lt;&lt;this-&gt;randomsTauModel&lt;&lt;endl;
00075   osFrameInfo &lt;&lt;<span class="stringliteral">"# Average block singles"</span>
00076               &lt;&lt; endl;
00077   osFrameInfo&lt;&lt;this-&gt;avgBlockSingles&lt;&lt;endl;
00078   osFrameInfo &lt;&lt;<span class="stringliteral">"# Measured detector efficiency offset (from delays to norm extrapolated to 0 singles)"</span>
00079               &lt;&lt; endl;
00080   osFrameInfo&lt;&lt;this-&gt;measuredEffOffset&lt;&lt;endl;
00081   osFrameInfo &lt;&lt;<span class="stringliteral">"# Computed detector efficiency offset (from blockSingles)"</span>
00082               &lt;&lt; endl;
00083   osFrameInfo&lt;&lt;this-&gt;computedEffOffset&lt;&lt;endl;
00084 
00085   osFrameInfo &lt;&lt;<span class="stringliteral">"# Randoms Fraction from Delays"</span>
00086               &lt;&lt; endl;
00087   osFrameInfo&lt;&lt;this-&gt;randomsFractionDelays&lt;&lt;endl;
00088   osFrameInfo &lt;&lt;<span class="stringliteral">"# Total Randoms Estimate"</span>
00089               &lt;&lt; endl;
00090   osFrameInfo&lt;&lt;this-&gt;totalRandomsEstimate&lt;&lt;endl;
00091 
00092   Status *status = Status::getStatus();
00093   <span class="keywordtype">int</span> numIter = (status-&gt;iter &gt;= params.algorithm.numIterations)?
00094                      params.algorithm.numIterations:status-&gt;iter;
00095   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i &lt; numIter; i++) {
00096      osFrameInfo &lt;&lt; <span class="stringliteral">"# Total Scatter Estimate for iteration: "</span>&lt;&lt;(i+1)
00097               &lt;&lt; endl;
00098      osFrameInfo&lt;&lt;this-&gt;totalScatterEstimate(i)&lt;&lt;endl;
00099      osFrameInfo &lt;&lt; <span class="stringliteral">"# Total Yhat Estimate for iteration: "</span>&lt;&lt;(i+1)
00100               &lt;&lt; endl;
00101      osFrameInfo&lt;&lt;this-&gt;totalYhatEstimate(i)&lt;&lt;endl;
00102      osFrameInfo &lt;&lt; <span class="stringliteral">"# Randoms Fraction"</span>
00103               &lt;&lt; endl;
00104      osFrameInfo&lt;&lt;this-&gt;randomsFraction&lt;&lt;endl;
00105      osFrameInfo &lt;&lt; <span class="stringliteral">"# Scatter Fraction for iteration: "</span>&lt;&lt;(i+1)
00106               &lt;&lt; endl;
00107      osFrameInfo&lt;&lt;this-&gt;scatterFraction(i)&lt;&lt;endl;
00108   }
00109 
00110   osFrameInfo.close();
00111 }
00112 
<a name="l00117"></a><a class="code" href="classFrameInfo.html#a1">00117</a> <span class="keywordtype">void</span> <a class="code" href="classFrameInfo.html#a1">FrameInfo::init</a>()
00118 {
00119   <a class="code" href="classHRRTHouseList.html">HRRTHouseList</a> &amp;houseList = *HRRTHouseList::getInstance();
00120   Params &amp;params = *Params::getInstance();
00121   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> &amp;scanner = *<a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00122 
00123   this-&gt;Duration = houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration;  <span class="comment">//in milli seconds</span>
00124   this-&gt;totalPrompts = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nPrompt;
00125   this-&gt;totalDelays = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nRandom;<span class="comment">//random by delayed time window</span>
00126   this-&gt;nAcceptScanner = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nAccept;
00127   this-&gt;nRejectScanner = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nReject;
00128   this-&gt;nSkip = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nSkip;
00129   this-&gt;nBadEvents = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nBadEvents;
00130   this-&gt;nBadNonEvents = houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nBadNonEvents;
00131   <span class="keywordflow">if</span>(houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nS &lt; houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration)
00132       this-&gt;badSinglesFraction = (houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration - houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nS) 
00133                                 / (<span class="keywordtype">float</span>) houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration;
00134   <span class="keywordflow">else</span> 
00135       this-&gt;badSinglesFraction = 0.0;
00136   <span class="keywordflow">if</span>(houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nT &lt; houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration)
00137       this-&gt;badTimeTagsFraction = (houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration - houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nT) 
00138                                 / (<span class="keywordtype">float</span>)houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration;
00139   <span class="keywordflow">else</span> 
00140       this-&gt;badTimeTagsFraction = 0.0;
00141   
00142   this-&gt;frameStartTimeTag = houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStartTimeTag;
00143   nAcceptObject = nAcceptScanner;
00144   nRejectObject = 0; 
00145   <span class="keywordtype">int</span> startTime = (houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.studyStartTime + 
00146                    houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStartTimeTag)/1000;
00147   <span class="keywordtype">int</span> hours, minutes, seconds;
00148   hours = startTime/3600;
00149   minutes = (startTime - hours*3600)/60;
00150   seconds = startTime - hours*3600 - minutes*60;
00151   <span class="comment">//get average motion transform matrix</span>
00152   <span class="keywordflow">if</span>(params.motionCorrection.enable)
00153     houseList.<a class="code" href="classHRRTHouseList.html#r8">motion</a>-&gt;<a class="code" href="classMotionCorrection.html#a4">getAverageTransformation</a>(this-&gt;averageXform);
00154   <span class="keywordflow">else</span>
00155     memset(this-&gt;averageXform,0,<span class="keyword">sizeof</span>(this-&gt;averageXform));
00156   stringstream ss;
00157   ss&lt;&lt;setfill(<span class="charliteral">'0'</span>)&lt;&lt;setw(2)&lt;&lt;hours&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;setfill(<span class="charliteral">'0'</span>)&lt;&lt;setw(2)&lt;&lt;minutes&lt;&lt;<span class="stringliteral">":"</span>
00158     &lt;&lt;setfill(<span class="charliteral">'0'</span>)&lt;&lt;setw(2)&lt;&lt;seconds;
00159   this-&gt;startTime = ss.str();
00160   this-&gt;timeStampsPerSecond = scanner.<a class="code" href="classHRRTScannerParams.html#o24">timeStampsPerSecond</a>;
00161   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5) {
00162     cout&lt;&lt;<span class="stringliteral">"Study start time "</span>&lt;&lt;houseList.<a class="code" href="classHRRTHouseList.html#r7">time</a>.studyStartTime&lt;&lt;endl;
00163     cout&lt;&lt;<span class="stringliteral">"Actual start time "</span>&lt;&lt;startTime&lt;&lt;endl;
00164     cout&lt;&lt;hours&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;minutes&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;seconds&lt;&lt;endl;
00165     cout&lt;&lt;this-&gt;startTime&lt;&lt;endl;
00166   }
00167 
00168   totalDecayFactor = static_cast&lt;float&gt; (houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nDecayFactor);
00169   totalLiveTimeFactor = static_cast&lt;float&gt; (houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nLiveTimeFactor);
00170   <span class="keywordtype">float</span> totalLiveTime_Decay = static_cast&lt;float&gt; (houseList.<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nLiveTime_Decay);
00171   this-&gt;averageLivetimeDecay = totalLiveTime_Decay/this-&gt;nAcceptScanner;
00172 
00173   randomsFraction = 0.0;
00174   scatterFraction.<a class="code" href="classArray1D.html#a8">init</a>(params.algorithm.numIterations+1); 
00175   totalScatterEstimate.<a class="code" href="classArray1D.html#a8">init</a>(params.algorithm.numIterations+1); 
00176   totalYhatEstimate.<a class="code" href="classArray1D.html#a8">init</a>(params.algorithm.numIterations+1); 
00177 
00178   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i &lt; params.algorithm.numIterations+1; i++) {
00179      scatterFraction(i) = 0.0;
00180      totalScatterEstimate(i) = 0.0;
00181      totalYhatEstimate(i) = 0.0;
00182   }
00183   
00184 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
