<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: AlgorithmOSEM class Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>AlgorithmOSEM Class Reference</h1><code>#include &lt;<a class="el" href="AlgorithmOSEM_8hpp-source.html">AlgorithmOSEM.hpp</a>&gt;</code>
<p>
<p>Inheritance diagram for AlgorithmOSEM:
<p><center><img src="classAlgorithmOSEM.png" usemap="#AlgorithmOSEM_map" border="0" alt=""></center>
<map name="AlgorithmOSEM_map">
<area href="classAlgorithm.html" alt="Algorithm" shape="rect" coords="0,0,102,24">
</map>
<a href="classAlgorithmOSEM-members.html">List of all members.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classAlgorithmOSEM.html#a0">reconstruct</a> (<a class="el" href="classImage.html">Image</a> &amp;lambda, <a class="el" href="classImage.html">Image</a> &amp;Q, <a class="el" href="classImage.html">Image</a> &amp;mu, House *house, <a class="el" href="classEventList.html">EventList</a> &amp;eventList, Params &amp;params, <a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;lambdaMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>float&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classAlgorithmOSEM.html#a1">oneIteration</a> (<a class="el" href="classImage.html">Image</a> &amp;lambda, <a class="el" href="classImage.html">Image</a> &amp;Q, <a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;lambdaMask, House *house, <a class="el" href="classEventList.html">EventList</a> &amp;eventList, Params &amp;params, <a class="el" href="classImage.html">Image</a> &amp;mu)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This class is a sub class of the <a class="el" href="classAlgorithm.html">Algorithm</a> class It implements the OSEM algorithm 
<p>

<p>
Definition at line <a class="el" href="AlgorithmOSEM_8hpp-source.html#l00008">8</a> of file <a class="el" href="AlgorithmOSEM_8hpp-source.html">AlgorithmOSEM.hpp</a>.<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="a1" doxytag="AlgorithmOSEM::oneIteration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> float AlgorithmOSEM::oneIteration </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>Q</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambdaMask</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>House *&nbsp;</td>
          <td class="mdname" nowrap> <em>house</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classEventList.html">EventList</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>eventList</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>Params &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>params</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>mu</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This function performs a iteration of the OSEM algorithm <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>lamda</em>&nbsp;</td><td>the lamda image </td></tr>
    <tr><td valign=top><em>Q</em>&nbsp;</td><td>the Q image </td></tr>
    <tr><td valign=top><em>lambdaMask</em>&nbsp;</td><td><a class="el" href="classMask.html">Mask</a> for image voxels to reconstruct </td></tr>
    <tr><td valign=top><em>params</em>&nbsp;</td><td>Instance of Params class, inited from the xml file </td></tr>
    <tr><td valign=top><em>eventlist</em>&nbsp;</td><td>stores the events </td></tr>
    <tr><td valign=top><em>house</em>&nbsp;</td><td>instance of House class, where the events are read in </td></tr>
    <tr><td valign=top><em>params</em>&nbsp;</td><td>Instance of Params class </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>log likehood </dd></dl>

<p>
Definition at line <a class="el" href="AlgorithmOSEM_8cpp-source.html#l00166">166</a> of file <a class="el" href="AlgorithmOSEM_8cpp-source.html">AlgorithmOSEM.cpp</a>.
<p>
References <a class="el" href="Algorithm_8cpp-source.html#l00010">Algorithm::fwdBackProjectEventX()</a>, <a class="el" href="Algorithm_8cpp-source.html#l00212">Algorithm::fwdBackProjectEventY()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00728">MOLAR::fwdProjectSolidAngleEventX()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00751">MOLAR::fwdProjectSolidAngleEventY()</a>, <a class="el" href="EventList_8cpp-source.html#l00331">EventList::getFirst()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00049">MOLAR::getInstance()</a>, <a class="el" href="HRRTScannerParams_8hpp-source.html#l00116">HRRTScannerParams::getInstance()</a>, <a class="el" href="Log_8hpp-source.html#l00079">Log::getLog()</a>, <a class="el" href="EventList_8cpp-source.html#l00352">EventList::getNext()</a>, <a class="el" href="EventList_8hpp-source.html#l00166">EventList::getNumEvents()</a>, <a class="el" href="MOLAR_8hpp-source.html#l00437">MOLAR::getScatterCorrection()</a>, <a class="el" href="EventList_8cpp-source.html#l00394">EventList::getSentry()</a>, <a class="el" href="Image_8cpp-source.html#l01929">Image::globalSum()</a>, <a class="el" href="Array3D_8hpp-source.html#l00232">Array3D&lt; float &gt;::innerProduct()</a>, <a class="el" href="EventPacket_8hpp-source.html#l00013">EventPacket::jstart</a>, <a class="el" href="EventPacket_8hpp-source.html#l00013">EventPacket::jstop</a>, <a class="el" href="EventPacket_8hpp-source.html#l00038">EventPacket::numEvents</a>, <a class="el" href="Log_8hpp-source.html#l00052">Log::outputMessage()</a>, <a class="el" href="HRRTScannerParams_8hpp-source.html#l00065">HRRTScannerParams::panelSeparation</a>, <a class="el" href="EventList_8cpp-source.html#l00320">EventList::replace()</a>, <a class="el" href="EventPacket_8hpp-source.html#l00021">EventPacket::resModelCodeR</a>, <a class="el" href="EventPacket_8hpp-source.html#l00023">EventPacket::resModelCodeZ</a>, <a class="el" href="EventPacket_8hpp-source.html#l00045">EventPacket::sinphi</a>, and <a class="el" href="EventPacket_8hpp-source.html#l00036">EventPacket::yhat</a>.
<p>
Referenced by <a class="el" href="AlgorithmOSEM_8cpp-source.html#l00024">reconstruct()</a>.
<p>
<div class="fragment"><pre>00169 {
00170   <span class="comment">// Instantiate nu, the update image</span>
00171   <span class="comment">// We never read or write nu; it is temporary</span>
00172   <span class="comment">// INITIALIZE NU TO ZERO;</span>
00173   <span class="keyword">static</span> <span class="keywordtype">int</span> yhatZero=0;
00174   
00175   <span class="keywordtype">float</span> logLike = 0;
00176   <span class="keywordtype">float</span> duration; 
00177 
00178   Status *status = Status::getStatus();   
00179   <a class="code" href="classLog.html">Log</a> * logg = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00180   <span class="comment">//count time for performance test</span>
00181   time_t timeFwdBackProj1, timeGlobalSum1;
00182   time_t timeFwdBackProj2, timeGlobalSum2;     
00183   <span class="keywordtype">double</span> timeFwdBackProj, timeGlobalSum;     
00184   time_t timeBarrier1, timeBarrier2;     
00185   <span class="keywordtype">double</span> timeBarrier = 0;
00186   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> &amp;scannerParams=*<a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00187 
00188   <span class="comment">//paramter for solid angle correction</span>
00189   <span class="keywordtype">float</span> d0 = scannerParams.<a class="code" href="classHRRTScannerParams.html#o6">panelSeparation</a>/2.0;
00190   <span class="keywordtype">float</span> omega[params.geometry.nX];<span class="comment">//solid angle correction coefficient</span>
00191   <span class="keywordtype">float</span> dl; <span class="comment">//paramter for solid angle correction and attenuation</span>
00192   <span class="keywordtype">float</span> sumCij; 
00193   <span class="keywordflow">if</span>(status-&gt;proc==0){
00194     stringstream ss;
00195     ss&lt;&lt;<span class="stringliteral">"================================="</span>&lt;&lt;endl;
00196     ss&lt;&lt;<span class="stringliteral">"ALgorithmOSEM iteration "</span>&lt;&lt;status-&gt;iter&lt;&lt;endl;
00197     logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 0);
00198     string comm=ss.str();
00199     Status::StatusCode code=Status::RUNNING;
00200     status-&gt;update(comm,code);
00201   <span class="comment">//broadcast duration from node 0</span>
00202     duration = house-&gt;getFrameInfo().Duration;
00203   }
00204   MPI::COMM_WORLD.Bcast(&amp;duration, 1, MPI::FLOAT, 0);
00205   <span class="comment">//cout&lt;&lt;"duration "&lt;&lt;duration&lt;&lt;endl;</span>
00206 
00207   
00208   <span class="comment">//count time</span>
00209   timeFwdBackProj1 = time((time_t *) 0);
00210   
00211   <a class="code" href="structResolutionTable.html">ResolutionTable</a> resFunR, resFunU; <span class="comment">//resolution functions</span>
00212   <a class="code" href="classMOLAR.html">MOLAR</a> *molar=<a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>(); 
00213   <a class="code" href="classEventPacket.html">EventPacket</a> event; <span class="comment">//event attracted from the event lise</span>
00214   <a class="code" href="classEventPacket.html">EventPacket</a> sentry = eventList.<a class="code" href="classEventList.html#a6">getSentry</a>(); <span class="comment">//prepare for sentry</span>
00215   <span class="keywordtype">int</span> countT = 0; <span class="comment">//count the number of the event got   </span>
00216   <span class="keywordtype">int</span> averageStart = 0, averageStop=0;
00217   
00218   <span class="comment">//prepare log file</span>
00219   ofstream oslog;
00220 
00221   <span class="keywordflow">if</span>((status-&gt;proc==0)){
00222     string filename;
00223     filename = params.frame.frameDirectory+<span class="stringliteral">"/"</span>+
00224       params.frame.outputFileNameBase
00225       +<span class="stringliteral">".log"</span>;
00226 
00227     <span class="keywordflow">if</span>(status-&gt;iter ==0)
00228       oslog.open(filename.c_str());
00229     <span class="keywordflow">else</span>
00230       oslog.open(filename.c_str(), ios::app);   
00231      
00232     <span class="keywordflow">if</span>(!oslog){
00233       stringstream ss;
00234       ss&lt;&lt;<span class="stringliteral">"Error in open log file "</span>&lt;&lt;filename&lt;&lt;endl;
00235       logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 0);
00236     }
00237   }
00238   <span class="keywordflow">for</span>(status-&gt;subset=0;status-&gt;subset&lt;
00239         params.algorithm.numSets;status-&gt;subset++){
00240     <span class="keywordflow">if</span>(status-&gt;proc ==0){
00241       cout&lt;&lt;endl&lt;&lt;<span class="stringliteral">"** Subset "</span>&lt;&lt;status-&gt;subset&lt;&lt;endl;
00242     }
00243     <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00244           status-&gt;printMemInfo();
00245     }
00246 
00247     <span class="keywordflow">if</span>(params.modelBasedScatter.enable){
00248       time_t timeScatterUpdate1, timeScatterUpdate2;     
00249       <span class="keywordtype">double</span> timeScatterUpdate;
00250 
00251       timeScatterUpdate1 = time((time_t *) 0);
00252       ScatterCorrection *scatterCorrection = molar-&gt;<a class="code" href="classMOLAR.html#a26">getScatterCorrection</a>();
00253       scatterCorrection-&gt;update(mu, lambda, eventList);
00254       timeScatterUpdate2 = time((time_t *) 0);
00255       timeScatterUpdate = difftime(timeScatterUpdate2, timeScatterUpdate1);
00256       <span class="keywordflow">if</span>((status-&gt;proc ==0) &amp;&amp; (params.frame.verbosity &gt; 2)){
00257         stringstream ss;
00258         ss&lt;&lt;<span class="stringliteral">"Scatter update takes "</span>&lt;&lt;timeScatterUpdate&lt;&lt;<span class="stringliteral">" s at iteration "</span> 
00259           &lt;&lt;status-&gt;iter&lt;&lt;<span class="stringliteral">" and subset "</span>&lt;&lt;status-&gt;subset&lt;&lt;endl;
00260         logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 2);
00261       }
00262     }
00263 
00264     time_t timeSubSet1=time((time_t *)0);
00265     <a class="code" href="classImage.html">Image</a> nu(params.geometry, <span class="stringliteral">"RAW"</span>, params.frame.outputDataType);
00266     event = eventList.<a class="code" href="classEventList.html#a3">getFirst</a>(status-&gt;subset);<span class="comment">//Get first event</span>
00267     <span class="keywordtype">int</span> countT = 0; <span class="comment">//count the number of the event got</span>
00268     <span class="keywordflow">while</span> (!(event==sentry)) {
00269      <span class="comment">// be sure the event is still in play</span>
00270      <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o1">jstop</a> &gt;= event.<a class="code" href="classEventPacket.html#o0">jstart</a>) {
00271       <span class="comment">//get resolution functions of the event</span>
00272       resFunR = house-&gt;getResFunR(event.<a class="code" href="classEventPacket.html#o6">resModelCodeR</a>);
00273       resFunU = house-&gt;getResFunZ(event.<a class="code" href="classEventPacket.html#o7">resModelCodeZ</a>);
00274       <span class="comment">//forward project</span>
00275       <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o22">sinphi</a> &gt; Constant::SIN45) {<span class="comment">//x is primary direction</span>
00276 
00277         molar-&gt;<a class="code" href="classMOLAR.html#a9">fwdProjectSolidAngleEventX</a>(event, params,d0,omega);
00278         <a class="code" href="classAlgorithm.html#a0">fwdBackProjectEventX</a>(Q,lambda,nu,event,resFunR,resFunU,
00279                              params,duration,omega);
00280       }
00281       <span class="keywordflow">else</span> { <span class="comment">//y is primary direction</span>
00282         molar-&gt;<a class="code" href="classMOLAR.html#a10">fwdProjectSolidAngleEventY</a>(event, params, d0, omega);
00283         <a class="code" href="classAlgorithm.html#a1">fwdBackProjectEventY</a>(Q,lambda,nu,event,resFunR,resFunU,
00284                              params,duration,omega);
00285       }
00286       <span class="comment">// yhat updated - resave event</span>
00287       eventList.<a class="code" href="classEventList.html#a7">replace</a>(status-&gt;subset,event);
00288       
00289       <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o18">yhat</a>!=0)
00290         logLike += (<span class="keywordtype">float</span>)event.<a class="code" href="classEventPacket.html#o19">numEvents</a> * log(event.<a class="code" href="classEventPacket.html#o18">yhat</a>);
00291       <span class="comment">//cout&lt;&lt;"logLike : "&lt;&lt;logLike&lt;&lt;endl;</span>
00292       ++countT; <span class="comment">//increase count</span>
00293       <span class="keywordflow">if</span>(status-&gt;proc ==0){ 
00294         <span class="keywordflow">if</span>(countT%50000==0 &amp;&amp; params.frame.verbosity&gt;=2) 
00295           (cout&lt;&lt;<span class="stringliteral">"Subset "</span>&lt;&lt;status-&gt;subset&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;countT&lt;&lt;<span class="stringliteral">" events out of "</span>
00296            &lt;&lt;eventList.<a class="code" href="classEventList.html#a12">getNumEvents</a>(status-&gt;subset)
00297            &lt;&lt;<span class="stringliteral">"  forward/backprojected"</span>&lt;&lt;endl).flush();
00298       }
00299      }
00300      event = eventList.<a class="code" href="classEventList.html#a4">getNext</a>(status-&gt;subset);
00301     }
00302     <span class="keywordflow">if</span>(status-&gt;proc ==0){
00303       cout&lt;&lt;<span class="stringliteral">"Subset "</span>&lt;&lt;status-&gt;subset&lt;&lt;<span class="stringliteral">": "</span>&lt;&lt;countT&lt;&lt;<span class="stringliteral">" events out of "</span>
00304            &lt;&lt;eventList.<a class="code" href="classEventList.html#a12">getNumEvents</a>(status-&gt;subset)
00305            &lt;&lt;<span class="stringliteral">"  forward/backprojected"</span>&lt;&lt;endl;
00306     }
00307     timeBarrier1 = time((time_t *) 0);
00308     MPI::COMM_WORLD.Barrier(); <span class="comment">//prepare processes</span>
00309     timeBarrier2 = time((time_t *) 0);
00310     timeBarrier += difftime(timeBarrier2, timeBarrier1);
00311 
00312     timeGlobalSum1 = time((time_t *) 0);
00313     <span class="comment">//global sum of Q slice by slice with raster</span>
00314     countT =0;
00315     nu.<a class="code" href="classImage.html#a14">globalSum</a>(Q,params);
00316 
00317     timeGlobalSum2 = time((time_t *) 0);
00318     timeGlobalSum = difftime(timeGlobalSum2,timeGlobalSum1);
00319     <span class="keywordflow">if</span>(status-&gt;proc ==0){
00320       stringstream ss;
00321       ss&lt;&lt;<span class="stringliteral">"nu global sum takes "</span>&lt;&lt;timeGlobalSum&lt;&lt;<span class="stringliteral">" s at iteration "</span> 
00322         &lt;&lt;status-&gt;iter;
00323       logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 2);
00324       <span class="comment">//stringstream filename;</span>
00325       <span class="comment">//filename&lt;&lt; params.frame.frameDirectory&lt;&lt;"/Nu"&lt;&lt;</span>
00326       <span class="comment">//params.frame.outputFileNameBase&lt;&lt; "-"&lt;&lt; status-&gt;iter;</span>
00327       <span class="comment">//filename &lt;&lt; ".hdr";</span>
00328       <span class="comment">//nu.write(filename.str(), params.extensions);</span>
00329       <span class="comment">//ss.str("");</span>
00330       <span class="comment">//ss&lt;&lt;"nu image is written to "&lt;&lt;filename.str()&lt;&lt;" successfully "</span>
00331       <span class="comment">//&lt;&lt;" at iteration "&lt;&lt;status-&gt;iter&lt;&lt;endl;</span>
00332       <span class="comment">//logg-&gt;outputMessage(ss.str(),ALGORITHM, 2);</span>
00333 
00334     }
00335     
00336     time_t timeUpdateLambda1=time((time_t *) 0);  
00337     <span class="comment">//float QAve = Q.average();</span>
00338     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ny=0;ny&lt;params.geometry.nY;ny++)
00339       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> nz=0;nz&lt;params.geometry.nZ;nz++)
00340         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> nx=0;nx&lt;params.geometry.nX;nx++){
00341 <span class="comment">//        if(Q(nx,ny,nz)&gt;params.algorithm.Qthreshold*QAve){</span>
00342           <span class="keywordflow">if</span>(lambdaMask(nx,ny,nz) &amp;&amp; (Q(nx,ny,nz) &gt; 0.0)){
00343             lambda(nx,ny,nz)=lambda(nx,ny,nz)*nu(nx,ny,nz)/Q(nx,ny,nz);
00344           }
00345           <span class="keywordflow">else</span>
00346             lambda(nx,ny,nz)=0;
00347         }
00348     time_t timeUpdateLambda2=time((time_t *) 0);  
00349     <span class="keywordtype">double</span>  timeUpdateLambda=difftime(timeUpdateLambda2,timeUpdateLambda1);
00350  
00351     <span class="keywordflow">if</span>(status-&gt;proc ==0){
00352       stringstream ss;
00353       ss&lt;&lt;<span class="stringliteral">"update lambda takes "</span>&lt;&lt;timeUpdateLambda&lt;&lt;<span class="stringliteral">" s at iteration "</span> 
00354         &lt;&lt;status-&gt;iter&lt;&lt;<span class="stringliteral">" sub set "</span>&lt;&lt;status-&gt;subset;
00355     logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 2);
00356     }
00357     time_t timeSubSet2=time((time_t *)0);
00358     <span class="keywordtype">double</span> timeSubSet = difftime(timeSubSet2, timeSubSet1);
00359     <span class="keywordflow">if</span>(status-&gt;proc ==0){
00360       stringstream ss;
00361       ss&lt;&lt;<span class="stringliteral">"Iteration "</span>&lt;&lt;status-&gt;iter&lt;&lt;<span class="stringliteral">" sub set "</span>&lt;&lt;status-&gt;subset&lt;&lt;
00362         <span class="stringliteral">" : "</span>&lt;&lt;timeSubSet&lt;&lt;<span class="stringliteral">" sec "</span> ;
00363       logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 2);
00364     }
00365 
00366   }
00367 
00368   
00369  {
00370      stringstream ss;
00371      ss&lt;&lt;<span class="stringliteral">"Barrier time at proc:"</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" is :"</span>&lt;&lt;timeBarrier
00372                 &lt;&lt;<span class="stringliteral">" for iteration :"</span>&lt;&lt;status-&gt;iter&lt;&lt;endl;
00373      logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 3);
00374  }
00375   <a class="code" href="classFrameInfo.html">FrameInfo</a> *fi = FrameInfo::getInstance();
00376   <span class="keywordflow">if</span>(status-&gt;iter == 1) {
00377       status-&gt;barrierTimes.init(status-&gt;numProcs, params.algorithm.numIterations);
00378       status-&gt;barrierTimes = 0;
00379   }
00380   status-&gt;barrierTimes(status-&gt;proc,status-&gt;iter-1) = timeBarrier;
00381 
00382   <span class="comment">//Do  a global sum of barrierTimes array to consolidate the results</span>
00383   <span class="keywordtype">int</span> *barrierTimesLocal = status-&gt;barrierTimes.getBlock(0,status-&gt;iter-1,status-&gt;numProcs); 
00384   
00385   <span class="keywordtype">int</span> bTimesSum[status-&gt;numProcs];
00386   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i &lt; status-&gt;numProcs; i++) bTimesSum[i] = barrierTimesLocal[i];
00387   MPI::COMM_WORLD.Allreduce(&amp;barrierTimesLocal[0], &amp;bTimesSum[0] , status-&gt;numProcs, 
00388                             MPI::INT, MPI::SUM);
00389   status-&gt;barrierTimes.putBlock(0,status-&gt;iter-1,status-&gt;numProcs,bTimesSum);
00390 
00391   <span class="comment">//DO A GLOBAL SUM ON logLike</span>
00392   <span class="keywordtype">float</span> logLikeLocal = logLike;
00393   MPI::COMM_WORLD.Allreduce(&amp;logLikeLocal, &amp;logLike , 1, 
00394                             MPI::FLOAT, MPI::SUM);
00395    
00396   <span class="keywordtype">float</span> QTlambda = Q.<a class="code" href="classArray3D.html#a12">innerProduct</a>(lambda);  <span class="comment">// treat them as array3Ds</span>
00397   
00398   logLike -= QTlambda;
00399   <span class="keywordflow">if</span>(status-&gt;proc == 0){
00400     stringstream ss;
00401     ss &lt;&lt; <span class="stringliteral">"Log likelihood at iteration "</span>&lt;&lt;status-&gt;iter&lt;&lt; <span class="stringliteral">" is "</span> 
00402        &lt;&lt; logLike &lt;&lt; endl;
00403     logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 0);
00404     <span class="keywordflow">if</span>(oslog) {
00405       ss.str(<span class="stringliteral">""</span>);
00406       ss&lt;&lt;logLike&lt;&lt;<span class="stringliteral">" "</span>;
00407       logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(oslog,ss.str(),ALGORITHM, 0);
00408     }
00409 
00410   }
00411  
00412   timeFwdBackProj2 = time((time_t *) 0);
00413   timeFwdBackProj = difftime(timeFwdBackProj2,timeFwdBackProj1);
00414   <span class="keywordflow">if</span>(status-&gt;proc ==0){
00415     stringstream ss;
00416     ss&lt;&lt;<span class="stringliteral">"Forward back projection takes "</span>&lt;&lt;timeFwdBackProj
00417       &lt;&lt;<span class="stringliteral">" s at iteration "</span> 
00418       &lt;&lt;status-&gt;iter&lt;&lt;endl;
00419     logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 2);
00420   }
00421     <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00422           status-&gt;printMemInfo();
00423     }
00424 
00425   <span class="keywordflow">return</span>(logLike);
00426 }       
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="AlgorithmOSEM::reconstruct" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void AlgorithmOSEM::reconstruct </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>Q</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>mu</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>House *&nbsp;</td>
          <td class="mdname" nowrap> <em>house</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classEventList.html">EventList</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>eventList</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>Params &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>params</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambdaMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [virtual]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This function is the virtual function for reconstruction The OSEM algorithm overides this function to perform reconstruction <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>lamda</em>&nbsp;</td><td>the lamda image </td></tr>
    <tr><td valign=top><em>Q</em>&nbsp;</td><td>the Q image </td></tr>
    <tr><td valign=top><em>eventlist</em>&nbsp;</td><td>stores the events </td></tr>
    <tr><td valign=top><em>house</em>&nbsp;</td><td>instance of House class, where the events are read in </td></tr>
    <tr><td valign=top><em>params</em>&nbsp;</td><td>Instance of Params class, inited from the xml file </td></tr>
    <tr><td valign=top><em>lambdaMask</em>&nbsp;</td><td>masking image, if the output mask is ture, use it to mask the output image </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>
Implements <a class="el" href="classAlgorithm.html#a2">Algorithm</a>.
<p>
Definition at line <a class="el" href="AlgorithmOSEM_8cpp-source.html#l00024">24</a> of file <a class="el" href="AlgorithmOSEM_8cpp-source.html">AlgorithmOSEM.cpp</a>.
<p>
References <a class="el" href="Algorithm_8cpp-source.html#l00408">Algorithm::collectEstimates()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00267">MOLAR::generateSinoGram()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00049">MOLAR::getInstance()</a>, <a class="el" href="Log_8hpp-source.html#l00079">Log::getLog()</a>, <a class="el" href="Utilities_8hpp-source.html#l00064">Utilities::getOutputExt()</a>, <a class="el" href="AlgorithmOSEM_8cpp-source.html#l00166">oneIteration()</a>, <a class="el" href="Log_8hpp-source.html#l00052">Log::outputMessage()</a>, and <a class="el" href="Image_8cpp-source.html#l00362">Image::write()</a>.
<p>
<div class="fragment"><pre>00028 {
00029   <span class="comment">/* Here we assume that the function HRRT::initializeLambda() and the</span>
00030 <span class="comment">     Status constructor have already dealt with the logic of reading</span>
00031 <span class="comment">     in the Q image, setting the starting iteration, etc.  In other</span>
00032 <span class="comment">     words, lambda and status are ready to go.</span>
00033 <span class="comment">  */</span>
00034   <span class="keywordtype">float</span> logLikelihood;
00035 
00036   <a class="code" href="classMOLAR.html">MOLAR</a> * molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00037   Status *status = Status::getStatus();
00038   <a class="code" href="classLog.html">Log</a> *logg = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00039   <span class="keywordtype">int</span> stopIter = status-&gt;iter + params.algorithm.numIterations;
00040   <span class="keywordflow">while</span>(status-&gt;iter &lt; stopIter){
00041     status-&gt;iter++;
00042 
00043     logLikelihood = <a class="code" href="classAlgorithmOSEM.html#a1">oneIteration</a>(lambda, Q, lambdaMask, house, eventList, params, mu);
00044 
00045 
00046 
00047     <span class="comment">//Collects the randoms, scatter, yhat and livetime_decay estimates an</span>
00048 
00049     <span class="comment">//wrties to the frameInfo fil</span>
00050 
00051     <a class="code" href="classAlgorithm.html#a3">collectEstimates</a>(eventList);
00052 
00053    
00054 
00055 
00056 
00057     <span class="keywordflow">if</span>(status-&gt;proc == 0){
00058       <span class="comment">//if(THIS IS ONE OF THE ITERATIONS TO WRITE THE IMAGE){</span>
00059       <span class="comment">// outputIteratoinIncrement says how often to write out images</span>
00060       <span class="comment">// 0 means write out last image</span>
00061       <span class="keywordflow">if</span>(params.algorithm.outputIterationIncrement == 0) 
00062         params.algorithm.outputIterationIncrement=stopIter;
00063       <span class="keywordflow">if</span>(params.algorithm.outputIterationIncrement &gt; stopIter) 
00064         params.algorithm.outputIterationIncrement=stopIter;
00065       <span class="keywordflow">if</span>((status-&gt;iter)%params.algorithm.outputIterationIncrement==0){
00066         string outputExt;<span class="comment">//extension of output image file</span>
00067         outputExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00068         
00069         stringstream filename;
00070         filename&lt;&lt; params.frame.frameDirectory&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;
00071           params.frame.outputFileNameBase&lt;&lt; <span class="stringliteral">"-"</span>&lt;&lt; status-&gt;iter;
00072         filename &lt;&lt; <span class="stringliteral">"."</span>&lt;&lt; outputExt;
00073         <span class="keywordflow">if</span>(params.algorithm.enableOutputMasking &lt;= 0){
00074          lambda.<a class="code" href="classImage.html#a8">write</a>(filename.str(), params.extensions);
00075         } <span class="keywordflow">else</span> {
00076          <span class="comment">// 2004-10-02 now truncate high values on edge slices</span>
00077          <span class="comment">// 2004-12-03 base cutoff on highest value in central slices in attenuating object</span>
00078          <span class="comment">// 2004-12-07 extend to also limit to inside the FOV_r</span>
00079          <span class="keywordtype">float</span> lambda_max=0.;
00080          <span class="keywordtype">int</span> nzskip=params.algorithm.enableOutputMasking;
00081          <span class="keywordtype">float</span> r2max=POW2(params.geometry.FOV_r/2.0);
00082          <span class="keywordtype">float</span> xmid = (params.geometry.nX-1)/2.0;
00083          <span class="keywordtype">float</span> ymid = (params.geometry.nY-1)/2.0;
00084          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0; iy&lt;params.geometry.nY; iy++)
00085            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = nzskip; iz &lt; params.geometry.nZ-nzskip; iz++)
00086              <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0; ix&lt; params.geometry.nX; ix++){
00087                if ((lambda(ix,iy,iz) &gt; lambda_max) &amp;&amp; (mu(ix,iy,iz) &gt; params.attenuation.threshold)
00088                 &amp;&amp; (POW2(ix-xmid) + POW2(iy-ymid)&lt;= r2max))
00089                 lambda_max = lambda(ix,iy,iz);
00090              }
00091          <span class="comment">// truncate all values in edge slices</span>
00092          <a class="code" href="classImage.html">Image</a> lambdaTemp(lambda);
00093          lambdaTemp = lambda;
00094          <span class="keywordtype">int</span> npix=0;
00095          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0; iy&lt;params.geometry.nY; iy++)
00096            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0; iz &lt; nzskip; iz++)
00097              <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0; ix&lt; params.geometry.nX; ix++){
00098                if (lambdaTemp(ix,iy,iz) &gt; lambda_max) {
00099                 lambdaTemp(ix,iy,iz)=lambda_max;
00100                 npix++;
00101                }
00102              }
00103          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0; iy&lt;params.geometry.nY; iy++)
00104            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = params.geometry.nZ-nzskip; iz &lt; params.geometry.nZ; iz++)
00105              <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0; ix&lt; params.geometry.nX; ix++){
00106                if (lambdaTemp(ix,iy,iz) &gt; lambda_max) {
00107                 lambdaTemp(ix,iy,iz)=lambda_max;
00108                 npix++;
00109                }
00110              }
00111          <span class="keywordflow">if</span>(params.frame.verbosity&gt;=2) {
00112            cout&lt;&lt;<span class="stringliteral">"Thresholding image for output. Max of central slices is "</span>&lt;&lt;lambda_max
00113                 &lt;&lt;endl;
00114             cout&lt;&lt;<span class="stringliteral">"Set "</span>&lt;&lt;npix&lt;&lt;<span class="stringliteral">" pixels in outer "</span>&lt;&lt;nzskip&lt;&lt;<span class="stringliteral">" slices"</span>&lt;&lt;endl;
00115          }
00116          <span class="comment">// truncate all values in central slices with mu &lt;= 0 OR outside FOV_r</span>
00117          <span class="keywordflow">if</span> (params.attenuation.enable) {
00118           <span class="keywordtype">int</span> npix=0;
00119           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0; iy&lt;params.geometry.nY; iy++)
00120             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = nzskip; iz &lt; params.geometry.nZ-nzskip; iz++)
00121               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0; ix&lt; params.geometry.nX; ix++){
00122                 <span class="keywordflow">if</span> ((lambda(ix,iy,iz) &gt; lambda_max) &amp;&amp; 
00123                 ((mu(ix,iy,iz) &lt;= params.attenuation.threshold) ||(POW2(ix-xmid) + POW2(iy-ymid)&gt; r2max)) ) {
00124                  lambdaTemp(ix,iy,iz)=lambda_max;
00125                  npix++;
00126                 }
00127               }
00128           <span class="keywordflow">if</span>(params.frame.verbosity&gt;=2) {
00129              cout&lt;&lt;<span class="stringliteral">"Set "</span>&lt;&lt;npix&lt;&lt;<span class="stringliteral">" pixels in inner "</span>&lt;&lt;params.geometry.nZ-2*nzskip&lt;&lt;<span class="stringliteral">" slices"</span>&lt;&lt;endl;
00130           }
00131          }   
00132          lambdaTemp.<a class="code" href="classImage.html#a8">write</a>(filename.str(), params.extensions, Q, params,lambdaMask);
00133         }
00134         stringstream ss;
00135         ss&lt;&lt;<span class="stringliteral">"Reconstructed image written to "</span>&lt;&lt; filename.str()
00136           &lt;&lt;<span class="stringliteral">" successfully "</span>
00137           &lt;&lt;<span class="stringliteral">" at iteration "</span>&lt;&lt;status-&gt;iter&lt;&lt;endl;
00138 
00139         logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 2);
00140       }
00141     }
00142      
00143       <span class="comment">//}</span>
00144 
00145       <span class="comment">//if(THIS IS ONE OF THE ITERATIONS TO WRITE THE SINOGRAM){</span>
00146     <span class="keywordflow">if</span> (params.sinogram.enable) 
00147      molar-&gt;<a class="code" href="classMOLAR.html#a17">generateSinoGram</a>(eventList, params, *status);
00148     <span class="comment">//Utilities::cleanUp(-1);</span>
00149     <span class="comment">//}*/</span>
00150     
00151   }
00152 }
</pre></div>    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="AlgorithmOSEM_8hpp-source.html">AlgorithmOSEM.hpp</a><li><a class="el" href="AlgorithmOSEM_8cpp-source.html">AlgorithmOSEM.cpp</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:48 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
