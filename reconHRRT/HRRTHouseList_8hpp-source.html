<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: HRRTHouseList.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>HRRTHouseList.hpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef HRRTHOUSELIST_HPP</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define HRRTHOUSELIST_HPP</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#include "Params.hpp"</span>
00004 <span class="preprocessor">#include "FourDReconstruction.hpp"</span>
00005 <span class="preprocessor">#</span>
00006 <span class="preprocessor"></span>
<a name="l00011"></a><a class="code" href="classHRRTHouseList.html">00011</a> <span class="keyword">class </span><a class="code" href="classHRRTHouseList.html">HRRTHouseList</a>{
00012   <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classHRRTHouse.html">HRRTHouse</a>;
00013   <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classHRRTHouseSingles.html">HRRTHouseSingles</a>;
00014   <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classFrameInfo.html">FrameInfo</a>;
00015   <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classHRRTHouseEvent.html">HRRTHouseEvent</a>;
00016   <span class="keyword">friend</span> <span class="keyword">class </span>HRRTHouseTest;
00017 <span class="keyword">private</span>:
00018     <span class="keyword">struct </span>StatusStruct {
00019     <span class="keywordtype">int</span> stat_key;
00020     <span class="keywordtype">long</span> nRead; <span class="comment">//number of packets read</span>
00021     <span class="keywordtype">long</span> nEvent; <span class="comment">//number of events read</span>
00022     <span class="keywordtype">long</span> nPrompt;<span class="comment">//number of prompts read</span>
00023     <span class="keywordtype">long</span> nRandom;<span class="comment">//number of randoms read</span>
00024     <span class="keywordtype">long</span> nNonEvent;<span class="comment">//number of nonevent read</span>
00025     <span class="keywordtype">long</span> nAccept; <span class="comment">//number of accepted events</span>
00026     <span class="keywordtype">long</span> nReject; <span class="comment">//number of rejected events</span>
00027     <span class="keywordtype">long</span> nSkip;<span class="comment">// number of skip</span>
00028     <span class="keywordtype">long</span> nBadEvents;<span class="comment">// number of bad events</span>
00029     <span class="keywordtype">long</span> nBadNonEvents;<span class="comment">// number of bad non-events</span>
00030     <span class="keywordtype">long</span> nT; <span class="comment">//number of time tags</span>
00031     <span class="keywordtype">long</span> nS;
00032     <span class="keywordtype">long</span> nFf;
00033     <span class="keywordtype">long</span> nFb;
00034     <span class="keywordtype">long</span> nBb;
00035     <span class="keywordtype">long</span> nAdjh;
00036     <span class="keywordtype">long</span> nMisc1;
00037     <span class="keywordtype">long</span> nMiscs;
00038     <span class="keywordtype">double</span> nDecayFactor;
00039     <span class="keywordtype">double</span> nLiveTimeFactor;
00040     <span class="keywordtype">double</span> nLiveTime_Decay;
00041   };
00042 
00045   <span class="keyword">struct </span>HrrtTime {
00046     <span class="keywordtype">int</span> studyStartTime; <span class="comment">//scan starting time form midnight, in ms</span>
00047     <span class="keywordtype">int</span> decayCorrectionTime; <span class="comment">//from midnight, in ms </span>
00048     <span class="keywordtype">int</span> requestedDuration; <span class="comment">//in ms</span>
00049     <span class="keywordtype">int</span> duration; <span class="comment">//actual duration, in ms</span>
00050     <span class="keywordtype">int</span> thisTimeTag; <span class="comment">//current time tag</span>
00051     <span class="keywordtype">int</span> firstTimeTagInFile;
00052     <span class="keywordtype">int</span> requestedFrameStartTimeTag; <span class="comment">//user requested start time tag </span>
00053     <span class="keywordtype">int</span> requestedFrameStopTimeTag;
00054     <span class="keywordtype">int</span> frameStartTimeTag; <span class="comment">//actual frame start time tag</span>
00055     <span class="keywordtype">int</span> frameStopTimeTag; <span class="comment">//actual frame stop time tag</span>
00056   };
00057 
00058 <span class="keyword">private</span>:
00059   <span class="comment">//  next few added 2006-08-30</span>
00060   <span class="keywordtype">float</span> sing_fix_time;  <span class="comment">// after this time, fix singles</span>
00061   <span class="keywordtype">float</span> sing_fix_constant;      <span class="comment">// fix by exp(-sing_fix_constant*(time-sing_fix_time))</span>
00062   <span class="keywordtype">float</span> sing_fix;               <span class="comment">// current scale factor</span>
00063   <span class="keywordtype">int</span> sing_fix_last_report;     <span class="comment">//last time tag when I reported the correction</span>
00064   <span class="comment">// end of additions for 2006-08-30</span>
00065   <span class="keyword">enum</span> Mode {ListMode, RandListMode} mode;
00066   StatusStruct stat; <span class="comment">//status parameters</span>
00067   FILE *lun; <span class="comment">//List mode file</span>
00068   HrrtTime time; <span class="comment">//time information</span>
00069   <span class="comment">//motion correction</span>
00070   <a class="code" href="classMotionCorrection.html">MotionCorrection</a> * motion;
00071   <span class="comment">// Four D</span>
00072   <span class="comment">//FourDReconstruction * fourd;</span>
00073 
00074 
00075   <span class="comment">//Pointers to the other classes used in this class</span>
00076   Params * params;
00077   <a class="code" href="classHRRTHouseSingles.html">HRRTHouseSingles</a> *houseSingles;
00078   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner;
00079   Status *status;
00080   <a class="code" href="classFrameInfo.html">FrameInfo</a> *fi;
00081 
00082   FILE **outfp;   <span class="comment">// array of output-file pointers in support of simulation</span>
00083 
00084   <span class="comment">//constructor</span>
00085   <a class="code" href="classHRRTHouseList.html">HRRTHouseList</a>();
00086 
00087   <span class="keywordtype">int</span> checkSum;
00088   <span class="comment">//check if the class is intialized, to prevent unsafe use of</span>
00089   <span class="comment">//the pointer</span>
00090   <span class="keywordtype">bool</span> checkValid(){
00091     <span class="keywordflow">return</span> checkSum==<span class="keyword">sizeof</span>(<a class="code" href="classHRRTHouseList.html">HRRTHouseList</a>);
00092   };
00093 
00094   <span class="comment">//calculate the frame start time tag</span>
00095   <span class="comment">//frameStartTimeTag = params.frame.frameStartTime-params.frame.scanStartTime</span>
00096   <span class="keywordtype">void</span> getFrameStartTimeTag();
00097 
00098   <span class="comment">//go to a specified frame time tag</span>
00099   <span class="keywordtype">void</span> gotoFrameStartTimeTag();
00100 
00101   <span class="comment">//check if the words synchronized, if not, synchronize them, </span>
00102   <span class="comment">//return false if cannot be synchronized</span>
00103   <span class="keywordtype">bool</span> checkSync(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *);
00104 
00105   <span class="comment">//The functions used in getNextEvent()</span>
00106   <span class="comment">//read the list mode file, decode the 64 bit data to two detector</span>
00107   <span class="comment">//structures, e1 and e2</span>
00108   <span class="comment">//return true as it gets a prompt</span>
00109   <span class="comment">//or it gets a random when calculating the random sinogram</span>
00110   <span class="comment">//return false when there is i/o error or end of file reached</span>
00111   <span class="keywordtype">bool</span> readListMode(<a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2);
00112   <span class="comment">//determine if a 64 bit event is a time tag</span>
00113   <span class="keywordtype">bool</span> isTimeTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b){
00114     <span class="keywordflow">return</span> <a class="code" href="classTOC.html#e0">TOC::isTimeTag</a>(b);
00115   }
00116   <span class="comment">//determine if a 64 bit event is a singles tag</span>
00117   <span class="keywordtype">bool</span> isSinglesTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00118   {
00119     <span class="keywordflow">return</span>(((b[1] &amp; 0x4000 )&gt;&gt;14) ==1 &amp;&amp; ((b[2] &amp; 0xe000) == 0xa000));
00120   }
00121   <span class="comment">//determine if a 64 bit event is an event</span>
00122   <span class="keywordtype">bool</span> isEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00123   {
00124     <span class="keywordflow">return</span> (((b[1] &amp; 0x4000 )&gt;&gt;14) == 0);
00125   }
00126   <span class="comment">//process the time tag</span>
00127   <span class="keywordtype">int</span> processTimeTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b);
00128   <span class="comment">//process the singles tag</span>
00129   <span class="keywordtype">void</span> processSinglesTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b);
00130   <span class="comment">//read list mode file till the frame start time tag</span>
00131   <span class="comment">//fill the time information</span>
00132   <span class="keywordtype">bool</span> prepareListModeFile();
00133   <span class="comment">//Read two words (64 bits) from the list mode data</span>
00134   <span class="comment">//decode the bits</span>
00135   <span class="keywordtype">bool</span> processEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *, <a class="code" href="structCrystalID.html">CrystalID</a> &amp;, 
00136                     <a class="code" href="structCrystalID.html">CrystalID</a> &amp;);
00137 
00141   <span class="keywordtype">bool</span> unProcessEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b,  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, 
00142                       <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2);
00143 
00144   <span class="keywordtype">void</span> processNonEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *);
00154   <span class="keywordtype">bool</span> findPreviousEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b);
00155 
00156   <span class="keywordtype">bool</span> findNextEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b);
00157   <span class="keywordtype">int</span> getBlockNumber(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e1); 
00158   <span class="comment">//calculate corresponding block number of e1</span>
00159 
00160  <span class="comment">//------------------------------------------------------------------------- </span>
00161  <span class="comment">// Reads the list-mode file under randomized mode. Continues reading</span>
00162  <span class="comment">// until it reaches a time stamp and then returns.  Can also return</span>
00163  <span class="comment">// due to an error condition.  </span>
00164   <span class="comment">//Reads the list mode file, decode the 64 bit data to two detector</span>
00165   <span class="comment">//structures, e1 and e2</span>
00166   <span class="comment">//return true as it gets a prompt</span>
00167   <span class="comment">//or it gets a random when calculating the random sinogram</span>
00168 
00169   <span class="comment">// RETURNS: 0 if the operation was successful, or Constants::FEOF or</span>
00170   <span class="comment">// Constants:FERROR or Constants:CHECKSYNC_ERROR if it was not successful.  </span>
00171 
00172   <span class="comment">//--------------------------------------------------------------------------</span>
00173 
00174   <span class="keywordtype">int</span> readRandomizedListMode();
00175 
00176 
00177 
00187   <span class="keywordtype">bool</span> prepareListData();
00188 
00198   <span class="keywordtype">bool</span> prepareRandomizedListData();
00203   <span class="keywordtype">void</span> outPutStatistics(); <span class="comment">//output information</span>
00204   <span class="keywordtype">void</span> outPutRandomStatistics(); <span class="comment">//output information</span>
00205 
00206   <span class="keyword">static</span> <a class="code" href="classHRRTHouseList.html">HRRTHouseList</a> * getInstance(){
00207     <span class="keyword">static</span> <a class="code" href="classHRRTHouseList.html">HRRTHouseList</a> singleton;
00208     <span class="keywordflow">return</span> &amp;singleton;
00209   }
00210 
00217   <span class="keywordtype">void</span> unProcessTimeTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, <span class="keywordtype">int</span> timeTag);
00218 
00219     
00220     
00221 <span class="comment">/******************************************************</span>
00222 <span class="comment"> * putNextEvent() - Called from</span>
00223 <span class="comment"> * AlgorithmSimulation::collectDistribute()</span>
00224 <span class="comment"> * This function takes a fully-formed event packet, extracts the</span>
00225 <span class="comment"> * fundamental identifying variables, and decodes them into a</span>
00226 <span class="comment"> * raw-event (a 64-bit word) for output to a list-mode file</span>
00227 <span class="comment"> * representing a simulation  realization.  It keeps track of the</span>
00228 <span class="comment"> * current (or, actually "previous") time tag for a particular</span>
00229 <span class="comment"> * realization.  When the time tag changes, this function also writes</span>
00230 <span class="comment"> * out a time stamp event and a block singles event.</span>
00231 <span class="comment"> *@param event the event to be written</span>
00232 <span class="comment"> *@param realiz - The realization number which identifies the file to</span>
00233 <span class="comment"> *be written .  </span>
00234 <span class="comment"> *@return true if everything OK, false if errors in I/O or unProcessEvent</span>
00235 <span class="comment"> */</span>
00236   <span class="keywordtype">bool</span> putNextEvent(<a class="code" href="classEventPacket.html">EventPacket</a> &amp; event, <span class="keywordtype">int</span> realiz);
00237 
00238 
00239 <span class="comment">/**************************************************</span>
00240 <span class="comment"> * prepareOutput</span>
00241 <span class="comment"> * This is a public function (to the parent) that needs to be called from</span>
00242 <span class="comment"> * AlgorithmSimulation::collectDistribute() prior to the actual</span>
00243 <span class="comment"> * redistribution of events.  It opens the output file corresponding</span>
00244 <span class="comment"> * to realization irealiz.  The filename is formed from the listmode</span>
00245 <span class="comment"> * filename in params.frame.listmodeFilename, with a substring</span>
00246 <span class="comment"> * inserted identifying the realization in front of the last "."</span>
00247 <span class="comment"> * In the event of an error condition, Utilities::cleanup() is called.</span>
00248 <span class="comment"> *@param irealiz - Identifies the realization number</span>
00249 <span class="comment"> ***************************/</span>
00250 
00251   <span class="keywordtype">void</span> prepareOutput(<span class="keywordtype">int</span> irealiz);
00252 
00253 
00254 
00255 <span class="comment">/*************************************************************************</span>
00256 <span class="comment"> * finalizeOutput</span>
00257 <span class="comment"> * Called toward the end of AlgorithmSimulation::collectDistribute,</span>
00258 <span class="comment"> * this function closes the output list-mode realization files</span>
00259 <span class="comment"> * assigned to the processor.</span>
00260 <span class="comment"> * If the realization number is not assigned to the current processor,</span>
00261 <span class="comment"> * this function will generate an error condition and call </span>
00262 <span class="comment"> * Utilities::cleanup()</span>
00263 <span class="comment"> ********************************************/</span>
00264 
00265   <span class="keywordtype">void</span> finalizeOutput(<span class="keywordtype">int</span> irealiz);
00266 
00267 <span class="comment">/*********************************************************************</span>
00268 <span class="comment">  * printErrEvent </span>
00269 <span class="comment">  * Prints any error in event packets in processing the event in </span>
00270 <span class="comment">  * processEvent</span>
00271 <span class="comment">**********************************************************************/</span>
00272   <span class="keywordtype">void</span> printErrEvent( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b,
00273                                  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1,
00274                                  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2, <span class="keywordtype">int</span> bank);
00275 
00276   <span class="keywordtype">float</span> fixSinglesFactor(<span class="keywordtype">int</span> time);
00277   
00278   <span class="keywordtype">int</span> FileSize(<span class="keyword">const</span> <span class="keywordtype">char</span>* filename);
00279 };
00280 
00281 
00282 <span class="preprocessor">#endif //HRRTHOUSELIST_HPP</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
