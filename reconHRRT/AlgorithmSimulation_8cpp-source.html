<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: AlgorithmSimulation.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>AlgorithmSimulation.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;math.h&gt;</span>
00002 <span class="preprocessor">#include "MOLAR.hpp"</span>
00003 <span class="preprocessor">#include "HRRTHouse.hpp"</span>
00004 <span class="preprocessor">#include "EventList.hpp"</span>
00005 <span class="preprocessor">#include "Params.hpp"</span>
00006 <span class="preprocessor">#include "Image.hpp"</span>
00007 <span class="preprocessor">#include "Algorithm.hpp"</span>
00008 <span class="preprocessor">#include "AlgorithmSimulation.hpp"</span>
00009 <span class="preprocessor">#include "Log.hpp"</span>
00010 <span class="preprocessor">#define PI 3.141592654</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#define M1 259200</span>
00012 <span class="preprocessor"></span><span class="preprocessor">#define IA1 7141</span>
00013 <span class="preprocessor"></span><span class="preprocessor">#define IC1 54773</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#define RM1 (1.0/M1)</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define M2 134456</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#define IA2 8121</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#define IC2 28411</span>
00018 <span class="preprocessor"></span><span class="preprocessor">#define RM2 (1.0/M2)</span>
00019 <span class="preprocessor"></span><span class="preprocessor">#define M3 243000</span>
00020 <span class="preprocessor"></span><span class="preprocessor">#define IA3 4561</span>
00021 <span class="preprocessor"></span><span class="preprocessor">#define IC3 51349</span>
00022 <span class="preprocessor"></span>
00023 <span class="preprocessor">#define ITMAX 100</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#define EPS 3.0e-7</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#define FPMIN 1.0e-30</span>
00026 <span class="preprocessor"></span>
00027 
00028 
00029 <span class="comment">/***************************************************************</span>
00030 <span class="comment">Algorithm, simulation constructor - just makes sure that certain</span>
00031 <span class="comment">parameter settings are correct.</span>
00032 <span class="comment">********/</span>
00033 
00034 AlgorithmSimulation::AlgorithmSimulation()
00035 {
00036   <span class="keywordtype">int</span>  errorNumber = 0;
00037   Status &amp;status = *Status::getStatus();
00038   Params &amp; params = *Params::getInstance();
00039   <span class="keywordflow">if</span>(params.algorithm.name != <span class="stringliteral">"simulation"</span>){
00040     <span class="keywordflow">if</span>(status.proc ==0){
00041       cout &lt;&lt; <span class="stringliteral">"Fatal error in AlgorithmSimulation constructor:  "</span> 
00042            &lt;&lt; <span class="stringliteral">", params.algorithm.name = "</span> &lt;&lt; params.algorithm.name &lt;&lt; endl;
00043     }
00044     errorNumber = -100;
00045   }
00046   <span class="keywordflow">if</span>(params.algorithm.numSets&gt;1){
00047     <span class="keywordflow">if</span>(status.proc==0){
00048       cout &lt;&lt; <span class="stringliteral">"Fatal error in AlgorithmSimulation constructor: "</span>
00049            &lt;&lt;<span class="stringliteral">" params.algorithm.numSets was entered as "</span> 
00050            &lt;&lt; params.algorithm.numSets &lt;&lt; <span class="stringliteral">", must be 1."</span>&lt;&lt;endl;
00051     }
00052     errorNumber += -200;
00053   }
00054   <span class="keywordflow">if</span> (errorNumber !=0)
00055     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(errorNumber);
00056 }
00057     
<a name="l00068"></a><a class="code" href="classAlgorithmSimulation.html#a0">00068</a> <span class="keywordtype">void</span> <a class="code" href="classAlgorithmSimulation.html#a0">AlgorithmSimulation::reconstruct</a>(<a class="code" href="classImage.html">Image</a> &amp;lambda, <a class="code" href="classImage.html">Image</a> &amp;Q, <a class="code" href="classImage.html">Image</a> &amp; mu, 
00069                                       House * house,
00070                                       <a class="code" href="classEventList.html">EventList</a> &amp;eventList,Params &amp;params , 
00071                                       <a class="code" href="classArray3D.html">Array3D&lt;char&gt;</a> &amp;lambdaMask)
00072 {
00073 
00074   <span class="comment">// get needed singleton objects</span>
00075   <a class="code" href="classFrameInfo.html">FrameInfo</a>&amp; fi = house-&gt;getFrameInfo();
00076   <a class="code" href="classMOLAR.html">MOLAR</a>* molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00077   Status *status = Status::getStatus();
00078   <a class="code" href="classLog.html">Log</a> * logg = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00079   <span class="keywordflow">if</span>(status-&gt;proc==0){
00080     stringstream ss;
00081     ss&lt;&lt;<span class="stringliteral">"================================="</span>&lt;&lt;endl;
00082     ss&lt;&lt;<span class="stringliteral">"ALgorithmSimulation"</span>&lt;&lt;endl;
00083     logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 0);
00084     string comm=ss.str();
00085     Status::StatusCode code=Status::RUNNING;
00086     status-&gt;update(comm,code);
00087   }
00088 
00089   <span class="comment">// forward Project the attenuation image and calculate Ai</span>
00090   ScatterCorrection *scatterCorrection = molar-&gt;<a class="code" href="classMOLAR.html#a26">getScatterCorrection</a>();
00091   status-&gt;iter = 1;        
00092 
00093   <span class="comment">// There needs to be a separate function 'simulate' in the</span>
00094   <span class="comment">// ScatterCorrection class</span>
00095   <span class="keywordflow">if</span>(params.modelBasedScatter.enable)
00096     scatterCorrection-&gt;update(mu,lambda,eventList); 
00097  
00098   <span class="comment">// forward Project the emission image, calculating the expected value of </span>
00099   <span class="comment">// each event </span>
00100   <span class="comment">// fills in event.yhat with expected count rate</span>
00101   molar-&gt;<a class="code" href="classMOLAR.html#a7">fwdProjectSolidAngle</a>(lambda,params,eventList); 
00102 
00103 
00104 
00105   <span class="comment">// We have now calculated the expected cps for a lot of potential events. </span>
00106   <span class="comment">// Account for undersampling of LORs by determining a scale factor</span>
00107   <span class="comment">//  undersamp_factor to scale up the expected values. This factor is : </span>
00108   <span class="comment">//   numLOR/(fi.naccept+fi.nreject) . </span>
00109   <span class="keywordtype">float</span> undersamp_factor=house-&gt;getTotalPossibleEvents()
00110     /((<span class="keywordtype">float</span>)fi.<a class="code" href="classFrameInfo.html#o5">nAcceptScanner</a> + (<span class="keywordtype">float</span>) fi.<a class="code" href="classFrameInfo.html#o6">nRejectScanner</a>) ;
00111   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00112     cout&lt;&lt;<span class="stringliteral">"Total possible events "</span>&lt;&lt;house-&gt;getTotalPossibleEvents()&lt;&lt;endl;
00113     cout&lt;&lt;<span class="stringliteral">"Total accepted events "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o5">nAcceptScanner</a>&lt;&lt;endl;
00114     cout&lt;&lt;<span class="stringliteral">"Total rejected events "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o6">nRejectScanner</a>&lt;&lt;endl;
00115  
00116     cout&lt;&lt;<span class="stringliteral">"undersamp_factor "</span>&lt;&lt;undersamp_factor&lt;&lt;endl;
00117     cout&lt;&lt;<span class="stringliteral">"Duration "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>&lt;&lt;endl;
00118   }
00119   <span class="comment">// Run through the events and convert cps to the </span>
00120   <span class="comment">// expected number of events per LOR. Correct for undersampling </span>
00121   <span class="comment">// and the scan duration.  </span>
00122   <span class="comment">// Also calculate the highest expected value as a diagnostic</span>
00123  
00124   <span class="keywordtype">float</span> count_factor=undersamp_factor * fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>/1000;
00125   <span class="keywordtype">float</span> yhat_max=0.0;
00126   <span class="keywordtype">double</span> yhat_ave=0.0;
00127   <span class="keywordtype">double</span> numEvents=0;
00128   <a class="code" href="classEventPacket.html">EventPacket</a> sentry = eventList.<a class="code" href="classEventList.html#a6">getSentry</a>(); <span class="comment">//prepare for sentry</span>
00129   <span class="keywordtype">int</span> count = 0;
00130   <span class="keywordflow">if</span>(status-&gt;proc ==0 &amp;&amp; params.frame.verbosity&gt;=2)
00131    cout&lt;&lt;<span class="stringliteral">"Scaling expected values..."</span>&lt;&lt;endl;
00132    
00133   <span class="keywordflow">for</span>(status-&gt;subset=0;status-&gt;subset&lt;
00134         params.algorithm.numSets;status-&gt;subset++){
00135     <a class="code" href="classEventPacket.html">EventPacket</a> event = eventList.<a class="code" href="classEventList.html#a3">getFirst</a>(status-&gt;subset); 
00136     <span class="keywordflow">while</span> (!(event ==sentry ) ) { 
00137       <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o0">jstart</a> &lt;=event.<a class="code" href="classEventPacket.html#o1">jstop</a>){
00138         event.<a class="code" href="classEventPacket.html#o18">yhat</a>  *= count_factor ;  <span class="comment">//  convert to counts</span>
00139         <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o18">yhat</a> &gt; yhat_max) 
00140           yhat_max = event.<a class="code" href="classEventPacket.html#o18">yhat</a>;
00141         yhat_ave += (<span class="keywordtype">double</span>)event.<a class="code" href="classEventPacket.html#o18">yhat</a>;
00142         numEvents += (<span class="keywordtype">double</span>)1;
00143       }
00144       
00145       event = eventList.<a class="code" href="classEventList.html#a4">getNext</a>(status-&gt;subset);
00146       count++;
00147       <span class="keywordflow">if</span>(status-&gt;proc ==0 &amp;&amp; params.frame.verbosity&gt;=2){ 
00148         <span class="keywordflow">if</span>(count%100000==0) 
00149           (cout&lt;&lt;count&lt;&lt;<span class="stringliteral">" events out of "</span> 
00150            &lt;&lt;eventList.<a class="code" href="classEventList.html#a12">getNumEvents</a>(status-&gt;subset)
00151            &lt;&lt;<span class="stringliteral">" scaled"</span>&lt;&lt;endl).flush();
00152         <span class="comment">//      if(event==sentry) (cout&lt;&lt;countT&lt;&lt;endl).flush();</span>
00153       } <span class="comment">//end if</span>
00154  
00155     }
00156   } 
00157   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00158 
00159     cout&lt;&lt;<span class="stringliteral">"Before collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_max is "</span>&lt;&lt;yhat_max&lt;&lt;endl;
00160     cout&lt;&lt;<span class="stringliteral">"Before collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_ave is "</span>&lt;&lt;yhat_ave&lt;&lt;endl;
00161     cout&lt;&lt;<span class="stringliteral">"Before collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" numEvents is "</span>&lt;&lt;numEvents&lt;&lt;endl;
00162   }
00163    
00164 
00165   <span class="keywordtype">float</span> yhatmaxlocal = yhat_max;
00166  
00167   MPI::COMM_WORLD.Allreduce(&amp;yhatmaxlocal,&amp;yhat_max,1,MPI::FLOAT,MPI::MAX);
00168 
00169   <span class="keywordtype">double</span> yhatavelocal = yhat_ave;
00170   MPI::COMM_WORLD.Allreduce(&amp;yhatavelocal,&amp;yhat_ave,1,MPI::DOUBLE,MPI::SUM);
00171   <span class="keywordtype">double</span> numEventslocal = numEvents;
00172   <span class="keywordtype">double</span> numEventsLocal = numEvents;
00173   MPI::COMM_WORLD.Allreduce(&amp;numEventslocal,&amp;numEvents,1,MPI::DOUBLE,MPI::SUM);
00174   <span class="keywordflow">if</span>(numEvents==0){
00175     cout &lt;&lt; <span class="stringliteral">"Error in AlgorithmSimulation::reconstruct(), colleted numEvents "</span>
00176          &lt;&lt; <span class="stringliteral">" is zero, aborting from processor "</span> &lt;&lt; status-&gt;proc &lt;&lt; endl;
00177     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(78);  
00178   }
00179   yhat_ave /= fi.<a class="code" href="classFrameInfo.html#o7">nAcceptObject</a>;
00180   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00181 
00182     cout&lt;&lt;<span class="stringliteral">" frameInfo::nAcceptObject is : "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o7">nAcceptObject</a>&lt;&lt;endl;
00183     cout&lt;&lt;<span class="stringliteral">" frameInfo::nRejectObject is : "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o8">nRejectObject</a>&lt;&lt;endl;
00184     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_max is "</span>&lt;&lt;yhat_max&lt;&lt;endl;
00185     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_ave is "</span>&lt;&lt;yhat_ave&lt;&lt;endl;
00186     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" numEvents is "</span>&lt;&lt;numEvents&lt;&lt;endl;
00187   }
00188 
00189   <span class="keywordtype">int</span> startTimeTag = fi.<a class="code" href="classFrameInfo.html#o15">frameStartTimeTag</a>;  <span class="comment">// need to add this field</span>
00190   <span class="keywordtype">int</span> stopTimeTag = startTimeTag + fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>;
00191   <span class="comment">// Calculate the average probability that a sample will be accepted.</span>
00192   <span class="comment">//double P1 = exp(-yhat_ave)*yhat_ave;</span>
00193   <span class="comment">//double P1 = 1; //disable sampling</span>
00194   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00195 
00196     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_ave is "</span>&lt;&lt;yhat_ave&lt;&lt;endl;
00197 
00198     cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">"startTimeTag is "</span>&lt;&lt;startTimeTag&lt;&lt;endl;
00199     cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">"stopTimeTag is "</span>&lt;&lt;stopTimeTag&lt;&lt;endl;
00200     cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">"numEventsLocal is "</span>&lt;&lt;numEventsLocal&lt;&lt;endl;
00201   }
00202 
00203   <span class="comment">// Calculate the desired time tag increment, in number of time tags.</span>
00204   <span class="comment">// This criterion determines how many time tags should comprise an</span>
00205   <span class="comment">// event buffer window for the messages going from list-processor to</span>
00206   <span class="comment">// realization -processor.  We want this increment to give us a</span>
00207   <span class="comment">// buffer size that will be at least 100 events, on average.</span>
00208   <span class="comment">// Note that we use the local number of events, since the events are</span>
00209   <span class="comment">// distributed and hence a buffer size criterion needs to take this</span>
00210   <span class="comment">// distribution into consideration.</span>
00211   <span class="comment">// 2007-05-01 - this next line is wrong in the case of low nSimEvents and high yhat_ave</span>
00212   <span class="comment">// I want to scale the number of events in the local buffer by the expected number</span>
00213   <span class="comment">// of counts per LOR = yhat_ave , not time the P(Y=1) = P1 </span>
00214   <span class="comment">//int timeTagIncrement = (int)ceil(100*(stopTimeTag - startTimeTag)/</span>
00215   <span class="comment">//                               (P1 *numEventsLocal));</span>
00216   <span class="keywordtype">int</span> timeTagIncrement = (<span class="keywordtype">int</span>)ceil(100*(stopTimeTag - startTimeTag)/
00217                                    (yhat_ave *numEventsLocal));
00218   <span class="comment">// be sure this is positive</span>
00219   <span class="keywordflow">if</span> (timeTagIncrement &lt;= 0) {
00220    timeTagIncrement = 1;
00221   }
00222   <span class="comment">// Now do a global collect operation to determine the maximum of the</span>
00223   <span class="comment">// calculated time tag increments.</span>
00224 
00225   <span class="keywordtype">int</span> localIncrement = timeTagIncrement;
00226   MPI::COMM_WORLD.Allreduce(&amp;localIncrement,&amp;timeTagIncrement,1,MPI::INT,
00227                             MPI::MAX);
00228                                   
00229 
00230   <span class="comment">// Print diagnostic for simulation code below</span>
00231   <span class="comment">// See comment below for details</span>
00232   <span class="keywordflow">if</span>((status-&gt;proc==0)&amp;&amp;(params.algorithm.verbosity&gt;=2)){
00233     cout&lt;&lt;<span class="stringliteral">"Report from AlgorithmSimulation::reconstruct() perusal of the "</span>
00234         &lt;&lt; <span class="stringliteral">"event list:"</span>&lt;&lt;endl;
00235     cout&lt;&lt;<span class="stringliteral">"Highest expected number of events per simulated LOR: "</span>
00236         &lt;&lt;yhat_max&lt;&lt;endl;
00237     cout&lt;&lt;<span class="stringliteral">"Average expected number of events per simulated LOR: "</span>
00238         &lt;&lt;yhat_ave&lt;&lt;endl;
00239     <span class="comment">//cout&lt;&lt;"Average probability of 1 event : "&lt;&lt;P1&lt;&lt;endl;</span>
00240     cout &lt;&lt;<span class="stringliteral">" Size of collection-distribution window, in number of time stamps: "</span>
00241          &lt;&lt;timeTagIncrement&lt;&lt;endl;
00242   }
00243   <span class="comment">/*if (yhat_max &gt; 0.2) {</span>
00244 <span class="comment">    if(status-&gt;proc==0){</span>
00245 <span class="comment">      cout&lt;&lt;"Fatal error in AlgorithmSimulation::reconstruct()  yhat_max = "</span>
00246 <span class="comment">          &lt;&lt;yhat_max&lt;&lt;endl</span>
00247 <span class="comment">          &lt;&lt;" This exceeds the range where the code is strictly legal"&lt;&lt;endl;</span>
00248 <span class="comment">    }</span>
00249 <span class="comment">    Utilities::cleanUp(-23);</span>
00250 <span class="comment">    }*/</span>
00251 
00252   <span class="keywordflow">if</span> (params.sinogram.enable) 
00253    molar-&gt;<a class="code" href="classMOLAR.html#a17">generateSinoGram</a>(eventList,params,*status);
00254 
00255   time_t time_CollectDis1 = time((time_t *)0);
00256   collectDistribute(*house, eventList, timeTagIncrement, count_factor);
00257   time_t time_CollectDis2 = time((time_t *)0);
00258   <span class="keywordtype">double</span> time_CollectDis = difftime(time_CollectDis2, time_CollectDis1);
00259   <span class="keywordflow">if</span>(params.algorithm.verbosity&gt;=2 &amp;&amp;(status-&gt;proc==0))
00260     cout&lt;&lt;<span class="stringliteral">"collectDistribution required "</span>&lt;&lt;time_CollectDis&lt;&lt;<span class="stringliteral">" sec"</span>&lt;&lt;endl;
00261 
00262 }
00263 
00264 <span class="comment">/***********************************************************************</span>
00265 <span class="comment">collectDistribute</span>
00266 <span class="comment">This function takes care of the Poisson sampling of the event list for</span>
00267 <span class="comment">each realization.  It also takes care of the interprocessor</span>
00268 <span class="comment">communication required redistribute the realized events from their assigned</span>
00269 <span class="comment">processors to the processors that are responsible for the appropriate</span>
00270 <span class="comment">realization.  </span>
00271 <span class="comment"></span>
00272 <span class="comment">INPUT:  House &amp;house     - The House</span>
00273 <span class="comment">INPUT:  EventList &amp;eventList - This is the event list to sample</span>
00274 <span class="comment">INPUT:  int timeTagIncremebt - The calculated number of time tags per</span>
00275 <span class="comment">communication window so that the average event buffer size will be at</span>
00276 <span class="comment">least 100.</span>
00277 <span class="comment">*/</span>
00278 
00279 
00280 <span class="keywordtype">void</span> AlgorithmSimulation::collectDistribute(House &amp;house, 
00281                                             <a class="code" href="classEventList.html">EventList</a>&amp; eventList, <span class="keywordtype">int</span> timeStampIncrement, <span class="keywordtype">float</span> count_factor)
00282 {
00283   <span class="keywordtype">float</span> poidev(<span class="keywordtype">float</span>, <span class="keywordtype">int</span> *);
00284 
00285   <span class="comment">// get needed singleton objects</span>
00286   <a class="code" href="classFrameInfo.html">FrameInfo</a>&amp; fi = house.getFrameInfo();
00287   <a class="code" href="classMOLAR.html">MOLAR</a> &amp;molar = *<a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00288   Status &amp;status = *Status::getStatus();
00289   Params &amp;params = *Params::getInstance();
00290 
00291   <span class="comment">// First, broadcast the array of singles packets</span>
00292   house.bcastSinglesPackets();
00293 
00294   <span class="keywordtype">int</span> frameStopTimeTag = fi.<a class="code" href="classFrameInfo.html#o15">frameStartTimeTag</a> + fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>;
00295 
00296   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> realiz=0;realiz&lt;params.algorithm.numRealizations;realiz++){
00297     <span class="keywordflow">if</span>(realiz % status.numProcs == status.proc)
00298       house.prepareOutput(realiz);
00299   }
00300   
00301   <a class="code" href="classEventPacket.html">EventPacket</a> sentry = eventList.<a class="code" href="classEventList.html#a6">getSentry</a>(); <span class="comment">//prepare for sentry</span>
00302   <span class="keywordtype">int</span> count = 0, countSend=0, countRecv=0, countPut=0, countGlobal;
00303   <span class="keywordtype">int</span> countCopy =0, countSampling = 0, countPutGlobal;
00304   status.subset=0;<span class="comment">//one subset for simulation</span>
00305   <a class="code" href="classEventPacket.html">EventPacket</a> event = eventList.<a class="code" href="classEventList.html#a3">getFirst</a>(status.subset); 
00306 
00307   <span class="keywordtype">int</span> iprint=0; <span class="comment">// flag to print</span>
00308   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> timeStamp = fi.<a class="code" href="classFrameInfo.html#o15">frameStartTimeTag</a>; timeStamp &lt;=frameStopTimeTag;
00309        timeStamp += timeStampIncrement){
00310     <span class="keywordflow">if</span>(event==sentry)<span class="keywordflow">break</span>;
00311     <span class="comment">// Declare and instantiate the EventBuffer</span>
00312     <a class="code" href="classEventBuffer.html">EventBuffer</a> sendEventBuffer(params.algorithm.numRealizations);
00313     
00314     <span class="comment">// Calculate the probability of zero for current event.  We use</span>
00315     <span class="comment">// this value in sampling, to determine whether or not to accept</span>
00316     <span class="comment">// the event.</span>
00317     <span class="comment">// We need to convert from units of cps to counts.</span>
00318     <span class="comment">//float P0 = -9.9e30;</span>
00319     <span class="keywordflow">while</span>(event.<a class="code" href="classEventPacket.html#o20">timeStamp</a> &lt; (timeStamp + timeStampIncrement) 
00320           &amp;&amp;event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>&gt;=timeStamp  &amp;&amp;!( event==sentry)){
00321       <span class="keywordtype">float</span> expected = event.<a class="code" href="classEventPacket.html#o18">yhat</a>*count_factor + (event.<a class="code" href="classEventPacket.html#o8">rand</a>+event.<a class="code" href="classEventPacket.html#o11">scatter</a>)*fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>/1000;
00322       <span class="keywordtype">int</span> groups = floor(expected/0.1);
00323       <span class="keywordtype">float</span> rest = expected-(groups*0.1);
00324       <span class="comment">//float P0 = exp(-expected); </span>
00325      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> realiz = 0; realiz&lt;params.algorithm.numRealizations;realiz++){
00326        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> n=0;n&lt;groups;n++){
00327         <span class="keywordtype">float</span> frand = (<span class="keywordtype">float</span>)rand()/(<span class="keywordtype">float</span>)RAND_MAX;
00328         <span class="comment">//if(frand &gt; P0){</span>
00329         <span class="keywordflow">if</span>(frand &lt; 0.1){
00330           <span class="comment">//float y=poidev(expected, &amp;status.seed);</span>
00331           <span class="comment">//event.numEvents = (int) y;</span>
00332           <span class="comment">//if(event.numEvents&gt;0){</span>
00333           sendEventBuffer.<a class="code" href="classEventBuffer.html#a3">appendResizable</a>(realiz,event);
00334           count++; 
00335         }
00336        }
00337        <span class="keywordflow">if</span> (rest != 0) {
00338         <span class="keywordtype">float</span> frand = (<span class="keywordtype">float</span>)rand()/(<span class="keywordtype">float</span>)RAND_MAX;
00339         <span class="comment">//if(frand &gt; P0){</span>
00340         <span class="keywordflow">if</span>(frand &lt; rest){
00341           <span class="comment">//float y=poidev(expected, &amp;status.seed);</span>
00342           <span class="comment">//event.numEvents = (int) y;</span>
00343           <span class="comment">//if(event.numEvents&gt;0){</span>
00344           sendEventBuffer.<a class="code" href="classEventBuffer.html#a3">appendResizable</a>(realiz,event);
00345           count++; 
00346         }       
00347        }
00348       }
00349       event = eventList.<a class="code" href="classEventList.html#a4">getNext</a>(status.subset);
00350       
00351     };
00352     <span class="comment">// 2007-05-03 - limit output </span>
00353     <span class="comment">// verbosity </span>
00354     <span class="comment">// 4 means all nodes every 10th output</span>
00355     <span class="comment">// 3 means node 0 every 10th output</span>
00356     <span class="comment">// 2 means node 0 every 100th output  </span>
00357     iprint++;
00358     <span class="keywordflow">if</span>((params.frame.verbosity&gt;=2) &amp;&amp; (iprint %10 == 0)){
00359       <span class="keywordflow">if</span> ((params.frame.verbosity&gt;=4)|| ((params.frame.verbosity==3) &amp;&amp; (status.proc ==0) )
00360         || ((params.frame.verbosity==2) &amp;&amp; (status.proc == 0) &amp;&amp; (iprint %100 ==0))) {
00361        cout&lt;&lt;<span class="stringliteral">"On proc "</span>&lt;&lt;status.proc&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;count
00362           &lt;&lt;<span class="stringliteral">" events appended to the send buffer by timestamp "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>&lt;&lt;endl;
00363         }
00364     }
00365     MPI::COMM_WORLD.Allreduce(&amp;count,&amp;countGlobal,1,MPI::INT,MPI::SUM);
00366     
00367     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> realiz = 0; realiz &lt; params.algorithm.numRealizations; realiz++){
00368       <span class="keywordflow">if</span>((realiz % status.numProcs)!=status.proc){
00369         <span class="comment">// Send buffer number 'realiz' to processor realiz%numProcs</span>
00370         <span class="comment">// and give it a tag realiz</span>
00371         sendEventBuffer.<a class="code" href="classEventBuffer.html#a15">sendTagged</a>(realiz,realiz%status.numProcs,realiz);
00372         countSend++;
00373 
00374 
00375       }
00376       <span class="keywordflow">if</span>(realiz % status.numProcs == status.proc){ <span class="comment">// My realization, so receive it</span>
00377         
00378         <span class="comment">// Declare and instantiate the receive event buffer</span>
00379         <span class="comment">// The reason we have to declare in such a nested fashion</span>
00380         <span class="comment">// is that the recvEventBuffer is only good for one realization</span>
00381         <a class="code" href="classEventBuffer.html">EventBuffer</a> recvEventBuffer(status.numProcs);
00382         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> source=0; source &lt;status.numProcs;source++){
00383           <span class="keywordflow">if</span>(source==status.proc){
00384             <span class="comment">// We do this instead of sending to self.  Note that</span>
00385             <span class="comment">// recvEventBuffer is the destination but that sendEventBuffer</span>
00386             <span class="comment">// is the source.</span>
00387             recvEventBuffer.<a class="code" href="classEventBuffer.html#a14">copy</a>(status.proc,sendEventBuffer,realiz);
00388             countCopy++;
00389           }
00390           <span class="keywordflow">else</span>{ <span class="comment">// We have already taken care of</span>
00391             <span class="comment">// copying the buffer over in the</span>
00392             <span class="comment">// case of source==dest</span>
00393             <span class="comment">// Do a "probed" receive into receive buffer number</span>
00394             <span class="comment">// "source", from processor "source", with tag "realiz"</span>
00395             recvEventBuffer.<a class="code" href="classEventBuffer.html#a16">recvProbed</a>(source,source,realiz);
00396             <span class="comment">//cout&lt;&lt;"Proc "&lt;&lt;status.proc&lt;&lt;" receiving buffer from "&lt;&lt;</span>
00397             <span class="comment">//source&lt;&lt;endl;</span>
00398             countRecv++;
00399           }
00400         }
00401         <span class="comment">// Now that we have received the event buffers, write out</span>
00402         <span class="comment">// the events, by time stamp</span>
00403         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ts=timeStamp;ts&lt;timeStamp+timeStampIncrement;ts++){
00404           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> source=0;source&lt;status.numProcs;source++){
00405             <span class="keywordflow">while</span>(recvEventBuffer.<a class="code" href="classEventBuffer.html#a10">hasMoreEvents</a>(source) &amp;&amp; 
00406                   (recvEventBuffer.<a class="code" href="classEventBuffer.html#a9">peekAhead</a>(source).<a class="code" href="classEventPacket.html#o20">timeStamp</a>==ts)){
00407               <a class="code" href="classEventPacket.html">EventPacket</a> e = recvEventBuffer.<a class="code" href="classEventBuffer.html#a8">getNextCopy</a>(source);
00408               <span class="keywordflow">if</span>(e==sentry){
00409                 cout&lt;&lt;<span class="stringliteral">"Sentry received "</span>&lt;&lt;endl;
00410                 <span class="keywordflow">break</span>;
00411               }
00412               <span class="comment">// Now we put this event in the appropriate realization file</span>
00413               house.putNextEvent(e,realiz);
00414               countPut++;
00415             }
00416           }
00417         }
00418         <span class="keywordflow">if</span>((params.frame.verbosity&gt;=2) &amp;&amp; (iprint %10 == 0)){
00419           <span class="keywordflow">if</span>((params.frame.verbosity&gt;=4) || (params.frame.verbosity==3 &amp;&amp; status.proc ==0 )
00420             || (params.frame.verbosity == 2 &amp;&amp; status.proc == 0 &amp;&amp; (iprint % 100 ==0))) {
00421             cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status.proc&lt;&lt;<span class="stringliteral">" at timeStamp "</span>&lt;&lt;timeStamp&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;countPut
00422                 &lt;&lt;<span class="stringliteral">" events outputted "</span>&lt;&lt;endl;
00423           }
00424         }
00425            
00426      }  <span class="comment">// this realization belongs to this node</span>
00427     }   <span class="comment">// realization nloop</span>
00428     <span class="comment">// All processors need to wait here until the others complete</span>
00429     MPI::COMM_WORLD.Barrier();
00430    
00431   }     <span class="comment">// next time stamp group</span>
00432   <span class="keywordflow">if</span> (params.frame.verbosity&gt;=4) 
00433    cout&lt;&lt;<span class="stringliteral">"processor "</span>&lt;&lt;status.proc&lt;&lt;<span class="stringliteral">" completed the simulations"</span>&lt;&lt;endl;
00434   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> realiz=0;realiz&lt;params.algorithm.numRealizations;realiz++){
00435     <span class="keywordflow">if</span>(realiz%status.numProcs == status.proc) house.finalizeOutput(realiz);
00436   }
00437 }
00438 
00439           
00440 <span class="keywordtype">float</span> poidev(<span class="keywordtype">float</span> xm,<span class="keywordtype">int</span> *idum)
00441 {
00442         <span class="keyword">static</span> <span class="keywordtype">float</span> sq,alxm,g,oldm=(-1.0);
00443         <span class="keywordtype">float</span> em,t,y;
00444         <span class="keywordtype">float</span> ran1(<span class="keywordtype">int</span> *idum);
00445         <span class="keywordtype">float</span> gammln(<span class="keywordtype">float</span> xx);
00446         <span class="keywordflow">if</span> (xm &lt; 12.0) {
00447                 <span class="keywordflow">if</span> (xm != oldm) {
00448                         oldm=xm;
00449                         g=exp(-xm);
00450                 }
00451                 em = -1;
00452                 t=1.0;
00453                 <span class="keywordflow">do</span> {
00454                         em += 1.0;
00455                         t *= ran1(idum);
00456                 } <span class="keywordflow">while</span> (t &gt; g);
00457         } <span class="keywordflow">else</span> {
00458                 <span class="keywordflow">if</span> (xm != oldm) {
00459                         oldm=xm;
00460                         sq=sqrt(2.0*xm);
00461                         alxm=log(xm);
00462                         g=xm*alxm-gammln(xm+1.0);
00463                 }
00464                 <span class="keywordflow">do</span> {
00465                         <span class="keywordflow">do</span> {
00466                                 y=tan(PI*ran1(idum));
00467                                 em=sq*y+xm;
00468                         } <span class="keywordflow">while</span> (em &lt; 0.0);
00469                         em=floor(em);
00470                         t=0.9*(1.0+y*y)*exp(em*alxm-gammln(em+1.0)-g);
00471                 } <span class="keywordflow">while</span> (ran1(idum) &gt; t);
00472         }
00473         <span class="keywordflow">return</span> em;
00474 }
00475 
00476 
00477 
00478 <span class="keywordtype">float</span> gammln(<span class="keywordtype">float</span> xx)
00479 {
00480         <span class="keywordtype">double</span> x,tmp,ser;
00481         <span class="keyword">static</span> <span class="keywordtype">double</span> cof[6]={76.18009173,-86.50532033,24.01409822,
00482                 -1.231739516,0.120858003e-2,-0.536382e-5};
00483         <span class="keywordtype">int</span> j;
00484 
00485         x=xx-1.0;
00486         tmp=x+5.5;
00487         tmp -= (x+0.5)*log(tmp);
00488         ser=1.0;
00489         <span class="keywordflow">for</span> (j=0;j&lt;=5;j++) {
00490                 x += 1.0;
00491                 ser += cof[j]/x;
00492         }
00493         <span class="keywordflow">return</span> -tmp+log(2.50662827465*ser);
00494 }
00495 
00496 
00497 
00498 <span class="keywordtype">float</span> ran1(<span class="keywordtype">int</span> *idum)
00499 {
00500         <span class="keyword">static</span> <span class="keywordtype">long</span> ix1,ix2,ix3;
00501         <span class="keyword">static</span> <span class="keywordtype">float</span> r[98];
00502         <span class="keywordtype">float</span> temp;
00503         <span class="keyword">static</span> <span class="keywordtype">int</span> iff=0;
00504         <span class="keywordtype">int</span> j;
00505         <span class="keywordtype">void</span> nrerror(<span class="keywordtype">char</span> error_text[]);
00506 
00507         <span class="keywordflow">if</span> (*idum &lt; 0 || iff == 0) {
00508                 iff=1;
00509                 ix1=(IC1-(*idum)) % M1;
00510                 ix1=(IA1*ix1+IC1) % M1;
00511                 ix2=ix1 % M2;
00512                 ix1=(IA1*ix1+IC1) % M1;
00513                 ix3=ix1 % M3;
00514                 <span class="keywordflow">for</span> (j=1;j&lt;=97;j++) {
00515                         ix1=(IA1*ix1+IC1) % M1;
00516                         ix2=(IA2*ix2+IC2) % M2;
00517                         r[j]=(ix1+ix2*RM2)*RM1;
00518                 }
00519                 *idum=1;
00520         }
00521         ix1=(IA1*ix1+IC1) % M1;
00522         ix2=(IA2*ix2+IC2) % M2;
00523         ix3=(IA3*ix3+IC3) % M3;
00524         j=1 + ((97*ix3)/M3);
00525         <span class="keywordflow">if</span> (j &gt; 97 || j &lt; 1) nrerror(<span class="stringliteral">"RAN1: This cannot happen."</span>);
00526         temp=r[j];
00527         r[j]=(ix1+ix2*RM2)*RM1;
00528         <span class="keywordflow">return</span> temp;
00529 }
00530 
00531 
00532 <span class="keywordtype">void</span> nrerror(<span class="keywordtype">char</span> error_text[])
00533 <span class="comment">/* Numerical Recipes standard error handler */</span>
00534 {
00535         fprintf(stderr,<span class="stringliteral">"Numerical Recipes run-time error...\n"</span>);
00536         fprintf(stderr,<span class="stringliteral">"%s\n"</span>,error_text);
00537         fprintf(stderr,<span class="stringliteral">"...now exiting to system...\n"</span>);
00538         exit(1);
00539 }
00540 
00541 
00542 
00543 
00544 
00545 
00546 
00547 <span class="keywordtype">float</span> gasdev(<span class="keywordtype">int</span> *idum)
00548 {
00549         <span class="keyword">static</span> <span class="keywordtype">int</span> iset=0;
00550         <span class="keyword">static</span> <span class="keywordtype">float</span> gset;
00551         <span class="keywordtype">float</span> fac,r,v1,v2;
00552         <span class="keywordtype">float</span> ran1(<span class="keywordtype">int</span> *idum);
00553         <span class="keywordflow">if</span>  (iset == 0) {
00554                 <span class="keywordflow">do</span> {
00555                         v1=2.0*ran1(idum)-1.0;
00556                         v2=2.0*ran1(idum)-1.0;
00557                         r=v1*v1+v2*v2;
00558                 } <span class="keywordflow">while</span> (r &gt;= 1.0);
00559                 fac=sqrt(-2.0*log(r)/r);
00560                 gset=v1*fac;
00561                 iset=1;
00562                 <span class="keywordflow">return</span> v2*fac;
00563         } <span class="keywordflow">else</span> {
00564                 iset=0;
00565                 <span class="keywordflow">return</span> gset;
00566         }
00567 }
00568 
00569 
00570 <span class="keywordtype">float</span> erff(<span class="keywordtype">float</span> x)
00571 {
00572         <span class="keywordtype">float</span> gammp(<span class="keywordtype">float</span> a, <span class="keywordtype">float</span> x);
00573 
00574         <span class="keywordflow">return</span> x &lt; 0.0 ? -gammp(0.5,x*x) : gammp(0.5,x*x);
00575 }
00576 
00577 
00578 <span class="keywordtype">float</span> gammp(<span class="keywordtype">float</span> a, <span class="keywordtype">float</span> x)
00579 {
00580         <span class="keywordtype">void</span> gcf(<span class="keywordtype">float</span> *gammcf, <span class="keywordtype">float</span> a, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> *gln);
00581         <span class="keywordtype">void</span> gser(<span class="keywordtype">float</span> *gamser, <span class="keywordtype">float</span> a, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> *gln);
00582         <span class="keywordtype">void</span> nrerror(<span class="keywordtype">char</span> error_text[]);
00583         <span class="keywordtype">float</span> gamser,gammcf,gln;
00584 
00585         <span class="keywordflow">if</span> (x &lt; 0.0 || a &lt;= 0.0) nrerror(<span class="stringliteral">"Invalid arguments in routine gammp"</span>);
00586         <span class="keywordflow">if</span> (x &lt; (a+1.0)) {
00587                 gser(&amp;gamser,a,x,&amp;gln);
00588                 <span class="keywordflow">return</span> gamser;
00589         } <span class="keywordflow">else</span> {
00590                 gcf(&amp;gammcf,a,x,&amp;gln);
00591                 <span class="keywordflow">return</span> 1.0-gammcf;
00592         }
00593 }
00594 
00595 <span class="keywordtype">void</span> gser(<span class="keywordtype">float</span> *gamser, <span class="keywordtype">float</span> a, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> *gln)
00596 {
00597         <span class="keywordtype">float</span> gammln(<span class="keywordtype">float</span>);
00598         <span class="keywordtype">void</span> nrerror(<span class="keywordtype">char</span> error_text[]);
00599         <span class="keywordtype">int</span> n;
00600         <span class="keywordtype">float</span> sum,del,ap;
00601 
00602         *gln=gammln(a);
00603         <span class="keywordflow">if</span> (x &lt;= 0.0) {
00604                 <span class="keywordflow">if</span> (x &lt; 0.0) nrerror(<span class="stringliteral">"x less than 0 in routine gser"</span>);
00605                 *gamser=0.0;
00606                 <span class="keywordflow">return</span>;
00607         } <span class="keywordflow">else</span> {
00608                 ap=a;
00609                 del=sum=1.0/a;
00610                 <span class="keywordflow">for</span> (n=1;n&lt;=ITMAX;n++) {
00611                         ++ap;
00612                         del *= x/ap;
00613                         sum += del;
00614                         <span class="keywordflow">if</span> (fabs(del) &lt; fabs(sum)*EPS) {
00615                                 *gamser=sum*exp(-x+a*log(x)-(*gln));
00616                                 <span class="keywordflow">return</span>;
00617                         }
00618                 }
00619                 nrerror(<span class="stringliteral">"a too large, ITMAX too small in routine gser"</span>);
00620                 <span class="keywordflow">return</span>;
00621         }
00622 }
00623 
00624 <span class="keywordtype">void</span> gcf(<span class="keywordtype">float</span> *gammcf, <span class="keywordtype">float</span> a, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> *gln)
00625 {
00626         <span class="keywordtype">float</span> gammln(<span class="keywordtype">float</span>);
00627         <span class="keywordtype">void</span> nrerror(<span class="keywordtype">char</span> error_text[]);
00628         <span class="keywordtype">int</span> i;
00629         <span class="keywordtype">float</span> an,b,c,d,del,h;
00630 
00631         *gln=gammln(a);
00632         b=x+1.0-a;
00633         c=1.0/FPMIN;
00634         d=1.0/b;
00635         h=d;
00636         <span class="keywordflow">for</span> (i=1;i&lt;=ITMAX;i++) {
00637                 an = -i*(i-a);
00638                 b += 2.0;
00639                 d=an*d+b;
00640                 <span class="keywordflow">if</span> (fabs(d) &lt; FPMIN) d=FPMIN;
00641                 c=b+an/c;
00642                 <span class="keywordflow">if</span> (fabs(c) &lt; FPMIN) c=FPMIN;
00643                 d=1.0/d;
00644                 del=d*c;
00645                 h *= del;
00646                 <span class="keywordflow">if</span> (fabs(del-1.0) &lt; EPS) <span class="keywordflow">break</span>;
00647         }
00648         <span class="keywordflow">if</span> (i &gt; ITMAX) nrerror(<span class="stringliteral">"a too large, ITMAX too small in gcf"</span>);
00649         *gammcf=exp(-x+a*log(x)-(*gln))*h;
00650 }
00651 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:46 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
