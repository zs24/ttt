<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: ResolutionFunction.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>ResolutionFunction.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "ResolutionFunction.hpp"</span>
00002 
00003 <span class="comment">//return calculated resolution functions on transaxial direction</span>
<a name="l00004"></a><a class="code" href="classResolutionFunction.html#a6">00004</a> <a class="code" href="structResolutionTable.html">ResolutionTable</a> * <a class="code" href="classResolutionFunction.html#a6">ResolutionFunction::getResFunR</a>()
00005 {
00006   <span class="keywordflow">return</span> resFunR;
00007 }
00008 
00009 <span class="comment">//return calculated resolution functions on axial direction</span>
<a name="l00010"></a><a class="code" href="classResolutionFunction.html#a7">00010</a> <a class="code" href="structResolutionTable.html">ResolutionTable</a> * <a class="code" href="classResolutionFunction.html#a7">ResolutionFunction::getResFunU</a>()
00011 {
00012   <span class="keywordflow">return</span> resFunU;
00013 }
00014 
00015 <span class="comment">//get index of resolution functions on transaxial direction</span>
<a name="l00016"></a><a class="code" href="classResolutionFunction.html#a8">00016</a> <a class="code" href="classArray3D.html">Array3D&lt;short&gt;</a> &amp; <a class="code" href="classResolutionFunction.html#a8">ResolutionFunction::getCodeIndexR</a>()
00017 {
00018   <span class="keywordflow">return</span> codeIndexR;
00019 }
00020 
00021 <span class="comment">//get index of resolution functions on axial direction</span>
<a name="l00022"></a><a class="code" href="classResolutionFunction.html#a9">00022</a> Array2D&lt;short&gt; &amp; <a class="code" href="classResolutionFunction.html#a9">ResolutionFunction::getCodeIndexU</a>()
00023 {
00024   <span class="keywordflow">return</span> codeIndexU;
00025 }
00026 
00027 
00028 <span class="comment">//calculate FWHM on transaxial direction</span>
<a name="l00029"></a><a class="code" href="classResolutionFunction.html#a0">00029</a> <span class="keywordtype">void</span> <a class="code" href="classResolutionFunction.html#a0">ResolutionFunction::calculateFWHMR</a>(Params &amp; params,
00030                                         <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner)
00031 {
00032   <span class="comment">//define scanner related parameters</span>
00033   <span class="keyword">const</span> <span class="keywordtype">int</span> nLayerSquare = POW2(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>);  <span class="comment">//layers</span>
00034   <span class="keyword">const</span> <span class="keywordtype">int</span> nDtctDouble = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>*2;
00035     <span class="comment">//lors between 2 detector  banks.</span>
00036   <span class="keyword">const</span> <span class="keywordtype">int</span> nCoincidence = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o10">coincidence</a>; 
00037   <span class="comment">//banks where the 2 detectors in coincidence are located</span>
00038   <span class="keywordtype">float</span> bankEffectEnable[5] = {1.2, 1.1, 1.0, 1.1, 1.2}; 
00039   <span class="comment">//bank effect when params.resolutionmodel.</span>
00040   <span class="comment">//detectorobliquness is set</span>
00041   <span class="keywordtype">float</span> bankEffectDisable[5] = {1.0, 1.0, 1.0, 1.0, 1.0};
00042   <span class="keywordtype">float</span> *bankEffect;
00043   <span class="keywordtype">float</span> layerEffectEnable[] = {1.0, 1.1, 1.1, 1.21}; 
00044   <span class="comment">//layer effect when params.resolutionmodel.layer is set</span>
00045   <span class="keywordtype">float</span> layerEffectDisable[] = {1.0, 1.0, 1.0, 1.0}; <span class="comment">//</span>
00046   <span class="keywordtype">float</span> *layerEffect;
00047   <span class="keywordtype">float</span> *positionEffect = <span class="keyword">new</span> <span class="keywordtype">float</span> [scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>]; 
00048   <span class="comment">//position effect</span>
00049 
00050   <span class="comment">//determine the scanner related parameters according to </span>
00051   <span class="comment">//the usr's setting</span>
00052   <span class="keywordflow">if</span> (params.resolutionModel.detectorObliqueness)  
00053     <span class="comment">//if detectorObliqueness is set</span>
00054     bankEffect = bankEffectEnable;
00055   <span class="keywordflow">else</span>                                                                          <span class="comment">//otherwise</span>
00056     bankEffect = bankEffectDisable;
00057   <span class="keywordflow">if</span> (params.resolutionModel.crystalPosition)  
00058     <span class="comment">//if crystalPosition set</span>
00059     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i= 0; i&lt; scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>; i++)
00060       positionEffect[i] = 1.0 + 0.005*(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>/2.0-
00061                                        fabs(i-scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>/2.0));
00062   <span class="keywordflow">else</span>                                                                          <span class="comment">//otherwise</span>
00063     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>; i++)
00064       positionEffect[i]= 1.0;
00065   <span class="keywordflow">if</span> (params.resolutionModel.layer)  <span class="comment">//if layer effect is set</span>
00066     layerEffect = layerEffectEnable;
00067   <span class="keywordflow">else</span>                                                          <span class="comment">//otherwise</span>
00068     layerEffect = layerEffectDisable;
00069                 
00070   efwhmR.<a class="code" href="classArray3D.html#a8">init</a>(nLayerSquare, nDtctDouble/2, nCoincidence); 
00071     <span class="comment">//full width with half maximum for resFunR</span>
00072   <span class="comment">//calculate FWHM for all indices</span>
00073   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; nLayerSquare; i++) <span class="comment">//first loop, 0 to layers</span>
00074     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o10">coincidence</a>; k++) 
00075         <span class="comment">//second loop, 0 to bank coincidence,</span>
00076       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>; j++) 
00077          <span class="comment">//third loop, 0 to number detectors in tranxial direction</span>
00078         efwhmR(i,j,k) = params.resolutionModel.FWHM*
00079           bankEffect[k]*positionEffect[j]*layerEffect[i];
00080   <span class="comment">//get max and min of FWHM</span>
00081   <span class="keywordtype">float</span> efwhmMax = efwhmR.<a class="code" href="classArray3D.html#a15">max</a>();
00082   <span class="keywordtype">float</span> efwhmMin = efwhmR.<a class="code" href="classArray3D.html#a16">min</a>();
00083   <span class="comment">//get number of index between min and max with sampling </span>
00084   <span class="comment">//distance RES_FUN_SAMPLING</span>
00085   numResTableR = floor((efwhmMax-efwhmMin)/
00086                        Constant::RES_FUN_SAMPLING)+1;
00087   resFunR = <span class="keyword">new</span> <a class="code" href="structResolutionTable.html">ResolutionTable</a>[numResTableR];
00088   <span class="comment">//calculate fwhmR after resampling</span>
00089   fwhmR.<a class="code" href="classArray1D.html#a8">init</a>(numResTableR);
00090   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iFWHM = 0; iFWHM&lt; numResTableR; iFWHM ++)
00091     fwhmR(iFWHM) = efwhmMin+ iFWHM*Constant::RES_FUN_SAMPLING;
00092   codeIndexR.<a class="code" href="classArray3D.html#a8">init</a>(POW2(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>),scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>*2,
00093                   scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o10">coincidence</a>); <span class="comment">//index of resFunR</span>
00094 
00095   <span class="keyword">delete</span> positionEffect;
00096 }
00097 
00098 <span class="comment">//calculate FWHM on axial direction</span>
<a name="l00099"></a><a class="code" href="classResolutionFunction.html#a1">00099</a> <span class="keywordtype">void</span> <a class="code" href="classResolutionFunction.html#a1">ResolutionFunction::calculateFWHMU</a>(Params &amp; params,
00100                                         <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner)
00101 {
00102   <span class="comment">//define scanner related parameters</span>
00103   <span class="keyword">const</span> <span class="keywordtype">int</span> nLayerSquare = POW2(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>);  <span class="comment">//layers</span>
00104   <span class="keywordtype">float</span> layerEffectEnable[] = {1.0, 1.1, 1.1, 1.21}; <span class="comment">//layer effect when params.resolutionmodel.layer is set</span>
00105   <span class="keywordtype">float</span> layerEffectDisable[] = {1.0, 1.0, 1.0, 1.0}; <span class="comment">//</span>
00106   <span class="keywordtype">float</span> *layerEffect;
00107   <span class="keywordtype">float</span> *positionEffect = <span class="keyword">new</span> <span class="keywordtype">float</span> [scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>]; <span class="comment">//position effect</span>
00108 
00109   <span class="comment">//determine the scanner related parameters according to </span>
00110   <span class="comment">//the usr's setting</span>
00111   <span class="keywordflow">if</span> (params.resolutionModel.crystalPosition) <span class="comment">//if crystalPosition set</span>
00112     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =0; i&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>; i++)
00113       positionEffect[i] = 1.0 + 0.005*(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>/2.0-
00114                                        fabs(i-scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>/2.0));
00115   <span class="keywordflow">else</span>                                                                  <span class="comment">//otherwise</span>
00116     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =0; i&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>; i++)
00117       positionEffect[i] = 1.0;
00118   <span class="keywordflow">if</span> (params.resolutionModel.layer)  <span class="comment">//if layer effect is set</span>
00119     layerEffect = layerEffectEnable;
00120   <span class="keywordflow">else</span><span class="comment">//otherwise</span>
00121     layerEffect = layerEffectDisable;
00122         
00123   efwhmU.init(nLayerSquare,scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>); 
00124   <span class="comment">//full width with half maximum for resFunU    </span>
00125   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nLayerSquare; i++)  <span class="comment">//layer</span>
00126     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>; j++) <span class="comment">//ring</span>
00127       efwhmU(i,j) = params.resolutionModel.FWHM*positionEffect[j]
00128         *layerEffect[i];
00129   <span class="comment">//min and max of FWHM</span>
00130   <span class="keywordtype">float</span> efwhmMax = efwhmU.max();
00131   <span class="keywordtype">float</span> efwhmMin = efwhmU.min();
00132   <span class="comment">//index number of resFunU</span>
00133   numResTableU = floor((efwhmMax-efwhmMin)/Constant::RES_FUN_SAMPLING)+1;<span class="comment">//</span>
00134   resFunU = <span class="keyword">new</span> <a class="code" href="structResolutionTable.html">ResolutionTable</a> [numResTableU]; <span class="comment">//allocate memory</span>
00135   assert(resFunU!=0);
00136   fwhmU.<a class="code" href="classArray1D.html#a8">init</a>(numResTableU);
00137   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iFWHM = 0; iFWHM&lt; numResTableU; iFWHM ++)
00138     fwhmU(iFWHM) = efwhmMin+ iFWHM*Constant::RES_FUN_SAMPLING;
00139   codeIndexU.init(POW2(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>),scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>*2); 
00140   <span class="comment">//full width with half maximum for resFunU</span>
00141 
00142   <span class="keyword">delete</span> positionEffect;
00143 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:48 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
