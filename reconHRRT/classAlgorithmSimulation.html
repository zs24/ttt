<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: AlgorithmSimulation class Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>AlgorithmSimulation Class Reference</h1><code>#include &lt;<a class="el" href="AlgorithmSimulation_8hpp-source.html">AlgorithmSimulation.hpp</a>&gt;</code>
<p>
<p>Inheritance diagram for AlgorithmSimulation:
<p><center><img src="classAlgorithmSimulation.png" usemap="#AlgorithmSimulation_map" border="0" alt=""></center>
<map name="AlgorithmSimulation_map">
<area href="classAlgorithm.html" alt="Algorithm" shape="rect" coords="0,0,122,24">
</map>
<a href="classAlgorithmSimulation-members.html">List of all members.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>void&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classAlgorithmSimulation.html#a0">reconstruct</a> (<a class="el" href="classImage.html">Image</a> &amp;lambda, <a class="el" href="classImage.html">Image</a> &amp;Q, <a class="el" href="classImage.html">Image</a> &amp;mu, House *house, <a class="el" href="classEventList.html">EventList</a> &amp;eventList, Params &amp;params, <a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;lambdaMask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>float&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classAlgorithmSimulation.html#a1">oneIteration</a> (<a class="el" href="classImage.html">Image</a> &amp;lambda, <a class="el" href="classImage.html">Image</a> &amp;Q, <a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;lambdaMask, House *house, <a class="el" href="classEventList.html">EventList</a> &amp;eventList, Params &amp;params)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="anchor" name="a2" doxytag="AlgorithmSimulation::collectDistribute" ></a>
void&nbsp;</td><td class="memItemRight" valign=bottom><b>collectDistribute</b> (House &amp;house, <a class="el" href="classEventList.html">EventList</a> &amp;eventList, int, float)</td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This class is a sub class of the <a class="el" href="classAlgorithm.html">Algorithm</a> class It implements the OSEM algorithm 
<p>

<p>
Definition at line <a class="el" href="AlgorithmSimulation_8hpp-source.html#l00012">12</a> of file <a class="el" href="AlgorithmSimulation_8hpp-source.html">AlgorithmSimulation.hpp</a>.<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="a1" doxytag="AlgorithmSimulation::oneIteration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> float AlgorithmSimulation::oneIteration </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>Q</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambdaMask</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>House *&nbsp;</td>
          <td class="mdname" nowrap> <em>house</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classEventList.html">EventList</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>eventList</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>Params &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>params</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This function performs a iteration of the OSEM algorithm <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>lamda</em>&nbsp;</td><td>the lamda image </td></tr>
    <tr><td valign=top><em>Q</em>&nbsp;</td><td>the Q image </td></tr>
    <tr><td valign=top><em>lambdaMask</em>&nbsp;</td><td><a class="el" href="classMask.html">Mask</a> for image voxels to reconstruct </td></tr>
    <tr><td valign=top><em>params</em>&nbsp;</td><td>Instance of Params class, inited from the xml file </td></tr>
    <tr><td valign=top><em>eventlist</em>&nbsp;</td><td>stores the events </td></tr>
    <tr><td valign=top><em>house</em>&nbsp;</td><td>instance of House class, where the events are read in </td></tr>
    <tr><td valign=top><em>params</em>&nbsp;</td><td>Instance of Params class </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>log likehood </dd></dl>
    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="AlgorithmSimulation::reconstruct" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> void AlgorithmSimulation::reconstruct </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambda</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>Q</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classImage.html">Image</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>mu</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>House *&nbsp;</td>
          <td class="mdname" nowrap> <em>house</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classEventList.html">EventList</a> &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>eventList</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>Params &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>params</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="classArray3D.html">Array3D</a>&lt; char &gt; &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>lambdaMask</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [virtual]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This function is the virtual function for reconstruction The OSEM algorithm overides this function to perform reconstruction <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>lamda</em>&nbsp;</td><td>the lamda image </td></tr>
    <tr><td valign=top><em>mu</em>&nbsp;</td><td>the mu image </td></tr>
    <tr><td valign=top><em>eventlist</em>&nbsp;</td><td>stores the events </td></tr>
    <tr><td valign=top><em>house</em>&nbsp;</td><td>instance of House class, where the events are read in </td></tr>
    <tr><td valign=top><em>params</em>&nbsp;</td><td>Instance of Params class, inited from the xml file </td></tr>
    <tr><td valign=top><em>lambdaMask</em>&nbsp;</td><td>masking image, if the output mask is ture, use it to mask the output image </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>none </dd></dl>

<p>
Implements <a class="el" href="classAlgorithm.html#a2">Algorithm</a>.
<p>
Definition at line <a class="el" href="AlgorithmSimulation_8cpp-source.html#l00068">68</a> of file <a class="el" href="AlgorithmSimulation_8cpp-source.html">AlgorithmSimulation.cpp</a>.
<p>
References <a class="el" href="Utilities_8hpp-source.html#l00106">Utilities::cleanUp()</a>, <a class="el" href="FrameInfo_8hpp-source.html#l00043">FrameInfo::Duration</a>, <a class="el" href="FrameInfo_8hpp-source.html#l00055">FrameInfo::frameStartTimeTag</a>, <a class="el" href="MOLAR_8cpp-source.html#l00771">MOLAR::fwdProjectSolidAngle()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00267">MOLAR::generateSinoGram()</a>, <a class="el" href="EventList_8cpp-source.html#l00331">EventList::getFirst()</a>, <a class="el" href="MOLAR_8cpp-source.html#l00049">MOLAR::getInstance()</a>, <a class="el" href="Log_8hpp-source.html#l00079">Log::getLog()</a>, <a class="el" href="EventList_8cpp-source.html#l00352">EventList::getNext()</a>, <a class="el" href="EventList_8hpp-source.html#l00166">EventList::getNumEvents()</a>, <a class="el" href="MOLAR_8hpp-source.html#l00437">MOLAR::getScatterCorrection()</a>, <a class="el" href="EventList_8cpp-source.html#l00394">EventList::getSentry()</a>, <a class="el" href="EventPacket_8hpp-source.html#l00013">EventPacket::jstart</a>, <a class="el" href="EventPacket_8hpp-source.html#l00013">EventPacket::jstop</a>, <a class="el" href="FrameInfo_8hpp-source.html#l00047">FrameInfo::nAcceptObject</a>, <a class="el" href="FrameInfo_8hpp-source.html#l00045">FrameInfo::nAcceptScanner</a>, <a class="el" href="FrameInfo_8hpp-source.html#l00048">FrameInfo::nRejectObject</a>, <a class="el" href="FrameInfo_8hpp-source.html#l00046">FrameInfo::nRejectScanner</a>, <a class="el" href="Log_8hpp-source.html#l00052">Log::outputMessage()</a>, and <a class="el" href="EventPacket_8hpp-source.html#l00036">EventPacket::yhat</a>.
<p>
<div class="fragment"><pre>00072 {
00073 
00074   <span class="comment">// get needed singleton objects</span>
00075   <a class="code" href="classFrameInfo.html">FrameInfo</a>&amp; fi = house-&gt;getFrameInfo();
00076   <a class="code" href="classMOLAR.html">MOLAR</a>* molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00077   Status *status = Status::getStatus();
00078   <a class="code" href="classLog.html">Log</a> * logg = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00079   <span class="keywordflow">if</span>(status-&gt;proc==0){
00080     stringstream ss;
00081     ss&lt;&lt;<span class="stringliteral">"================================="</span>&lt;&lt;endl;
00082     ss&lt;&lt;<span class="stringliteral">"ALgorithmSimulation"</span>&lt;&lt;endl;
00083     logg-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),ALGORITHM, 0);
00084     string comm=ss.str();
00085     Status::StatusCode code=Status::RUNNING;
00086     status-&gt;update(comm,code);
00087   }
00088 
00089   <span class="comment">// forward Project the attenuation image and calculate Ai</span>
00090   ScatterCorrection *scatterCorrection = molar-&gt;<a class="code" href="classMOLAR.html#a26">getScatterCorrection</a>();
00091   status-&gt;iter = 1;        
00092 
00093   <span class="comment">// There needs to be a separate function 'simulate' in the</span>
00094   <span class="comment">// ScatterCorrection class</span>
00095   <span class="keywordflow">if</span>(params.modelBasedScatter.enable)
00096     scatterCorrection-&gt;update(mu,lambda,eventList); 
00097  
00098   <span class="comment">// forward Project the emission image, calculating the expected value of </span>
00099   <span class="comment">// each event </span>
00100   <span class="comment">// fills in event.yhat with expected count rate</span>
00101   molar-&gt;<a class="code" href="classMOLAR.html#a7">fwdProjectSolidAngle</a>(lambda,params,eventList); 
00102 
00103 
00104 
00105   <span class="comment">// We have now calculated the expected cps for a lot of potential events. </span>
00106   <span class="comment">// Account for undersampling of LORs by determining a scale factor</span>
00107   <span class="comment">//  undersamp_factor to scale up the expected values. This factor is : </span>
00108   <span class="comment">//   numLOR/(fi.naccept+fi.nreject) . </span>
00109   <span class="keywordtype">float</span> undersamp_factor=house-&gt;getTotalPossibleEvents()
00110     /((<span class="keywordtype">float</span>)fi.<a class="code" href="classFrameInfo.html#o5">nAcceptScanner</a> + (<span class="keywordtype">float</span>) fi.<a class="code" href="classFrameInfo.html#o6">nRejectScanner</a>) ;
00111   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00112     cout&lt;&lt;<span class="stringliteral">"Total possible events "</span>&lt;&lt;house-&gt;getTotalPossibleEvents()&lt;&lt;endl;
00113     cout&lt;&lt;<span class="stringliteral">"Total accepted events "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o5">nAcceptScanner</a>&lt;&lt;endl;
00114     cout&lt;&lt;<span class="stringliteral">"Total rejected events "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o6">nRejectScanner</a>&lt;&lt;endl;
00115  
00116     cout&lt;&lt;<span class="stringliteral">"undersamp_factor "</span>&lt;&lt;undersamp_factor&lt;&lt;endl;
00117     cout&lt;&lt;<span class="stringliteral">"Duration "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>&lt;&lt;endl;
00118   }
00119   <span class="comment">// Run through the events and convert cps to the </span>
00120   <span class="comment">// expected number of events per LOR. Correct for undersampling </span>
00121   <span class="comment">// and the scan duration.  </span>
00122   <span class="comment">// Also calculate the highest expected value as a diagnostic</span>
00123  
00124   <span class="keywordtype">float</span> count_factor=undersamp_factor * fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>/1000;
00125   <span class="keywordtype">float</span> yhat_max=0.0;
00126   <span class="keywordtype">double</span> yhat_ave=0.0;
00127   <span class="keywordtype">double</span> numEvents=0;
00128   <a class="code" href="classEventPacket.html">EventPacket</a> sentry = eventList.<a class="code" href="classEventList.html#a6">getSentry</a>(); <span class="comment">//prepare for sentry</span>
00129   <span class="keywordtype">int</span> count = 0;
00130   <span class="keywordflow">if</span>(status-&gt;proc ==0 &amp;&amp; params.frame.verbosity&gt;=2)
00131    cout&lt;&lt;<span class="stringliteral">"Scaling expected values..."</span>&lt;&lt;endl;
00132    
00133   <span class="keywordflow">for</span>(status-&gt;subset=0;status-&gt;subset&lt;
00134         params.algorithm.numSets;status-&gt;subset++){
00135     <a class="code" href="classEventPacket.html">EventPacket</a> event = eventList.<a class="code" href="classEventList.html#a3">getFirst</a>(status-&gt;subset); 
00136     <span class="keywordflow">while</span> (!(event ==sentry ) ) { 
00137       <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o0">jstart</a> &lt;=event.<a class="code" href="classEventPacket.html#o1">jstop</a>){
00138         event.<a class="code" href="classEventPacket.html#o18">yhat</a>  *= count_factor ;  <span class="comment">//  convert to counts</span>
00139         <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o18">yhat</a> &gt; yhat_max) 
00140           yhat_max = event.<a class="code" href="classEventPacket.html#o18">yhat</a>;
00141         yhat_ave += (<span class="keywordtype">double</span>)event.<a class="code" href="classEventPacket.html#o18">yhat</a>;
00142         numEvents += (<span class="keywordtype">double</span>)1;
00143       }
00144       
00145       event = eventList.<a class="code" href="classEventList.html#a4">getNext</a>(status-&gt;subset);
00146       count++;
00147       <span class="keywordflow">if</span>(status-&gt;proc ==0 &amp;&amp; params.frame.verbosity&gt;=2){ 
00148         <span class="keywordflow">if</span>(count%100000==0) 
00149           (cout&lt;&lt;count&lt;&lt;<span class="stringliteral">" events out of "</span> 
00150            &lt;&lt;eventList.<a class="code" href="classEventList.html#a12">getNumEvents</a>(status-&gt;subset)
00151            &lt;&lt;<span class="stringliteral">" scaled"</span>&lt;&lt;endl).flush();
00152         <span class="comment">//      if(event==sentry) (cout&lt;&lt;countT&lt;&lt;endl).flush();</span>
00153       } <span class="comment">//end if</span>
00154  
00155     }
00156   } 
00157   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00158 
00159     cout&lt;&lt;<span class="stringliteral">"Before collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_max is "</span>&lt;&lt;yhat_max&lt;&lt;endl;
00160     cout&lt;&lt;<span class="stringliteral">"Before collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_ave is "</span>&lt;&lt;yhat_ave&lt;&lt;endl;
00161     cout&lt;&lt;<span class="stringliteral">"Before collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" numEvents is "</span>&lt;&lt;numEvents&lt;&lt;endl;
00162   }
00163    
00164 
00165   <span class="keywordtype">float</span> yhatmaxlocal = yhat_max;
00166  
00167   MPI::COMM_WORLD.Allreduce(&amp;yhatmaxlocal,&amp;yhat_max,1,MPI::FLOAT,MPI::MAX);
00168 
00169   <span class="keywordtype">double</span> yhatavelocal = yhat_ave;
00170   MPI::COMM_WORLD.Allreduce(&amp;yhatavelocal,&amp;yhat_ave,1,MPI::DOUBLE,MPI::SUM);
00171   <span class="keywordtype">double</span> numEventslocal = numEvents;
00172   <span class="keywordtype">double</span> numEventsLocal = numEvents;
00173   MPI::COMM_WORLD.Allreduce(&amp;numEventslocal,&amp;numEvents,1,MPI::DOUBLE,MPI::SUM);
00174   <span class="keywordflow">if</span>(numEvents==0){
00175     cout &lt;&lt; <span class="stringliteral">"Error in AlgorithmSimulation::reconstruct(), colleted numEvents "</span>
00176          &lt;&lt; <span class="stringliteral">" is zero, aborting from processor "</span> &lt;&lt; status-&gt;proc &lt;&lt; endl;
00177     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(78);  
00178   }
00179   yhat_ave /= fi.<a class="code" href="classFrameInfo.html#o7">nAcceptObject</a>;
00180   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00181 
00182     cout&lt;&lt;<span class="stringliteral">" frameInfo::nAcceptObject is : "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o7">nAcceptObject</a>&lt;&lt;endl;
00183     cout&lt;&lt;<span class="stringliteral">" frameInfo::nRejectObject is : "</span>&lt;&lt;fi.<a class="code" href="classFrameInfo.html#o8">nRejectObject</a>&lt;&lt;endl;
00184     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_max is "</span>&lt;&lt;yhat_max&lt;&lt;endl;
00185     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_ave is "</span>&lt;&lt;yhat_ave&lt;&lt;endl;
00186     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" numEvents is "</span>&lt;&lt;numEvents&lt;&lt;endl;
00187   }
00188 
00189   <span class="keywordtype">int</span> startTimeTag = fi.<a class="code" href="classFrameInfo.html#o15">frameStartTimeTag</a>;  <span class="comment">// need to add this field</span>
00190   <span class="keywordtype">int</span> stopTimeTag = startTimeTag + fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>;
00191   <span class="comment">// Calculate the average probability that a sample will be accepted.</span>
00192   <span class="comment">//double P1 = exp(-yhat_ave)*yhat_ave;</span>
00193   <span class="comment">//double P1 = 1; //disable sampling</span>
00194   <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5){
00195 
00196     cout&lt;&lt;<span class="stringliteral">"After collection, On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" yhat_ave is "</span>&lt;&lt;yhat_ave&lt;&lt;endl;
00197 
00198     cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">"startTimeTag is "</span>&lt;&lt;startTimeTag&lt;&lt;endl;
00199     cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">"stopTimeTag is "</span>&lt;&lt;stopTimeTag&lt;&lt;endl;
00200     cout&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">"numEventsLocal is "</span>&lt;&lt;numEventsLocal&lt;&lt;endl;
00201   }
00202 
00203   <span class="comment">// Calculate the desired time tag increment, in number of time tags.</span>
00204   <span class="comment">// This criterion determines how many time tags should comprise an</span>
00205   <span class="comment">// event buffer window for the messages going from list-processor to</span>
00206   <span class="comment">// realization -processor.  We want this increment to give us a</span>
00207   <span class="comment">// buffer size that will be at least 100 events, on average.</span>
00208   <span class="comment">// Note that we use the local number of events, since the events are</span>
00209   <span class="comment">// distributed and hence a buffer size criterion needs to take this</span>
00210   <span class="comment">// distribution into consideration.</span>
00211   <span class="comment">// 2007-05-01 - this next line is wrong in the case of low nSimEvents and high yhat_ave</span>
00212   <span class="comment">// I want to scale the number of events in the local buffer by the expected number</span>
00213   <span class="comment">// of counts per LOR = yhat_ave , not time the P(Y=1) = P1 </span>
00214   <span class="comment">//int timeTagIncrement = (int)ceil(100*(stopTimeTag - startTimeTag)/</span>
00215   <span class="comment">//                               (P1 *numEventsLocal));</span>
00216   <span class="keywordtype">int</span> timeTagIncrement = (<span class="keywordtype">int</span>)ceil(100*(stopTimeTag - startTimeTag)/
00217                                    (yhat_ave *numEventsLocal));
00218   <span class="comment">// be sure this is positive</span>
00219   <span class="keywordflow">if</span> (timeTagIncrement &lt;= 0) {
00220    timeTagIncrement = 1;
00221   }
00222   <span class="comment">// Now do a global collect operation to determine the maximum of the</span>
00223   <span class="comment">// calculated time tag increments.</span>
00224 
00225   <span class="keywordtype">int</span> localIncrement = timeTagIncrement;
00226   MPI::COMM_WORLD.Allreduce(&amp;localIncrement,&amp;timeTagIncrement,1,MPI::INT,
00227                             MPI::MAX);
00228                                   
00229 
00230   <span class="comment">// Print diagnostic for simulation code below</span>
00231   <span class="comment">// See comment below for details</span>
00232   <span class="keywordflow">if</span>((status-&gt;proc==0)&amp;&amp;(params.algorithm.verbosity&gt;=2)){
00233     cout&lt;&lt;<span class="stringliteral">"Report from AlgorithmSimulation::reconstruct() perusal of the "</span>
00234         &lt;&lt; <span class="stringliteral">"event list:"</span>&lt;&lt;endl;
00235     cout&lt;&lt;<span class="stringliteral">"Highest expected number of events per simulated LOR: "</span>
00236         &lt;&lt;yhat_max&lt;&lt;endl;
00237     cout&lt;&lt;<span class="stringliteral">"Average expected number of events per simulated LOR: "</span>
00238         &lt;&lt;yhat_ave&lt;&lt;endl;
00239     <span class="comment">//cout&lt;&lt;"Average probability of 1 event : "&lt;&lt;P1&lt;&lt;endl;</span>
00240     cout &lt;&lt;<span class="stringliteral">" Size of collection-distribution window, in number of time stamps: "</span>
00241          &lt;&lt;timeTagIncrement&lt;&lt;endl;
00242   }
00243   <span class="comment">/*if (yhat_max &gt; 0.2) {</span>
00244 <span class="comment">    if(status-&gt;proc==0){</span>
00245 <span class="comment">      cout&lt;&lt;"Fatal error in AlgorithmSimulation::reconstruct()  yhat_max = "</span>
00246 <span class="comment">          &lt;&lt;yhat_max&lt;&lt;endl</span>
00247 <span class="comment">          &lt;&lt;" This exceeds the range where the code is strictly legal"&lt;&lt;endl;</span>
00248 <span class="comment">    }</span>
00249 <span class="comment">    Utilities::cleanUp(-23);</span>
00250 <span class="comment">    }*/</span>
00251 
00252   <span class="keywordflow">if</span> (params.sinogram.enable) 
00253    molar-&gt;<a class="code" href="classMOLAR.html#a17">generateSinoGram</a>(eventList,params,*status);
00254 
00255   time_t time_CollectDis1 = time((time_t *)0);
00256   collectDistribute(*house, eventList, timeTagIncrement, count_factor);
00257   time_t time_CollectDis2 = time((time_t *)0);
00258   <span class="keywordtype">double</span> time_CollectDis = difftime(time_CollectDis2, time_CollectDis1);
00259   <span class="keywordflow">if</span>(params.algorithm.verbosity&gt;=2 &amp;&amp;(status-&gt;proc==0))
00260     cout&lt;&lt;<span class="stringliteral">"collectDistribution required "</span>&lt;&lt;time_CollectDis&lt;&lt;<span class="stringliteral">" sec"</span>&lt;&lt;endl;
00261 
00262 }
</pre></div>    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="AlgorithmSimulation_8hpp-source.html">AlgorithmSimulation.hpp</a><li><a class="el" href="AlgorithmSimulation_8cpp-source.html">AlgorithmSimulation.cpp</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:48 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
