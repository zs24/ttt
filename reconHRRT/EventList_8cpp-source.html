<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: EventList.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>EventList.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "EventList.hpp"</span>
00002 <span class="preprocessor">#include "Status.hpp"</span>
00003 <span class="preprocessor">#include "Log.hpp"</span>
00004 <span class="preprocessor">#include "Constant.hpp"</span>
00005 <span class="preprocessor">#include &lt;assert.h&gt;</span>
00006 <span class="comment">//    3.2  EventList class implementations</span>
00007 
00008 <span class="comment">// constructor; initializes array of numset lists</span>
<a name="l00009"></a><a class="code" href="classEventList.html#a0">00009</a> <a class="code" href="classEventList.html#a0">EventList:: EventList</a> (<span class="keywordtype">int</span> numset)
00010 {
00011   numSet = numset; <span class="comment">//number of subset</span>
00012   firstPtr.<a class="code" href="classArray1D.html#a8">init</a>(numSet);<span class="comment">//pointer to first node</span>
00013   lastPtr.<a class="code" href="classArray1D.html#a8">init</a>(numSet);<span class="comment">//pointer to last node</span>
00014   currentPtr.<a class="code" href="classArray1D.html#a8">init</a>(numSet);<span class="comment">//pointer to current node</span>
00015   sentry = <span class="keyword">new</span> <a class="code" href="classEventListNode.html">EventListNode</a>(NULLEVENT); <span class="comment">//end of the list</span>
00016   cSentry = <span class="keyword">new</span> EventListNode(CURRENTLISTSENTRY);
00017   <span class="comment">//init the pointers</span>
00018   firstPtr = sentry;
00019   lastPtr = sentry;
00020   currentPtr = sentry;
00021   replaced=removed=<span class="keyword">false</span>;
00022 
00023   numEvents.<a class="code" href="classArray1D.html#a8">init</a>(numSet);
00024   portion.<a class="code" href="classArray1D.html#a8">init</a>(numSet);
00025   nPortion.<a class="code" href="classArray1D.html#a8">init</a>(numSet);
00026   numEvents =0;
00027   portion =0;
00028   nPortion = 0;
00029 
00030   <span class="comment">//KW: create directory</span>
00031   <span class="keywordtype">char</span> *templatename=<span class="keyword">new</span> <span class="keywordtype">char</span>[120];
00032   strcpy(templatename, <span class="stringliteral">"/scratch/XXXXXX"</span>);
00033   <span class="keywordtype">char</span> * dname=mkdtemp(templatename);
00034   strcpy(tempDirName,dname+strlen(dname)-6);
00035 }
00036 
00037 <span class="comment">//destructor; destroy array of numset lists</span>
<a name="l00038"></a><a class="code" href="classEventList.html#a1">00038</a> <a class="code" href="classEventList.html#a1">EventList:: ~EventList</a>()
00039 {
00040         
00041   Status *status = Status::getStatus();
00042   <span class="keywordtype">int</span> proc = status-&gt;proc;
00043   Params &amp;params = *Params::getInstance();
00044 
00045   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numSet; i++)
00046     {
00047       deleteList(i);
00048       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;portion(i); j++)
00049         {
00050           stringstream ss;
00051                         
00052           <span class="comment">//KW: ss&lt;&lt;"/scratch/EventList-"&lt;&lt;proc&lt;&lt;"-"&lt;&lt;i&lt;&lt;"-"&lt;&lt;j;</span>
00053           ss&lt;&lt;<span class="stringliteral">"/scratch/"</span>&lt;&lt;tempDirName&lt;&lt;<span class="stringliteral">"/EventList-"</span>&lt;&lt;proc&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt;j;
00054           string fileName=ss.str();
00055           <span class="keywordflow">if</span>(std::remove(fileName.c_str())==-1)
00056             cout&lt;&lt;<span class="stringliteral">"Error deleting list swap file "</span>&lt;&lt;fileName&lt;&lt;endl;
00057           <span class="keywordflow">else</span> 
00058             <span class="keywordflow">if</span>((params.frame.verbosity &gt;= 3) || 
00059                 ((params.frame.verbosity &gt;= 2) &amp;&amp; (status-&gt;proc == 0))) 
00060                 cout&lt;&lt;<span class="stringliteral">"delete file "</span>&lt;&lt;fileName&lt;&lt;endl;
00061         }               
00062     }
00063   <span class="keyword">delete</span> sentry;
00064   <span class="keyword">delete</span> cSentry;
00065 <span class="preprocessor">#ifdef DEBUG</span>
00066 <span class="preprocessor"></span>  <span class="comment">//cout&lt;&lt;"EventList deleted ..."&lt;&lt;countD&lt;&lt;endl;</span>
00067 <span class="preprocessor">#endif</span>
00068 <span class="preprocessor"></span>}
00069 
00070 <span class="comment">//destroy current subset of the event list</span>
00071 <span class="keywordtype">void</span> EventList::deleteList(<span class="keywordtype">int</span> subset)
00072 {
00073   <span class="keywordtype">int</span> i=subset;
00074   <span class="keywordflow">if</span>(!<a class="code" href="classEventList.html#a9">isEmpty</a>(i))               <span class="comment">//List number i is not empty</span>
00075     {
00076       <a class="code" href="classEventListNode.html">EventListNode</a> *tmpPtr;            <span class="comment">//temp pointer to eventlistnode</span>
00077       currentPtr(i) = firstPtr(i);      <span class="comment">//set current pointer to first</span>
00078       <span class="keywordflow">while</span>(currentPtr(i) != sentry)    <span class="comment">//delet the remaining nodes</span>
00079         {
00080           tmpPtr = currentPtr(i);
00081           currentPtr(i) = currentPtr(i)-&gt;nextPtr;
00082           assert(tmpPtr!=0);
00083           assert(tmpPtr!=sentry);
00084           <span class="keyword">delete</span> tmpPtr;
00085         }
00086     }
00087   firstPtr(i)=lastPtr(i)=currentPtr(i)=sentry;
00088   numEvents(i)=0;
00089 }
00090 
00091 
00092 <span class="comment">//if a subset of the eventlist exceeded portion size, </span>
00093 <span class="comment">//swap it to disk to save memory</span>
00094 <span class="keywordtype">void</span> EventList::swapToDisk(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> nP)
00095 {
00096   <span class="comment">//list-swap file name: Eventlist-&lt;processor&gt;-&lt;subset&gt;-&lt;portion&gt;</span>
00097   Status * status=Status::getStatus();
00098   <span class="keywordtype">int</span> proc = status-&gt;proc;
00099   stringstream ss;
00100   <span class="comment">//KW:ss&lt;&lt;"/scratch/EventList-"&lt;&lt;proc&lt;&lt;"-"&lt;&lt;i&lt;&lt;"-"&lt;&lt;nP;</span>
00101   ss&lt;&lt;<span class="stringliteral">"/scratch/"</span>&lt;&lt;tempDirName&lt;&lt;<span class="stringliteral">"/EventList-"</span>&lt;&lt;proc&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt;nP;
00102   string fileName = ss.str();
00103   ofstream fEventListSwap(fileName.c_str(),ios::binary);
00104   Params &amp;params = *Params::getInstance();
00105   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00106     status-&gt;printMemInfo();
00107   }
00108   <span class="keywordflow">if</span>(status-&gt;proc == 0){
00109     string comm = <span class="stringliteral">"Swapping to disk"</span>;
00110     Status::StatusCode code = Status::SWAPPING;
00111     status-&gt;update(comm, code);
00112   }
00113   <span class="comment">//open list-swap file</span>
00114   <span class="keywordflow">if</span>(!fEventListSwap)
00115     {
00116       string comm=<span class="stringliteral">"Error in open event list swapping file "</span>+fileName
00117         +<span class="stringliteral">", Program aborted"</span>;
00118       Status::StatusCode code = Status::ERROR;
00119       status-&gt;update(comm, code);
00120       cout&lt;&lt;comm&lt;&lt;endl;
00121       MPI::COMM_WORLD.Abort(-1);
00122     }
00123 
00124   <span class="comment">//swap event list to disk</span>
00125   <span class="keywordflow">if</span>(!<a class="code" href="classEventList.html#a9">isEmpty</a>(i))               <span class="comment">//subset i is not empty</span>
00126     {
00127       ss.str(<span class="stringliteral">""</span>);
00128       ss.clear();
00129       ss&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;proc&lt;&lt;<span class="stringliteral">", Eventlist swapped to "</span>&lt;&lt;fileName;
00130       string comm=ss.str();
00131       <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00132       <span class="keywordflow">if</span>((params.frame.verbosity &gt;= 3) || 
00133      ((params.frame.verbosity &gt;= 2) &amp;&amp; (status-&gt;proc == 0))) log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(comm, FRAME, 0);
00134       <a class="code" href="classEventListNode.html">EventListNode</a> *tmpPtr;            <span class="comment">//temp pointer to eventlistnode</span>
00135       currentPtr(i) = firstPtr(i);      <span class="comment">//set current pointer to first</span>
00136       <span class="keywordflow">while</span>(currentPtr(i) != sentry)    <span class="comment">//swap and delete the remaining nodes</span>
00137         {
00138           tmpPtr = currentPtr(i);
00139           currentPtr(i) = currentPtr(i)-&gt;nextPtr;
00140           assert(tmpPtr!=0);
00141           assert(tmpPtr!=sentry);
00142           fEventListSwap.write((<span class="keywordtype">char</span> *) &amp;(tmpPtr-&gt;<a class="code" href="classEventListNode.html#r0">event</a>), <span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>));<span class="comment">//write to file</span>
00143           <span class="keywordflow">if</span>(fEventListSwap.bad()) <span class="comment">//if write fails, quit</span>
00144             {
00145               ss.str(<span class="stringliteral">""</span>);
00146               ss.clear();
00147               ss &lt;&lt;<span class="stringliteral">"Error in writing swap file "</span>&lt;&lt;fileName&lt;&lt;<span class="stringliteral">" on processor "</span>&lt;&lt;proc;
00148               comm = ss.str();
00149               Status::StatusCode code = Status::ERROR;
00150               status-&gt;update(comm, code);
00151               log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(comm, FRAME, 0);
00152               MPI::COMM_WORLD.Abort(-1);
00153             }
00154           <span class="keyword">delete</span> tmpPtr; <span class="comment">//delete the node</span>
00155         }
00156     }
00157 
00158   firstPtr(i)=lastPtr(i)=currentPtr(i)=sentry; <span class="comment">//reset pointers</span>
00159   numEvents(i)=0; <span class="comment">//reset number</span>
00160   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00161      status-&gt;printMemInfo(); <span class="comment">//DEBUG</span>
00162   }
00163   fEventListSwap.flush();
00164   fEventListSwap.close();
00165   <span class="keywordflow">if</span>(status-&gt;proc == 0)
00166     {
00167       string comm = <span class="stringliteral">"Swapping to disk end"</span>;
00168       Status::StatusCode code = Status::RUNNING;
00169       status-&gt;update(comm, code);
00170     }
00171 }
00172 
00173 
00174 <span class="comment">//when trasversal the eventlist, swap back from the disk</span>
00175 <span class="keywordtype">void</span> EventList::swapFromDisk(<span class="keywordtype">int</span> subset, <span class="keywordtype">int</span> nP)
00176 {
00177   Status * status=Status::getStatus();
00178   Params &amp;params = *Params::getInstance();
00179   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00180      status-&gt;printMemInfo(); <span class="comment">//DEBUG</span>
00181   }
00182   <span class="comment">//list-swap file name: Eventlist-&lt;processor&gt;-&lt;subset&gt;-&lt;portion&gt;</span>
00183   <span class="keywordtype">int</span> proc = status-&gt;proc;
00184   stringstream ss;
00185   <span class="comment">//KW:ss&lt;&lt;"/scratch/EventList-"&lt;&lt;proc&lt;&lt;"-"&lt;&lt;subset&lt;&lt;"-"&lt;&lt;nP;</span>
00186   ss&lt;&lt;<span class="stringliteral">"/scratch/"</span>&lt;&lt;tempDirName&lt;&lt;<span class="stringliteral">"/EventList-"</span>&lt;&lt;proc&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt;subset&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt;nP;
00187   string fileName = ss.str();
00188   ifstream fEventListSwap(fileName.c_str(),ios::binary);
00189   ss.str(<span class="stringliteral">""</span>);
00190   ss.clear();
00191   ss&lt;&lt;<span class="stringliteral">"On processor "</span>&lt;&lt;proc&lt;&lt;<span class="stringliteral">", Eventlist swapped from "</span>&lt;&lt;fileName;
00192   string comm=ss.str();
00193   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00194   <span class="keywordflow">if</span>((params.frame.verbosity &gt;= 3) || 
00195      ((params.frame.verbosity &gt;= 2) &amp;&amp; (status-&gt;proc == 0))) log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(comm, FRAME, 0);
00196   <span class="keywordflow">if</span>(status-&gt;proc == 0)
00197     {
00198       string comm = <span class="stringliteral">"Swapping from disk"</span>;
00199       Status::StatusCode code = Status::SWAPPING;
00200       status-&gt;update(comm, code);
00201     }
00202 
00203   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;VOLUM/numSet; i++)
00204     {
00205       <a class="code" href="classEventPacket.html">EventPacket</a> event;
00206       fEventListSwap.read((<span class="keywordtype">char</span> *) &amp;event, <span class="keyword">sizeof</span>(<a class="code" href="classEventPacket.html">EventPacket</a>));<span class="comment">//read an Event</span>
00207       <span class="keywordflow">if</span>(fEventListSwap.bad()) <span class="comment">//read error</span>
00208         {
00209           ss.str(<span class="stringliteral">""</span>);
00210           ss.clear();
00211           ss&lt;&lt; <span class="stringliteral">"Error in reading swap file "</span>&lt;&lt;fileName&lt;&lt;<span class="stringliteral">" on processor "</span>&lt;&lt;proc;
00212           string comm = ss.str();
00213           Status::StatusCode code = Status::ERROR;
00214           status-&gt;update(comm, code);
00215           cout&lt;&lt;comm&lt;&lt;endl;
00216           MPI::COMM_WORLD.Abort(-1);
00217         }
00218       <span class="keywordflow">if</span>(event == cSentry-&gt;<a class="code" href="classEventListNode.html#r0">event</a>) <span class="keywordflow">break</span>;
00219       <a class="code" href="classEventList.html#a2">append</a>(subset, event); <span class="comment">//append the event to current list</span>
00220     }
00221   <span class="keywordflow">if</span>(status-&gt;proc == 0)
00222     {
00223       string comm = <span class="stringliteral">"Swapping from disk end"</span>;
00224       Status::StatusCode code = Status::RUNNING;
00225       status-&gt;update(comm, code);
00226     }
00227   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00228      status-&gt;printMemInfo(); <span class="comment">//DEBUG</span>
00229   }
00230 }
00231 
00232 <span class="comment">//appends event to specified subset-list</span>
<a name="l00233"></a><a class="code" href="classEventList.html#a2">00233</a> <span class="keywordtype">void</span> <a class="code" href="classEventList.html#a2">EventList::append</a>(<span class="keywordtype">int</span> subset, <span class="keyword">const</span> <a class="code" href="classEventPacket.html">EventPacket</a> &amp;event)
00234 {
00235   assert(subset&lt;numSet);
00236   numEvents(subset)++;
00237   Params &amp;params = *Params::getInstance();
00238   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6 &amp;&amp; (numEvents(subset) %
00239   Constant::EVENTSTATSCOUNT == 0) &amp;&amp; subset == 0) {
00240          Status *status = Status::getStatus();
00241          status-&gt;printMemInfo();
00242   }             
00243 
00244   <span class="keywordflow">if</span>(numEvents(subset)&gt;VOLUM/numSet) 
00245     {
00246       swapToDisk(subset,portion(subset));
00247       portion(subset)++; <span class="comment">//increase portion by 1</span>
00248     }
00249   <a class="code" href="classEventListNode.html">EventListNode</a> *newPtr = getNewNode(event);
00250   <span class="comment">//generates a new node</span>
00251   <span class="keywordflow">if</span>(<a class="code" href="classEventList.html#a9">isEmpty</a>(subset))   <span class="comment">//List subset is empty</span>
00252     firstPtr(subset) = lastPtr(subset) = currentPtr(subset) = newPtr;
00253   <span class="keywordflow">else</span>          <span class="comment">//list subset is not empty</span>
00254     {
00255       lastPtr(subset)-&gt;nextPtr = newPtr;
00256       lastPtr(subset) = newPtr;
00257       currentPtr(subset) = lastPtr(subset);
00258     }
00259 }
00260 
00261 <span class="comment">//Is the list subset empty?</span>
<a name="l00262"></a><a class="code" href="classEventList.html#a9">00262</a> <span class="keywordtype">bool</span> <a class="code" href="classEventList.html#a9">EventList:: isEmpty</a>(<span class="keywordtype">int</span> subset)
00263 {
00264   assert(subset&lt;numSet);
00265   <span class="keywordflow">return</span> firstPtr(subset) == sentry;
00266 }
00267 
00268 <span class="comment">//return a pointer to a newly allocated node</span>
00269 <a class="code" href="classEventListNode.html">EventListNode</a> * EventList::getNewNode(<span class="keyword">const</span> <a class="code" href="classEventPacket.html">EventPacket</a> &amp; event)
00270 {
00271   <a class="code" href="classEventListNode.html">EventListNode</a> *ptr = <span class="keyword">new</span> <a class="code" href="classEventListNode.html">EventListNode</a>(event);
00272   ptr-&gt;<a class="code" href="classEventListNode.html#r1">nextPtr</a> = sentry;
00273   assert(ptr !=0);
00274   <span class="keywordflow">return</span> ptr;
00275 }
00276 
00277 <span class="comment">//removes last event of specified eventlist subset</span>
<a name="l00278"></a><a class="code" href="classEventList.html#a5">00278</a> <span class="keywordtype">bool</span> <a class="code" href="classEventList.html#a5">EventList:: remove</a>(<span class="keywordtype">int</span> subset)
00279 {
00280 <span class="comment">//   assert(subset&lt;numSet);</span>
00281 <span class="comment">//   if(isEmpty(subset)) return false;  //list empty, don't do anything</span>
00282 <span class="comment">//   else</span>
00283 <span class="comment">//     {</span>
00284 <span class="comment">//       EventListNode *tmpPtr = currentPtr(subset);</span>
00285 <span class="comment">//       if(firstPtr(subset) == lastPtr(subset)) //only one event in list</span>
00286 <span class="comment">//      firstPtr(subset) = lastPtr(subset)  = currentPtr(subset) = sentry;</span>
00287 <span class="comment">//       else</span>
00288 <span class="comment">//      {</span>
00289 <span class="comment">//        EventListNode *ptr = firstPtr(subset);</span>
00290 <span class="comment">//        if(ptr==currentPtr(subset)) //remove the first event</span>
00291 <span class="comment">//             {</span>
00292 <span class="comment">//            firstPtr(subset)=currentPtr(subset)=ptr-&gt;nextPtr;</span>
00293 <span class="comment">//             }</span>
00294 <span class="comment">//        else</span>
00295 <span class="comment">//             {</span>
00296 <span class="comment">//            while(ptr-&gt;nextPtr !=currentPtr(subset)) //find the node before current node</span>
00297 <span class="comment">//              {</span>
00298 <span class="comment">//                ptr = ptr-&gt;nextPtr;</span>
00299 <span class="comment">//              }</span>
00300 <span class="comment">//             }</span>
00301 <span class="comment">//        if(currentPtr(subset) == lastPtr(subset)) //remove the last event</span>
00302 <span class="comment">//             {</span>
00303 <span class="comment">//            currentPtr(subset) = lastPtr(subset) = ptr;</span>
00304 <span class="comment">//            currentPtr(subset)-&gt;nextPtr = lastPtr(subset)-&gt;nextPtr = sentry;</span>
00305 <span class="comment">//             }</span>
00306 <span class="comment">//        else</span>
00307 <span class="comment">//          ptr-&gt;nextPtr=currentPtr(subset)=currentPtr(subset)-&gt;nextPtr;</span>
00308 <span class="comment">//      }</span>
00309 
00310 <span class="comment">//       delete tmpPtr;</span>
00311 <span class="comment">//       numEvents(subset)--;</span>
00312 <span class="comment">//       removed=true;</span>
00313 <span class="comment">//       return true;</span>
00314 <span class="comment">//     }</span>
00315   currentPtr(subset)-&gt;event.jstart= currentPtr(subset)-&gt;event.jstop-1;
00316   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00317 }
00318 
00319 <span class="comment">//replaces existing event packet at current event with argument</span>
<a name="l00320"></a><a class="code" href="classEventList.html#a7">00320</a> <span class="keywordtype">bool</span> <a class="code" href="classEventList.html#a7">EventList::replace</a>(<span class="keywordtype">int</span> subset, <span class="keyword">const</span> <a class="code" href="classEventPacket.html">EventPacket</a> &amp; event)
00321 {
00322   assert(subset&lt;numSet);
00323   <span class="keywordflow">if</span>(<a class="code" href="classEventList.html#a9">isEmpty</a>(subset)) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//if list is empty, do nothing</span>
00324   currentPtr(subset)-&gt;event = event;
00325   replaced=<span class="keyword">true</span>;
00326   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00327 }
00328 
00329 <span class="comment">//return first event in specified subset list, put current pointer</span>
00330 <span class="comment">//to the second event of the list</span>
<a name="l00331"></a><a class="code" href="classEventList.html#a3">00331</a> <a class="code" href="classEventPacket.html">EventPacket</a> <a class="code" href="classEventList.html#a3">EventList::getFirst</a>(<span class="keywordtype">int</span> subset)
00332 {
00333   assert(subset&lt;numSet);
00334   replaced=removed = <span class="keyword">false</span>;
00335   <span class="keywordflow">if</span>(portion(subset)&gt;0)
00336     {
00337       <span class="comment">//swap current portion of eventlist to disk</span>
00338       <a class="code" href="classEventList.html#a2">append</a>(subset,cSentry-&gt;<a class="code" href="classEventListNode.html#r0">event</a>);
00339       Params &amp;params = *Params::getInstance();
00340       <span class="keywordflow">if</span>(numSet&lt;=VOLUM/numSet) swapToDisk(subset,portion(subset));
00341       <span class="comment">//swap back the first portion</span>
00342       nPortion(subset) = 0;
00343       swapFromDisk(subset,nPortion(subset));<span class="comment">//swap back the first list-swap file</span>
00344     }
00345   <span class="keywordflow">if</span>(<a class="code" href="classEventList.html#a9">isEmpty</a>(subset)) <span class="keywordflow">return</span> <a class="code" href="classEventList.html#a6">getSentry</a>();<span class="comment">//if list empty, return a nullEvent</span>
00346   currentPtr(subset) = firstPtr(subset);
00347   <span class="keywordflow">return</span> firstPtr(subset)-&gt;event;<span class="comment">//else return first event</span>
00348 }
00349 
00350 <span class="keywordtype">int</span> eventCount = 0;
00351 <span class="comment">//returns next event of specified subset list, null if at end of the list</span>
<a name="l00352"></a><a class="code" href="classEventList.html#a4">00352</a> <a class="code" href="classEventPacket.html">EventPacket</a> <a class="code" href="classEventList.html#a4">EventList::getNext</a>(<span class="keywordtype">int</span> subset)
00353 {
00354   assert(subset&lt;numSet);
00355   <span class="keywordflow">if</span>(<a class="code" href="classEventList.html#a9">isEmpty</a>(subset)) <span class="keywordflow">return</span> <a class="code" href="classEventList.html#a6">getSentry</a>(); <span class="comment">//if list empty, return a sentry Event</span>
00356   <span class="keywordflow">if</span>(currentPtr(subset) == lastPtr(subset)) <span class="comment">//end of the current list reached</span>
00357     {
00358       nPortion(subset)++;     <span class="comment">//number of portion read increases by 1</span>
00359       <span class="keywordflow">if</span>(portion(subset)==0 || nPortion(subset) == (portion(subset)+1)) <span class="comment">//all list-swap files read</span>
00360         <span class="keywordflow">return</span> <a class="code" href="classEventList.html#a6">getSentry</a>(); <span class="comment">//reach the end of the list, return a sentry event</span>
00361       <span class="keywordflow">else</span>
00362         {
00363           <span class="keywordflow">if</span>(replaced || removed)
00364             {
00365               swapToDisk(subset, nPortion(subset)-1);
00366               <span class="keywordflow">if</span>(removed) <a class="code" href="classEventList.html#a2">append</a>(subset,cSentry-&gt;<a class="code" href="classEventListNode.html#r0">event</a>);
00367               replaced=removed = <span class="keyword">false</span>;
00368             }
00369           <span class="keywordflow">else</span>
00370             {
00371               deleteList(subset);        <span class="comment">//delete current list</span>
00372             }
00373           swapFromDisk(subset, nPortion(subset)); <span class="comment">//swap back next list-swap file</span>
00374           currentPtr(subset)=firstPtr(subset); <span class="comment">//put current pointer to first</span>
00375           <span class="keywordflow">return</span> currentPtr(subset)-&gt;event; <span class="comment">//return first event of current list</span>
00376         }
00377     }
00378 
00379   currentPtr(subset) = currentPtr(subset)-&gt;nextPtr;<span class="comment">//move current event a forward step</span>
00380   <a class="code" href="classEventPacket.html">EventPacket</a> tmpEvent = currentPtr(subset)-&gt;event;
00381  
00382   eventCount++;
00383   Params &amp;params = *Params::getInstance();
00384   Status *status = Status::getStatus();
00385 
00386   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6 &amp;&amp; (eventCount % Constant::EVENTSTATSCOUNT == 0)) {
00387      status-&gt;printMemInfo();
00388   } 
00389 
00390   <span class="keywordflow">return</span> tmpEvent;
00391 }
00392 
00393 <span class="comment">//get sentry</span>
<a name="l00394"></a><a class="code" href="classEventList.html#a6">00394</a> <a class="code" href="classEventPacket.html">EventPacket</a> <a class="code" href="classEventList.html#a6">EventList::getSentry</a>()
00395 {
00396   <span class="keywordflow">return</span> NULLEVENT;
00397 }
00398 
00399 <span class="comment">//write the events in EventList to file</span>
00400 <span class="comment">/*void EventList::print()</span>
00401 <span class="comment">  {</span>
00402 <span class="comment">  ofstream fEvent("EventList.dat");</span>
00403 <span class="comment">  for(int i=0 ; i&lt;numSet; i++)</span>
00404 <span class="comment">  {</span>
00405 <span class="comment">  fEvent&lt;&lt;"Subset List "&lt;&lt;i&lt;&lt;" : "&lt;&lt;endl;</span>
00406 <span class="comment">  fEvent&lt;&lt;"jstart "&lt;&lt;"jstop "&lt;&lt;"secondaryStart "&lt;&lt;"zStart ";</span>
00407 <span class="comment">  fEvent&lt;&lt;"secondaryStep "&lt;&lt;"zStep "&lt;&lt;"x1 y1 z1"&lt;&lt;" x2 y2 z2";</span>
00408 <span class="comment">  fEvent&lt;&lt;endl;</span>
00409 <span class="comment">  if(isEmpty(i)) continue;</span>
00410 <span class="comment">  EventListNode * ptr = firstPtr(i);</span>
00411 <span class="comment">  EventPacket e=ptr-&gt;event;</span>
00412 <span class="comment">  fEvent&lt;&lt;e.jstart&lt;&lt;" "&lt;&lt;e.jstop&lt;&lt;" "&lt;&lt;e.secondaryStart&lt;&lt;" ";</span>
00413 <span class="comment">  fEvent&lt;&lt;e.zStart&lt;&lt;" "&lt;&lt;e.secondaryStep&lt;&lt;" "&lt;&lt;e.zStep&lt;&lt;" ";</span>
00414 <span class="comment">  fEvent&lt;&lt;e.x1&lt;&lt;" "&lt;&lt;e.y1&lt;&lt;" "&lt;&lt;e.z1&lt;&lt;" ";</span>
00415 <span class="comment">  fEvent&lt;&lt;e.x2&lt;&lt;" "&lt;&lt;e.y2&lt;&lt;" "&lt;&lt;e.z2&lt;&lt;endl;</span>
00416 <span class="comment">  while((ptr=ptr-&gt;nextPtr)!=sentry)</span>
00417 <span class="comment">  {</span>
00418 <span class="comment">  e=ptr-&gt;event;</span>
00419 <span class="comment">  fEvent&lt;&lt;e.jstart&lt;&lt;" "&lt;&lt;e.jstop&lt;&lt;" "&lt;&lt;e.secondaryStart&lt;&lt;" ";</span>
00420 <span class="comment">  fEvent&lt;&lt;e.zStart&lt;&lt;" "&lt;&lt;e.secondaryStep&lt;&lt;" "&lt;&lt;e.zStep&lt;&lt;" ";</span>
00421 <span class="comment">  fEvent&lt;&lt;e.x1&lt;&lt;" "&lt;&lt;e.y1&lt;&lt;" "&lt;&lt;e.z1&lt;&lt;" ";</span>
00422 <span class="comment">  fEvent&lt;&lt;e.x2&lt;&lt;" "&lt;&lt;e.y2&lt;&lt;" "&lt;&lt;e.z2&lt;&lt;endl;</span>
00423 <span class="comment">  }</span>
00424 <span class="comment">  }</span>
00425 <span class="comment">  #ifdef DEBUG</span>
00426 <span class="comment">  cout&lt;&lt;"event list printed..."&lt;&lt;endl;</span>
00427 <span class="comment">  #endif</span>
00428 <span class="comment">  }*/</span>
00429 
<a name="l00430"></a><a class="code" href="classEventList.html#a10">00430</a> <span class="keywordtype">void</span> <a class="code" href="classEventList.html#a10">EventList::printOnScreen</a>()
00431 {
00432   <span class="keywordtype">int</span> totalEvent = 0;
00433   <span class="keywordtype">int</span> count[numSet];
00434   stringstream ss;
00435   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00436   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt;numSet; i++)
00437     {
00438       count[i]=1;
00439       ss&lt;&lt;<span class="stringliteral">"Subset List "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">" : "</span>&lt;&lt;endl;
00440       ss&lt;&lt;<span class="stringliteral">"jstart "</span>&lt;&lt;<span class="stringliteral">"jstop "</span>&lt;&lt;<span class="stringliteral">"secondaryStart "</span>&lt;&lt;<span class="stringliteral">"zStart "</span>;
00441       ss&lt;&lt;<span class="stringliteral">"secondaryStep "</span>&lt;&lt;<span class="stringliteral">"zStep "</span>;
00442       ss&lt;&lt;<span class="stringliteral">"Index    x1 y1 z1"</span>&lt;&lt;<span class="stringliteral">" x2 y2 z2"</span>;
00443       ss&lt;&lt;endl;
00444       <span class="keywordflow">if</span>(<a class="code" href="classEventList.html#a9">isEmpty</a>(i)) <span class="keywordflow">continue</span>;
00445       <a class="code" href="classEventPacket.html">EventPacket</a> e=<a class="code" href="classEventList.html#a3">getFirst</a>(i);
00446       ss&lt;&lt;e.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>&lt;&lt;<span class="stringliteral">" "</span>;
00447       ss&lt;&lt;e.<a class="code" href="classEventPacket.html#o3">zStart</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o5">zStep</a>&lt;&lt;<span class="stringliteral">" "</span>;
00448       ss&lt;&lt;count[i]&lt;&lt;<span class="stringliteral">"      "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;<span class="stringliteral">" "</span>;
00449       ss&lt;&lt;e.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00450       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(), FRAME, 4);
00451       <span class="keywordflow">while</span>(!(e==<a class="code" href="classEventList.html#a6">getSentry</a>()))
00452         {
00453           e=<a class="code" href="classEventList.html#a4">getNext</a>(i);
00454           ss.str(<span class="stringliteral">""</span>);
00455           ss.clear();
00456           ss&lt;&lt;e.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>&lt;&lt;<span class="stringliteral">" "</span>;
00457           ss&lt;&lt;e.<a class="code" href="classEventPacket.html#o3">zStart</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o5">zStep</a>&lt;&lt;<span class="stringliteral">" "</span>;
00458           count[i]++;
00459           ss&lt;&lt;count[i]&lt;&lt;<span class="stringliteral">"      "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;<span class="stringliteral">" "</span>;
00460           ss&lt;&lt;e.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;e.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00461           log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(), FRAME, 4);
00462         }
00463       totalEvent += count[i];
00464     }
00465   ss.str(<span class="stringliteral">""</span>);
00466   ss.clear();
00467   ss&lt;&lt;<span class="stringliteral">"Totally "</span>&lt;&lt;totalEvent&lt;&lt;<span class="stringliteral">" Eevents in the lists"</span>&lt;&lt;endl;
00468   log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(), FRAME, 4);
00469 <span class="preprocessor">#ifdef DEBUG2</span>
00470 <span class="preprocessor"></span>  <span class="comment">//cout&lt;&lt;"event list printed..."&lt;&lt;endl;</span>
00471 <span class="preprocessor">#endif</span>
00472 <span class="preprocessor"></span>}
00473 
<a name="l00478"></a><a class="code" href="classEventList.html#a13">00478</a> <span class="keywordtype">int</span> <a class="code" href="classEventList.html#a13">EventList::getTotalSize</a>()
00479 {
00480   <span class="keywordtype">int</span> totalSize = 0;
00481   <span class="comment">//get number of events from each subset</span>
00482   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;this-&gt;<a class="code" href="classEventList.html#a11">getNumSet</a>(); i++)
00483     totalSize += this-&gt;<a class="code" href="classEventList.html#a12">getNumEvents</a>(i);
00484   <span class="keywordflow">return</span> totalSize;
00485 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
