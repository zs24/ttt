<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: TOC.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>TOC.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00002 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00003 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00004 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00005 <span class="preprocessor">#include "TOC.hpp"</span>
00006 <span class="preprocessor">#include "Constant.hpp"</span>
00007 <span class="preprocessor">#include "Utilities.hpp"</span>
00008 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00017"></a><a class="code" href="classTOC.html#a0">00017</a> <a class="code" href="classTOC.html#a0">TOC:: TOC</a>(string &amp; fileName, string &amp; pathTOC)
00018 {
00019   <span class="keyword">extern</span> <span class="keywordtype">int</span> errno;
00020   <span class="keywordflow">if</span>(pathTOC == <span class="stringliteral">""</span>) {
00021   <span class="comment">//Let pathTOC be the study directory where the listmode is found</span>
00022       <span class="keywordtype">int</span> i1 = fileName.find_last_of(<span class="stringliteral">"/"</span>);
00023 
00024       pathTOC = fileName.substr(0,i1);
00025   }
00026   <span class="keywordtype">int</span> i1 = fileName.find_last_of(<span class="stringliteral">"/"</span>);
00027   string studyPath = fileName.substr(0,i1);
00028 
00029   Params *params = Params::getInstance();
00030   <span class="keywordflow">if</span>(fileName.find_last_of(<span class="stringliteral">".l64"</span>) != string::npos) {
00031      <span class="keywordtype">int</span> idx = fileName.find_last_of(<span class="stringliteral">"."</span>);
00032      fileName = fileName.replace(idx,4,<span class="stringliteral">".hc"</span>);
00033   }
00034   this-&gt;fileNameHC= fileName;
00035   
00036   <span class="keywordtype">int</span> index1 = fileNameHC.find_last_of(<span class="stringliteral">"/"</span>);
00037   <span class="keywordtype">int</span> index2 = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00038   string fileNameBase = fileName.substr(index1+1,index2-index1-1);
00039   fileNameTOC = pathTOC+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".toc"</span>;
00040   string fileNameTOC2 = studyPath+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".toc"</span>; 
00041   <span class="comment">// 2006-08-30 initialize singles fix parameter</span>
00042   <span class="comment">// will look for this file in the Study directory only</span>
00043   fileName_sing_fix = studyPath+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".toc2"</span>;
00044   sing_fix_time=0.;
00045   sing_fix_constant=0.;
00046   <span class="comment">//generate TOC file if the file does not exist</span>
00047   <span class="comment">//generate lock file to prevent multiprocessors generate TOC </span>
00048   <span class="comment">//file at same time</span>
00049   string fileNameLock = pathTOC+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".lock"</span>;
00050   <span class="keywordtype">int</span> file_desc= open(fileNameLock.c_str(), O_RDWR |
00051                        O_CREAT | O_EXCL, 0444);
00052   <span class="keywordtype">int</span> isleep=0;
00053   <span class="keywordflow">while</span>( (file_desc==-1)&amp;&amp;(isleep &lt; 10000))
00054   {
00055     cout&lt;&lt;<span class="stringliteral">"TOC file is locked or you do not have permission to write "</span>
00056       &lt;&lt;fileNameTOC&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;fileNameLock&lt;&lt;endl;
00057     cout&lt;&lt;<span class="stringliteral">"Error number is: "</span>&lt;&lt;errno&lt;&lt;endl;
00058     cout&lt;&lt;<span class="stringliteral">"Will try 10000 times"</span>&lt;&lt;endl;
00059     file_desc= open(fileNameLock.c_str(), O_RDWR |
00060               O_CREAT | O_EXCL, 0444);
00061     isleep++;
00062     cout&lt;&lt;<span class="stringliteral">"This is try number "</span>&lt;&lt;isleep&lt;&lt;endl;
00063    
00064   }
00065   
00066   <span class="keywordflow">if</span>(isleep&gt;=10000)
00067   {
00068      cout&lt;&lt;<span class="stringliteral">"TOC file did not get better after 10000 tries  "</span>
00069         &lt;&lt;fileNameTOC&lt;&lt;endl;
00070      (<span class="keywordtype">void</span>) close(file_desc);
00071      (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00072       exit(-1);
00073   }
00074 
00075   <span class="keywordflow">if</span>(file_desc!=-1)
00076   {
00077     ifstream isTOC2(fileNameTOC2.c_str());
00078     <span class="comment">//Look in the study directory first</span>
00079     <span class="keywordflow">if</span>(!isTOC2) {
00080          <span class="comment">//Now look in the scratch path specified</span>
00081          ifstream isTOC(fileNameTOC.c_str());
00082          <span class="comment">//Not in both create one now</span>
00083          <span class="keywordflow">if</span>(!isTOC) {
00084              <span class="keywordflow">if</span>(!CreateTOC()){
00085                cout&lt;&lt;<span class="stringliteral">"Error in generate TOC file"</span>&lt;&lt;endl;
00086                (<span class="keywordtype">void</span>) close(file_desc);
00087                (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00088 
00089                exit(-1);
00090              }
00091              <span class="comment">//close lock file;</span>
00092              (<span class="keywordtype">void</span>) close(file_desc);
00093              (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00094          } <span class="keywordflow">else</span> {
00095            <span class="keywordflow">if</span>(!<a class="code" href="classTOC.html#a5">setLookForZero</a>()) {
00096               cout&lt;&lt;<span class="stringliteral">"Error in reading TOC file :"</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00097               (<span class="keywordtype">void</span>) close(file_desc);
00098               (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00099 
00100               exit(-1);
00101            }
00102          }
00103      } <span class="keywordflow">else</span> {
00104        <span class="comment">// found TOC in study path</span>
00105        fileNameTOC = fileNameTOC2;
00106        <span class="keywordflow">if</span>(!<a class="code" href="classTOC.html#a5">setLookForZero</a>()) {
00107           cout&lt;&lt;<span class="stringliteral">"Error in reading TOC file :"</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00108           (<span class="keywordtype">void</span>) close(file_desc);
00109           (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00110 
00111           exit(-1);
00112        }
00113        <span class="comment">// 2006-08-30 now open singles fix file and read values</span>
00114        ifstream isSF;
00115        isSF.open(fileName_sing_fix.c_str());
00116        <span class="keywordflow">if</span>(!isSF) {
00117          cout&lt;&lt;<span class="stringliteral">"No file with singles fix information found named "</span>&lt;&lt;fileName_sing_fix&lt;&lt;endl;
00118        } <span class="keywordflow">else</span> {
00119         <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00120         <span class="keywordtype">char</span> buff[256];
00121         isSF&gt;&gt;sing_fix_time&gt;&gt;sing_fix_constant;
00122         isSF.close();
00123         cout&lt;&lt;<span class="stringliteral">"TOC:Will correct singles after "</span>&lt;&lt;sing_fix_time&lt;&lt;<span class="stringliteral">" msec with constant "</span>&lt;&lt;sing_fix_constant&lt;&lt;endl;
00124        }
00125      }
00126   }
00127  (<span class="keywordtype">void</span>) close(file_desc);
00128  (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00129 
00130 }
00135 <span class="keywordtype">bool</span> TOC:: CreateTOC()
00136 {
00137   
00138   <span class="comment">//open .hc file</span>
00139   ifstream isHC(fileNameHC.c_str());
00140   <span class="keywordflow">if</span>(!isHC){
00141     cout&lt;&lt;<span class="stringliteral">"Error in opening file "</span>&lt;&lt;fileNameHC&lt;&lt;endl;
00142     cout&lt;&lt;<span class="stringliteral">"Create TOC file from the list mode file"</span>&lt;&lt;endl;
00143     <span class="keywordflow">return</span> createTOCFromListModeFile();
00144   }
00145 
00146   <span class="comment">//open TOC file</span>
00147   <span class="keywordtype">int</span> index2 = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00148   ofstream osTOC(fileNameTOC.c_str());
00149   <span class="keywordflow">if</span>(!osTOC){
00150     cout&lt;&lt;<span class="stringliteral">"Error in opening TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00151     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00152   }
00153   <span class="comment">//find the offset of time tag zero</span>
00154   string fileNameListMode = fileNameHC;
00155   <span class="keywordflow">if</span>(fileNameListMode.find_last_of(<span class="stringliteral">".hc"</span>) != string::npos) {
00156      fileNameListMode.replace(index2,3,<span class="stringliteral">".l64"</span>);
00157   }
00158   <span class="comment">//first time tag and last time tag</span>
00159   OFF_T offsettemp;
00160   <span class="keywordtype">int</span> firstTimeTag = findFirstTimeTag(fileNameListMode, offsettemp);
00161   <span class="keywordflow">if</span>(firstTimeTag &lt;0){
00162     cout&lt;&lt;<span class="stringliteral">"Error in looking for the first time tag in the file "</span>
00163         &lt;&lt;fileNameListMode&lt;&lt;endl;
00164     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00165   }
00166        
00167   <span class="keywordtype">int</span> lastTimeTag = findLastTimeTag(fileNameListMode, offsettemp);
00168   <span class="keywordflow">if</span>(lastTimeTag&lt;0){
00169     cout&lt;&lt;<span class="stringliteral">"Error in looking for the last time tag in the file "</span>
00170         &lt;&lt;fileNameListMode&lt;&lt;endl;
00171     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00172   }
00173 
00174   osTOC&lt;&lt;firstTimeTag&lt;&lt;<span class="stringliteral">" //first time tag"</span>&lt;&lt;endl
00175        &lt;&lt;lastTimeTag&lt;&lt;<span class="stringliteral">" //last time tag"</span>&lt;&lt;endl;
00176   <span class="comment">//offset of zero time tag</span>
00177   OFF_T zeroOffset;
00178   zeroOffset= findZeroOffset(fileNameListMode);
00179 
00180   osTOC&lt;&lt;<span class="stringliteral">"time(ms) offset singles randoms prompts"</span>&lt;&lt;endl;
00181   <span class="keywordflow">if</span>(lookForZero)
00182     osTOC&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;zeroOffset&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;endl;
00183 
00184   <span class="keywordtype">int</span> singles,randoms,prompts,timeTag=0;
00185   <span class="keywordtype">char</span> buffer[256];
00186   isHC.getline(buffer, 256); <span class="comment">//skip the first line</span>
00187   <span class="comment">//write to TOC file</span>
00188   <span class="keywordtype">int</span> previousTimeTag;
00189   <span class="comment">//init variables</span>
00190   OFF_T  randomsOffset, promptsOffset, tagsOffset,  offset;
00191   randomsOffset= promptsOffset= tagsOffset=0;
00192   <span class="keywordflow">do</span>{
00193     <span class="comment">//read in</span>
00194     previousTimeTag = timeTag;
00195 
00196     <span class="keywordtype">char</span> ch;
00197     isHC&gt;&gt;singles;
00198     isHC&gt;&gt;ch;
00199     isHC&gt;&gt;randoms;
00200     isHC&gt;&gt;ch;
00201     isHC&gt;&gt;prompts;
00202     isHC&gt;&gt;ch;
00203     isHC&gt;&gt;timeTag; <span class="comment">//read in</span>
00204     <span class="comment">//calcuation</span>
00205     <span class="keywordtype">int</span> timeInterval = (timeTag - previousTimeTag)/TIMETAGPERSECOND;
00206     randomsOffset += (OFF_T) (randoms*
00207                                       timeInterval*BYTEPERCOUNT/SAVEUNIT);
00208     promptsOffset += (OFF_T) (prompts*
00209                                       timeInterval*BYTEPERCOUNT/SAVEUNIT);
00210     <span class="comment">//tagsOffset = (OFF_T) ( (float)2*timeTag*BYTEPERCOUNT/SAVEUNIT);</span>
00211     tagsOffset = 0;
00212     offset = randomsOffset + promptsOffset+tagsOffset+zeroOffset;
00213     <span class="comment">//write</span>
00214     <span class="keywordflow">if</span>(!isHC.eof())
00215       osTOC &lt;&lt; timeTag &lt;&lt; <span class="stringliteral">" "</span>&lt;&lt;offset&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;singles&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;
00216         randoms&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;prompts&lt;&lt;endl;
00217 
00218 
00219   }<span class="keywordflow">while</span>( !isHC.eof());
00220   osTOC.close();
00221   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00222 }
00223   
00224 <span class="comment">//calculate offset at zero time tag</span>
00225 OFF_T TOC::findZeroOffset(string &amp; fileNameListMode)
00226 {
00227   <span class="comment">//open list mode file</span>
00228   FILE * isListMode;
00229   isListMode = fopen(fileNameListMode.c_str(), <span class="stringliteral">"rb"</span>);
00230   <span class="keywordflow">if</span>(!isListMode){
00231     cout&lt;&lt;<span class="stringliteral">"Error in openning list mode file "</span>&lt;&lt;fileNameListMode
00232         &lt;&lt;<span class="stringliteral">", program aborted"</span>&lt;&lt;endl;
00233     exit(-1);
00234   }
00235   
00236   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4];
00237   <span class="keywordtype">int</span> previousTimeTag , timeTag =-1;
00238   <span class="keywordtype">long</span> numCount = 0;
00239   <span class="comment">//read to time tag zero</span>
00240   <span class="keywordflow">do</span>{
00241     <span class="keywordflow">do</span> {
00242       fread((<span class="keywordtype">char</span> *)b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, isListMode);
00243 
00244       numCount ++;
00245     } <span class="keywordflow">while</span>(!<a class="code" href="classTOC.html#e0">isTimeTag</a>(b) &amp;&amp; !feof(isListMode) &amp;&amp; !ferror(isListMode));
00246     previousTimeTag = timeTag;
00247     timeTag = <a class="code" href="classTOC.html#e1">processTimeTag</a>(b);
00248   } <span class="keywordflow">while</span>((timeTag != 0 &amp;&amp; timeTag&gt;previousTimeTag)
00249           &amp;&amp; !feof(isListMode) &amp;&amp; !ferror(isListMode));
00250   <span class="keywordflow">if</span>(feof(isListMode) || ferror(isListMode)) {
00251     lookForZero = <span class="keyword">false</span>;
00252     <span class="keywordflow">return</span> 0;
00253   } <span class="keywordflow">else</span> {
00254     lookForZero = <span class="keyword">true</span>;
00255     <span class="keywordflow">if</span>(timeTag &lt; previousTimeTag &amp;&amp; timeTag != 0) {
00256         missingZeroTag = <span class="keyword">true</span>;
00257     } <span class="keywordflow">else</span> {
00258         missingZeroTag = <span class="keyword">false</span>; 
00259     }
00260   }
00261   numCount--;
00262   <span class="keywordflow">return</span> OFF_T ( numCount*BYTEPERCOUNT/SAVEUNIT);
00263 }
<a name="l00269"></a><a class="code" href="classTOC.html#a1">00269</a> OFF_T <a class="code" href="classTOC.html#a1">TOC::estimateOffset</a>(<span class="keywordtype">int</span> timeTag)
00270 {
00271   <span class="comment">//if toc file is not existed, created it</span>
00272   ifstream isTOC;
00273   isTOC.open(fileNameTOC.c_str());
00274   <span class="keywordflow">if</span>(!isTOC) {
00275     cout&lt;&lt;<span class="stringliteral">"Error in openning TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00276     <span class="keywordflow">return</span> -1;
00277   }
00278   <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00279   <span class="keywordtype">char</span> buff[256];
00280   isTOC&gt;&gt;firstTimeTag;
00281   isTOC.getline(buff, 256);
00282   isTOC&gt;&gt;lastTimeTag;
00283   isTOC.getline(buff, 256);
00284   isTOC.getline(buff, 256); <span class="comment">//pass comments</span>
00285   OFF_T offset=0;
00286   <span class="keywordtype">int</span> thisTimeTag = -1, singles, randoms, prompts;
00287   <span class="comment">//read the TOC file </span>
00288   <span class="keywordflow">if</span>(timeTag&lt;0 &amp;&amp; lookForZero){
00289     isTOC&gt;&gt;thisTimeTag&gt;&gt;offset;<span class="comment">//&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;</span>
00290     <span class="keywordflow">return</span> offset;
00291   }
00292   <span class="keywordflow">if</span>(timeTag&lt;0 &amp;&amp; !lookForZero)
00293     <span class="keywordflow">return</span> 0;
00294   
00295   <span class="keywordflow">while</span>(thisTimeTag &lt; timeTag &amp;&amp; !isTOC.eof() &amp;&amp; !isTOC.bad()) {
00296     isTOC&gt;&gt;thisTimeTag&gt;&gt;offset;<span class="comment">//&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;</span>
00297     isTOC.getline(buff, 256);
00298   }
00299   <span class="keywordflow">if</span>(isTOC.eof() || isTOC.bad()){
00300     cout&lt;&lt;<span class="stringliteral">"Did not find the offset for specified time tag "</span>&lt;&lt;timeTag
00301         &lt;&lt;<span class="stringliteral">" in TOC file"</span>&lt;&lt;endl;
00302     cout&lt;&lt;<span class="stringliteral">" The last time tag and offset in TOC file is "</span>
00303         &lt;&lt;thisTimeTag&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;offset&lt;&lt;endl;
00304     <span class="keywordflow">return</span> offset;
00305   }
00306   <span class="comment">//Adust the offset  </span>
00307   <span class="comment">/*int timeInterval =  thisTimeTag - timeTag;</span>
00308 <span class="comment">  offset = offset - (float) timeInterval*(randoms+prompts)/TIMETAGPERSECOND</span>
00309 <span class="comment">  *BYTEPERCOUNT/SAVEUNIT;*/</span>
00310   <span class="keywordflow">return</span> offset;
00311 }
00312    
00313 <span class="comment">//find the first time tag in the list mode file      </span>
00314 <span class="keywordtype">int</span> TOC::findFirstTimeTag(string &amp; fileNameListMode, OFF_T &amp; offset)
00315 {
00316   <span class="comment">//open list mode file</span>
00317   FILE * isListMode;
00318   isListMode = fopen(fileNameListMode.c_str(), <span class="stringliteral">"rb"</span>);
00319   <span class="keywordflow">if</span>(!isListMode){
00320     cout&lt;&lt;<span class="stringliteral">"Error in openning list mode file "</span>&lt;&lt;fileNameListMode
00321         &lt;&lt;<span class="stringliteral">", program aborted"</span>&lt;&lt;endl;
00322     <span class="keywordflow">return</span> -1;
00323   }
00324   
00325   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4];
00326   <span class="keywordtype">int</span> timeTag ;
00327   <span class="keywordtype">long</span> nSkip;
00328   <span class="comment">//read to first time tag</span>
00329   <span class="keywordflow">do</span> {
00330     fread((<span class="keywordtype">char</span> *)b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, isListMode);
00331     <span class="keywordflow">if</span> (!<a class="code" href="classTOC.html#e4">checkSync</a>(b, isListMode, nSkip)) <span class="keywordflow">return</span> -1; 
00332 
00333   } <span class="keywordflow">while</span>(!<a class="code" href="classTOC.html#e0">isTimeTag</a>(b) &amp;&amp; !feof(isListMode) &amp;&amp; !ferror(isListMode) );
00334   <span class="keywordflow">if</span>(feof(isListMode) || ferror(isListMode)){
00335     cout&lt;&lt;<span class="stringliteral">"Error in looking for the first time tag "</span>&lt;&lt;endl;
00336     <span class="keywordflow">return</span> -1;
00337   }
00338   timeTag = <a class="code" href="classTOC.html#e1">processTimeTag</a>(b);
00339   
00340   offset = ftello(isListMode);
00341   <span class="keywordflow">return</span> timeTag;
00342 }
00343 
00344 <span class="comment">//find the last time tag in the list mode file</span>
00345 <span class="keywordtype">int</span> TOC::findLastTimeTag(string &amp; fileNameListMode, OFF_T &amp;offset)
00346 {
00347   <span class="comment">//open list mode file</span>
00348   FILE * isListMode;
00349   isListMode = fopen(fileNameListMode.c_str(), <span class="stringliteral">"rb"</span>);
00350   <span class="keywordflow">if</span>(!isListMode){
00351     cout&lt;&lt;<span class="stringliteral">"Error in openning list mode file "</span>&lt;&lt;fileNameListMode
00352         &lt;&lt;<span class="stringliteral">", program aborted"</span>&lt;&lt;endl;
00353     <span class="keywordflow">return</span> -1;
00354   }
00355   
00356   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4];
00357   <span class="keywordtype">int</span> timeTag ;
00358   <span class="comment">//read to first time tag</span>
00359   fseeko(isListMode, 0 , SEEK_END);
00360   <span class="keywordflow">do</span> {
00361     OFF_T offset = -2*BYTEPERCOUNT;
00362     fseeko(isListMode,offset, SEEK_CUR);
00363     fread((<span class="keywordtype">char</span> *)b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, isListMode);
00364   } <span class="keywordflow">while</span>(!<a class="code" href="classTOC.html#e0">isTimeTag</a>(b) &amp;&amp; !feof(isListMode) &amp;&amp; !ferror(isListMode));
00365   <span class="keywordflow">if</span>(feof(isListMode) || ferror(isListMode)){
00366     cout&lt;&lt;<span class="stringliteral">"Error in looking for the first time tag "</span>&lt;&lt;endl;
00367     <span class="keywordflow">return</span> -1;
00368   }
00369      
00370   timeTag = <a class="code" href="classTOC.html#e1">processTimeTag</a>(b);
00371   offset = ftello(isListMode);
00372   <span class="keywordflow">return</span> timeTag;
00373 }
00374 
00375 <span class="comment">//gets the stop time tag of the frame from the list mode file</span>
<a name="l00376"></a><a class="code" href="classTOC.html#a2">00376</a> <span class="keywordtype">int</span> <a class="code" href="classTOC.html#a2">TOC::getFrameStopTimeTag</a>(<span class="keywordtype">int</span> requestedFrameStopTimeTag)
00377 {
00378   <span class="keywordtype">int</span> frameStopTimeTag;
00379 <span class="comment">//estimate the offset of the requested frame stop time </span>
00380 <span class="comment">//tag in the list mode file</span>
00381   OFF_T offset;
00382   offset = <a class="code" href="classTOC.html#a1">estimateOffset</a>(requestedFrameStopTimeTag);
00383   <span class="comment">//open the list mode file</span>
00384   <span class="keywordtype">int</span> index2 = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00385   string fileNameListMode = fileNameHC;
00386   <span class="keywordflow">if</span>(fileNameListMode.find_last_of(<span class="stringliteral">".hc"</span>) != string::npos)
00387      fileNameListMode.replace(index2,3,<span class="stringliteral">".l64"</span>);
00388   FILE * fListMode;
00389   <span class="keywordflow">if</span>((fListMode = fopen(fileNameListMode.c_str(), <span class="stringliteral">"rb"</span>))==0){
00390     string msg = <span class="stringliteral">"Error in open the list mode file"</span>;
00391     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00392     <span class="keywordflow">return</span> Constant::IOERROR;
00393   }
00394                 
00395   <span class="keywordflow">if</span>(offset &lt;0 ||offset&gt;<a class="code" href="classUtilities.html#e6">Utilities::getFileLength</a>(fListMode) ){
00396     string msg = <span class="stringliteral">"TOC offset error"</span>;
00397     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00398     <span class="keywordflow">return</span> Constant::IOERROR;
00399   }
00400 
00401   <span class="comment">//put the file pointer to the offset</span>
00402   fseeko(fListMode, offset, SEEK_SET);
00403 
00404   <span class="comment">//find the actual stop time tag, this logic is similar as which </span>
00405   <span class="comment">//in House::gotoFrameStartTimeTag function</span>
00406 
00407   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4]; <span class="comment">//buffer to hold 64 bits read from list mode file</span>
00408   <span class="keywordtype">bool</span> success; <span class="comment">//if read the list mode success</span>
00409   
00410   <span class="keywordtype">bool</span> reverseFlag = <span class="keyword">true</span>; <span class="comment">//look for backward first</span>
00411   <span class="keywordtype">bool</span> foundItFlag = <span class="keyword">false</span>;
00412   <span class="keywordtype">int</span> thisTimeTag;
00413   <span class="keywordflow">while</span>(!foundItFlag) {
00414     <span class="keywordflow">do</span> {
00415       <span class="keywordflow">if</span>(reverseFlag)
00416         <span class="comment">//find backward</span>
00417         success = <a class="code" href="classTOC.html#e2">findPreviousEvent</a>(b, fListMode);
00418       <span class="keywordflow">else</span>
00419         <span class="comment">//find forward</span>
00420         success = <a class="code" href="classTOC.html#e3">findNextEvent</a>(b,fListMode);
00421       
00422     } <span class="keywordflow">while</span>(!<a class="code" href="classTOC.html#e0">isTimeTag</a>(b) &amp;&amp; success);
00423     <span class="keywordflow">if</span>(!success &amp;&amp; ! feof(fListMode)){ <span class="comment">//beginning of the file reached</span>
00424       <span class="comment">//string msg = "Error in get stop time tag: beginning of file reached";</span>
00425       <span class="comment">// Utilities::logError(msg);</span>
00426       <span class="comment">//return Constant::IOERROR;</span>
00427       reverseFlag = <span class="keyword">false</span>;
00428 
00429     }
00430     
00431     <span class="keywordflow">if</span>(<a class="code" href="classTOC.html#e0">isTimeTag</a>(b))
00432       thisTimeTag = <a class="code" href="classTOC.html#e1">processTimeTag</a>(b);
00433     <span class="keywordflow">if</span>(thisTimeTag &lt; requestedFrameStopTimeTag)
00434       <span class="comment">//go forward</span>
00435       reverseFlag = <span class="keyword">false</span>;
00436   
00437     <span class="keywordflow">if</span>((thisTimeTag == requestedFrameStopTimeTag)<span class="comment">//find it </span>
00438        ||(!reverseFlag  &amp;&amp;(thisTimeTag &gt;requestedFrameStopTimeTag))
00439        <span class="comment">//the requested time tag missing</span>
00440        ||(feof(fListMode))<span class="comment">//requestedTimeTag &gt; last time tag in file</span>
00441        )
00442       <span class="comment">//found it</span>
00443       foundItFlag = <span class="keyword">true</span>;
00444   
00445   }
00446 
00447   frameStopTimeTag = thisTimeTag;
00448   fclose(fListMode);
00449   <span class="keywordflow">return</span> frameStopTimeTag;
00450 }
00451          
00452  
<a name="l00453"></a><a class="code" href="classTOC.html#e2">00453</a> <span class="keywordtype">bool</span> <a class="code" href="classTOC.html#e2">TOC::findPreviousEvent</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, FILE *lun)
00454 {
00455   OFF_T offset; <span class="comment">//current offset of the file</span>
00456   <span class="keywordtype">long</span> nSkip=0;
00457   <span class="comment">//beginning of the file reached</span>
00458   <span class="keywordflow">if</span>(ftello(lun) &lt; 2*Constant::BYTESPERCOUNT)
00459     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00460   <span class="comment">//go backward 2 event counts..since we have already examined -1*8 bytes event</span>
00461   <span class="comment">//and are interested in the -2*8 bytes offset event</span>
00462   offset = -2*Constant::BYTESPERCOUNT;
00463   fseeko(lun, offset, SEEK_CUR);
00464   <span class="comment">//read in a event count</span>
00465   fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun); <span class="comment">//read in 64 bit (2 words)</span>
00466   <span class="keywordflow">if</span> (!checkSyncReverse(b, lun, nSkip)) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00467   <span class="comment">//check if the 2 word synchronized</span>
00468   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00469 }
00470 
00471 <span class="comment">//get an event from the list mode file</span>
<a name="l00472"></a><a class="code" href="classTOC.html#e3">00472</a> <span class="keywordtype">bool</span> <a class="code" href="classTOC.html#e3">TOC::findNextEvent</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, FILE * lun)
00473 {
00474   <span class="comment">//if end of file reached</span>
00475   <span class="keywordtype">long</span> nSkip=0;
00476   <span class="keywordflow">if</span>(feof(lun))
00477     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00478   fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun); <span class="comment">//read in 64 bit (2 words)</span>
00479   <span class="keywordflow">if</span> (!<a class="code" href="classTOC.html#e4">checkSync</a>(b, lun, nSkip)) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00480   <span class="comment">//check if the 2 word synchronized</span>
00481   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00482 }
00483 
00484 <span class="comment">//--------------------------------------------------------------</span>
00485 <span class="comment">//check if the two 32 bit words synchronized</span>
00486 <span class="comment">//-------------------------------------------------------- </span>
<a name="l00487"></a><a class="code" href="classTOC.html#e4">00487</a> <span class="keywordtype">bool</span> <a class="code" href="classTOC.html#e4">TOC::checkSync</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, FILE *lun, <span class="keywordtype">long</span> &amp; nSkip)
00488 {
00489   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> buf;
00490   Params *params = Params::getInstance();
00491   <span class="keywordflow">while</span>( ((b[1]&gt;&gt;15) != 0) || ((b[3]&gt;&gt;15) != 1 )) {
00492     <span class="comment">//check the corresponding bits</span>
00493     <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5)
00494       cout&lt;&lt;<span class="stringliteral">"Out of sync, skipped 1 word..."</span>&lt;&lt;endl;
00495     nSkip ++;
00496     b[0] = b[2];
00497     b[1] = b[3];
00498     <span class="comment">//read in a word</span>
00499     <span class="keywordflow">if</span> (feof(lun) ||ferror(lun)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00500     fread(&amp;buf, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 1, lun);<span class="comment">//first 16 bits</span>
00501     b[2] = buf;
00502     fread(&amp;buf, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 1, lun);<span class="comment">//second 16 bits</span>
00503     b[3] = buf;
00504   }
00505   <span class="keywordflow">if</span> (feof(lun) ||ferror(lun)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00506   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00507 }       
00508 
00509 <span class="keywordtype">bool</span> TOC::checkSyncReverse(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, FILE *lun, <span class="keywordtype">long</span> &amp; nSkip)
00510 {
00511   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> buf;
00512   OFF_T offset; <span class="comment">//current offset of the file</span>
00513   Params *params = Params::getInstance();
00514   <span class="keywordflow">while</span>( ((b[1]&gt;&gt;15) != 0) || ((b[3]&gt;&gt;15) != 1 )) {
00515     <span class="comment">//check the corresponding bits</span>
00516     <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5)
00517       cout&lt;&lt;<span class="stringliteral">"Out of sync, skipped 1 word..."</span>&lt;&lt;endl;
00518     nSkip ++;
00519     <span class="comment">//read in a word</span>
00520   <span class="keywordflow">if</span>(ftello(lun) &lt; 1.5*Constant::BYTESPERCOUNT)
00521     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00522   <span class="comment">//go backward 2 event counts</span>
00523   offset = -1.5*Constant::BYTESPERCOUNT;
00524   fseeko(lun, offset, SEEK_CUR);
00525   <span class="comment">//read in a event count</span>
00526   fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun); <span class="comment">//read in 64 bit (2 words)</span>
00527   }
00528   <span class="keywordflow">if</span> (feof(lun) ||ferror(lun)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00529   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00530 }       
00531 
00532 <span class="comment">//if the head curve file doesn't exist</span>
00533 <span class="comment">//create TOC file directly from the list mode file</span>
00534 <span class="keywordtype">bool</span> TOC::createTOCFromListModeFile()
00535 {
00536     <span class="comment">//open TOC file</span>
00537   <span class="keywordtype">int</span> index2 = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00538   ofstream osTOC(fileNameTOC.c_str());
00539   <span class="keywordflow">if</span>(!osTOC){
00540     cout&lt;&lt;<span class="stringliteral">"Error in opening TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00541     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00542   }
00543   <span class="comment">//find the offset of time tag zero</span>
00544   string fileNameListMode = fileNameHC;
00545   <span class="keywordflow">if</span>(fileNameListMode.find_last_of(<span class="stringliteral">".hc"</span>) != string::npos)
00546      fileNameListMode.replace(index2,3,<span class="stringliteral">".l64"</span>);
00547  <span class="comment">//first time tag and last time tag</span>
00548   OFF_T offsettemp;
00549   <span class="keywordtype">int</span> firstTimeTag = findFirstTimeTag(fileNameListMode, offsettemp);
00550   <span class="keywordtype">int</span> lastTimeTag = findLastTimeTag(fileNameListMode, offsettemp);
00551   osTOC&lt;&lt;firstTimeTag&lt;&lt;<span class="stringliteral">" //first time tag"</span>&lt;&lt;endl
00552        &lt;&lt;lastTimeTag&lt;&lt;<span class="stringliteral">" //last time tag"</span>&lt;&lt;endl;
00553   <span class="comment">//offset of zero time tag</span>
00554   OFF_T zeroOffset = findZeroOffset(fileNameListMode);
00555   osTOC&lt;&lt;<span class="stringliteral">"time(ms) offset singles randoms prompts"</span>&lt;&lt;endl;
00556   <span class="keywordflow">if</span>(lookForZero &amp;&amp; !missingZeroTag)
00557      osTOC&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;zeroOffset&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;endl;
00558   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(lookForZero)
00559      osTOC&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;endl;
00560     <span class="comment">//open list mode file</span>
00561   FILE * isListMode;
00562   isListMode = fopen(fileNameListMode.c_str(), <span class="stringliteral">"rb"</span>);
00563   <span class="keywordflow">if</span>(!isListMode){
00564     cout&lt;&lt;<span class="stringliteral">"Error in openning list mode file "</span>&lt;&lt;fileNameListMode
00565         &lt;&lt;<span class="stringliteral">", program aborted"</span>&lt;&lt;endl;
00566     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00567   }
00568  
00569   <span class="comment">//read through the list mode file</span>
00570   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4];
00571   <span class="keywordtype">int</span> previousTimeTag , timeTag =0;
00572   OFF_T numCount = 0;
00573   <span class="comment">//go to the time tag 0</span>
00574   <span class="comment">//isListMode.seekg(zeroOffset,ios::beg);</span>
00575   fseeko(isListMode,zeroOffset,SEEK_SET);
00576   <span class="comment">//isListMode.read((char *)b, sizeof(unsigned short)*4);</span>
00577   fread((<span class="keywordtype">char</span> *)b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, isListMode);
00578 
00579   <span class="comment">//read list mode file and write to TOC file</span>
00580   <span class="keywordflow">do</span>{
00581     <span class="keywordflow">do</span> {
00582         <span class="keywordtype">long</span> nSkip = 0;
00583         fread((<span class="keywordtype">char</span> *)b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, isListMode);
00584         <span class="keywordflow">if</span> (!<a class="code" href="classTOC.html#e4">checkSync</a>(b, isListMode, nSkip) &amp;&amp; !feof(isListMode) 
00585           &amp;&amp; !ferror(isListMode)) 
00586            <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00587         numCount ++;
00588     } <span class="keywordflow">while</span>(!<a class="code" href="classTOC.html#e0">isTimeTag</a>(b) &amp;&amp; !feof(isListMode) &amp;&amp; !ferror(isListMode));
00589     <span class="keywordflow">if</span>(!feof(isListMode) &amp;&amp; !ferror(isListMode)) {
00590       previousTimeTag = timeTag;
00591       timeTag = <a class="code" href="classTOC.html#e1">processTimeTag</a>(b);
00592       <span class="keywordtype">int</span> prompts = 0;<span class="comment">//numCount/(timeTag/TIMETAGPERSECOND);</span>
00593       OFF_T offset =  numCount*BYTEPERCOUNT/SAVEUNIT;
00594       <span class="keywordflow">if</span>(timeTag % 1000 == 0 || (previousTimeTag/1000) != (timeTag/1000)){
00595         osTOC&lt;&lt;timeTag&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;offset&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;0&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;prompts&lt;&lt;endl;
00596       }
00597     }
00598     
00599   } <span class="keywordflow">while</span>(!feof(isListMode) &amp;&amp; !ferror(isListMode));
00600 
00601   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00602 }
00603   
<a name="l00607"></a><a class="code" href="classTOC.html#a3">00607</a> OFF_T <a class="code" href="classTOC.html#a3">TOC::getZeroOffset</a>()
00608 {
00609   <span class="keywordflow">if</span>(!lookForZero)
00610     <span class="keywordflow">return</span> -1;
00611   <span class="keywordflow">else</span>
00612     <span class="keywordflow">return</span> <a class="code" href="classTOC.html#a1">estimateOffset</a>(0);
00613 }
00614 
00615 <span class="comment">//calculate offset at zero time tag</span>
<a name="l00616"></a><a class="code" href="classTOC.html#a5">00616</a> <span class="keywordtype">bool</span> <a class="code" href="classTOC.html#a5">TOC::setLookForZero</a>()
00617 {
00618   <span class="comment">//if toc file is not existed, created it</span>
00619   ifstream isTOC;
00620   isTOC.open(fileNameTOC.c_str());
00621   <span class="keywordflow">if</span>(!isTOC) {
00622     cout&lt;&lt;<span class="stringliteral">"Error in openning TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00623     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00624   }
00625   <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00626   <span class="keywordtype">char</span> buff[256];
00627   isTOC&gt;&gt;firstTimeTag;
00628   isTOC.getline(buff, 256);
00629   isTOC&gt;&gt;lastTimeTag;
00630   isTOC.getline(buff, 256);
00631   isTOC.getline(buff, 256); <span class="comment">//pass comments</span>
00632   OFF_T offset=0;
00633   <span class="keywordtype">int</span> thisTimeTag = -1, singles, randoms, prompts;
00634   <span class="comment">//read the TOC file </span>
00635   isTOC&gt;&gt;thisTimeTag&gt;&gt;offset;<span class="comment">//&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;</span>
00636   <span class="keywordflow">if</span>(thisTimeTag == 0) {
00637         this-&gt;lookForZero = <span class="keyword">true</span>;
00638   } <span class="keywordflow">else</span> {
00639         this-&gt;lookForZero = <span class="keyword">false</span>;
00640   }
00641   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00642 }
00643 
00644 <span class="keywordtype">float</span> TOC::getEstimatedCounts(<span class="keywordtype">long</span> frameStartTimeTag, <span class="keywordtype">long</span> frameStopTimeTag) {
00645   ifstream isTOC;
00646   <span class="keywordtype">float</span> totalPrompts =0.0 ;
00647   isTOC.open(fileNameTOC.c_str());
00648   <span class="keywordflow">if</span>(!isTOC) {
00649     cout&lt;&lt;<span class="stringliteral">"Error in opening TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00650     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00651   }
00652   <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00653   <span class="keywordtype">char</span> buff[256];
00654   isTOC&gt;&gt;firstTimeTag;
00655   isTOC.getline(buff, 256);
00656   isTOC&gt;&gt;lastTimeTag;
00657   isTOC.getline(buff, 256);
00658   isTOC.getline(buff, 256); <span class="comment">//pass comments</span>
00659   OFF_T offset=0;
00660   <span class="keywordtype">int</span> prevTimeTag = -1, thisTimeTag = -1, singles=0, 
00661       randoms=0, prevPrompts = 0, prompts=0;
00662       
00663   <span class="keywordflow">if</span>(frameStopTimeTag == -1) frameStopTimeTag = lastTimeTag;
00664   <span class="comment">//read the TOC file</span>
00665   <span class="keywordflow">while</span>(thisTimeTag &lt; frameStartTimeTag &amp;&amp; !isTOC.bad() &amp;&amp; !isTOC.eof()) { 
00666      isTOC&gt;&gt;thisTimeTag&gt;&gt;offset&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;
00667      prevTimeTag = thisTimeTag;
00668      prevPrompts = prompts;
00669  <span class="comment">//     cout&lt;&lt;"prevTimeTag:"&lt;&lt;prevTimeTag&lt;&lt;" thisTimeTag: "&lt;&lt;thisTimeTag&lt;&lt;</span>
00670    <span class="comment">//   "  prevPrompts: "&lt;&lt;prevPrompts&lt;&lt;" prompts: "&lt;&lt;prompts&lt;&lt;endl;</span>
00671   }
00672   <span class="keywordflow">while</span>(thisTimeTag &lt; frameStopTimeTag &amp;&amp; !isTOC.bad() &amp;&amp; !isTOC.eof()) {
00673      prevTimeTag = thisTimeTag;
00674      prevPrompts = prompts;
00675      isTOC&gt;&gt;thisTimeTag&gt;&gt;offset&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;
00676      
00677 <span class="comment">//      cout&lt;&lt;"true - prevTimeTag:"&lt;&lt;prevTimeTag&lt;&lt;" thisTimeTag: "&lt;&lt;thisTimeTag&lt;&lt;</span>
00678 <span class="comment">//      "  prevPrompts: "&lt;&lt;prevPrompts&lt;&lt;" prompts: "&lt;&lt;prompts&lt;&lt;endl;</span>
00679      totalPrompts += ((prompts+prevPrompts)/2.0)*
00680                        ((thisTimeTag - prevTimeTag)/1000.0);
00681   }  
00682   <span class="keywordflow">return</span> totalPrompts; 
00683 }
00684 
00685 <span class="keywordtype">float</span> TOC::get_fix_sing_time()
00686  {
00687    <span class="keywordflow">return</span> sing_fix_time;
00688   }
00689 <span class="keywordtype">float</span> TOC::get_fix_sing_constant()
00690  {
00691    <span class="keywordflow">return</span> sing_fix_constant;
00692   }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:48 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
