<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: Image.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>Image.cpp</h1><div class="fragment"><pre>00001 
00008 <span class="preprocessor">#include &lt;strings.h&gt;</span>
00009 <span class="preprocessor">#include &lt;fstream&gt;</span>
00010 <span class="preprocessor">#include &lt;sstream&gt;</span>
00011 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00012 <span class="preprocessor">#include "Status.hpp"</span>
00013 <span class="preprocessor">#include "Image.hpp"</span>
00014 <span class="preprocessor">#include "Log.hpp"</span>
00015 <span class="preprocessor">#include "Constant.hpp"</span>
00016 <span class="preprocessor">#include "MOLAR.hpp"</span>
00017 
<a name="l00018"></a><a class="code" href="classImage.html#a0">00018</a> <a class="code" href="classImage.html#a0">Image::Image</a>(<a class="code" href="structParams_1_1Geometry.html">Params::Geometry</a> &amp;geometry, string fileType, string dataType) {
00019         
00020   <span class="comment">//            Image::geometry = geometry;</span>
00021   <span class="comment">//            memset(&amp;imageFileInfo, 0, sizeof(struct fileInfo));</span>
00022   imageFileInfo.dataset_attr.fileType = fileType;
00023   imageFileInfo.dataset_attr.dataType = dataType;
00024   <a class="code" href="classArray3D.html#a8">init</a>(geometry.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>, geometry.<a class="code" href="structParams_1_1Geometry.html#o1">nY</a>, geometry.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>); <span class="comment">// Calling Array3D constructor</span>
00025   imageFileInfo.dataset_attr.extents[0] = geometry.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>;
00026   imageFileInfo.dataset_attr.extents[1] = geometry.<a class="code" href="structParams_1_1Geometry.html#o1">nY</a>;
00027   imageFileInfo.dataset_attr.extents[2] = geometry.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>;
00028   imageFileInfo.dataset_attr.start_locations[0] = loc1 = geometry.<a class="code" href="structParams_1_1Geometry.html#o8">offsetX</a>;
00029   imageFileInfo.dataset_attr.start_locations[1] = loc2 = geometry.<a class="code" href="structParams_1_1Geometry.html#o9">offsetY</a>;
00030   imageFileInfo.dataset_attr.start_locations[2] = loc3 = geometry.<a class="code" href="structParams_1_1Geometry.html#o10">offsetZ</a>;
00031   step1 = geometry.<a class="code" href="structParams_1_1Geometry.html#o5">dX</a>;
00032   step2 = geometry.<a class="code" href="structParams_1_1Geometry.html#o6">dY</a>;
00033   step3 = geometry.<a class="code" href="structParams_1_1Geometry.html#o7">dZ</a>;
00034   imageFileInfo.dataset_attr.resolutions[0] = geometry.<a class="code" href="structParams_1_1Geometry.html#o5">dX</a>;
00035   imageFileInfo.dataset_attr.resolutions[1] = geometry.<a class="code" href="structParams_1_1Geometry.html#o6">dY</a>;
00036   imageFileInfo.dataset_attr.resolutions[2] = geometry.<a class="code" href="structParams_1_1Geometry.html#o7">dZ</a>;
00037   <span class="comment">// Dont know how to initialise step_units &amp; imageFileInfo.dataset_attr.units for blank image-hardcoding to Millimeters        </span>
00038   imageFileInfo.dataset_attr.units[0] = step_units1 = <span class="stringliteral">"Millimeters"</span>;
00039   imageFileInfo.dataset_attr.units[1] = step_units2 = <span class="stringliteral">"Millimeters"</span>;
00040   imageFileInfo.dataset_attr.units[2] = step_units3 = <span class="stringliteral">"Millimeters"</span>;
00041                 
00042   <span class="comment">// Dont know how to initialise endianess</span>
00043   imageFileInfo.dataset_attr.endianess = L_ENDIAN;
00044   imageFileInfo.dataset_attr.imageOffset = 0;
00045   imageFileInfo.dataset_attr.slice_spacing = 0;
00046   imageFileInfo.dataset_attr.nDimensions = DIMENSIONS; <span class="comment">// Hardcoding Dimensions;</span>
00047   imageFileInfo.dataset_attr.orientation = <span class="stringliteral">"Unknown"</span>;
00048   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00049     imageFileInfo.dataset_attr.subject_axis_orientation[i] = <span class="stringliteral">"Unknown"</span>;
00050   }
00051                 
00052   <span class="comment">//Build the XML tree here</span>
00053   buildXMLTree();
00054 }
00055 
<a name="l00056"></a><a class="code" href="classImage.html#a1">00056</a> <a class="code" href="classImage.html#a0">Image::Image</a>(string filename, string fileType, string dataType, 
00057              <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> &amp;extensions) {
00058   <span class="comment">//memset(&amp;imageFileInfo, 0, sizeof(struct fileInfo));</span>
00059   imageFileInfo.dataset_attr.hdrFileName = filename;
00060   imageFileInfo.dataset_attr.fileType = fileType;
00061   imageFileInfo.dataset_attr.dataType = dataType;
00062   imageFileInfo.dataset_attr.ext = extensions;
00063   <span class="keywordflow">if</span> (!readHdr()) {
00064     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00065     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(<span class="stringliteral">"Image(string filename, string fileType, string dataType, Params::Extensions &amp;extensions): Reading the file header:"</span>+filename+<span class="stringliteral">" failed\n"</span>, FRAME, HIGH);
00066   }
00067   <span class="comment">// Array3D variables setting</span>
00068   <span class="keywordtype">int</span> d1 = imageFileInfo.dataset_attr.extents[0];
00069   <span class="keywordtype">int</span> d2 = imageFileInfo.dataset_attr.extents[1];
00070   <span class="keywordtype">int</span> d3 = imageFileInfo.dataset_attr.extents[2];
00071   step1 = imageFileInfo.dataset_attr.resolutions[0];
00072   step2 = imageFileInfo.dataset_attr.resolutions[1];
00073   step3 = imageFileInfo.dataset_attr.resolutions[2];
00074   step_units1 = imageFileInfo.dataset_attr.units[0];
00075   step_units2 = imageFileInfo.dataset_attr.units[1];
00076   step_units3 = imageFileInfo.dataset_attr.units[2];
00077   loc1 = imageFileInfo.dataset_attr.start_locations[0];
00078   loc2 = imageFileInfo.dataset_attr.start_locations[1];
00079   loc3 = imageFileInfo.dataset_attr.start_locations[2];
00080 
00081   <a class="code" href="classArray3D.html#a8">init</a>(d1, d2, d3);
00082                 
00083   <span class="keywordflow">if</span> (!readData()) {
00084     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();   
00085     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(<span class="stringliteral">"Image: Reading the file:"</span>+
00086                        imageFileInfo.dataset_attr.dataFileName
00087                        +<span class="stringliteral">" failed...aborting\n"</span>,FRAME,HIGH);
00088   }
00089 }
00090 
<a name="l00091"></a><a class="code" href="classImage.html#a2">00091</a> <a class="code" href="classImage.html#a0">Image::Image</a>(<span class="keywordtype">int</span> d1, <span class="keywordtype">int</span> d2, <span class="keywordtype">int</span> d3) : <a class="code" href="classArray3D.html">Array3D</a>&lt;float&gt;(d1,d2,d3) {
00092   imageFileInfo.dataset_attr.dataType = <span class="stringliteral">"Float"</span>;
00093   imageFileInfo.dataset_attr.endianess = L_ENDIAN;
00094   imageFileInfo.dataset_attr.imageOffset = 0;
00095   imageFileInfo.dataset_attr.slice_spacing = 0;
00096   imageFileInfo.dataset_attr.nDimensions = DIMENSIONS; 
00097   <span class="comment">// Hardcoding Dimensions;</span>
00098   imageFileInfo.dataset_attr.orientation = <span class="stringliteral">"Unknown"</span>;
00099 
00100   imageFileInfo.dataset_attr.extents[0] = d1;
00101   imageFileInfo.dataset_attr.extents[1] = d2;
00102   imageFileInfo.dataset_attr.extents[2] = d3;
00103 
00104   step1 = imageFileInfo.dataset_attr.resolutions[0] = 1.0;
00105   step2 = imageFileInfo.dataset_attr.resolutions[1] = 1.0;
00106   step3 = imageFileInfo.dataset_attr.resolutions[2] = 1.0;
00107   <span class="comment">// Dont know how to initialise step_units &amp; </span>
00108   <span class="comment">//imageFileInfo.dataset_attr.units for blank </span>
00109   <span class="comment">//image-hardcoding to Millimeters     </span>
00110   imageFileInfo.dataset_attr.units[0] = step_units1 = <span class="stringliteral">"Millimeters"</span>;
00111   imageFileInfo.dataset_attr.units[1] = step_units2 = <span class="stringliteral">"Millimeters"</span>;
00112   imageFileInfo.dataset_attr.units[2] = step_units3 = <span class="stringliteral">"Millimeters"</span>;
00113   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00114     imageFileInfo.dataset_attr.subject_axis_orientation[i] = <span class="stringliteral">"Unknown"</span>;
00115     imageFileInfo.dataset_attr.start_locations[i] = 0.0;
00116   }
00117 }
00118 
<a name="l00119"></a><a class="code" href="classImage.html#a3">00119</a> <a class="code" href="classImage.html#a0">Image::Image</a>(<a class="code" href="classImage.html">Image</a> &amp;img) : <a class="code" href="classArray3D.html">Array3D</a>&lt;float&gt;(img) {
00120   <span class="comment">//memset(&amp;imageFileInfo, 0, sizeof(struct fileInfo));</span>
00121   <a class="code" href="classImage.html#o0">xml</a> = img.xml;
00122   imageFileInfo = img.imageFileInfo;
00123 }
00124 
<a name="l00125"></a><a class="code" href="classImage.html#a4">00125</a> <a class="code" href="classImage.html">Image</a>&amp; <a class="code" href="classImage.html#a4">Image::operator=</a>(<a class="code" href="classImage.html">Image</a>&amp; img) {
00126   <span class="comment">//memset(&amp;imageFileInfo, 0, sizeof(struct fileInfo));</span>
00127   <a class="code" href="classImage.html#o0">xml</a> = img.<a class="code" href="classImage.html#o0">xml</a>;
00128   imageFileInfo = img.<a class="code" href="classImage.html#r0">imageFileInfo</a>;
00129   this-&gt;<a class="code" href="classArray3D.html#a5">Array3D&lt;float&gt;::operator=</a>(img);
00130 
00131   <span class="keywordflow">return</span> (*this);
00132 }
00133 
00134 <span class="keywordtype">int</span> Image::setDataType(string dataType) {
00135   <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"Float"</span>) != string::npos ||
00136      dataType.find(<span class="stringliteral">"float"</span>) != string::npos ||
00137      dataType.find(<span class="stringliteral">"FLOAT"</span>) != string::npos) {
00138     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos ||
00139        dataType.find(<span class="stringliteral">"Unsigned"</span>) != string::npos ||
00140        dataType.find(<span class="stringliteral">"UNSIGNED"</span>) != string::npos)
00141       <span class="keywordflow">return</span> GRAY32_UNSIGNED_FLOAT;
00142     <span class="keywordflow">else</span> 
00143       <span class="keywordflow">return</span> GRAY32_FLOAT;
00144   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"int"</span>) != string::npos ||
00145             dataType.find(<span class="stringliteral">"Int"</span>) != string::npos ||
00146             dataType.find(<span class="stringliteral">"INT"</span>) != string::npos) {
00147     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos ||
00148        dataType.find(<span class="stringliteral">"Unsigned"</span>) != string::npos ||
00149        dataType.find(<span class="stringliteral">"UNSIGNED"</span>) != string::npos)
00150       <span class="keywordflow">return</span> GRAY32_UNSIGNED_INT;
00151     <span class="keywordflow">else</span>
00152       <span class="keywordflow">return</span> GRAY32_INT;
00153   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"short"</span>) != string::npos ||
00154             dataType.find(<span class="stringliteral">"Short"</span>) != string::npos ||
00155             dataType.find(<span class="stringliteral">"SHORT"</span>) != string::npos) {
00156     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos ||
00157        dataType.find(<span class="stringliteral">"Unsigned"</span>) != string::npos ||
00158        dataType.find(<span class="stringliteral">"UNSIGNED"</span>) != string::npos)
00159       <span class="keywordflow">return</span> GRAY16_UNSIGNED_SHORT;
00160     <span class="keywordflow">else</span>
00161       <span class="keywordflow">return</span> GRAY16_SHORT;
00162   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"byte"</span>) != string::npos ||
00163             dataType.find(<span class="stringliteral">"Byte"</span>) != string::npos ||
00164             dataType.find(<span class="stringliteral">"BYTE"</span>) != string::npos) {
00165     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos ||
00166        dataType.find(<span class="stringliteral">"Unsigned"</span>) != string::npos ||
00167        dataType.find(<span class="stringliteral">"UNSIGNED"</span>) != string::npos)
00168       <span class="keywordflow">return</span> GRAY8_UNSIGNED_BYTE;
00169     <span class="keywordflow">else</span>
00170       <span class="keywordflow">return</span> GRAY8_BYTE;
00171   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"bool"</span>) != string::npos ||
00172             dataType.find(<span class="stringliteral">"Bool"</span>) != string::npos ||
00173             dataType.find(<span class="stringliteral">"BOOL"</span>) != string::npos) {
00174     <span class="keywordflow">return</span> GRAY1_BOOLEAN;
00175   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"double"</span>) != string::npos ||
00176             dataType.find(<span class="stringliteral">"DOUBLE"</span>) != string::npos ||
00177             dataType.find(<span class="stringliteral">"Double"</span>) != string::npos) {
00178     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos ||
00179        dataType.find(<span class="stringliteral">"Unsigned"</span>) != string::npos ||
00180        dataType.find(<span class="stringliteral">"UNSIGNED"</span>) != string::npos)
00181       <span class="keywordflow">return</span> GRAY64_UNSIGNED_DOUBLE;
00182     <span class="keywordflow">else</span>
00183       <span class="keywordflow">return</span> GRAY64_DOUBLE;
00184   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"RGB"</span>) != string::npos ||
00185             dataType.find(<span class="stringliteral">"rgb"</span>) != string::npos ||
00186             dataType.find(<span class="stringliteral">"Rgb"</span>) != string::npos) {
00187     <span class="keywordflow">return</span> GRAY64_RGB;
00188   } <span class="keywordflow">else</span> {
00189     <span class="comment">//Setting the default to Float since Image class is hardcoded to Array3D&lt;float&gt;</span>
00190     <span class="keywordflow">return</span> GRAY32_FLOAT;
00191   }
00192 }
00193 
00194 <span class="keywordtype">int</span> Image::setFileType() {
00195   string fileType = imageFileInfo.dataset_attr.fileType;
00196   <span class="keywordflow">if</span>(fileType.find(<span class="stringliteral">"xml"</span>) != string::npos) {
00197     <span class="keywordflow">return</span> XML;
00198   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fileType.find(<span class="stringliteral">"analyze"</span>) != string::npos) {
00199     <span class="keywordflow">return</span> ANALYZE;
00200   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileType.find(<span class="stringliteral">"interfile"</span>) != string::npos) {
00201     <span class="keywordflow">return</span> INTERFILE;
00202   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileType.find(<span class="stringliteral">"dicom"</span>) != string::npos) {
00203     <span class="keywordflow">return</span> DICOM;
00204   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fileType.find(<span class="stringliteral">"raw"</span>) != string::npos) {
00205     <span class="keywordflow">return</span> RAW;
00206   } <span class="keywordflow">else</span> {
00207     <span class="keywordflow">return</span> ANALYZE;
00208   }
00209 }       
00210 
<a name="l00211"></a><a class="code" href="classImage.html#a6">00211</a> string <a class="code" href="classImage.html#a6">Image::getDataType</a>() {
00212   <span class="keywordflow">return</span> imageFileInfo.dataset_attr.dataType;
00213 }
00214 
<a name="l00215"></a><a class="code" href="classImage.html#a5">00215</a> string <a class="code" href="classImage.html#a5">Image::getFileType</a>() {
00216   <span class="keywordflow">return</span> imageFileInfo.dataset_attr.fileType;
00217 }
00218 
00219 <span class="keywordtype">void</span> Image::setEndianess(string endianess) {
00220   <span class="keywordflow">if</span>(endianess.find(<span class="stringliteral">"Little"</span>) != string::npos ||        
00221      endianess.find(<span class="stringliteral">"little"</span>) != string::npos || 
00222      endianess.find(<span class="stringliteral">"LITTLE"</span>) != string::npos)
00223     imageFileInfo.dataset_attr.endianess = L_ENDIAN;
00224   <span class="keywordflow">else</span> 
00225     imageFileInfo.dataset_attr.endianess = B_ENDIAN;
00226 }       
00227 
00228 string Image::getEndianess() {
00229   <span class="keywordflow">if</span>( imageFileInfo.dataset_attr.endianess == L_ENDIAN) {
00230     <span class="keywordflow">return</span> <span class="stringliteral">"Little"</span>;
00231   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( imageFileInfo.dataset_attr.endianess == B_ENDIAN) {
00232     <span class="keywordflow">return</span> <span class="stringliteral">"Big"</span>;
00233   } <span class="keywordflow">else</span> {
00234     <span class="comment">//Setting Default to Big Endian</span>
00235     <span class="keywordflow">return</span> <span class="stringliteral">"Big"</span>;
00236   }
00237 }       
00238 
00239 <span class="comment">// The is read operation reads the specified file based</span>
00240 <span class="comment">//  on the geometry, datatype and filetype params</span>
<a name="l00241"></a><a class="code" href="classImage.html#a7">00241</a> <span class="keywordtype">bool</span> <a class="code" href="classImage.html#a7">Image::read</a>(string fileName, <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> &amp;ext) {
00242   imageFileInfo.dataset_attr.hdrFileName = fileName;
00243   imageFileInfo.dataset_attr.ext = ext;
00244   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00245 
00246   <span class="keywordflow">if</span>(readHdr()) {
00247                 
00248     <span class="keywordflow">if</span>(readData()) {
00249 <span class="preprocessor">#ifdef DEBUG3</span>
00250 <span class="preprocessor"></span>      cout &lt;&lt; <span class="stringliteral">"Image::read: Image read successful\n"</span>;
00251 <span class="preprocessor">#endif</span>
00252 <span class="preprocessor"></span>      <span class="keywordflow">return</span> <span class="keyword">true</span>;
00253     } <span class="keywordflow">else</span> {
00254       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(<span class="stringliteral">"Image::read: Image read unsuccessful\n"</span>, 
00255                          FRAME, HIGH);
00256       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00257     }
00258   } <span class="keywordflow">else</span> {
00259     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::read: Image read header failed\n"</span>, 
00260                         FRAME, HIGH);
00261     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00262   }
00263 }
00264 
00265 <span class="keywordtype">bool</span> Image::readHdr() {
00266   <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> ext = imageFileInfo.dataset_attr.ext;
00267   string hdrFileName = imageFileInfo.dataset_attr.hdrFileName;
00268 
00269   <span class="keywordflow">if</span> (hdrFileName == <span class="stringliteral">""</span>) {
00270     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00271 
00272     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readHdr: FileName not set -- Cannot read file \n"</span>, FRAME, HIGH);
00273     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00274   }
00275   <span class="comment">/*</span>
00276 <span class="comment">    if(strcmp(imageFileInfo.dataset_attr.fileType.c_str(), "") != 0) {</span>
00277 <span class="comment">    #ifdef DEBUG3</span>
00278 <span class="comment">    cout &lt;&lt; "Image::readHdr: file type is set\n";</span>
00279 <span class="comment">    #endif      </span>
00280 <span class="comment">    int fType = setFileType();</span>
00281 <span class="comment">                        </span>
00282 <span class="comment">    switch(fType) {</span>
00283 <span class="comment">    case ANALYZE:</span>
00284 <span class="comment">    #ifdef DEBUG3</span>
00285 <span class="comment">    cout &lt;&lt; "Image::readHdr: Analyze Image\n";</span>
00286 <span class="comment">    #endif      </span>
00287 <span class="comment">    return analyzeReadHdr();</span>
00288 <span class="comment">    break;</span>
00289 <span class="comment">    case INTERFILE:</span>
00290 <span class="comment">    #ifdef DEBUG3</span>
00291 <span class="comment">    cout &lt;&lt; "Image::readHdr: Interfile Image\n";</span>
00292 <span class="comment">    #endif      </span>
00293 <span class="comment">    return interfileReadHdr();</span>
00294 <span class="comment">    break;</span>
00295 <span class="comment">    case DICOM:</span>
00296 <span class="comment">    #ifdef DEBUG3</span>
00297 <span class="comment">    cout &lt;&lt; "Image::readHdr: Dicom Image\n";</span>
00298 <span class="comment">    #endif      </span>
00299 <span class="comment">    return dicomReadHdr();</span>
00300 <span class="comment">    break;</span>
00301 <span class="comment">    case XML:</span>
00302 <span class="comment">    #ifdef DEBUG3</span>
00303 <span class="comment">    cout &lt;&lt; "Image::readHdr: XML Image\n";</span>
00304 <span class="comment">    #endif      </span>
00305 <span class="comment">    return xmlReadHdr();</span>
00306 <span class="comment">    break;</span>
00307 <span class="comment">    case RAW: // directly read data</span>
00308 <span class="comment">    imageFileInfo.dataset_attr.dataFileName = </span>
00309 <span class="comment">    imageFileInfo.dataset_attr.hdrFileName; </span>
00310 <span class="comment">    // Since raw images dont have headers</span>
00311 <span class="comment">    imageFileInfo.dataset_attr.nDimensions = DIMENSIONS; </span>
00312 <span class="comment">    // HARDCODING Dimensions</span>
00313 <span class="comment">    #ifdef DEBUG3</span>
00314 <span class="comment">    cout &lt;&lt; "Image::readHdr: Raw Image\n";</span>
00315 <span class="comment">    #endif      </span>
00316 <span class="comment">    return true;</span>
00317 <span class="comment">    break;</span>
00318 <span class="comment">    default:</span>
00319 <span class="comment">    break;</span>
00320 <span class="comment">    }</span>
00321 <span class="comment">    } </span>
00322 <span class="comment">  */</span>
00323   <span class="keywordflow">if</span> (ext.<a class="code" href="structParams_1_1Extensions.html#o0">xml</a> != <span class="stringliteral">""</span> || ext.<a class="code" href="structParams_1_1Extensions.html#o2">raw</a> != <span class="stringliteral">""</span> || ext.<a class="code" href="structParams_1_1Extensions.html#o3">dicom</a> != <span class="stringliteral">""</span> || 
00324       ext.<a class="code" href="structParams_1_1Extensions.html#o5">interfile</a> != <span class="stringliteral">""</span> || ext.<a class="code" href="structParams_1_1Extensions.html#o4">analyze</a> != <span class="stringliteral">""</span>) {
00325     <span class="keywordtype">int</span> dot = 0;
00326     <span class="keywordflow">if</span>((dot = hdrFileName.find_last_of(<span class="stringliteral">"."</span>)) == string::npos) {
00327       <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00328       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readHdr: FileName's extension not set -- Cannot read file \n"</span>, FRAME, HIGH);
00329       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00330     }
00331     string ex = hdrFileName.substr(dot+1);
00332 
00333     <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o0">xml</a>) {
00334       <span class="keywordflow">return</span> xmlReadHdr();
00335     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o3">dicom</a>) {
00336       <span class="keywordflow">return</span> dicomReadHdr();
00337     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o5">interfile</a>) {
00338       <span class="keywordflow">return</span> interfileReadHdr();
00339     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o4">analyze</a>) {
00340       <span class="keywordflow">return</span> analyzeReadHdr();
00341     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ex == ext.<a class="code" href="structParams_1_1Extensions.html#o2">raw</a>) { <span class="comment">// Directly read data</span>
00342       imageFileInfo.dataset_attr.dataFileName = 
00343         imageFileInfo.dataset_attr.hdrFileName; 
00344         <span class="comment">// Since raw images dont have headers</span>
00345       imageFileInfo.dataset_attr.nDimensions = DIMENSIONS; 
00346         <span class="comment">// HARDCODING Dimensions</span>
00347       <span class="keywordflow">return</span> <span class="keyword">true</span>; 
00348     } <span class="keywordflow">else</span> {
00349       <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00350 
00351       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readHdr: FileName's:"</span>+hdrFileName+<span class="stringliteral">" extension unknown - Not in the Extensions structure -- Cannot read file \n"</span>, FRAME, HIGH);
00352       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00353     }
00354   } <span class="keywordflow">else</span> {
00355     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00356 
00357     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readHdr: Extensions not set  and fileType not known -- Cannot read file:"</span>+hdrFileName+<span class="stringliteral">" \n"</span>, FRAME, HIGH);
00358     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00359   }
00360   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00361 }
<a name="l00362"></a><a class="code" href="classImage.html#a8">00362</a> <span class="keywordtype">bool</span> <a class="code" href="classImage.html#a8">Image::write</a>(string filename, <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> &amp;ext, <a class="code" href="classImage.html">Image</a> &amp;Q, 
00363                   Params &amp;params, <a class="code" href="classArray3D.html">Array3D&lt;char&gt;</a> &amp;lambdaMask) 
00364 {
00365   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0; iz &lt; params.geometry.nZ; iz++)
00366     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0; iy&lt;params.geometry.nY; iy++)
00367       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0; ix&lt; params.geometry.nX; ix++)
00368           (*this)(ix,iy,iz) *= lambdaMask(ix,iy,iz);
00369   
00370   <span class="keywordflow">return</span> (<a class="code" href="classImage.html#a8">write</a>(filename, ext));
00371 }
00372 
00373 
00374 <span class="keywordtype">bool</span> <a class="code" href="classImage.html#a8">Image::write</a>(string filename, <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> &amp;ext) {
00375 
00376   <span class="keywordtype">bool</span> result = <span class="keyword">false</span>;
00377 <span class="preprocessor">#ifdef DEBUG3</span>
00378 <span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">"Image::write: Writing into "</span>&lt;&lt;filename&lt;&lt;<span class="stringliteral">"\n"</span>;
00379 <span class="preprocessor">#endif</span>
00380 <span class="preprocessor"></span>
00381   imageFileInfo.dataset_attr.hdrFileName = filename;
00382   imageFileInfo.dataset_attr.ext = ext;
00383 
00384   string hdrFileName = imageFileInfo.dataset_attr.hdrFileName;
00385 
00386   <span class="keywordflow">if</span> (hdrFileName == <span class="stringliteral">""</span>) {
00387     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00388 
00389     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::write: FileName not set -- Cannot read file \n"</span>, FRAME, HIGH);
00390     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00391   }
00392 
00393   <span class="comment">// DataType when writing will always be Float</span>
00394   imageFileInfo.dataset_attr.dataType = <span class="stringliteral">"Float"</span>;
00395                 
00396   <span class="keywordflow">if</span>(strcmp(imageFileInfo.dataset_attr.fileType.c_str(), <span class="stringliteral">""</span>) != 0) {
00397 <span class="preprocessor">#ifdef DEBUG3</span>
00398 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::write: file type is set\n"</span>;
00399 <span class="preprocessor">#endif  </span>
00400 <span class="preprocessor"></span>    <span class="keywordtype">int</span> fType = setFileType();
00401                         
00402     <span class="keywordflow">switch</span>(fType) {
00403     <span class="keywordflow">case</span> ANALYZE:
00404       result = analyzeWriteHdr();
00405       <span class="keywordflow">break</span>;
00406     <span class="keywordflow">case</span> INTERFILE:
00407       result = interfileWriteHdr();
00408       <span class="keywordflow">break</span>;
00409     <span class="keywordflow">case</span> DICOM:
00410       result = dicomWriteHdr();
00411       <span class="keywordflow">break</span>;
00412     <span class="keywordflow">case</span> XML:
00413       result = xmlWriteHdr();
00414       <span class="keywordflow">break</span>;
00415     <span class="keywordflow">case</span> RAW: <span class="comment">// directly write data</span>
00416       result = <span class="keyword">true</span>;
00417       <span class="keywordflow">break</span>;
00418     <span class="keywordflow">default</span>:
00419       result = <span class="keyword">false</span>;
00420       <span class="keywordflow">break</span>;
00421     }
00422   } 
00423   <span class="keywordflow">if</span> (ext.<a class="code" href="structParams_1_1Extensions.html#o0">xml</a> != <span class="stringliteral">""</span> &amp;&amp; ext.<a class="code" href="structParams_1_1Extensions.html#o2">raw</a> != <span class="stringliteral">""</span> &amp;&amp; ext.<a class="code" href="structParams_1_1Extensions.html#o3">dicom</a> != <span class="stringliteral">""</span> &amp;&amp; 
00424       ext.<a class="code" href="structParams_1_1Extensions.html#o5">interfile</a> != <span class="stringliteral">""</span> &amp;&amp; ext.<a class="code" href="structParams_1_1Extensions.html#o4">analyze</a> != <span class="stringliteral">""</span> &amp;&amp; !result) {
00425 
00426     <span class="keywordtype">int</span> dot = 0;
00427     <span class="keywordflow">if</span>((dot = hdrFileName.find_last_of(<span class="stringliteral">"."</span>)) == string::npos) {
00428       <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00429 
00430       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::write: FileName's extension not set -- Cannot read file:"</span>+hdrFileName+<span class="stringliteral">" \n"</span>, FRAME, HIGH);
00431       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00432     }
00433     string ex = hdrFileName.substr(dot+1);
00434 
00435 <span class="preprocessor">#ifdef DEBUG3</span>
00436 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::write: File Extensions is:"</span>&lt;&lt;ex&lt;&lt;<span class="stringliteral">"\n"</span>;
00437 <span class="preprocessor">#endif</span>
00438 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o0">xml</a>) {
00439       result = xmlWriteHdr();
00440     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o3">dicom</a>) {
00441       result = dicomWriteHdr();
00442     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o5">interfile</a>) {
00443       result = interfileWriteHdr();
00444     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o4">analyze</a>) {
00445       result = analyzeWriteHdr();
00446     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ex == ext.<a class="code" href="structParams_1_1Extensions.html#o2">raw</a>) { <span class="comment">// directly write data</span>
00447       result = <span class="keyword">true</span>;
00448     } <span class="keywordflow">else</span> {
00449       <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00450 
00451       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::write: FileName's extension unknown - Not in the Extensions structure -- Cannot read file:"</span>+hdrFileName+<span class="stringliteral">" \n"</span>, FRAME, HIGH);
00452       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00453     }
00454                 
00455   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!result) {
00456     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00457 
00458     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::write: Not able to determine the output file type or extensions\n"</span>, FRAME, HIGH);
00459     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00460   }
00461         
00462   <span class="keywordflow">if</span>(result) {
00463     <span class="keywordflow">return</span> writeData(); 
00464   } <span class="keywordflow">else</span> {
00465     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00466   }
00467 }
00468 
<a name="l00469"></a><a class="code" href="classImage.html#a10">00469</a> <span class="keywordtype">bool</span> <a class="code" href="classImage.html#a8">Image::write</a>(string filename, XMLTree &amp;newTree, 
00470                   <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> &amp;ext) {
00471   <span class="keywordflow">if</span>(<a class="code" href="classImage.html#o0">xml</a>.empty) {
00472 
00473 <span class="preprocessor">#ifdef DEBUG3</span>
00474 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::write: XML Tree is empty.. constructing a new tree\n"</span>;
00475 <span class="preprocessor">#endif</span>
00476 <span class="preprocessor"></span>    buildXMLTree();     
00477   }
00478 
00479   <span class="comment">// Inserting the Status or the Params xml trees under image ?? TBD...</span>
00480   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTree(<span class="stringliteral">"image"</span>, newTree, <span class="stringliteral">""</span>,<span class="stringliteral">""</span>,<span class="stringliteral">""</span>))
00481     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00482   <span class="keywordflow">if</span> (!<a class="code" href="classImage.html#a8">write</a>(filename, ext)) {  
00483     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00484   }
00485   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00486 }
00487 
00488 <span class="comment">// Private functions</span>
00489 
00490 string Image::getReqdAttributes(string attributes, string searchstr) {
00491   string value=<span class="stringliteral">""</span>;
00492   <span class="keywordflow">if</span>(attributes.find(searchstr) != string::npos) {
00493 
00494     <span class="keywordtype">int</span> idx = attributes.find(searchstr);
00495     string tmpStr = attributes.substr(idx+searchstr.length());
00496     idx = tmpStr.find(<span class="stringliteral">"="</span>);
00497     tmpStr = tmpStr.substr(idx+1);
00498     <span class="keywordflow">if</span> ((idx = tmpStr.find_first_of(<span class="stringliteral">"\""</span>)) != string::npos)
00499       {
00500         tmpStr = tmpStr.substr(idx+1);
00501         idx = tmpStr.find_first_of(<span class="stringliteral">"\""</span>);
00502         value = tmpStr.substr(0, idx);
00503       } <span class="keywordflow">else</span> {
00504         idx = tmpStr.find_first_of(<span class="stringliteral">" "</span>);
00505         value = tmpStr.substr(0, idx);
00506       }
00507   }
00508   <span class="keywordflow">return</span> value;
00509 }
00510 
00511 <span class="keywordtype">bool</span> Image::setReqdAttributes(string &amp;attributes, string searchstr,
00512                               string value) {
00513 <span class="preprocessor">#ifdef DEBUG3</span>
00514 <span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">"Image::setReqdAttributes: params are:"</span>
00515        &lt;&lt;attributes&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;searchstr&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;value&lt;&lt;<span class="stringliteral">"\n"</span>;
00516 <span class="preprocessor">#endif</span>
00517 <span class="preprocessor"></span>  attributes = <a class="code" href="classUtilities.html#e10">Utilities::trim</a>(attributes);
00518   searchstr = <a class="code" href="classUtilities.html#e10">Utilities::trim</a>(searchstr);
00519   value = <a class="code" href="classUtilities.html#e10">Utilities::trim</a>(value);
00520 
00521   <span class="keywordflow">if</span>(attributes.find(searchstr) != string::npos) {
00522 
00523     string oldVal;
00524     <span class="keywordtype">int</span> idx = attributes.find(searchstr);
00525     string tmpStr = attributes.substr(idx+searchstr.length());
00526     <span class="keywordtype">int</span> strIdx = idx+searchstr.length();
00527     idx = tmpStr.find(<span class="stringliteral">"="</span>);
00528 
00529     strIdx += idx+1;
00530                         
00531     tmpStr = tmpStr.substr(idx+1);
00532     <span class="keywordflow">if</span> ((idx = tmpStr.find_first_of(<span class="stringliteral">"\""</span>)) != string::npos)
00533       {
00534         strIdx += idx+1;
00535         tmpStr = tmpStr.substr(idx+1);
00536         idx = tmpStr.find_first_of(<span class="stringliteral">"\""</span>);
00537         oldVal = tmpStr.substr(0, idx);
00538       } <span class="keywordflow">else</span> {
00539         idx = tmpStr.find_first_of(<span class="stringliteral">" "</span>);
00540         oldVal = tmpStr.substr(0, idx);
00541       }
00542     attributes.replace(strIdx, oldVal.length(), value);
00543   } <span class="keywordflow">else</span> {
00544     attributes += <span class="stringliteral">" "</span>+searchstr+<span class="stringliteral">"=\""</span>+value+<span class="stringliteral">"\""</span>;
00545   }
00546 <span class="preprocessor">#ifdef DEBUG3</span>
00547 <span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">"Image::setReqdAttributes: params are:"</span>
00548        &lt;&lt;attributes&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;searchstr&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;value&lt;&lt;<span class="stringliteral">"\n"</span>;
00549 <span class="preprocessor">#endif</span>
00550 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;
00551                 
00552 }
00553 
00554 <span class="keywordtype">bool</span> Image::xmlReadHdr() {
00555                 
00556   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.parseFile(imageFileInfo.dataset_attr.hdrFileName)) {
00557     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00558   }
00559 
00560   string curSubTree = <span class="stringliteral">"image"</span>;
00561   string nDim=<span class="stringliteral">""</span>;
00562   string value=<span class="stringliteral">""</span>;
00563   string attributes=<span class="stringliteral">""</span>;
00564   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00565   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00566 
00567   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">""</span>,value,attributes)) { 
00568     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Required Image tag Attributes not found in header -- Cannot read file\n"</span>, FRAME, HIGH);
00569     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00570   }             
00571   <span class="keywordflow">if</span>((nDim = getReqdAttributes(attributes, <span class="stringliteral">"nDimensions"</span>)) == <span class="stringliteral">""</span>) {
00572     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): nDimensions not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00573     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00574   }
00575 
00576   imageFileInfo.dataset_attr.nDimensions = atoi(nDim.c_str());
00577                 
00578   <span class="keywordflow">if</span>((imageFileInfo.dataset_attr.dataFileName = 
00579       getReqdAttributes(attributes, <span class="stringliteral">"filename"</span>)) == <span class="stringliteral">""</span>) { 
00580     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Image data filename not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00581     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00582   }             
00583 
00584   curSubTree = <span class="stringliteral">"image/Dataset-attributes"</span>;
00585   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Data-type"</span>, 
00586                       imageFileInfo.dataset_attr.dataType)) {
00587     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Data Type not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00588     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00589   }             
00590   string endianess;     
00591   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Endianess"</span>, endianess)) {
00592     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Endianess not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00593     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00594   }             
00595   setEndianess(endianess);
00596                 
00597   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">true</span>;
00598   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00599     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00600     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Extents"</span>, 
00601                         imageFileInfo.dataset_attr.extents[i])) {
00602       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Extents not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00603       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00604     }
00605   }             
00606   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00607     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00608     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Resolutions"</span>, 
00609                         imageFileInfo.dataset_attr.resolutions[i])) {
00610       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Resolutions not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00611       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00612     }
00613   }
00614 
00615   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00616     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00617     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Units"</span>, 
00618                         imageFileInfo.dataset_attr.units[i])) {
00619       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr(): Units not found in the file -- Cannot read file\n"</span>, FRAME, HIGH);
00620       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00621     }
00622   }
00623 
00624   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00625     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00626     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Start-locations"</span>, 
00627                         imageFileInfo.dataset_attr.start_locations[i])) {
00628       <span class="comment">//DEBUG log-&gt;outputMessage( "Image::xmlReadHdr: Warning: </span>
00629       <span class="comment">//Start-locations not found in the file\n";</span>
00630       imageFileInfo.dataset_attr.start_locations[i]=0.0;
00631     }
00632 
00633   }
00634 
00635   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00636     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00637     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Subject-axis-orientation"</span>, 
00638                imageFileInfo.dataset_attr.subject_axis_orientation[i])) {
00639       <span class="comment">//DEBUG log-&gt;outputMessage( "Image::xmlReadHdr: Warning: Subject-axis-orientation not found in the file\n";</span>
00640       imageFileInfo.dataset_attr.subject_axis_orientation[i] = <span class="stringliteral">"Unknown"</span>;
00641     }
00642   }
00643 
00644   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Image-offset"</span>, 
00645                       imageFileInfo.dataset_attr.imageOffset)) {
00646     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr: Warning: Image-offset not found in the file\n"</span>, FRAME, DEBUGL);
00647     imageFileInfo.dataset_attr.imageOffset = 0;
00648   }             
00649 
00650   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Slice-spacing"</span>, 
00651                       imageFileInfo.dataset_attr.slice_spacing)) {
00652     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlReadHdr: Warning: Slice-spacing not found in the file\n"</span>, FRAME, DEBUGL);
00653     imageFileInfo.dataset_attr.slice_spacing = 0;
00654   }             
00655 
00656   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.getTagValue(curSubTree, <span class="stringliteral">"Orientation"</span>, imageFileInfo.dataset_attr.orientation)) {
00657     <span class="comment">//DEBUG log-&gt;outputMessage( "Image::xmlReadHdr: Warning: Orientation not found in the file\n";</span>
00658     imageFileInfo.dataset_attr.orientation = <span class="stringliteral">"Unknown"</span>;
00659   }             
00660 
00661   loc1 = imageFileInfo.dataset_attr.start_locations[0];
00662   loc2 = imageFileInfo.dataset_attr.start_locations[1];
00663   loc3 = imageFileInfo.dataset_attr.start_locations[2];
00664   step1 = imageFileInfo.dataset_attr.resolutions[0];
00665   step2 = imageFileInfo.dataset_attr.resolutions[1];
00666   step3 = imageFileInfo.dataset_attr.resolutions[2];
00667   step_units1 = imageFileInfo.dataset_attr.units[0];
00668   step_units2 = imageFileInfo.dataset_attr.units[1];
00669   step_units3 = imageFileInfo.dataset_attr.units[2];
00670 
00671   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00672 }
00673 
00674 <span class="keywordtype">bool</span> Image::buildXMLTree() {
00675   <a class="code" href="classImage.html#o0">xml</a>.empty = <span class="keyword">false</span>;
00676   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00677 
00678   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(<span class="stringliteral">""</span>, <span class="stringliteral">"image"</span>)) {
00679     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">" Image::buildXMLTree: Inserting a new 'image' tag failed\n"</span>, FRAME, HIGH);
00680     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00681   }
00682 
00683   string nDims=<span class="stringliteral">""</span>, attributes=<span class="stringliteral">""</span>;
00684   stringstream ss;
00685 
00686   ss &lt;&lt; imageFileInfo.dataset_attr.nDimensions;
00687   ss &gt;&gt; nDims;
00688 
00689   <span class="keywordflow">if</span>(!setReqdAttributes(attributes, string(<span class="stringliteral">"xmlns:xsi"</span>), 
00690                         <span class="stringliteral">"http://www.w3.org/2001/XMLSchema-instance"</span>)) {
00691     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">" Image::buildXMLTree: Inserting a new xmlns:xsi attribute to image tag failed\n"</span>, FRAME, DEBUGL);
00692     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00693   }
00694 
00695   <span class="keywordflow">if</span>(!setReqdAttributes(attributes, string(<span class="stringliteral">"nDimensions"</span>), nDims)) {
00696     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">" Image::buildXMLTree: Inserting a new nDimensions attribute to image tag failed\n"</span>, FRAME, HIGH);
00697     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00698   }
00699 
00700   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00701   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(<span class="stringliteral">"image"</span>,<span class="stringliteral">""</span>,<span class="stringliteral">""</span>, attributes)) {
00702     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new image tag failed\n"</span>, FRAME, HIGH);
00703     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00704   }
00705 
00706   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(<span class="stringliteral">"image"</span>, <span class="stringliteral">"Dataset-attributes"</span>)) {
00707     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Dataset-attributes tag failed\n"</span>, FRAME, HIGH);
00708     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00709   }
00710 
00711   string curSubTree = <span class="stringliteral">"image/Dataset-attributes"</span>;
00712   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Image-offset"</span>)) {
00713     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Image-offset tag failed\n"</span>, FRAME, HIGH);
00714     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00715   }
00716 
00717   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Image-offset"</span>, 
00718                       imageFileInfo.dataset_attr.imageOffset)) {
00719     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Image-offset tag failed\n"</span>, FRAME, HIGH);
00720     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00721   }
00722 
00723   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Data-type"</span>)) {
00724     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Data-type tag failed\n"</span>, FRAME, HIGH);
00725     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00726   }
00727 
00728   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Data-type"</span>, 
00729                       imageFileInfo.dataset_attr.dataType)) {
00730     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Data-type tag failed\n"</span>, FRAME, HIGH);
00731     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00732   }
00733 
00734   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Endianess"</span>)) {
00735     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Endianess tag failed\n"</span>, FRAME, HIGH);
00736     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00737   }
00738   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Endianess"</span>, 
00739                       getEndianess())) {
00740     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Endianess tag failed\n"</span>, FRAME, HIGH);
00741     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00742   }
00743 
00744   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">true</span>;
00745   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00746     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Extents"</span>)) {
00747       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Extents tag failed\n"</span>, FRAME, HIGH);
00748       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00749     }
00750 <span class="preprocessor">#ifdef DEBUG3</span>
00751 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::buildXMLTree: Extents["</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"]:"</span>
00752          &lt;&lt;imageFileInfo.dataset_attr.extents[i]&lt;&lt;<span class="stringliteral">"\n"</span>;
00753 <span class="preprocessor">#endif</span>
00754 <span class="preprocessor"></span>    <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00755     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Extents"</span>, 
00756                         imageFileInfo.dataset_attr.extents[i])) {
00757       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Extents tag failed\n"</span>, FRAME, HIGH);
00758       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00759     }
00760   }
00761   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00762     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Resolutions"</span>)) {
00763       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Resolutions tag failed\n"</span>, FRAME, HIGH);
00764       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00765     }
00766 <span class="preprocessor">#ifdef DEBUG3</span>
00767 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::buildXMLTree: resolutions["</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"]:"</span>
00768          &lt;&lt;imageFileInfo.dataset_attr.resolutions[i]&lt;&lt;<span class="stringliteral">"\n"</span>;
00769 <span class="preprocessor">#endif</span>
00770 <span class="preprocessor"></span>    <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00771     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Resolutions"</span>, 
00772                         imageFileInfo.dataset_attr.resolutions[i])) {
00773       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Resolutions tag failed\n"</span>, FRAME, HIGH);
00774       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00775     }
00776   }
00777 
00778   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00779   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Slice-spacing"</span>)) {
00780     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Slice-spacing tag failed\n"</span>, FRAME, DEBUGL);
00781     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00782   }
00783   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Slice-spacing"</span>, 
00784                       imageFileInfo.dataset_attr.slice_spacing)) {
00785     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Slice-spacing tag failed\n"</span>, FRAME, DEBUGL);
00786     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00787   }
00788 
00789   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">true</span>;
00790   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00791     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Units"</span>)) {
00792       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Units tag failed\n"</span>, FRAME, HIGH);
00793       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00794     }
00795     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00796     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Units"</span>, 
00797                         imageFileInfo.dataset_attr.units[i])) {
00798       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Units tag failed\n"</span>, FRAME, HIGH);
00799       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00800     }
00801   }
00802   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00803   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Orientation"</span>)) {
00804     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Orientation tag failed\n"</span>, FRAME, DEBUGL);
00805     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00806   }
00807   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Orientation"</span>, 
00808                       imageFileInfo.dataset_attr.orientation)) {
00809     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to Orientation tag failed\n"</span>, FRAME, DEBUGL);
00810     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00811   }
00812   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">true</span>;
00813   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00814     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Subject-axis-orientation"</span>)) {
00815       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Subject-axis-orientation tag failed\n"</span>, FRAME, DEBUGL);
00816       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00817     }
00818 <span class="preprocessor">#ifdef DEBUG3</span>
00819 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::buildXMLTree: Subject-axis-orientation["</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"]:"</span>
00820          &lt;&lt;imageFileInfo.dataset_attr.subject_axis_orientation[i]&lt;&lt;<span class="stringliteral">"\n"</span>;
00821 <span class="preprocessor">#endif</span>
00822 <span class="preprocessor"></span>    <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00823     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Subject-axis-orientation"</span>, 
00824                imageFileInfo.dataset_attr.subject_axis_orientation[i])) {
00825       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to subject_axis_orientation tag failed\n"</span>, FRAME, DEBUGL);
00826       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00827     }
00828   }
00829 
00830   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00831     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Start-locations"</span>)) {
00832       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting a new Start-Locations tag failed\n"</span>, FRAME, HIGH);
00833       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00834     }
00835 <span class="preprocessor">#ifdef DEBUG3</span>
00836 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::buildXMLTree: Start-locations["</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">"]:"</span>
00837          &lt;&lt;imageFileInfo.dataset_attr.start_locations[i]&lt;&lt;<span class="stringliteral">"\n"</span>;
00838 <span class="preprocessor">#endif</span>
00839 <span class="preprocessor"></span>    <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00840     <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Start-locations"</span>, 
00841                         imageFileInfo.dataset_attr.start_locations[i])) {
00842       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::buildXMLTree: Inserting value to start_locations tag failed\n"</span>, FRAME, HIGH);
00843       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00844     }
00845   }
00846 
00847   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00848 
00849   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00850 }
00851 
00852 <span class="keywordtype">bool</span> Image::xmlWriteHdr() {
00853 
00854   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00855 <span class="preprocessor">#ifdef DEBUG3</span>
00856 <span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">"Image::xmlWriteHdr: hdrfile: "</span>
00857        &lt;&lt;imageFileInfo.dataset_attr.hdrFileName
00858        &lt;&lt;<span class="stringliteral">" in XMLWriteHeader method\n"</span>;
00859 <span class="preprocessor">#endif</span>
00860 <span class="preprocessor"></span>                
00861   <span class="keywordtype">int</span> dot = imageFileInfo.dataset_attr.hdrFileName.find_last_of(<span class="stringliteral">"."</span>);
00862 
00863   <span class="keywordflow">if</span>(dot == string::npos) {
00864     imageFileInfo.dataset_attr.dataFileName = 
00865       imageFileInfo.dataset_attr.hdrFileName+<span class="stringliteral">".raw"</span>;
00866   } <span class="keywordflow">else</span> {
00867     imageFileInfo.dataset_attr.dataFileName = 
00868       imageFileInfo.dataset_attr.hdrFileName.substr(0, dot+1)+<span class="stringliteral">"raw"</span>;
00869   } 
00870 
00871   <span class="keywordflow">if</span>(<a class="code" href="classImage.html#o0">xml</a>.empty) {
00872 
00873 <span class="preprocessor">#ifdef DEBUG3</span>
00874 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::xmlWriteHdr: XML Tree is empty.. constructing a new tree\n"</span>;
00875 <span class="preprocessor">#endif</span>
00876 <span class="preprocessor"></span>    buildXMLTree();     
00877   }
00878   string value=<span class="stringliteral">""</span>, attributes=<span class="stringliteral">""</span>;
00879   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00880   <a class="code" href="classImage.html#o0">xml</a>.getTagValue(<span class="stringliteral">"image"</span>, <span class="stringliteral">""</span>, value, attributes);
00881   setReqdAttributes(attributes, <span class="stringliteral">"filename"</span>, 
00882                     imageFileInfo.dataset_attr.dataFileName);
00883   <a class="code" href="classImage.html#o0">xml</a>.putTagValue(<span class="stringliteral">"image"</span>,<span class="stringliteral">""</span>,<span class="stringliteral">""</span>,attributes);
00884 
00885   <a class="code" href="classImage.html#o0">xml</a>.writeTreeToFile(imageFileInfo.dataset_attr.hdrFileName);
00886 
00887   string curSubTree = <span class="stringliteral">"image/Dataset-attributes"</span>;
00888   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">true</span>;
00889   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00890     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00891     <a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Extents"</span>, 
00892                     imageFileInfo.dataset_attr.extents[i]);
00893   }
00894   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00895     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00896     <a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Resolutions"</span>, 
00897                     imageFileInfo.dataset_attr.resolutions[i]);
00898   }
00899   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i&lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
00900     <a class="code" href="classImage.html#o0">xml</a>.tagCount = i+1;
00901     <a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Units"</span>, 
00902                     imageFileInfo.dataset_attr.units[i]);
00903   }
00904   <a class="code" href="classImage.html#o0">xml</a>.multipleTags = <span class="keyword">false</span>;
00905   <a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Endianess"</span>, getEndianess());
00906   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Data-type"</span>, 
00907                       imageFileInfo.dataset_attr.dataType)) {
00908     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::xmlWriteHdr: Inserting value to Data-type tag failed\n"</span>, FRAME, HIGH);
00909   }
00910 
00911   <span class="keywordflow">if</span>(!<a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Orientation"</span>, 
00912                       imageFileInfo.dataset_attr.orientation)) {
00913     <a class="code" href="classImage.html#o0">xml</a>.insertTag(curSubTree, <span class="stringliteral">"Orientation"</span>);
00914     <a class="code" href="classImage.html#o0">xml</a>.putTagValue(curSubTree, <span class="stringliteral">"Orientation"</span>, 
00915                     imageFileInfo.dataset_attr.orientation);
00916   }
00917 
00918   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00919 }
00920 
00921 <span class="keywordtype">bool</span> Image::dicomReadHdr() {
00922   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00923 }
00924 
00925 <span class="keywordtype">bool</span> Image::dicomWriteHdr() {
00926   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00927 }
00928 
00929 <span class="keywordtype">int</span> Image::readInt(ifstream &amp;fs, <span class="keywordtype">bool</span> littlendian) { 
00930   <span class="keywordtype">char</span> b0, b1, b2, b3;
00931   fs.read(&amp;b0, <span class="keyword">sizeof</span>(b0));
00932   fs.read(&amp;b1, <span class="keyword">sizeof</span>(b1));
00933   fs.read(&amp;b2, <span class="keyword">sizeof</span>(b2));
00934   fs.read(&amp;b3, <span class="keyword">sizeof</span>(b3));
00935   <span class="keywordflow">if</span>(littlendian)
00936     <span class="keywordflow">return</span> ( (((b3 &amp; 0xff) &lt;&lt; 24) | ((b2 &amp; 0xff) &lt;&lt; 16) | 
00937               ((b1 &amp; 0xff) &lt;&lt; 8) | (b0 &amp; 0xff)) );
00938   <span class="keywordflow">else</span>
00939     <span class="keywordflow">return</span> ( (((b0 &amp; 0xff) &lt;&lt; 24) | ((b1 &amp; 0xff) &lt;&lt; 16) | 
00940               ((b2 &amp; 0xff) &lt;&lt; 8) | (b3 &amp; 0xff)) );
00941 } 
00942         
00943 <span class="keywordtype">float</span> Image::readFloat(ifstream &amp;fs, <span class="keywordtype">bool</span> littlendian) { 
00944   <span class="keywordtype">int</span> i = readInt(fs, littlendian);
00945                 
00946   <span class="keywordflow">return</span>  *(<span class="keywordtype">float</span> *) &amp;i;
00947 }                
00948         
00949 <span class="keywordtype">short</span> Image::readShort(ifstream &amp;fs, <span class="keywordtype">bool</span> littlendian) { 
00950   <span class="keywordtype">char</span> b0, b1, b2, b3;
00951   fs.read(&amp;b0, <span class="keyword">sizeof</span>(b0));
00952   fs.read(&amp;b1, <span class="keyword">sizeof</span>(b1));
00953                 
00954   <span class="keywordflow">if</span>(littlendian)
00955     <span class="keywordflow">return</span> (((b1 &amp; 0xff) &lt;&lt; 8) | (b0 &amp; 0xff));
00956   <span class="keywordflow">else</span>
00957     <span class="keywordflow">return</span> (((b0 &amp; 0xff) &lt;&lt; 8) | (b1 &amp; 0xff));  
00958 }
00959 
00960 <span class="keywordtype">bool</span> Image::analyzeReadHdr() {
00961   <span class="keywordtype">int</span> size, i;
00962   <span class="keywordtype">bool</span> littlendian=<span class="keyword">false</span>;
00963   <span class="keywordtype">char</span> units[4], voxunits[8];
00964   <span class="keywordtype">char</span> orientChar;
00965   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00966                 
00967   string filename = imageFileInfo.dataset_attr.hdrFileName;
00968                 
00969   <span class="keywordtype">int</span> dot = 0;
00970   <span class="keywordflow">if</span>((dot = filename.find_last_of(<span class="stringliteral">"."</span>)) == string::npos) {
00971     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::analyzeReadHdr: FileName's extension not set -- Cannot read file \n"</span>, FRAME, HIGH);
00972     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00973   }
00974   imageFileInfo.dataset_attr.dataFileName =
00975     filename.substr(0,dot+1)+<span class="stringliteral">"img"</span>;
00976                         
00977   ifstream fs(imageFileInfo.dataset_attr.hdrFileName.c_str(), 
00978               ios::in | ios::binary);
00979   <span class="keywordflow">if</span>(!fs) 
00980     { 
00981       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(<span class="stringliteral">"Image::analyzereadHdr: Can't open file:"</span> +
00982                          filename, FRAME, HIGH); 
00983       fs.close();
00984       <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00985     } 
00986   <span class="comment">//            fs.read(hdr,sizeof(struct dsr));</span>
00987   <span class="comment">//  header_key  </span>
00988   <span class="keywordtype">char</span> ch;
00989   readInt (fs, littlendian);                            <span class="comment">// sizeof_hdr</span>
00990   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);                      <span class="comment">// data_type</span>
00991   <span class="keywordflow">for</span> (i=0; i&lt;18; i++) fs.get(ch);                      <span class="comment">// db_name </span>
00992   readInt (fs, littlendian);                            <span class="comment">// extents </span>
00993   readShort (fs, littlendian);                  <span class="comment">// session_error</span>
00994   fs.get(ch);                           <span class="comment">// regular </span>
00995   fs.get(ch);                           <span class="comment">// hkey_un0 </span>
00996 
00997   <span class="comment">// image_dimension</span>
00998 
00999   <span class="keywordtype">short</span> endian = readShort (fs, littlendian);           <span class="comment">// dim[0] </span>
01000   <span class="keywordflow">if</span> ((endian &lt; 0) || (endian &gt; 15)) { 
01001     littlendian = <span class="keyword">true</span>;
01002     imageFileInfo.dataset_attr.endianess = L_ENDIAN;
01003   } <span class="keywordflow">else</span> {
01004     imageFileInfo.dataset_attr.endianess = B_ENDIAN; 
01005   }     
01006   imageFileInfo.dataset_attr.extents[0] = readShort (fs, littlendian);          <span class="comment">// dim[1] </span>
01007   imageFileInfo.dataset_attr.extents[1] = readShort (fs, littlendian);          <span class="comment">// dim[2] </span>
01008   imageFileInfo.dataset_attr.extents[2] = readShort (fs, littlendian);          <span class="comment">// dim[3] </span>
01009   readShort (fs, littlendian);                          <span class="comment">// dim[4] </span>
01010   <span class="keywordflow">for</span> (i=0; i&lt;3; i++) readShort(fs, littlendian);       <span class="comment">// dim[5-7] </span>
01011   fs.read (units, 4);                   <span class="comment">// vox_units </span>
01012                 
01013   strncpy(voxunits, units,4); 
01014   <span class="keywordflow">for</span> (i=0; i&lt;8; i++) fs.get();         <span class="comment">// cal_units[8] </span>
01015   readShort(fs, littlendian);                           <span class="comment">// unused1</span>
01016   <span class="keywordtype">short</span> datatype = readShort(fs, littlendian);          <span class="comment">// datatype </span>
01017   <span class="keywordtype">short</span> bitsallocated = readShort(fs, littlendian);             <span class="comment">// bitpix</span>
01018   readShort (fs, littlendian);                          <span class="comment">// dim_un0</span>
01019   readFloat (fs, littlendian);                          <span class="comment">// pixdim[0] </span>
01020   imageFileInfo.dataset_attr.resolutions[0] =  
01021     readFloat(fs, littlendian); <span class="comment">// pixdim[1] </span>
01022   imageFileInfo.dataset_attr.resolutions[1] =  
01023     readFloat(fs, littlendian); <span class="comment">// pixdim[2] </span>
01024   imageFileInfo.dataset_attr.resolutions[2] = 
01025     readFloat(fs, littlendian);         <span class="comment">// pixdim[3] </span>
01026   <span class="keywordflow">for</span> (i=0; i&lt;4; i++) readFloat(fs, littlendian);       <span class="comment">// pixdim[4-7]  </span>
01027   imageFileInfo.dataset_attr.imageOffset = 
01028     (<span class="keywordtype">int</span>) readFloat(fs, littlendian);                   <span class="comment">// vox_offset</span>
01029   imageFileInfo.dataset_attr.start_locations[0] = 
01030     readFloat (fs, littlendian);                <span class="comment">// roi_scale </span>
01031   imageFileInfo.dataset_attr.start_locations[1] = 
01032     readFloat (fs, littlendian);                <span class="comment">// funused1 </span>
01033   imageFileInfo.dataset_attr.start_locations[2] = 
01034     readFloat (fs, littlendian);                        <span class="comment">// funused2 </span>
01035   readFloat (fs, littlendian);                          <span class="comment">// cal_max </span>
01036   readFloat (fs, littlendian);                          <span class="comment">// cal_min </span>
01037   readInt (fs, littlendian);                            <span class="comment">// compressed</span>
01038   readInt (fs, littlendian);                            <span class="comment">// verified  </span>
01039   <span class="comment">//   ImageStatistics s = imp.getStatistics();</span>
01040   readInt (fs, littlendian);    <span class="comment">//(int) s.max           // glmax </span>
01041   readInt (fs, littlendian);    <span class="comment">//(int) s.min           // glmin </span>
01042 
01043   <span class="comment">// data_history </span>
01044 
01045   <span class="keywordflow">for</span> (i=0; i&lt;80; i++) fs.get(ch);              <span class="comment">// descrip  </span>
01046   <span class="keywordflow">for</span> (i=0; i&lt;24; i++) fs.get(ch);              <span class="comment">// aux_file </span>
01047   fs.get(ch);
01048   orientChar = ch;                              <span class="comment">// orient </span>
01049   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);              <span class="comment">// originator </span>
01050   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);              <span class="comment">// generated </span>
01051   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);              <span class="comment">// scannum </span>
01052   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);              <span class="comment">// patient_id  </span>
01053   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);              <span class="comment">// exp_date </span>
01054   <span class="keywordflow">for</span> (i=0; i&lt;10; i++) fs.get(ch);              <span class="comment">// exp_time  </span>
01055   <span class="keywordflow">for</span> (i=0; i&lt;3; i++) fs.get(ch);               <span class="comment">// hist_un0</span>
01056   readInt (fs, littlendian);                            <span class="comment">// views </span>
01057   readInt (fs, littlendian);                            <span class="comment">// vols_added </span>
01058   readInt (fs, littlendian);                            <span class="comment">// start_field  </span>
01059   readInt (fs, littlendian);                            <span class="comment">// field_skip</span>
01060   readInt (fs, littlendian);                            <span class="comment">// omax  </span>
01061   readInt (fs, littlendian);                            <span class="comment">// omin </span>
01062   readInt (fs, littlendian);                            <span class="comment">// smax  </span>
01063   readInt (fs, littlendian);                            <span class="comment">// smin </span>
01064 
01065   fs.close();
01066    
01067   string dataType = <span class="stringliteral">""</span>;
01068                 
01069   <span class="keywordflow">switch</span> (datatype) {
01070   <span class="keywordflow">case</span> DT_NONE:
01071     dataType=<span class="stringliteral">""</span>;
01072     <span class="keywordflow">break</span>;
01073   <span class="keywordflow">case</span> DT_BINARY:
01074     dataType=<span class="stringliteral">"Bool"</span>;
01075     <span class="keywordflow">break</span>;
01076   <span class="keywordflow">case</span> DT_UNSIGNED_CHAR:
01077     dataType=<span class="stringliteral">"Unsigned Byte"</span>;
01078     <span class="keywordflow">break</span>;              
01079   <span class="keywordflow">case</span> DT_SIGNED_SHORT:
01080     dataType=<span class="stringliteral">"Short"</span>;
01081     <span class="keywordflow">break</span>;              
01082   <span class="keywordflow">case</span> DT_SIGNED_INT:
01083     dataType=<span class="stringliteral">"Int"</span>;
01084     <span class="keywordflow">break</span>;              
01085   <span class="keywordflow">case</span> DT_FLOAT:
01086     dataType=<span class="stringliteral">"Float"</span>;
01087     <span class="keywordflow">break</span>;              
01088   <span class="keywordflow">case</span> DT_COMPLEX:
01089     dataType=<span class="stringliteral">"Double"</span>;
01090     <span class="keywordflow">break</span>;              
01091   <span class="keywordflow">case</span> DT_DOUBLE:
01092     dataType=<span class="stringliteral">"Double"</span>;
01093     <span class="keywordflow">break</span>;              
01094   <span class="keywordflow">case</span> DT_RGB:
01095     dataType=<span class="stringliteral">"RGB"</span>;
01096     <span class="keywordflow">break</span>;              
01097   <span class="keywordflow">case</span> DT_ALL:
01098     dataType=<span class="stringliteral">""</span>;
01099     <span class="keywordflow">break</span>;              
01100   }  
01101 
01102   imageFileInfo.dataset_attr.dataType = dataType;
01103                 
01104   imageFileInfo.dataset_attr.nDimensions = DIMENSIONS;
01105   imageFileInfo.dataset_attr.slice_spacing = 0;
01106   string orient;
01107                 
01108   <span class="keywordflow">switch</span> (orientChar) {
01109   <span class="keywordflow">case</span> 0: 
01110     <span class="comment">//orient = "transverse unflipped";</span>
01111     orient = <span class="stringliteral">"Axial"</span>;
01112     <span class="keywordflow">break</span>;
01113   <span class="keywordflow">case</span> 1: 
01114     <span class="comment">//orient = "coronal unflipped";</span>
01115     orient = <span class="stringliteral">"Coronal"</span>;
01116     <span class="keywordflow">break</span>;
01117   <span class="keywordflow">case</span> 2: 
01118     <span class="comment">//orient = "sagittal unflipped";</span>
01119     orient = <span class="stringliteral">"Sagittal"</span>;
01120     <span class="keywordflow">break</span>;      
01121   <span class="keywordflow">case</span> 3: 
01122     orient = <span class="stringliteral">"transverse flipped"</span>;
01123     orient = <span class="stringliteral">"Axial"</span>;
01124     <span class="keywordflow">break</span>;
01125   <span class="keywordflow">case</span> 4: 
01126     orient = <span class="stringliteral">"coronal flipped"</span>;
01127     orient = <span class="stringliteral">"Coronal"</span>;
01128     <span class="keywordflow">break</span>;
01129   <span class="keywordflow">case</span> 5: 
01130     orient = <span class="stringliteral">"sagittal flipped"</span>;
01131     orient = <span class="stringliteral">"Sagittal"</span>;
01132     <span class="keywordflow">break</span>;
01133   }
01134   imageFileInfo.dataset_attr.orientation=orient;
01135   string vunits;
01136   <span class="keywordflow">if</span>(stricmp(voxunits, <span class="stringliteral">"mm"</span>) == 0) {
01137     vunits = <span class="stringliteral">"Millimeters"</span>;
01138   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(voxunits, <span class="stringliteral">"cm"</span>) == 0) {
01139     vunits = <span class="stringliteral">"Centimeters"</span>;
01140   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(voxunits, <span class="stringliteral">"um"</span>) == 0) {
01141     vunits = <span class="stringliteral">"Micrometers"</span>;
01142   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(voxunits, <span class="stringliteral">"nm"</span>) == 0) {
01143     vunits = <span class="stringliteral">"Nanometers"</span>;
01144   } <span class="keywordflow">else</span> {
01145     vunits = <span class="stringliteral">"Unknown"</span>;
01146   }
01147   imageFileInfo.dataset_attr.units[0] = vunits;
01148   imageFileInfo.dataset_attr.units[1] = vunits;
01149   imageFileInfo.dataset_attr.units[2] = vunits;
01150   imageFileInfo.dataset_attr.subject_axis_orientation[0] = <span class="stringliteral">"Unknown"</span>;
01151   imageFileInfo.dataset_attr.subject_axis_orientation[1] = <span class="stringliteral">"Unknown"</span>;
01152   imageFileInfo.dataset_attr.subject_axis_orientation[2] = <span class="stringliteral">"Unknown"</span>;
01153 <span class="preprocessor">#ifdef DEBUG3</span>
01154 <span class="preprocessor"></span>  showFileHeader();
01155 <span class="preprocessor">#endif                          </span>
01156 <span class="preprocessor"></span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;
01157 } 
01158                         
01159 <span class="keywordtype">bool</span> Image::analyzeWriteHdr() {
01160   <span class="keywordtype">short</span> bitsallocated, datatype;
01161 
01162 <span class="preprocessor">#ifdef DEBUG3</span>
01163 <span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">"Image::: analyzeWriteHdr hdrfile: "</span>
01164        &lt;&lt;imageFileInfo.dataset_attr.hdrFileName&lt;&lt;<span class="stringliteral">"\n"</span>;
01165 <span class="preprocessor">#endif</span>
01166 <span class="preprocessor"></span>                
01167   <span class="keywordtype">int</span> dot = imageFileInfo.dataset_attr.hdrFileName.find_last_of(<span class="stringliteral">"."</span>);
01168 
01169   <span class="keywordflow">if</span>(dot == string::npos) {
01170     imageFileInfo.dataset_attr.dataFileName = 
01171       imageFileInfo.dataset_attr.hdrFileName+<span class="stringliteral">".img"</span>;
01172   } <span class="keywordflow">else</span> {
01173     imageFileInfo.dataset_attr.dataFileName = 
01174       imageFileInfo.dataset_attr.hdrFileName.substr(0, dot+1)+<span class="stringliteral">"img"</span>;
01175   } 
01176                 
01177   ofstream output(imageFileInfo.dataset_attr.hdrFileName.c_str(), 
01178                   ios::out | ios::binary);
01179 
01180                 
01181   <span class="keywordtype">int</span> dType = setDataType(imageFileInfo.dataset_attr.dataType);
01182                 
01183   <span class="keywordflow">switch</span> (dType)
01184     {   
01185     <span class="keywordflow">case</span> GRAY8_BYTE:
01186     <span class="keywordflow">case</span> GRAY8_UNSIGNED_BYTE:
01187       datatype = DT_UNSIGNED_CHAR;              <span class="comment">// DT_UNSIGNED_CHAR </span>
01188       bitsallocated = 8;
01189       <span class="keywordflow">break</span>;
01190     <span class="keywordflow">case</span> GRAY16_SHORT:
01191     <span class="keywordflow">case</span> GRAY16_UNSIGNED_SHORT:
01192       datatype = DT_SIGNED_SHORT;               <span class="comment">// DT_SIGNED_SHORT </span>
01193       bitsallocated = 16;
01194       <span class="keywordflow">break</span>;
01195     <span class="keywordflow">case</span> GRAY32_INT:
01196     <span class="keywordflow">case</span> GRAY32_UNSIGNED_INT:
01197       datatype = DT_SIGNED_INT;                 <span class="comment">// DT_SIGNED_INT</span>
01198       bitsallocated = 32;
01199       <span class="keywordflow">break</span>; 
01200     <span class="keywordflow">case</span> GRAY32_FLOAT:
01201       datatype = DT_FLOAT;              <span class="comment">// DT_FLOAT </span>
01202       bitsallocated = 32;
01203       <span class="keywordflow">break</span>; 
01204     <span class="keywordflow">default</span>:
01205       datatype = DT_UNKNOWN;            <span class="comment">// DT_UNKNOWN</span>
01206       bitsallocated = 0;
01207     }
01208 
01209   <span class="comment">//     header_key  </span>
01210 
01211   writeInt(output, 348);                                <span class="comment">// sizeof_hdr</span>
01212   <span class="keywordtype">int</span> i;
01213   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( (<span class="keywordtype">char</span>) 0 );      <span class="comment">// data_type</span>
01214   <span class="keywordflow">for</span> (i = 0; i &lt; 18; i++) output.put( (<span class="keywordtype">char</span>) 0 );      <span class="comment">// db_name </span>
01215   writeInt(output, 16384);                              <span class="comment">// extents </span>
01216   writeShort( output, 0);                               <span class="comment">// session_error</span>
01217   output.put ( <span class="charliteral">'r'</span> );                                   <span class="comment">// regular </span>
01218   output.put ( (<span class="keywordtype">char</span>) 0 );                              <span class="comment">// hkey_un0 </span>
01219 
01220   <span class="comment">// image_dimension</span>
01221 
01222   writeShort(output, (<span class="keywordtype">short</span>) 4 );                       <span class="comment">// dim[0] </span>
01223   writeShort(output, imageFileInfo.dataset_attr.extents[0] );   <span class="comment">// dim[1] </span>
01224   writeShort(output, imageFileInfo.dataset_attr.extents[1] );<span class="comment">// dim[2] </span>
01225   writeShort(output, imageFileInfo.dataset_attr.extents[2] );<span class="comment">// dim[3] </span>
01226   writeShort(output, (<span class="keywordtype">short</span>) 1 );                            <span class="comment">// dim[4] </span>
01227   <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) writeShort(output, 0);        <span class="comment">// dim[5-7]</span>
01228         
01229   <span class="keywordtype">char</span> units[4];
01230   <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.units[0].c_str(), <span class="stringliteral">"Millimeters"</span>) 
01231      == 0) {
01232     strcpy(units, <span class="stringliteral">"mm\0"</span>);      
01233   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.units[0].c_str(),
01234                     <span class="stringliteral">"Centimeters"</span>) == 0) {
01235     strcpy(units, <span class="stringliteral">"cm\0"</span>);      
01236   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.units[0].c_str(), 
01237                     <span class="stringliteral">"Nanometers"</span>) == 0) {
01238     strcpy(units, <span class="stringliteral">"nm\0"</span>);      
01239   } <span class="keywordflow">else</span>  <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.units[0].c_str(), 
01240                      <span class="stringliteral">"Micrometers"</span>) == 0) {
01241     strcpy(units, <span class="stringliteral">"um\0"</span>);      
01242   } <span class="keywordflow">else</span> {
01243     strcpy(units, <span class="stringliteral">"mm\0"</span>);      
01244   }
01245 
01246   output.write (units, 4);                              <span class="comment">// vox_units</span>
01247   <span class="keywordflow">for</span> (i = 0; i &lt; 8; i++) output.put( 0 );              <span class="comment">// cal_units[8] </span>
01248   writeShort( output, 0);                               <span class="comment">// unused1</span>
01249   writeShort( output, datatype );                       <span class="comment">// datatype </span>
01250   writeShort( output, bitsallocated );          <span class="comment">// bitpix</span>
01251   writeShort(output, 0);                        <span class="comment">// dim_un0</span>
01252                 
01253   writeFloat(output, 0 );                       <span class="comment">// pixdim[0] </span>
01254   writeFloat(output, imageFileInfo.dataset_attr.resolutions[0] );
01255     <span class="comment">// pixdim[1] </span>
01256   writeFloat(output, imageFileInfo.dataset_attr.resolutions[1] );
01257                 <span class="comment">// pixdim[2] </span>
01258   writeFloat(output, imageFileInfo.dataset_attr.resolutions[2] ); 
01259                 <span class="comment">// pixdim[3] </span>
01260   <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) writeFloat(output, 0);        <span class="comment">// pixdim[4-7]</span>
01261                 
01262   writeFloat(output, 0);        
01263         <span class="comment">// vox_offset </span>
01264   writeFloat(output, 1);                                             
01265         <span class="comment">// roi_scale </span>
01266   writeFloat(output, 0);        
01267         <span class="comment">// funused1 </span>
01268   writeFloat(output, 0);
01269         <span class="comment">// funused2 </span>
01270   writeFloat(output, 0 );
01271        <span class="comment">// cal_max </span>
01272   writeFloat(output, 0 );
01273         <span class="comment">// cal_min </span>
01274   writeInt(output, 0 ); 
01275         <span class="comment">// compressed</span>
01276   writeInt(output, 0 ); 
01277         <span class="comment">// verified  </span>
01278   writeInt(output, (<span class="keywordtype">int</span>) <a class="code" href="classArray3D.html#a15">max</a>() );
01279         <span class="comment">// glmax </span>
01280   writeInt(output, (<span class="keywordtype">int</span>) <a class="code" href="classArray3D.html#a16">min</a>() );       
01281         <span class="comment">// glmin </span>
01282 
01283   <span class="comment">// data_history </span>
01284 
01285   <span class="keywordflow">for</span> (i = 0; i &lt; 80; i++) output.put( (<span class="keywordtype">char</span>) 0 );
01286                 <span class="comment">// descrip  </span>
01287   <span class="keywordflow">for</span> (i = 0; i &lt; 24; i++) output.put( (<span class="keywordtype">char</span>) 0 );
01288                 <span class="comment">// aux_file </span>
01289   <span class="keywordtype">char</span> orient = 0;
01290   <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.orientation.c_str(), <span class="stringliteral">"Axial"</span>) 
01291      == 0) {
01292     orient = 0;
01293   } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.orientation.c_str(),
01294                     <span class="stringliteral">"Coronal"</span>) == 0) {
01295     orient = 1;
01296   } <span class="keywordflow">else</span>  <span class="keywordflow">if</span>(stricmp(imageFileInfo.dataset_attr.orientation.c_str(), 
01297                      <span class="stringliteral">"Sagittal"</span>) == 0) {
01298     orient = 2;
01299   } 
01300   output.put((<span class="keywordtype">char</span>) orient);                                   <span class="comment">// orient </span>
01301   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( (<span class="keywordtype">char</span>) 0 );        <span class="comment">// originator </span>
01302   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( (<span class="keywordtype">char</span>) 0 );         <span class="comment">// generated </span>
01303   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( 0 );             <span class="comment">// scannum </span>
01304   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( 0 );             <span class="comment">// patient_id  </span>
01305   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( 0 );             <span class="comment">// exp_date </span>
01306   <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) output.put( 0 );             <span class="comment">// exp_time  </span>
01307   <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++)  output.put( 0 );             <span class="comment">// hist_un0</span>
01308   writeInt(output, 0 ); <span class="comment">// views </span>
01309   writeInt(output, 0 );                         
01310                         <span class="comment">// vols_added </span>
01311   writeInt(output, 0 );  <span class="comment">// start_field  </span>
01312   writeInt(output, 0 ); <span class="comment">// field_skip</span>
01313   writeInt(output, 0 ); <span class="comment">// omax  </span>
01314   writeInt(output, 0 ); <span class="comment">// omin </span>
01315   writeInt(output, 0 ); <span class="comment">// smax  </span>
01316   writeInt(output, 0 ); <span class="comment">// smin </span>
01317                 
01318   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01319 }
01320 
01321 <span class="keywordtype">void</span> Image::writeInt(ofstream &amp;input , <span class="keywordtype">int</span> value)
01322 {
01323   <span class="keywordtype">char</span> b1 = (<span class="keywordtype">char</span>) (value &amp; 0xff);
01324   <span class="keywordtype">char</span> b2 = (<span class="keywordtype">char</span>) ((value &gt;&gt; 8) &amp; 0xff);
01325   <span class="keywordtype">char</span> b3 = (<span class="keywordtype">char</span>) ((value &gt;&gt; 16) &amp; 0xff);
01326   <span class="keywordtype">char</span> b4 = (<span class="keywordtype">char</span>) ((value &gt;&gt; 24) &amp; 0xff); 
01327   <span class="keywordflow">if</span>(imageFileInfo.dataset_attr.endianess == B_ENDIAN) {
01328     input.put(b4);
01329     input.put(b3);
01330     input.put(b2);
01331     input.put(b1);
01332   } <span class="keywordflow">else</span> {
01333     input.put(b1);
01334     input.put(b2);
01335     input.put(b3);
01336     input.put(b4);
01337   }
01338 }
01339         
01340 <span class="keywordtype">void</span> Image::writeShort(ofstream &amp;input, <span class="keywordtype">short</span> value)
01341 {
01342   <span class="keywordtype">char</span> b1 = (<span class="keywordtype">char</span>) (value &amp; 0xff);
01343   <span class="keywordtype">char</span> b2 = (<span class="keywordtype">char</span>) ((value &gt;&gt; 8) &amp; 0xff);
01344   <span class="keywordflow">if</span>(imageFileInfo.dataset_attr.endianess == B_ENDIAN) {
01345     input.put(b2);
01346     input.put(b1);
01347   } <span class="keywordflow">else</span> {
01348     input.put(b1);
01349     input.put(b2);
01350   }
01351 }
01352         
01353 <span class="keywordtype">void</span> Image::writeFloat(ofstream &amp;input, <span class="keywordtype">float</span> value)
01354 {
01355   writeInt(input, *(<span class="keywordtype">int</span> *) &amp;value ); 
01356 }
01357 
01358 <span class="keywordtype">bool</span> Image::interfileReadHdr() {
01359   string interFileName = imageFileInfo.dataset_attr.hdrFileName;
01360   map&lt;string,string&gt; fileContents;
01361   ifstream fs (interFileName.c_str(), ios::in); 
01362   <span class="keyword">const</span> <span class="keywordtype">int</span> sz=300; <span class="comment">//buffer Size</span>
01363   <span class="keywordtype">char</span> buf[sz];
01364   <span class="keywordtype">int</span> bytesPerPixel = 0;
01365   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
01366 
01367   <span class="keywordflow">if</span>(!fs) 
01368     { 
01369       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(<span class="stringliteral">"Image::interfileReadHdr: Can't open file:"</span> 
01370                          + interFileName, FRAME, HIGH); 
01371       fs.close();
01372       <span class="keywordflow">return</span> <span class="keyword">false</span>; 
01373     } 
01374 
01375   <span class="keywordflow">while</span>(fs.getline(buf, sz) &amp;&amp; fs.good()) {
01376     string line(buf);
01377 <span class="preprocessor">#ifdef DEBUG3</span>
01378 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::interfileReadHdr Line is:"</span>&lt;&lt;line&lt;&lt;<span class="stringliteral">"\n"</span>;
01379 <span class="preprocessor">#endif</span>
01380 <span class="preprocessor"></span>    string::size_type pos = line.find(<span class="stringliteral">":="</span>);
01381     <span class="keywordflow">if</span>(pos != string::npos) {
01382       string key = line.substr(0, pos);
01383       string value = line.substr(pos+2, line.npos);
01384         
01385       key = <a class="code" href="classUtilities.html#e10">Utilities::trim</a>(key);
01386       value = <a class="code" href="classUtilities.html#e10">Utilities::trim</a>(value);
01387       fileContents[key] = value;
01388     }
01389                         
01390   }
01391   fs.close();
01392 
01393   <span class="comment">// Initialize the structure</span>
01394   imageFileInfo.dataset_attr.imageOffset = 0;
01395   imageFileInfo.dataset_attr.dataFileName = <span class="stringliteral">""</span>;
01396   imageFileInfo.dataset_attr.endianess = B_ENDIAN;
01397   imageFileInfo.dataset_attr.dataType = <span class="stringliteral">""</span>;
01398   imageFileInfo.dataset_attr.nDimensions = DIMENSIONS;
01399   imageFileInfo.dataset_attr.extents[0] = 0;
01400   imageFileInfo.dataset_attr.extents[1] = 0;
01401   imageFileInfo.dataset_attr.extents[2] = 0;
01402   imageFileInfo.dataset_attr.resolutions[0] = 0;
01403   imageFileInfo.dataset_attr.resolutions[1] = 0;
01404   imageFileInfo.dataset_attr.resolutions[2] = 0;
01405 
01406   map&lt;string,string&gt;::iterator iter = fileContents.begin();
01407   <span class="keywordflow">while</span>(iter != fileContents.end()) {
01408                         
01409     string key = iter-&gt;first;
01410     string value = iter-&gt;second;
01411                         
01412     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"data offset in bytes"</span>) != string::npos) {
01413       imageFileInfo.dataset_attr.imageOffset = atoi(value.c_str());
01414     } 
01415     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"name of data file"</span>) != string::npos) {
01416       imageFileInfo.dataset_attr.dataFileName = <a class="code" href="classUtilities.html#e10">Utilities::trim</a>(value);
01417     }
01418     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"imagedata byte order"</span>) != string::npos) {
01419       <span class="keywordflow">if</span>(value.find(<span class="stringliteral">"little"</span>) != string::npos || value.find(<span class="stringliteral">"LITTLE"</span>) 
01420          != string::npos 
01421          || value.find(<span class="stringliteral">"Little"</span>) != string::npos ) {
01422         imageFileInfo.dataset_attr.endianess = L_ENDIAN;
01423       } <span class="keywordflow">else</span> {
01424         imageFileInfo.dataset_attr.endianess = B_ENDIAN;
01425       }
01426     }
01427     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"number format"</span>) != string::npos) {
01428       imageFileInfo.dataset_attr.dataType = value;
01429     }
01430     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"number of bytes per pixel"</span>) != string::npos) {
01431       bytesPerPixel = atoi(value.c_str());
01432     }
01433     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"number of dimensions"</span>) != string::npos) {
01434       imageFileInfo.dataset_attr.nDimensions = atoi(value.c_str());
01435     }
01436     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"matrix size [1]"</span>) != string::npos) {
01437       imageFileInfo.dataset_attr.extents[0] = atoi(value.c_str());
01438     }
01439     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"matrix size [2]"</span>) != string::npos) {
01440       imageFileInfo.dataset_attr.extents[1] = atoi(value.c_str());
01441     }
01442     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"matrix size [3]"</span>) != string::npos) {
01443       imageFileInfo.dataset_attr.extents[2] = atoi(value.c_str());
01444     } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"total number of images"</span>) != string::npos) {
01445       imageFileInfo.dataset_attr.extents[2] = atoi(value.c_str());
01446     }
01447     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"scaling factor (mm/pixel) [1]"</span>) != string::npos) {
01448       imageFileInfo.dataset_attr.resolutions[0] = atof(value.c_str());
01449     }
01450     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"scaling factor (mm/pixel) [2]"</span>) != string::npos) {
01451       imageFileInfo.dataset_attr.resolutions[1] = atof(value.c_str());
01452     }
01453     <span class="keywordflow">if</span>(key.find(<span class="stringliteral">"scaling factor (mm/pixel) [3]"</span>) != string::npos) {
01454       imageFileInfo.dataset_attr.resolutions[2] = atof(value.c_str());
01455     }
01456     iter++;
01457   }
01458   imageFileInfo.dataset_attr.units[0] = step_units1 = <span class="stringliteral">"Millimeters"</span>;
01459   imageFileInfo.dataset_attr.units[1] = step_units2 = <span class="stringliteral">"Millimeters"</span>;
01460   imageFileInfo.dataset_attr.units[2] = step_units3 = <span class="stringliteral">"Millimeters"</span>;
01461   imageFileInfo.dataset_attr.slice_spacing = 0;
01462   imageFileInfo.dataset_attr.orientation = <span class="stringliteral">"Unknown"</span>;
01463   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0 ; i &lt; imageFileInfo.dataset_attr.nDimensions ; i++) {
01464     imageFileInfo.dataset_attr.subject_axis_orientation[i] = <span class="stringliteral">"Unknown"</span>;
01465     imageFileInfo.dataset_attr.start_locations[i] = 0;
01466   }
01467 
01468   string dataType = imageFileInfo.dataset_attr.dataType;
01469   <span class="keywordflow">switch</span> (bytesPerPixel) {
01470   <span class="keywordflow">case</span> 0:
01471     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01472     <span class="keywordflow">break</span>;
01473   <span class="keywordflow">case</span> 1:
01474     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos) 
01475       dataType = <span class="stringliteral">"Unsigned Byte"</span>;
01476     <span class="keywordflow">else</span> 
01477       dataType = <span class="stringliteral">"Byte"</span>;
01478     <span class="keywordflow">break</span>;
01479   <span class="keywordflow">case</span> 2:
01480     <span class="keywordflow">if</span>(dataType.find(<span class="stringliteral">"unsigned"</span>) != string::npos) 
01481       dataType = <span class="stringliteral">"Unsigned Short"</span>;
01482     <span class="keywordflow">else</span> 
01483       dataType = <span class="stringliteral">"Short"</span>;
01484     <span class="keywordflow">break</span>;
01485   }             
01486   imageFileInfo.dataset_attr.dataType = dataType;
01487                 
01488 <span class="preprocessor">#ifdef DEBUG3</span>
01489 <span class="preprocessor"></span>  showFileHeader();
01490 <span class="preprocessor">#endif                          </span>
01491 <span class="preprocessor"></span>
01492   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01493 }
01494 
01495 <span class="keywordtype">bool</span> Image::interfileWriteHdr() {
01496   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01497 }
01498 
01499 <span class="keywordtype">bool</span> Image::readData() {
01500 
01501   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
01502 
01503   string rawFile = imageFileInfo.dataset_attr.dataFileName;
01504   <span class="keywordtype">int</span> dType = setDataType(imageFileInfo.dataset_attr.dataType);
01505   <span class="keywordtype">int</span> bytesPerPixel = pixelBytes();
01506 
01507   <span class="comment">// Searching for the data file in the Header file directory</span>
01508   string hdrFileName = imageFileInfo.dataset_attr.hdrFileName;
01509   <span class="keywordtype">int</span> slash = 0;
01510   <span class="keywordflow">if</span>((slash = hdrFileName.find_last_of(<span class="stringliteral">"/"</span>)) != string::npos) {
01511     string dir = hdrFileName.substr(0, slash+1);
01512     <span class="keywordflow">if</span>((slash = rawFile.find_last_of(<span class="stringliteral">"/"</span>)) == string::npos) {
01513       rawFile = dir + rawFile;
01514     }
01515   }
01516   ifstream dFile(rawFile.c_str(), ios::in | ios::binary);       
01517 
01518   <span class="keywordflow">if</span>((dFile.rdstate() &amp; ifstream::failbit ) != 0) {
01519 
01520     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readData: failbit set, Error opening file: "</span>+rawFile+<span class="stringliteral">"\n"</span>, FRAME, HIGH);
01521     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01522   }
01523 <span class="preprocessor">#ifdef DEBUG33</span>
01524 <span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">"Image::readData: Opened file:"</span>&lt;&lt;rawFile&lt;&lt;<span class="stringliteral">"\n"</span>;
01525 <span class="preprocessor">#endif</span>
01526 <span class="preprocessor"></span>                
01527   <span class="keywordflow">if</span> (imageFileInfo.dataset_attr.nDimensions != 3) {
01528     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readData: Dimensions not set -- Cannot read file\n"</span>, FRAME, HIGH);
01529     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01530   }
01531   <span class="keywordtype">int</span> dim[imageFileInfo.dataset_attr.nDimensions];
01532         
01533   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n1=0; n1 &lt; imageFileInfo.dataset_attr.nDimensions ; n1++) {
01534     dim[n1] = imageFileInfo.dataset_attr.extents[n1];
01535 <span class="preprocessor">#ifdef DEBUG33</span>
01536 <span class="preprocessor"></span>    cout &lt;&lt; <span class="stringliteral">"Image::readData: Dim -"</span>&lt;&lt;n1&lt;&lt;<span class="stringliteral">" is:"</span>&lt;&lt;dim[n1]&lt;&lt;<span class="stringliteral">"\n"</span>;
01537 <span class="preprocessor">#endif</span>
01538 <span class="preprocessor"></span>  }
01539   <span class="keywordtype">int</span> skip = 0;
01540   <span class="comment">// If imageoffset is &gt; 0, skip the file pointer</span>
01541   <span class="keywordflow">if</span>(imageFileInfo.dataset_attr.imageOffset &gt; 0) {
01542     skip = imageFileInfo.dataset_attr.imageOffset;
01543   }
01544 
01545   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n1=0 ; n1&lt; dim[2]; n1++) { <span class="comment">//Read each image slice at a time</span>
01546 
01547     <span class="keywordflow">if</span>(skip &gt; 0) {
01548       <span class="keywordtype">int</span> curPos = dFile.tellg();
01549       curPos += skip;
01550       dFile.seekg(curPos);
01551       curPos = dFile.tellg();
01552       skip = imageFileInfo.dataset_attr.slice_spacing;
01553     }
01554                                 
01555     <span class="keywordtype">int</span> width, height;
01556     <span class="keywordtype">int</span> bufferSize, byteCount, nPixels;
01557                 
01558     width=dim[0]; height=dim[1];
01559     byteCount = width*height*bytesPerPixel;
01560     nPixels = width*height;
01561     bufferSize = byteCount/25;
01562     <span class="keywordflow">if</span> (bufferSize&lt;8192)
01563       bufferSize = 8192;
01564     <span class="keywordflow">else</span>
01565       bufferSize = (bufferSize/8192)*8192;
01566     <span class="keywordtype">int</span> pixelsRead;
01567     <span class="keywordtype">char</span> buffer[bufferSize];
01568     <span class="keywordtype">float</span> pixels[nPixels];
01569     <span class="keywordtype">int</span> totalRead = 0;
01570     <span class="keywordtype">int</span> base = 0;
01571     <span class="keywordtype">int</span> count;
01572     <span class="keywordtype">int</span> bufferCount;
01573     <span class="keywordtype">int</span> tmp;
01574     <span class="keywordtype">short</span> tmpShort;
01575     <span class="keywordtype">double</span> tmpDouble;
01576                         
01577     <span class="keywordflow">while</span> (totalRead&lt;byteCount) {
01578       <span class="keywordflow">if</span> ((totalRead+bufferSize)&gt;byteCount)
01579         bufferSize = byteCount-totalRead;
01580       bufferCount = 0;
01581       <span class="keywordflow">while</span> (bufferCount&lt;bufferSize &amp;&amp; dFile.good()) { <span class="comment">// fill the buffer</span>
01582         dFile.read(buffer+bufferCount, bufferSize-bufferCount);
01583         count = dFile.gcount();
01584         <span class="keywordflow">if</span>(count &lt;= 0) {
01585           log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readData: EOF Error\n"</span>, FRAME, HIGH);
01586           <span class="keywordflow">return</span> <span class="keyword">false</span>;
01587         }
01588         bufferCount += count;
01589       }
01590       <span class="keywordflow">if</span>(bufferCount &lt; bufferSize) { 
01591         log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::readData: something went wrong while reading data\n"</span>, FRAME, HIGH); 
01592         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
01593       }
01594 
01595       totalRead += bufferSize;
01596       pixelsRead = bufferSize/bytesPerPixel;
01597       <span class="keywordtype">int</span> j = 0;
01598       <span class="keywordflow">switch</span>(dType) {
01599 
01600         <span class="comment">/*******************</span>
01601 <span class="comment">         case GRAY64_DOUBLE:</span>
01602 <span class="comment">         case GRAY64_UNSIGNED_DOUBLE:</span>
01603 <span class="comment">             if (imageFileInfo.dataset_attr.endianess == L_ENDIAN) {</span>
01604 <span class="comment">                                                        for (int i=base; i &lt; (base+pixelsRead); i++) {</span>
01605 <span class="comment">                                                                tmpDouble = (double)(((buffer[j+7]&amp;0xff)&lt;&lt;56) | ((buffer[j+6]&amp;0xff)&lt;&lt;48) | ((buffer[j+5]&amp;0xff)&lt;&lt;40) | ((buffer[j+4]&amp;0xff)&lt;&lt;32) | ((buffer[j+3]&amp;0xff)&lt;&lt;24) | ((buffer[j+2]&amp;0xff)&lt;&lt;16) | ((buffer[j+1]&amp;0xff)&lt;&lt;8) | (buffer[j]&amp;0xff));</span>
01606 <span class="comment">                                                                if (dType == GRAY64_DOUBLE) // Check to see signed float</span>
01607 <span class="comment">                                                                        pixels[i] =  *(double *) &amp;tmpDouble;</span>
01608 <span class="comment">                                                                else if (dType == GRAY64_UNSIGNED_DOUBLE) // Check to see unsigned float</span>
01609 <span class="comment">                                                                        pixels[i] = (float)(tmpDouble&amp;0xffffffffffffffff);</span>
01610 <span class="comment">                                                                j += 8;</span>
01611 <span class="comment">                                                        }</span>
01612 <span class="comment">                                                } else {</span>
01613 <span class="comment">                                                        for (int i=base; i &lt; (base+pixelsRead); i++) {</span>
01614 <span class="comment">                                                                tmpDouble = (double)(((buffer[j]&amp;0xff)&lt;&lt;56) | ((buffer[j+1]&amp;0xff)&lt;&lt;48) | ((buffer[j+2]&amp;0xff)&lt;&lt;40) | ((buffer[j+3]&amp;0xff)&lt;&lt;32) | ((buffer[j+4]&amp;0xff)&lt;&lt;24) | ((buffer[j+5]&amp;0xff)&lt;&lt;16) | ((buffer[j+6]&amp;0xff)&lt;&lt;8) | (buffer[j+7]&amp;0xff));</span>
01615 <span class="comment">                                                                if (dType == GRAY64_DOUBLE) // Check to see signed float</span>
01616 <span class="comment">                                                                        pixels[i] =  *(double *) &amp;tmpDouble;</span>
01617 <span class="comment">                                                                else if (dType == GRAY64_UNSIGNED_DOUBLE) // Check to see unsigned float</span>
01618 <span class="comment">                                                                        pixels[i] = (float)(tmpDouble&amp;0xffffffffffffffff);</span>
01619 <span class="comment">                                                                j += 8;</span>
01620 <span class="comment">                                                        }</span>
01621 <span class="comment">                                                }</span>
01622 <span class="comment">                                                break;</span>
01623 <span class="comment">        ***************************/</span>
01624       <span class="keywordflow">case</span> GRAY32_FLOAT:
01625       <span class="keywordflow">case</span> GRAY32_UNSIGNED_FLOAT:
01626       <span class="keywordflow">case</span> GRAY32_INT:
01627       <span class="keywordflow">case</span> GRAY32_UNSIGNED_INT:
01628         <span class="keywordflow">if</span> (imageFileInfo.dataset_attr.endianess == L_ENDIAN) {
01629           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=base; i &lt; (base+pixelsRead); i++) {
01630             tmp = (<span class="keywordtype">int</span>)(((buffer[j+3]&amp;0xff)&lt;&lt;24) | 
01631                         ((buffer[j+2]&amp;0xff)&lt;&lt;16) | 
01632                         ((buffer[j+1]&amp;0xff)&lt;&lt;8) | (buffer[j]&amp;0xff));
01633             <span class="keywordflow">if</span> (dType == GRAY32_FLOAT) <span class="comment">// Check to see signed float</span>
01634               pixels[i] =  *(<span class="keywordtype">float</span> *) &amp;tmp;
01635             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dType == GRAY32_UNSIGNED_FLOAT) 
01636               <span class="comment">// Check to see unsigned float</span>
01637               pixels[i] = (<span class="keywordtype">float</span>)(tmp&amp;0xffffffffL);
01638             <span class="keywordflow">else</span> <span class="comment">// If it is a Int</span>
01639               pixels[i] = tmp;
01640             j += 4;
01641           }
01642         } <span class="keywordflow">else</span> {
01643           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=base; i &lt; (base+pixelsRead); i++) {
01644             tmp = (<span class="keywordtype">int</span>)(((buffer[j]&amp;0xff)&lt;&lt;24) | 
01645                         ((buffer[j+1]&amp;0xff)&lt;&lt;16) | 
01646                         ((buffer[j+2]&amp;0xff)&lt;&lt;8) | (buffer[j+3]&amp;0xff));
01647             <span class="keywordflow">if</span> (dType == GRAY32_FLOAT) <span class="comment">// Check to see signed float</span>
01648               pixels[i] = *(<span class="keywordtype">float</span> *) &amp;tmp;
01649             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dType == GRAY32_UNSIGNED_FLOAT) 
01650               <span class="comment">// Check to see unsigned float</span>
01651               pixels[i] = (<span class="keywordtype">float</span>)(tmp&amp;0xffffffffL);
01652             <span class="keywordflow">else</span> <span class="comment">// If it is a Int</span>
01653               pixels[i] = tmp;
01654             j += 4;
01655           }
01656         }
01657         <span class="keywordflow">break</span>;
01658       <span class="keywordflow">case</span> GRAY16_UNSIGNED_SHORT:
01659       <span class="keywordflow">case</span> GRAY16_SHORT:
01660         <span class="keywordflow">if</span> (imageFileInfo.dataset_attr.endianess == L_ENDIAN) {
01661           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=base; i &lt; (base+pixelsRead); i++) {
01662             <span class="keywordflow">if</span>(dType == GRAY16_SHORT) {
01663               tmpShort = (<span class="keywordtype">short</span>)(((buffer[j+1]&amp;0xff)&lt;&lt;8) | 
01664                                  (buffer[j]&amp;0xff)+32768);
01665             } <span class="keywordflow">else</span> {
01666               tmpShort = (<span class="keywordtype">short</span>)(((buffer[j+1]&amp;0xff)&lt;&lt;8) | 
01667                                  (buffer[j]&amp;0xff));
01668             }
01669             pixels[i] = (<span class="keywordtype">float</span>) *(<span class="keywordtype">short</span> *) &amp;tmpShort;
01670             j += 2;
01671           }
01672         } <span class="keywordflow">else</span> {
01673           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=base; i &lt; (base+pixelsRead); i++) {
01674             tmpShort = (<span class="keywordtype">short</span>)(((buffer[j]&amp;0xff)&lt;&lt;8) | 
01675                                (buffer[j+1]&amp;0xff));
01676             pixels[i] = (<span class="keywordtype">float</span>) *(<span class="keywordtype">short</span> *) &amp;tmpShort;
01677             j += 2;
01678           }
01679         }
01680         <span class="keywordflow">break</span>;
01681       <span class="keywordflow">case</span> GRAY8_BYTE:
01682       <span class="keywordflow">case</span> GRAY8_UNSIGNED_BYTE:
01683         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=base; i &lt; (base+pixelsRead); i++) {
01684           <span class="keywordflow">if</span>(dType == GRAY8_UNSIGNED_BYTE) {
01685             pixels[i] = (<span class="keywordtype">float</span>) *(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;buffer[j];
01686           } <span class="keywordflow">else</span> {
01687             pixels[i] = (<span class="keywordtype">float</span>) *(<span class="keywordtype">char</span> *) &amp;buffer[j];
01688           }
01689           j++;
01690         }
01691         <span class="keywordflow">break</span>;
01692       <span class="keywordflow">default</span>:
01693         <span class="keywordflow">break</span>;
01694       }
01695 
01696       base += pixelsRead;
01697     }
01698     <span class="comment">//for(int n2=0 ; n2 &lt; dim[1] ; n2++) {</span>
01699     <a class="code" href="classImage.html#a12">putOrderSlice</a>(n1, pixels);          
01700     <span class="comment">//}</span>
01701                         
01702   }
01703   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01704 }
01705 
01706 <span class="keywordtype">bool</span> Image::writeData() {
01707   string rawFile = imageFileInfo.dataset_attr.dataFileName;
01708   <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
01709 
01710   ofstream file(rawFile.c_str(), ios::out|ios::binary); 
01711 
01712   <span class="keywordflow">if</span>(!file) {
01713     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::writeData: Error opening file:"</span>+
01714                         rawFile+<span class="stringliteral">"\n"</span>, FRAME, HIGH);
01715     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01716   }
01717 
01718   <span class="keywordtype">long</span> initialFilePos = file.tellp();
01719                 
01720   <span class="keywordflow">if</span> (imageFileInfo.dataset_attr.nDimensions != DIMENSIONS) {
01721     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>( <span class="stringliteral">"Image::writeData: Dimensions not set\n"</span>, 
01722                         FRAME, HIGH);
01723     <span class="keywordflow">return</span> <span class="keyword">false</span>;
01724   }
01725   <span class="keywordtype">int</span> dim[imageFileInfo.dataset_attr.nDimensions];
01726         
01727   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n1=0; n1 &lt; imageFileInfo.dataset_attr.nDimensions ; n1++) {
01728     dim[n1] = imageFileInfo.dataset_attr.extents[n1];
01729   }
01730 
01731   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n1=0 ; n1&lt; dim[2]; n1++) { <span class="comment">//Write each image slice at a time</span>
01732     <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> pixels(dim[0]*dim[1]);
01733 
01734     <span class="comment">//for(int n2=0 ; n2&lt;dim[1] ; n2++) {</span>
01735     {
01736       <span class="keywordtype">float</span> *tmp;
01737       tmp = <a class="code" href="classImage.html#a11">getOrderSlice</a>(n1);
01738 
01739       pixels.<a class="code" href="classArray1D.html#a11">putBlock</a>(0, dim[0]*dim[1], tmp);
01740                         
01741       <span class="keyword">delete</span>[] tmp;
01742     }
01743 
01744     <span class="keywordtype">int</span> dType = pixelBytes();
01745     <span class="keywordtype">int</span> bytesWritten = 0;
01746     <span class="keywordtype">int</span> size = dim[0]*dim[1]*dType;
01747     <span class="keywordtype">int</span> count = 8192;
01748     <span class="keywordtype">char</span> buffer[count];
01749     <span class="keywordtype">int</span> tmp;
01750 
01751     <span class="keywordflow">while</span> (bytesWritten&lt;size &amp;&amp; file.good()) {
01752       <span class="keywordflow">if</span> ((bytesWritten + count)&gt;size)
01753         count = size - bytesWritten;
01754       <span class="keywordtype">int</span> j = bytesWritten/dType;
01755       <span class="keywordflow">if</span> (imageFileInfo.dataset_attr.endianess == L_ENDIAN) {
01756         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; count; i+=4) {
01757           tmp = *(<span class="keywordtype">int</span> *) &amp;pixels(j);
01758           buffer[i]   = (<span class="keywordtype">char</span>)tmp;
01759           buffer[i+1] = (<span class="keywordtype">char</span>)(tmp&gt;&gt;8);
01760           buffer[i+2] = (<span class="keywordtype">char</span>)(tmp&gt;&gt;16);
01761           buffer[i+3] = (<span class="keywordtype">char</span>)(tmp&gt;&gt;24);
01762           j++;
01763         }
01764       } <span class="keywordflow">else</span> {
01765         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; count; i+=4) {
01766           tmp = *(<span class="keywordtype">int</span> *) &amp;pixels(j);
01767           buffer[i]   = (<span class="keywordtype">char</span>)(tmp&gt;&gt;24);
01768           buffer[i+1] = (<span class="keywordtype">char</span>)(tmp&gt;&gt;16);
01769           buffer[i+2] = (<span class="keywordtype">char</span>)(tmp&gt;&gt;8);
01770           buffer[i+3] = (<span class="keywordtype">char</span>)tmp;
01771           j++;
01772         }
01773       }
01774       initialFilePos = file.tellp();
01775       file.write(buffer, count);
01776       count = file.tellp()-initialFilePos;
01777       bytesWritten += count;
01778                         
01779     }
01780   }
01781   file.flush();
01782   file.close();
01783   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01784 }
01785 
01786 <span class="keywordtype">int</span> Image::pixelBytes() {
01787   <span class="keywordtype">int</span> dType = setDataType(imageFileInfo.dataset_attr.dataType);
01788   <span class="comment">/************</span>
01789 <span class="comment">                if(imageFileInfo.dataset_attr.bytesPerPixel &gt; 0) {</span>
01790 <span class="comment">                        return imageFileInfo.dataset_attr.bytesPerPixel;</span>
01791 <span class="comment">                }</span>
01792 <span class="comment">  **************/</span>
01793 
01794   <span class="keywordflow">switch</span>(dType) {
01795   <span class="keywordflow">case</span> GRAY64_UNSIGNED_DOUBLE:
01796   <span class="keywordflow">case</span> GRAY64_DOUBLE:
01797     <span class="keywordflow">return</span> 8;
01798     <span class="keywordflow">break</span>;
01799 
01800   <span class="keywordflow">case</span> GRAY32_FLOAT:
01801   <span class="keywordflow">case</span> GRAY32_UNSIGNED_FLOAT:
01802   <span class="keywordflow">case</span> GRAY32_INT:
01803   <span class="keywordflow">case</span> GRAY32_UNSIGNED_INT:
01804     <span class="keywordflow">return</span> 4;
01805     <span class="keywordflow">break</span>;
01806 
01807   <span class="keywordflow">case</span> GRAY16_SHORT:
01808     <span class="keywordflow">return</span> 2;
01809     <span class="keywordflow">break</span>;
01810 
01811   <span class="keywordflow">case</span> GRAY8_UNSIGNED_BYTE:
01812   <span class="keywordflow">case</span> GRAY8_BYTE:
01813     <span class="keywordflow">return</span> 1;
01814     <span class="keywordflow">break</span>;
01815 
01816   <span class="keywordflow">case</span> GRAY1_BOOLEAN:
01817   <span class="keywordflow">default</span>:
01818     <span class="keywordflow">return</span> 0;
01819     <span class="keywordflow">break</span>;
01820   }
01821 }
01822 
01823 <span class="keywordtype">void</span> Image::showFileHeader() {
01824 
01825   cout &lt;&lt; <span class="stringliteral">"Image::showFileHeader: imageFileInfo Values\n"</span>;
01826   cout &lt;&lt; <span class="stringliteral">"nDims:"</span>&lt;&lt;imageFileInfo.dataset_attr.nDimensions&lt;&lt;<span class="stringliteral">"\n"</span>;
01827   cout &lt;&lt; <span class="stringliteral">"fileType:"</span>&lt;&lt;imageFileInfo.dataset_attr.fileType&lt;&lt;<span class="stringliteral">"\n"</span>;
01828   cout &lt;&lt; <span class="stringliteral">"hdrFileName:"</span>&lt;&lt;imageFileInfo.dataset_attr.hdrFileName&lt;&lt;<span class="stringliteral">"\n"</span>;
01829   cout &lt;&lt; <span class="stringliteral">"dataFileName:"</span>&lt;&lt;imageFileInfo.dataset_attr.dataFileName&lt;&lt;<span class="stringliteral">"\n"</span>;
01830   cout &lt;&lt; <span class="stringliteral">"imageOffset:"</span>&lt;&lt;imageFileInfo.dataset_attr.imageOffset&lt;&lt;<span class="stringliteral">"\n"</span>;
01831   cout &lt;&lt; <span class="stringliteral">"dataType:"</span>&lt;&lt;imageFileInfo.dataset_attr.dataType&lt;&lt;<span class="stringliteral">"\n"</span>;
01832   cout &lt;&lt; <span class="stringliteral">"endianess:"</span>&lt;&lt;imageFileInfo.dataset_attr.endianess&lt;&lt;<span class="stringliteral">"\n"</span>;
01833   cout &lt;&lt; <span class="stringliteral">"extents[0]:"</span>&lt;&lt;imageFileInfo.dataset_attr.extents[0]&lt;&lt;<span class="stringliteral">"\n"</span>;
01834   cout &lt;&lt; <span class="stringliteral">"extents[1]:"</span>&lt;&lt;imageFileInfo.dataset_attr.extents[1]&lt;&lt;<span class="stringliteral">"\n"</span>;
01835   cout &lt;&lt; <span class="stringliteral">"extents[2]:"</span>&lt;&lt;imageFileInfo.dataset_attr.extents[2]&lt;&lt;<span class="stringliteral">"\n"</span>;
01836   cout &lt;&lt; <span class="stringliteral">"resolutions[0]:"</span>&lt;&lt;imageFileInfo.dataset_attr.resolutions[0]
01837        &lt;&lt;<span class="stringliteral">"\n"</span>;
01838   cout &lt;&lt; <span class="stringliteral">"resolutions[1]:"</span>&lt;&lt;imageFileInfo.dataset_attr.resolutions[1]
01839        &lt;&lt;<span class="stringliteral">"\n"</span>;
01840   cout &lt;&lt; <span class="stringliteral">"resolutions[2]:"</span>&lt;&lt;imageFileInfo.dataset_attr.resolutions[2]
01841        &lt;&lt;<span class="stringliteral">"\n"</span>;
01842   cout &lt;&lt; <span class="stringliteral">"sliceSpacing:"</span>&lt;&lt;imageFileInfo.dataset_attr.slice_spacing
01843        &lt;&lt;<span class="stringliteral">"\n"</span>;
01844   cout &lt;&lt; <span class="stringliteral">"units[0]:"</span>&lt;&lt;imageFileInfo.dataset_attr.units[0]&lt;&lt;<span class="stringliteral">"\n"</span>;
01845   cout &lt;&lt; <span class="stringliteral">"units[0]:"</span>&lt;&lt;imageFileInfo.dataset_attr.units[0]&lt;&lt;<span class="stringliteral">"\n"</span>;
01846   cout &lt;&lt; <span class="stringliteral">"units[0]:"</span>&lt;&lt;imageFileInfo.dataset_attr.units[0]&lt;&lt;<span class="stringliteral">"\n"</span>;
01847   cout &lt;&lt; <span class="stringliteral">"orientation:"</span>&lt;&lt;imageFileInfo.dataset_attr.orientation&lt;&lt;<span class="stringliteral">"\n"</span>;
01848   cout &lt;&lt; <span class="stringliteral">"Image::showFileHeader: End of imageFileInfo Values\n"</span>;
01849 }
01850 
<a name="l01858"></a><a class="code" href="classImage.html#a11">01858</a> <span class="keywordtype">float</span>* <a class="code" href="classImage.html#a11">Image::getOrderSlice</a>( <span class="keywordtype">int</span> iz)
01859 {
01860        
01861   <span class="keywordtype">int</span>  i2 = iz; <span class="comment">//z index in the middle</span>
01862   <span class="keywordflow">if</span>(i2&lt;0||dim2&lt;=i2) { <span class="comment">//check dimension</span>
01863     cout &lt;&lt; <span class="stringliteral">"Bad index "</span>&lt;&lt;i2&lt;&lt;<span class="stringliteral">"&gt; "</span>&lt;&lt;dim2&lt;&lt; endl;
01864     <span class="keywordflow">return</span>(**z);
01865   }
01866        
01867   <span class="keywordtype">float</span> * block = <span class="keyword">new</span> <span class="keywordtype">float</span> [dim1*dim3]; <span class="comment">//buffer to return</span>
01868   <span class="keywordtype">int</span> index = 0, jz= iz;
01869  
01870   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jy = 0; jy&lt;dim3; jy++)
01871     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jx = 0; jx&lt;dim1; jx++){
01872       block[index] = this-&gt;z[jy][jz][jx];
01873       index ++;
01874     }
01875    
01876   <span class="keywordflow">return</span> (block);
01877 }
<a name="l01883"></a><a class="code" href="classImage.html#a13">01883</a> <span class="keywordtype">float</span> <a class="code" href="classImage.html#a13">Image::getSliceAverage</a>(<span class="keywordtype">int</span> jz)
01884 {
01885   <span class="keywordtype">int</span>  i2 = jz; <span class="comment">//z index in the middle</span>
01886   <span class="keywordflow">if</span>(i2&lt;0||dim2&lt;=i2) { <span class="comment">//check dimension</span>
01887     cout &lt;&lt; <span class="stringliteral">"Bad index &lt;"</span>&lt;&lt;i2&lt;&lt;<span class="stringliteral">"&gt; "</span>&lt;&lt;dim2&lt;&lt; endl;
01888     <span class="keywordflow">return</span> 0;
01889   }
01890   <span class="keywordtype">float</span> avg = 0;
01891   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jy = 0; jy&lt;dim3; jy++)
01892     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jx = 0; jx&lt;dim1; jx++){
01893       avg += this-&gt;z[jy][jz][jx];
01894     }
01895   <span class="keywordflow">return</span> avg/(dim3*dim1);
01896 }
01897 
01898 
<a name="l01907"></a><a class="code" href="classImage.html#a12">01907</a> <span class="keywordtype">void</span> <a class="code" href="classImage.html#a12">Image:: putOrderSlice</a>( <span class="keywordtype">int</span> iz,  <span class="keywordtype">float</span>* array)
01908 {
01909    
01910   <span class="keywordtype">int</span> i2 = iz;<span class="comment">//z index in the middle</span>
01911        
01912   <span class="keywordflow">if</span>(i2&lt;0||dim2&lt;=i2){ <span class="comment">//check index</span>
01913     cout &lt;&lt; <span class="stringliteral">"Bad index "</span>&lt;&lt;i2&lt;&lt;<span class="stringliteral">" &gt; "</span>;
01914     cout &lt;&lt;dim2&lt;&lt; endl;
01915     <span class="keywordflow">return</span>;
01916   }
01917   <span class="keywordtype">int</span> index = 0, jz= iz;
01918   
01919   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jy = 0; jy&lt;dim3; jy++)
01920     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> jx = 0; jx&lt;dim1; jx++){
01921       this-&gt;z[jy][jz][jx]= array[index];
01922       index ++;
01923     }
01924 
01925 }
01926 
<a name="l01929"></a><a class="code" href="classImage.html#a14">01929</a> <span class="keywordtype">void</span> <a class="code" href="classImage.html#a14">Image::globalSum</a>(Params &amp; params)
01930 {
01931   <span class="keywordtype">float</span> workArr[params.geometry.nX*params.geometry.nZ];
01932 
01933   time_t timeGlobalSum1,  timeGlobalSum2;     
01934   <span class="keywordtype">double</span> timeGlobalSum;     
01935   timeGlobalSum1 = time((time_t *) 0);
01936   <span class="keywordtype">int</span> countT = 0;
01937   Status *status = Status::getStatus();
01938 
01939   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n1 = 0; n1&lt;params.geometry.nY; n1++) {
01940     memcpy(workArr, &amp;(this-&gt;z[n1][0][0]), <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>)*
01941            params.geometry.nX*params.geometry.nZ);
01942     
01943     MPI::COMM_WORLD.Allreduce(workArr, &amp;(this-&gt;z[n1][0][0]) ,
01944                                params.geometry.nX*params.geometry.nZ , 
01945                               MPI::FLOAT, MPI::SUM);
01946 
01947     timeGlobalSum2 = time((time_t *) 0);
01948     timeGlobalSum = difftime(timeGlobalSum2,timeGlobalSum1);
01949 
01950     ++countT; <span class="comment">//increase count</span>
01951     <span class="keywordflow">if</span>(status-&gt;proc ==0) 
01952       <span class="keywordflow">if</span>(countT%10==0 &amp;&amp; params.frame.verbosity&gt;=2) 
01953         (cout&lt;&lt;countT&lt;&lt;<span class="stringliteral">" slices global sumed, spends time : "</span>
01954          &lt;&lt;timeGlobalSum&lt;&lt;<span class="stringliteral">" s"</span>&lt;&lt;endl).flush();
01955     
01956   }
01957   MPI::COMM_WORLD.Barrier(); <span class="comment">//prepare processes</span>
01958 }
01959 
<a name="l01967"></a><a class="code" href="classImage.html#a15">01967</a> <span class="keywordtype">void</span> <a class="code" href="classImage.html#a14">Image::globalSum</a>(<a class="code" href="classImage.html">Image</a> &amp; Q, Params &amp; params)
01968 {
01969   <span class="keywordtype">int</span> buffSize =params.geometry.nX*params.geometry.nZ*
01970     Constant::GLOBALSUMSLICENUM; 
01971   <span class="keywordtype">int</span> sliceSize = params.geometry.nX*params.geometry.nZ;
01972   <span class="keywordtype">float</span> *sendBuff=<span class="keyword">new</span> <span class="keywordtype">float</span>[buffSize]; <span class="comment">//send buffer</span>
01973   <span class="keywordtype">float</span> *revBuff= <span class="keyword">new</span> <span class="keywordtype">float</span>[buffSize]; <span class="comment">//receive buffer</span>
01974   <span class="keywordtype">int</span> sendBuffIndex = 0;
01975   <span class="keywordtype">bool</span> enoughBuff = <span class="keyword">true</span>; <span class="comment">//if buffer has enough space for the next slice</span>
01976 
01977 
01978   <span class="keywordtype">int</span> ny = 0; <span class="comment">//init slice number</span>
01979   <span class="keywordflow">while</span>(ny&lt;params.geometry.nY){
01980     <span class="comment">//fill the send buffer</span>
01981     <span class="comment">// when elements of Q != 0</span>
01982     <span class="keywordtype">int</span> iyStart = ny; <span class="comment">//starting slice</span>
01983     <span class="keywordflow">while</span>(ny&lt;params.geometry.nY &amp;&amp; enoughBuff){      
01984       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> nz = 0; nz&lt; params.geometry.nZ; nz++)
01985         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> nx =0; nx &lt; params.geometry.nX; nx++){
01986           <span class="keywordflow">if</span>(Q(nx,ny,nz)!=0){ <span class="comment">//fill the send buffer</span>
01987             sendBuff[sendBuffIndex] = (*this)(nx,ny,nz);
01988             sendBuffIndex ++;
01989           }
01990         }
01991       <span class="comment">//check if the buffer enough for next slice</span>
01992       enoughBuff = (buffSize - sendBuffIndex) &gt; sliceSize; 
01993       ny++;<span class="comment">//next slice</span>
01994     }
01995     <span class="keywordtype">int</span> iyEnd = ny;<span class="comment">//end slice</span>
01996     <span class="comment">//Global sum</span>
01997     MPI::COMM_WORLD.Barrier(); 
01998     MPI::COMM_WORLD.Allreduce(sendBuff, revBuff, sendBuffIndex, 
01999                               MPI::FLOAT, MPI::SUM);
02000     <span class="comment">//using receive buffer to fill the image</span>
02001     <span class="keywordtype">int</span>  revBuffIndex = 0;
02002     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = iyStart; iy&lt;iyEnd; iy++) <span class="comment">//slice number</span>
02003       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0; iz&lt;params.geometry.nZ; iz++)
02004         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix = 0; ix&lt;params.geometry.nX; ix ++){
02005           <span class="keywordflow">if</span>(Q(ix,iy,iz)!=0){<span class="comment">//file image</span>
02006             (*this)(ix,iy,iz) = revBuff[revBuffIndex];
02007             revBuffIndex ++;
02008           }
02009         }
02010     <span class="keywordflow">if</span>(revBuffIndex!=sendBuffIndex) 
02011       cout&lt;&lt;<span class="stringliteral">"something wrong in nu global sum"</span>&lt;&lt;endl;
02012     <span class="comment">//reset the values</span>
02013     sendBuffIndex = 0;
02014     enoughBuff = <span class="keyword">true</span>;
02015   }
02016   <span class="keyword">delete</span> []sendBuff;
02017   <span class="keyword">delete</span> []revBuff;
02018 }
02019 
<a name="l02025"></a><a class="code" href="classImage.html#a16">02025</a> <span class="keywordtype">void</span> <a class="code" href="classImage.html#a16">Image::scale</a>(Params &amp; params, <span class="keywordtype">float</span> coeff)
02026 {
02027     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0; iy&lt;params.geometry.nY; iy++)
02028       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0; iz &lt; params.geometry.nZ; iz++)
02029         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0; ix&lt; params.geometry.nX; ix++)
02030           (*this)(ix,iy,iz) *= coeff;
02031 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
