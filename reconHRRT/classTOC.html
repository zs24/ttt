<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: TOC class Reference</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>TOC Class Reference</h1><code>#include &lt;<a class="el" href="TOC_8hpp-source.html">TOC.hpp</a>&gt;</code>
<p>
<a href="classTOC-members.html">List of all members.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#a0">TOC</a> (string &amp;fileName, string &amp;pathTOC)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>OFF_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#a1">estimateOffset</a> (int timeTag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#a2">getFrameStopTimeTag</a> (int requestedFrameStopTimeTag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>OFF_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#a3">getZeroOffset</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>bool&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#a4">isLookForZero</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>bool&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#a5">setLookForZero</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="anchor" name="a6" doxytag="TOC::get_fix_sing_time" ></a>
float&nbsp;</td><td class="memItemRight" valign=bottom><b>get_fix_sing_time</b> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="anchor" name="a7" doxytag="TOC::get_fix_sing_constant" ></a>
float&nbsp;</td><td class="memItemRight" valign=bottom><b>get_fix_sing_constant</b> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="anchor" name="a8" doxytag="TOC::getEstimatedCounts" ></a>
float&nbsp;</td><td class="memItemRight" valign=bottom><b>getEstimatedCounts</b> (long frameStartTimeTag, long frameStopTimeTag)</td></tr>

<tr><td colspan=2><br><h2>Static Public Member Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>bool&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#e0">isTimeTag</a> (unsigned short *b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#e1">processTimeTag</a> (unsigned short *b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>bool&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#e2">findPreviousEvent</a> (unsigned short *b, FILE *lun)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>bool&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#e3">findNextEvent</a> (unsigned short *b, FILE *lun)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>bool&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#e4">checkSync</a> (unsigned short *b, FILE *lun, long &amp;nSkip)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="anchor" name="e5" doxytag="TOC::checkSyncReverse" ></a>
bool&nbsp;</td><td class="memItemRight" valign=bottom><b>checkSyncReverse</b> (unsigned short *b, FILE *lun, long &amp;nSkip)</td></tr>

<tr><td colspan=2><br><h2>Friends</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="anchor" name="n0" doxytag="TOC::HRRTHouseList" ></a>
class&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="classTOC.html#n0">HRRTHouseList</a></td></tr>

</table>
<hr><a name="_details"></a><h2>Detailed Description</h2>
This class constructs table of offset for time tags for the head curve file And estimate the offset for a time tag 
<p>

<p>
Definition at line <a class="el" href="TOC_8hpp-source.html#l00014">14</a> of file <a class="el" href="TOC_8hpp-source.html">TOC.hpp</a>.<hr><h2>Constructor &amp; Destructor Documentation</h2>
<a class="anchor" name="a0" doxytag="TOC::TOC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> TOC::TOC </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">string &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>fileName</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>string &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>pathTOC</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Constructor if the TOC file does not exist, the function calls createTOC() to creat it <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>fileName</em>&nbsp;</td><td>.hc file name </td></tr>
    <tr><td valign=top><em>pathTOC</em>&nbsp;</td><td>path of the toc file </td></tr>
  </table>
</dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00017">17</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
References <a class="el" href="TOC_8cpp-source.html#l00616">setLookForZero()</a>.
<p>
<div class="fragment"><pre>00018 {
00019   <span class="keyword">extern</span> <span class="keywordtype">int</span> errno;
00020   <span class="keywordflow">if</span>(pathTOC == <span class="stringliteral">""</span>) {
00021   <span class="comment">//Let pathTOC be the study directory where the listmode is found</span>
00022       <span class="keywordtype">int</span> i1 = fileName.find_last_of(<span class="stringliteral">"/"</span>);
00023 
00024       pathTOC = fileName.substr(0,i1);
00025   }
00026   <span class="keywordtype">int</span> i1 = fileName.find_last_of(<span class="stringliteral">"/"</span>);
00027   string studyPath = fileName.substr(0,i1);
00028 
00029   Params *params = Params::getInstance();
00030   <span class="keywordflow">if</span>(fileName.find_last_of(<span class="stringliteral">".l64"</span>) != string::npos) {
00031      <span class="keywordtype">int</span> idx = fileName.find_last_of(<span class="stringliteral">"."</span>);
00032      fileName = fileName.replace(idx,4,<span class="stringliteral">".hc"</span>);
00033   }
00034   this-&gt;fileNameHC= fileName;
00035   
00036   <span class="keywordtype">int</span> index1 = fileNameHC.find_last_of(<span class="stringliteral">"/"</span>);
00037   <span class="keywordtype">int</span> index2 = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00038   string fileNameBase = fileName.substr(index1+1,index2-index1-1);
00039   fileNameTOC = pathTOC+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".toc"</span>;
00040   string fileNameTOC2 = studyPath+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".toc"</span>; 
00041   <span class="comment">// 2006-08-30 initialize singles fix parameter</span>
00042   <span class="comment">// will look for this file in the Study directory only</span>
00043   fileName_sing_fix = studyPath+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".toc2"</span>;
00044   sing_fix_time=0.;
00045   sing_fix_constant=0.;
00046   <span class="comment">//generate TOC file if the file does not exist</span>
00047   <span class="comment">//generate lock file to prevent multiprocessors generate TOC </span>
00048   <span class="comment">//file at same time</span>
00049   string fileNameLock = pathTOC+<span class="stringliteral">"/"</span>+fileNameBase+<span class="stringliteral">".lock"</span>;
00050   <span class="keywordtype">int</span> file_desc= open(fileNameLock.c_str(), O_RDWR |
00051                        O_CREAT | O_EXCL, 0444);
00052   <span class="keywordtype">int</span> isleep=0;
00053   <span class="keywordflow">while</span>( (file_desc==-1)&amp;&amp;(isleep &lt; 10000))
00054   {
00055     cout&lt;&lt;<span class="stringliteral">"TOC file is locked or you do not have permission to write "</span>
00056       &lt;&lt;fileNameTOC&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;fileNameLock&lt;&lt;endl;
00057     cout&lt;&lt;<span class="stringliteral">"Error number is: "</span>&lt;&lt;errno&lt;&lt;endl;
00058     cout&lt;&lt;<span class="stringliteral">"Will try 10000 times"</span>&lt;&lt;endl;
00059     file_desc= open(fileNameLock.c_str(), O_RDWR |
00060               O_CREAT | O_EXCL, 0444);
00061     isleep++;
00062     cout&lt;&lt;<span class="stringliteral">"This is try number "</span>&lt;&lt;isleep&lt;&lt;endl;
00063    
00064   }
00065   
00066   <span class="keywordflow">if</span>(isleep&gt;=10000)
00067   {
00068      cout&lt;&lt;<span class="stringliteral">"TOC file did not get better after 10000 tries  "</span>
00069         &lt;&lt;fileNameTOC&lt;&lt;endl;
00070      (<span class="keywordtype">void</span>) close(file_desc);
00071      (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00072       exit(-1);
00073   }
00074 
00075   <span class="keywordflow">if</span>(file_desc!=-1)
00076   {
00077     ifstream isTOC2(fileNameTOC2.c_str());
00078     <span class="comment">//Look in the study directory first</span>
00079     <span class="keywordflow">if</span>(!isTOC2) {
00080          <span class="comment">//Now look in the scratch path specified</span>
00081          ifstream isTOC(fileNameTOC.c_str());
00082          <span class="comment">//Not in both create one now</span>
00083          <span class="keywordflow">if</span>(!isTOC) {
00084              <span class="keywordflow">if</span>(!CreateTOC()){
00085                cout&lt;&lt;<span class="stringliteral">"Error in generate TOC file"</span>&lt;&lt;endl;
00086                (<span class="keywordtype">void</span>) close(file_desc);
00087                (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00088 
00089                exit(-1);
00090              }
00091              <span class="comment">//close lock file;</span>
00092              (<span class="keywordtype">void</span>) close(file_desc);
00093              (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00094          } <span class="keywordflow">else</span> {
00095            <span class="keywordflow">if</span>(!<a class="code" href="classTOC.html#a5">setLookForZero</a>()) {
00096               cout&lt;&lt;<span class="stringliteral">"Error in reading TOC file :"</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00097               (<span class="keywordtype">void</span>) close(file_desc);
00098               (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00099 
00100               exit(-1);
00101            }
00102          }
00103      } <span class="keywordflow">else</span> {
00104        <span class="comment">// found TOC in study path</span>
00105        fileNameTOC = fileNameTOC2;
00106        <span class="keywordflow">if</span>(!<a class="code" href="classTOC.html#a5">setLookForZero</a>()) {
00107           cout&lt;&lt;<span class="stringliteral">"Error in reading TOC file :"</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00108           (<span class="keywordtype">void</span>) close(file_desc);
00109           (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00110 
00111           exit(-1);
00112        }
00113        <span class="comment">// 2006-08-30 now open singles fix file and read values</span>
00114        ifstream isSF;
00115        isSF.open(fileName_sing_fix.c_str());
00116        <span class="keywordflow">if</span>(!isSF) {
00117          cout&lt;&lt;<span class="stringliteral">"No file with singles fix information found named "</span>&lt;&lt;fileName_sing_fix&lt;&lt;endl;
00118        } <span class="keywordflow">else</span> {
00119         <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00120         <span class="keywordtype">char</span> buff[256];
00121         isSF&gt;&gt;sing_fix_time&gt;&gt;sing_fix_constant;
00122         isSF.close();
00123         cout&lt;&lt;<span class="stringliteral">"TOC:Will correct singles after "</span>&lt;&lt;sing_fix_time&lt;&lt;<span class="stringliteral">" msec with constant "</span>&lt;&lt;sing_fix_constant&lt;&lt;endl;
00124        }
00125      }
00126   }
00127  (<span class="keywordtype">void</span>) close(file_desc);
00128  (<span class="keywordtype">void</span>) unlink(fileNameLock.c_str());
00129 
00130 }
</pre></div>    </td>
  </tr>
</table>
<hr><h2>Member Function Documentation</h2>
<a class="anchor" name="e4" doxytag="TOC::checkSync" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> bool TOC::checkSync </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>b</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>FILE *&nbsp;</td>
          <td class="mdname" nowrap> <em>lun</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>long &amp;&nbsp;</td>
          <td class="mdname" nowrap> <em>nSkip</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This static function checks if the two 32 bit words synchronized if not read in a word till it is synchronized <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>b</em>&nbsp;</td><td>pointer to 64 bit word </td></tr>
    <tr><td valign=top><em>lun</em>&nbsp;</td><td>the file pointer to the list mode file </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true if synchronized, false if end of file reached or i/o error </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00487">487</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00472">findNextEvent()</a>.
<p>
<div class="fragment"><pre>00488 {
00489   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> buf;
00490   Params *params = Params::getInstance();
00491   <span class="keywordflow">while</span>( ((b[1]&gt;&gt;15) != 0) || ((b[3]&gt;&gt;15) != 1 )) {
00492     <span class="comment">//check the corresponding bits</span>
00493     <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5)
00494       cout&lt;&lt;<span class="stringliteral">"Out of sync, skipped 1 word..."</span>&lt;&lt;endl;
00495     nSkip ++;
00496     b[0] = b[2];
00497     b[1] = b[3];
00498     <span class="comment">//read in a word</span>
00499     <span class="keywordflow">if</span> (feof(lun) ||ferror(lun)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00500     fread(&amp;buf, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 1, lun);<span class="comment">//first 16 bits</span>
00501     b[2] = buf;
00502     fread(&amp;buf, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 1, lun);<span class="comment">//second 16 bits</span>
00503     b[3] = buf;
00504   }
00505   <span class="keywordflow">if</span> (feof(lun) ||ferror(lun)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00506   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00507 }       
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="TOC::estimateOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> OFF_T TOC::estimateOffset </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>timeTag</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This function estimates the offset of a time tag from the TOC file <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>timeTag</em>&nbsp;</td><td>the time tag for which the offset to be estimated </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>the offset of the time tag </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00269">269</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00376">getFrameStopTimeTag()</a>, and <a class="el" href="TOC_8cpp-source.html#l00607">getZeroOffset()</a>.
<p>
<div class="fragment"><pre>00270 {
00271   <span class="comment">//if toc file is not existed, created it</span>
00272   ifstream isTOC;
00273   isTOC.open(fileNameTOC.c_str());
00274   <span class="keywordflow">if</span>(!isTOC) {
00275     cout&lt;&lt;<span class="stringliteral">"Error in openning TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00276     <span class="keywordflow">return</span> -1;
00277   }
00278   <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00279   <span class="keywordtype">char</span> buff[256];
00280   isTOC&gt;&gt;firstTimeTag;
00281   isTOC.getline(buff, 256);
00282   isTOC&gt;&gt;lastTimeTag;
00283   isTOC.getline(buff, 256);
00284   isTOC.getline(buff, 256); <span class="comment">//pass comments</span>
00285   OFF_T offset=0;
00286   <span class="keywordtype">int</span> thisTimeTag = -1, singles, randoms, prompts;
00287   <span class="comment">//read the TOC file </span>
00288   <span class="keywordflow">if</span>(timeTag&lt;0 &amp;&amp; lookForZero){
00289     isTOC&gt;&gt;thisTimeTag&gt;&gt;offset;<span class="comment">//&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;</span>
00290     <span class="keywordflow">return</span> offset;
00291   }
00292   <span class="keywordflow">if</span>(timeTag&lt;0 &amp;&amp; !lookForZero)
00293     <span class="keywordflow">return</span> 0;
00294   
00295   <span class="keywordflow">while</span>(thisTimeTag &lt; timeTag &amp;&amp; !isTOC.eof() &amp;&amp; !isTOC.bad()) {
00296     isTOC&gt;&gt;thisTimeTag&gt;&gt;offset;<span class="comment">//&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;</span>
00297     isTOC.getline(buff, 256);
00298   }
00299   <span class="keywordflow">if</span>(isTOC.eof() || isTOC.bad()){
00300     cout&lt;&lt;<span class="stringliteral">"Did not find the offset for specified time tag "</span>&lt;&lt;timeTag
00301         &lt;&lt;<span class="stringliteral">" in TOC file"</span>&lt;&lt;endl;
00302     cout&lt;&lt;<span class="stringliteral">" The last time tag and offset in TOC file is "</span>
00303         &lt;&lt;thisTimeTag&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;offset&lt;&lt;endl;
00304     <span class="keywordflow">return</span> offset;
00305   }
00306   <span class="comment">//Adust the offset  </span>
00307   <span class="comment">/*int timeInterval =  thisTimeTag - timeTag;</span>
00308 <span class="comment">  offset = offset - (float) timeInterval*(randoms+prompts)/TIMETAGPERSECOND</span>
00309 <span class="comment">  *BYTEPERCOUNT/SAVEUNIT;*/</span>
00310   <span class="keywordflow">return</span> offset;
00311 }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="e3" doxytag="TOC::findNextEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> bool TOC::findNextEvent </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>b</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>FILE *&nbsp;</td>
          <td class="mdname" nowrap> <em>lun</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This static function find a event forward from a list mode file <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>b</em>&nbsp;</td><td>pointer to 64 bit word </td></tr>
    <tr><td valign=top><em>lun</em>&nbsp;</td><td>the file pointer to the list mode file </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true if find an event, false when the end of file reached </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00472">472</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
References <a class="el" href="TOC_8cpp-source.html#l00487">checkSync()</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00376">getFrameStopTimeTag()</a>.
<p>
<div class="fragment"><pre>00473 {
00474   <span class="comment">//if end of file reached</span>
00475   <span class="keywordtype">long</span> nSkip=0;
00476   <span class="keywordflow">if</span>(feof(lun))
00477     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00478   fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun); <span class="comment">//read in 64 bit (2 words)</span>
00479   <span class="keywordflow">if</span> (!<a class="code" href="classTOC.html#e4">checkSync</a>(b, lun, nSkip)) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00480   <span class="comment">//check if the 2 word synchronized</span>
00481   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00482 }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="e2" doxytag="TOC::findPreviousEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> bool TOC::findPreviousEvent </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname" nowrap> <em>b</em>, </td>
        </tr>
        <tr>
          <td></td>
          <td></td>
          <td class="md" nowrap>FILE *&nbsp;</td>
          <td class="mdname" nowrap> <em>lun</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"><code> [static]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This static function find a event backward from a list mode file <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>b</em>&nbsp;</td><td>pointer to 64 bit word </td></tr>
    <tr><td valign=top><em>lun</em>&nbsp;</td><td>the file pointer to the list mode file </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true if find an event, false when the beginning of file reached </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00453">453</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00376">getFrameStopTimeTag()</a>.
<p>
<div class="fragment"><pre>00454 {
00455   OFF_T offset; <span class="comment">//current offset of the file</span>
00456   <span class="keywordtype">long</span> nSkip=0;
00457   <span class="comment">//beginning of the file reached</span>
00458   <span class="keywordflow">if</span>(ftello(lun) &lt; 2*Constant::BYTESPERCOUNT)
00459     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00460   <span class="comment">//go backward 2 event counts..since we have already examined -1*8 bytes event</span>
00461   <span class="comment">//and are interested in the -2*8 bytes offset event</span>
00462   offset = -2*Constant::BYTESPERCOUNT;
00463   fseeko(lun, offset, SEEK_CUR);
00464   <span class="comment">//read in a event count</span>
00465   fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun); <span class="comment">//read in 64 bit (2 words)</span>
00466   <span class="keywordflow">if</span> (!checkSyncReverse(b, lun, nSkip)) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00467   <span class="comment">//check if the 2 word synchronized</span>
00468   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00469 }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="TOC::getFrameStopTimeTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int TOC::getFrameStopTimeTag </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">int&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>requestedFrameStopTimeTag</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This function returns the actual stop time tag of the frame Given the requested frame stop time tag, which is calculated from the House::gotoFrameStartTimeTag() function, this function will find the actual frame stop time tag. There are two cases the actual frame stop time tag is different from the requested frame stop time tag. The first one is the requested frame time exceed the last time tag of the list mode file, then the actual stop time tag will be assigned as the last time tag of the list mode file. The second case is that the requested frame stop time tag is missed in the list mode, then the actual time tag will be the next time tag of the requested frame stop time tag in the list mode file. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>requestedFrameStopTimeTag</em>&nbsp;</td><td>requested frame stop time tag </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>actual frame stop time tag </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00376">376</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
References <a class="el" href="TOC_8cpp-source.html#l00269">estimateOffset()</a>, <a class="el" href="TOC_8cpp-source.html#l00472">findNextEvent()</a>, <a class="el" href="TOC_8cpp-source.html#l00453">findPreviousEvent()</a>, <a class="el" href="Utilities_8hpp-source.html#l00085">Utilities::getFileLength()</a>, <a class="el" href="TOC_8hpp-source.html#l00064">isTimeTag()</a>, <a class="el" href="Utilities_8hpp-source.html#l00095">Utilities::logError()</a>, and <a class="el" href="TOC_8hpp-source.html#l00073">processTimeTag()</a>.
<p>
<div class="fragment"><pre>00377 {
00378   <span class="keywordtype">int</span> frameStopTimeTag;
00379 <span class="comment">//estimate the offset of the requested frame stop time </span>
00380 <span class="comment">//tag in the list mode file</span>
00381   OFF_T offset;
00382   offset = <a class="code" href="classTOC.html#a1">estimateOffset</a>(requestedFrameStopTimeTag);
00383   <span class="comment">//open the list mode file</span>
00384   <span class="keywordtype">int</span> index2 = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00385   string fileNameListMode = fileNameHC;
00386   <span class="keywordflow">if</span>(fileNameListMode.find_last_of(<span class="stringliteral">".hc"</span>) != string::npos)
00387      fileNameListMode.replace(index2,3,<span class="stringliteral">".l64"</span>);
00388   FILE * fListMode;
00389   <span class="keywordflow">if</span>((fListMode = fopen(fileNameListMode.c_str(), <span class="stringliteral">"rb"</span>))==0){
00390     string msg = <span class="stringliteral">"Error in open the list mode file"</span>;
00391     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00392     <span class="keywordflow">return</span> Constant::IOERROR;
00393   }
00394                 
00395   <span class="keywordflow">if</span>(offset &lt;0 ||offset&gt;<a class="code" href="classUtilities.html#e6">Utilities::getFileLength</a>(fListMode) ){
00396     string msg = <span class="stringliteral">"TOC offset error"</span>;
00397     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00398     <span class="keywordflow">return</span> Constant::IOERROR;
00399   }
00400 
00401   <span class="comment">//put the file pointer to the offset</span>
00402   fseeko(fListMode, offset, SEEK_SET);
00403 
00404   <span class="comment">//find the actual stop time tag, this logic is similar as which </span>
00405   <span class="comment">//in House::gotoFrameStartTimeTag function</span>
00406 
00407   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4]; <span class="comment">//buffer to hold 64 bits read from list mode file</span>
00408   <span class="keywordtype">bool</span> success; <span class="comment">//if read the list mode success</span>
00409   
00410   <span class="keywordtype">bool</span> reverseFlag = <span class="keyword">true</span>; <span class="comment">//look for backward first</span>
00411   <span class="keywordtype">bool</span> foundItFlag = <span class="keyword">false</span>;
00412   <span class="keywordtype">int</span> thisTimeTag;
00413   <span class="keywordflow">while</span>(!foundItFlag) {
00414     <span class="keywordflow">do</span> {
00415       <span class="keywordflow">if</span>(reverseFlag)
00416         <span class="comment">//find backward</span>
00417         success = <a class="code" href="classTOC.html#e2">findPreviousEvent</a>(b, fListMode);
00418       <span class="keywordflow">else</span>
00419         <span class="comment">//find forward</span>
00420         success = <a class="code" href="classTOC.html#e3">findNextEvent</a>(b,fListMode);
00421       
00422     } <span class="keywordflow">while</span>(!<a class="code" href="classTOC.html#e0">isTimeTag</a>(b) &amp;&amp; success);
00423     <span class="keywordflow">if</span>(!success &amp;&amp; ! feof(fListMode)){ <span class="comment">//beginning of the file reached</span>
00424       <span class="comment">//string msg = "Error in get stop time tag: beginning of file reached";</span>
00425       <span class="comment">// Utilities::logError(msg);</span>
00426       <span class="comment">//return Constant::IOERROR;</span>
00427       reverseFlag = <span class="keyword">false</span>;
00428 
00429     }
00430     
00431     <span class="keywordflow">if</span>(<a class="code" href="classTOC.html#e0">isTimeTag</a>(b))
00432       thisTimeTag = <a class="code" href="classTOC.html#e1">processTimeTag</a>(b);
00433     <span class="keywordflow">if</span>(thisTimeTag &lt; requestedFrameStopTimeTag)
00434       <span class="comment">//go forward</span>
00435       reverseFlag = <span class="keyword">false</span>;
00436   
00437     <span class="keywordflow">if</span>((thisTimeTag == requestedFrameStopTimeTag)<span class="comment">//find it </span>
00438        ||(!reverseFlag  &amp;&amp;(thisTimeTag &gt;requestedFrameStopTimeTag))
00439        <span class="comment">//the requested time tag missing</span>
00440        ||(feof(fListMode))<span class="comment">//requestedTimeTag &gt; last time tag in file</span>
00441        )
00442       <span class="comment">//found it</span>
00443       foundItFlag = <span class="keyword">true</span>;
00444   
00445   }
00446 
00447   frameStopTimeTag = thisTimeTag;
00448   fclose(fListMode);
00449   <span class="keywordflow">return</span> frameStopTimeTag;
00450 }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="TOC::getZeroOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> OFF_T TOC::getZeroOffset </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Gets the offset of zero time tag <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>lookForZeroTag</em>&nbsp;</td><td>if the list mode file has the zero time tag </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>offset of the zero time tag if lookForZero is true, -1 otherwise </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00607">607</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
References <a class="el" href="TOC_8cpp-source.html#l00269">estimateOffset()</a>.
<p>
<div class="fragment"><pre>00608 {
00609   <span class="keywordflow">if</span>(!lookForZero)
00610     <span class="keywordflow">return</span> -1;
00611   <span class="keywordflow">else</span>
00612     <span class="keywordflow">return</span> <a class="code" href="classTOC.html#a1">estimateOffset</a>(0);
00613 }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="TOC::isLookForZero" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> bool TOC::isLookForZero </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Returns the lookForZero parameter. This supercedes the lookForZero parameter in the <a class="el" href="structParams_1_1Frame.html">Params.Frame</a> structure. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>whether there is a zero tag or not </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8hpp-source.html#l00139">139</a> of file <a class="el" href="TOC_8hpp-source.html">TOC.hpp</a>.
<p>
<div class="fragment"><pre>00139                        {
00140       <span class="keywordflow">return</span> this-&gt;lookForZero;
00141   }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="e0" doxytag="TOC::isTimeTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> bool TOC::isTimeTag </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>b</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline, static]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This static function determines if an event is a time tag <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>b</em>&nbsp;</td><td>pointer to 64 bit word </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>true, if it is a time tag, false else </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8hpp-source.html#l00064">64</a> of file <a class="el" href="TOC_8hpp-source.html">TOC.hpp</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00376">getFrameStopTimeTag()</a>.
<p>
<div class="fragment"><pre>00065   {
00066     <span class="keywordflow">return</span> ( ((b[1] &amp; 0x4000 )&gt;&gt;14) ==1 &amp;&amp; (b[2] &amp; 0xe000) == 0x8000);
00067   }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="e1" doxytag="TOC::processTimeTag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int TOC::processTimeTag </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">unsigned short *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>b</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap><code> [inline, static]</code></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
This static function process a time tag event <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>b</em>&nbsp;</td><td>pointer to 64 bit word </td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>the time tag </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8hpp-source.html#l00073">73</a> of file <a class="el" href="TOC_8hpp-source.html">TOC.hpp</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00376">getFrameStopTimeTag()</a>.
<p>
<div class="fragment"><pre>00074   {
00075     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> b2=b[2], b0=b[0], mask=0x1fff;
00076     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> bMask = (b2 &amp; mask)&lt;&lt;16;
00077     <span class="keywordflow">return</span> (bMask+b0);
00078   }
</pre></div>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="TOC::setLookForZero" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> bool TOC::setLookForZero </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>

      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
Looks for zero tag in the TOC file and sets the lookForZero parameter. This supercedes the lookForZero parameter in the <a class="el" href="structParams_1_1Frame.html">Params.Frame</a> structure. <dl compact><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign=top><em>none</em>&nbsp;</td><td></td></tr>
  </table>
</dl>
<dl compact><dt><b>Returns:</b></dt><dd>whether it was successful in opening and reading the TOC file </dd></dl>

<p>
Definition at line <a class="el" href="TOC_8cpp-source.html#l00616">616</a> of file <a class="el" href="TOC_8cpp-source.html">TOC.cpp</a>.
<p>
Referenced by <a class="el" href="TOC_8cpp-source.html#l00017">TOC()</a>.
<p>
<div class="fragment"><pre>00617 {
00618   <span class="comment">//if toc file is not existed, created it</span>
00619   ifstream isTOC;
00620   isTOC.open(fileNameTOC.c_str());
00621   <span class="keywordflow">if</span>(!isTOC) {
00622     cout&lt;&lt;<span class="stringliteral">"Error in openning TOC file "</span>&lt;&lt;fileNameTOC&lt;&lt;endl;
00623     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00624   }
00625   <span class="keywordtype">int</span> firstTimeTag, lastTimeTag;
00626   <span class="keywordtype">char</span> buff[256];
00627   isTOC&gt;&gt;firstTimeTag;
00628   isTOC.getline(buff, 256);
00629   isTOC&gt;&gt;lastTimeTag;
00630   isTOC.getline(buff, 256);
00631   isTOC.getline(buff, 256); <span class="comment">//pass comments</span>
00632   OFF_T offset=0;
00633   <span class="keywordtype">int</span> thisTimeTag = -1, singles, randoms, prompts;
00634   <span class="comment">//read the TOC file </span>
00635   isTOC&gt;&gt;thisTimeTag&gt;&gt;offset;<span class="comment">//&gt;&gt;singles&gt;&gt;randoms&gt;&gt;prompts;</span>
00636   <span class="keywordflow">if</span>(thisTimeTag == 0) {
00637         this-&gt;lookForZero = <span class="keyword">true</span>;
00638   } <span class="keywordflow">else</span> {
00639         this-&gt;lookForZero = <span class="keyword">false</span>;
00640   }
00641   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00642 }
</pre></div>    </td>
  </tr>
</table>
<hr>The documentation for this class was generated from the following files:<ul>
<li><a class="el" href="TOC_8hpp-source.html">TOC.hpp</a><li><a class="el" href="TOC_8cpp-source.html">TOC.cpp</a></ul>
<hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:50 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
