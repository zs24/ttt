<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: HRRTHouseResolution.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>HRRTHouseResolution.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include &lt;sstream&gt;</span>
00004 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00005 <span class="preprocessor">#include "HRRTHouseResolution.hpp"</span>
00006 <span class="preprocessor">#include "Status.hpp"</span>
00007 <span class="preprocessor">#include "ResolutionFunction.hpp"</span>
00008 <span class="preprocessor">#include "IsoGaussian.hpp"</span>
00009 <span class="preprocessor">#include "Utilities.hpp"</span>
00010 <span class="preprocessor">#include "Constant.hpp"</span>
00011 <span class="preprocessor">#include "TOC.hpp"</span>
00012 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00013 
00014 
00015 
00016 <span class="comment">/**********************************************************************</span>
00017 <span class="comment">;+</span>
00018 <span class="comment">;       NAME</span>
00019 <span class="comment">;               void createReaolutionTable()</span>
00020 <span class="comment">;</span>
00021 <span class="comment">;       DESCRIPTION</span>
00022 <span class="comment">;               create resolution functions</span>
00023 <span class="comment">;</span>
00024 <span class="comment">;       OUTPUT</span>
00025 <span class="comment">;           resFunR, resFunU - radial and axial resolution functions</span>
00026 <span class="comment">;    Parameters</span>
00027 <span class="comment">;</span>
00028 <span class="comment">;     params   - parameter object from API</span>
00029 <span class="comment">;</span>
00030 <span class="comment">;     params-&gt;resolutionmodel.modeltype - fixed:gaussian; ...</span>
00031 <span class="comment">; params-&gt;resolutionmodel.xtab_file - string, if not null, </span>
00032 <span class="comment">  file names of the external resolution table</span>
00033 <span class="comment">;          (ResFile.r and ResFile.z]</span>
00034 <span class="comment">; </span>
00035 <span class="comment">;       </span>
00036 <span class="comment">;-</span>
00037 <span class="comment">**********************************************************************/</span>
00038 
00039 <span class="keywordtype">void</span> HRRTHouseResolution::createResolutionTable()
00040 {
00041         
00042   Status *status = Status::getStatus();
00043   <span class="comment">//check if the pointer initialized when use it</span>
00044   <span class="keywordflow">if</span>(!checkValid()){
00045     <span class="keywordflow">if</span>(status-&gt;proc ==0){
00046       cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseResolution"</span>
00047           &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00048           &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00049       cout.flush();
00050     }
00051     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00052   }
00053   Params * params = Params::getInstance();
00054   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> * scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00055   <span class="comment">/*if (!params-&gt;resolutionModel.xtab_file.empty()){ </span>
00056 <span class="comment">    //if resolution table file pre defined, read it in</span>
00057 <span class="comment">    //open 1st file and read tableR</span>
00058 <span class="comment">    string fileTableR = params-&gt;resolutionModel.xtab_file+".r";</span>
00059 <span class="comment">    //tableR.read(fileTableR);</span>
00060 <span class="comment">    </span>
00061 <span class="comment">    //open 2nd file and read table_z</span>
00062 <span class="comment">    string fileTableZ = params-&gt;resolutionModel.xtab_file+".z";</span>
00063 <span class="comment">    //tableZ.read(fileTableZ);</span>
00064 <span class="comment">  }</span>
00065 <span class="comment">  else{*/</span> <span class="comment">//else, generate resolution table using some models</span>
00066     
00067   <span class="keywordflow">if</span> (stricmp(params-&gt;resolutionModel.modelType.c_str(), <span class="stringliteral">"fixed"</span>)==0){ 
00068     <span class="comment">//fixed model: Gaussian</span>
00069     
00070     <a class="code" href="classResolutionFunction.html">ResolutionFunction</a> * resolutionFunction = 
00071       <span class="keyword">new</span> <a class="code" href="classIsoGaussian.html">IsoGaussian</a>(*params, scanner);
00072     <span class="comment">//get maping index</span>
00073     codeIndexR=(resolutionFunction-&gt;<a class="code" href="classResolutionFunction.html#a8">getCodeIndexR</a>());
00074     codeIndexU = (resolutionFunction-&gt;<a class="code" href="classResolutionFunction.html#a9">getCodeIndexU</a>());
00075     <span class="comment">//get resolution function</span>
00076     resFunR = resolutionFunction-&gt;<a class="code" href="classResolutionFunction.html#a6">getResFunR</a>();
00077     resFunU = resolutionFunction-&gt;<a class="code" href="classResolutionFunction.html#a7">getResFunU</a>();
00078     <span class="keyword">delete</span> resolutionFunction;
00079   }
00080   <span class="keywordflow">else</span>{
00081     <span class="keywordflow">if</span>(status-&gt;proc==0){
00082       cout&lt;&lt;<span class="stringliteral">"The resolution function type "</span>
00083           &lt;&lt;params-&gt;resolutionModel.modelType
00084           &lt;&lt;<span class="stringliteral">" is not available, program aborted"</span>&lt;&lt;endl;
00085     }
00086     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::RESOLUTIONFUNCTIONERROR);
00087   }
00088   
00089   <span class="keywordflow">if</span>(params-&gt;resolutionModel.verbosity){
00090     <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00091     stringstream ss;
00092     <span class="keywordflow">if</span>(status-&gt;proc ==0){       
00093       ss&lt;&lt;<span class="stringliteral">"=========================================="</span>&lt;&lt;endl;
00094       ss&lt;&lt;<span class="stringliteral">"Resolution tables estabilished:"</span>&lt;&lt;endl;
00095       ss&lt;&lt;<span class="stringliteral">"  Modeltype: "</span>&lt;&lt;params-&gt;resolutionModel.modelType&lt;&lt;endl;
00096       ss&lt;&lt;<span class="stringliteral">"  FWHM: "</span>&lt;&lt;params-&gt;resolutionModel.FWHM&lt;&lt;endl;
00097       ss&lt;&lt;<span class="stringliteral">"  PercentCutoff: "</span>&lt;&lt;params-&gt;resolutionModel.percentCutoff
00098         &lt;&lt;endl;
00099       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(), RESOLUTIONMODEL, 1);
00100     }
00101   }     
00102 }
00103 
00104 
00105 
00106 <span class="comment">//---------------------------------------------------------------------</span>
00107 <span class="comment">//DESCRIPTION</span>
00108 <span class="comment">//  return the index of radial resolution function</span>
00109 <span class="comment">//Parameters:</span>
00110 <span class="comment">// t0 (4):              Layers,   t0 = n_layer * lyr2  +  lyr1   0 to 3</span>
00111 <span class="comment">// t1 (72x2):   lors between 2 detector  banks. </span>
00112 <span class="comment">//  t1 =  ( id1-id2 ) + n_dtct</span>
00113 <span class="comment">// t2 (5):  banks where the 2 detectors in coincidence are located:     </span>
00114 <span class="comment">//  t2 = ( bnk1 - bnk2 ) - n_bank/2 + n_bank/4</span>
00115 <span class="comment">//---------------------------------------------------------------------</span>
00116 <span class="keywordtype">short</span> HRRTHouseResolution::getResFunRIndex(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, 
00117                                  <span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2)
00118 {
00119   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00120   <span class="keywordtype">int</span> t0 =  e2.<a class="code" href="structCrystalID.html#o3">layer</a>*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a> + e1.<a class="code" href="structCrystalID.html#o3">layer</a>;
00121   <span class="keywordtype">int</span> t1 = (e2.<a class="code" href="structCrystalID.html#o0">dtct</a> - e1.<a class="code" href="structCrystalID.html#o0">dtct</a>) + scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>;
00122   <span class="keywordtype">int</span> t2 = abs(e2.<a class="code" href="structCrystalID.html#o2">bank</a> - e1.<a class="code" href="structCrystalID.html#o2">bank</a>) - scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>/2 + 
00123     scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>/2/2;
00124   <span class="keywordflow">return</span> codeIndexR(t0,t1,t2);
00125 }
00126 
00127 
00128 <span class="comment">//-----------------------------------------------------------------------------</span>
00129 <span class="comment">//       DESCRIPTION</span>
00130 <span class="comment">//               return the index of axial resolution function</span>
00131 <span class="comment">//              Parameters</span>
00132 <span class="comment">//              t0 (4):         Layers,   t0 = n_layer * lyr2  +  lyr1  0 to 3</span>
00133 <span class="comment">//      t1 (208):       lors between 2 rings.  t1 =  ( rng1 - rng2 ) + n_ring</span>
00134 <span class="comment">//-----------------------------------------------------------------------------</span>
00135 <span class="keywordtype">short</span> HRRTHouseResolution::getResFunZIndex(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, 
00136                                  <span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2)
00137 {
00138   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00139   <span class="keywordtype">int</span>   t0 = e2.<a class="code" href="structCrystalID.html#o3">layer</a>*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a> + e1.<a class="code" href="structCrystalID.html#o3">layer</a>;
00140   <span class="keywordtype">int</span>   t1 = (e2.<a class="code" href="structCrystalID.html#o1">ring</a> - e1.<a class="code" href="structCrystalID.html#o1">ring</a>) + scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>;
00141   <span class="keywordflow">return</span> codeIndexU(t0,t1);
00142 }
00143 
00144 
00145 <span class="comment">/*;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
00146 <span class="comment">  ;+</span>
00147 <span class="comment">  ;       NAME</span>
00148 <span class="comment">  ;               getResFunR</span>
00149 <span class="comment">  ;</span>
00150 <span class="comment">  ;       SYNOPSIS</span>
00151 <span class="comment">  ;               resfun = getResFunR(const short &amp; index)</span>
00152 <span class="comment">  ;</span>
00153 <span class="comment">  ;       INPUT</span>
00154 <span class="comment">  ;                             index - index of r resolution function</span>
00155 <span class="comment">  ;             OUTPUT</span>
00156 <span class="comment">  ;          resFunR[index] - Resolution function in radial direction </span>
00157 <span class="comment">  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;*/</span>
00158 
00159 <a class="code" href="structResolutionTable.html">ResolutionTable</a> HRRTHouseResolution::getResFunR(<span class="keyword">const</span> <span class="keywordtype">short</span> &amp;index)
00160 {
00161   <span class="keywordflow">return</span> resFunR[index];
00162 }
00163         
00164 <span class="comment">/*;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
00165 <span class="comment">  ;+</span>
00166 <span class="comment">  ;       NAME</span>
00167 <span class="comment">  ;               getResFunZ</span>
00168 <span class="comment">  ;</span>
00169 <span class="comment">  ;       SYNOPSIS</span>
00170 <span class="comment">  ;               resfun = getResFunZ(const short &amp; index)</span>
00171 <span class="comment">  ;</span>
00172 <span class="comment">  ;       PARAMETERS</span>
00173 <span class="comment">  ;               resFunU - Resolution function in axial direction </span>
00174 <span class="comment">  ;               index - index into U resolution function</span>
00175 <span class="comment">  ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;*/</span>
00176 <a class="code" href="structResolutionTable.html">ResolutionTable</a> HRRTHouseResolution::getResFunZ(<span class="keyword">const</span> <span class="keywordtype">short</span> &amp;index)
00177 {
00178   <span class="keywordflow">return</span> resFunU[index];
00179 }
00180 
00181 <span class="comment">//for debug purpose</span>
00182 <span class="keywordtype">void</span> HRRTHouseResolution::write()
00183 {
00184   
00185   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00186 
00187   <span class="comment">//debug variables</span>
00188   <span class="keyword">const</span> <span class="keywordtype">int</span> nLayerSquare = POW2(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>);  <span class="comment">//layers</span>
00189   <span class="keyword">const</span> <span class="keywordtype">int</span> nDtctDouble = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>*2; 
00190   <span class="comment">//lors between 2 detector  banks.</span>
00191   <span class="keyword">const</span> <span class="keywordtype">int</span> nCoincidence = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o10">coincidence</a>; 
00192 
00193   <span class="comment">//banks where the 2 detectors in coincidence are located</span>
00194   Status * status = Status::getStatus();
00195   <span class="keywordflow">if</span>(status-&gt;proc==0){
00196     <span class="keywordtype">int</span> numResCode=1;
00197     <span class="comment">//output to file</span>
00198     cout&lt;&lt;<span class="stringliteral">"write to table r"</span>&lt;&lt;endl;
00199     ofstream ftableR(<span class="stringliteral">"tableR.dat"</span>);
00200     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;Constant::LENGTH_RESFUN;i++)
00201       ftableR&lt;&lt;i&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;resFunR[0].kernel[i]&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;endl;
00202         ftableR&lt;&lt;endl;
00203         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numResCode; i++)
00204           ftableR&lt;&lt;<span class="stringliteral">"CentralIndex : "</span>
00205                  &lt;&lt;resFunR[i].kCentralIndex
00206                  &lt;&lt;<span class="stringliteral">" central value "</span>
00207                  &lt;&lt;resFunR[i].kernel[resFunR[i].kCentralIndex]
00208                  &lt;&lt; <span class="stringliteral">", downSpread : "</span>
00209                  &lt;&lt;resFunR[i].downSpread
00210                  &lt;&lt;<span class="stringliteral">", upSpread : "</span>
00211                  &lt;&lt;resFunR[i].upSpread&lt;&lt;endl;
00212         ftableR&lt;&lt;<span class="stringliteral">"magnification: "</span>&lt;&lt;resFunR[0].magnification&lt;&lt;endl;
00213         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> k=0; k&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o10">coincidence</a>; k++)
00214           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>*2; j++){
00215             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; nLayerSquare; i++)
00216               ftableR&lt;&lt;codeIndexR(i,j,k)&lt;&lt;<span class="stringliteral">" "</span>;
00217             ftableR&lt;&lt;endl;
00218           }
00219 
00220         
00221         ftableR.close();
00222         <span class="comment">//output to file</span>
00223         ofstream ftableU(<span class="stringliteral">"tableU.dat"</span>);
00224         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;Constant::LENGTH_RESFUN;i++)
00225           ftableU&lt;&lt;i&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;resFunU[0].kernel[i]&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;endl;
00226         ftableU&lt;&lt;endl;
00227         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numResCode; i++)
00228           ftableU&lt;&lt;<span class="stringliteral">"CentralIndex : "</span>&lt;&lt;resFunU[i].kCentralIndex
00229                  &lt;&lt;<span class="stringliteral">", downSpread : "</span>&lt;&lt;resFunU[i].downSpread
00230                  &lt;&lt;<span class="stringliteral">", upSpread : "</span>&lt;&lt;resFunU[i].upSpread&lt;&lt;endl;
00231         ftableU&lt;&lt;<span class="stringliteral">"magnification : "</span>&lt;&lt;resFunU[0].magnification &lt;&lt;endl;
00232         ftableU&lt;&lt;<span class="stringliteral">"numResCode : "</span>&lt;&lt;numResCode &lt;&lt;endl;
00233         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>*2; j++){
00234           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt; nLayerSquare; i++)
00235             ftableU&lt;&lt;codeIndexU(i,j)&lt;&lt;<span class="stringliteral">" "</span>;
00236           ftableU&lt;&lt;endl;
00237         }
00238         ftableU.close();
00239   }
00240   
00241 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
