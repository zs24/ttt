<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: Sinogram.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>Sinogram.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "Sinogram.hpp"</span>
00002 <span class="preprocessor">#include "Utilities.hpp"</span>
00003 
00004 <span class="comment">//----------------------------------------------------</span>
00005 <span class="comment">//constructor, init from params</span>
00006 <span class="comment">//----------------------------------------------------</span>
00007 Sinogram::Sinogram(Params &amp; params)
00008 {
00009   <span class="comment">//init variables using params</span>
00010   nr = params.sinogram.nr;
00011   nphi=params.sinogram.nphi;
00012   numSinos = params.sinogram.numSinos;
00013   z0Min = params.sinogram.min_zmid;
00014   z0Max = params.sinogram.max_zmid;
00015   thetaMin = params.sinogram.minTheta*Constant::PI/180.0;
00016   thetaMax = params.sinogram.maxTheta*Constant::PI/180.0;
00017   rMax = params.geometry.FOV_r*params.geometry.dX;
00018   verbosity = params.sinogram.verbosity;
00019   type = setSinoGramType(params.sinogram.type);
00020   ext = params.extensions;
00021   verbosity = params.sinogram.verbosity;
00022    <span class="comment">//init sinogram image</span>
00023   <a class="code" href="structParams_1_1Geometry.html">Params::Geometry</a> g;
00024   g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a> = nr; g.<a class="code" href="structParams_1_1Geometry.html#o1">nY</a> = nphi; g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a> = numSinos;
00025   g.<a class="code" href="structParams_1_1Geometry.html#o5">dX</a> = g.<a class="code" href="structParams_1_1Geometry.html#o6">dY</a> = g.<a class="code" href="structParams_1_1Geometry.html#o7">dZ</a> = 1;
00026   g.<a class="code" href="structParams_1_1Geometry.html#o8">offsetX</a> = g.<a class="code" href="structParams_1_1Geometry.html#o9">offsetY</a> = g.<a class="code" href="structParams_1_1Geometry.html#o10">offsetZ</a> = 0;
00027   string fileType =params.frame.outputFileType, 
00028     dataType = params.frame.outputDataType;
00029   sinoGram = <span class="keyword">new</span> <a class="code" href="classImage.html">Image</a>(g, fileType, dataType);
00030   binWeight.init(nr,nphi,numSinos);
00031   <span class="comment">// cout&lt;&lt;"sinogram verbosity"&lt;&lt;verbosity&lt;&lt;endl;</span>
00032 
00033   Status *status = Status::getStatus();
00034   <span class="comment">//write to proc 0</span>
00035   <span class="keywordflow">if</span>(status-&gt;proc == 0)
00036     outPutGeo();
00037   <span class="comment">//output sinogram to file</span>
00038   <span class="keywordflow">if</span>(status-&gt;proc == 0){
00039     <span class="comment">//determine the output file type and use the proper extension</span>
00040     string outputExt;
00041     outputExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00042     <span class="comment">//write sinogram data to file</span>
00043     fileName=params.frame.frameDirectory+<span class="stringliteral">"/SINO-"</span>+
00044       params.frame.outputFileNameBase+<span class="stringliteral">"."</span>+outputExt;
00045   }
00046   <span class="comment">//validation check</span>
00047   string msg;
00048   <span class="keywordflow">if</span>(nr==0 || nphi ==0 || numSinos==0){         
00049       msg = <span class="stringliteral">" Error, Dimension of singram can not be 0, Program aborted"</span>;
00050       MPI::COMM_WORLD.Abort(-1);
00051       Status::StatusCode code = Status::ERROR;
00052       status-&gt;update(msg, code);
00053       <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00054       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, SINOGRAM, 0);
00055   }
00056 
00057 
00058 }
00059 
00060 
00061 <span class="comment">//--------------------------------------------------------</span>
00062 <span class="comment">//destructor</span>
00063 <span class="comment">//---------------------------------------------------------</span>
00064 Sinogram::~Sinogram()
00065 {
00066   <span class="keyword">delete</span> sinoGram;
00067   <span class="comment">//    cout&lt;&lt;"Sinogram deleted"&lt;&lt;endl;</span>
00068 }
00069 
00070 <span class="comment">//----------------------------------------------------------------</span>
00071 <span class="comment">//generates a sinogram from EventList</span>
00072 <span class="comment">//----------------------------------------------------------------</span>
00073 <span class="keywordtype">void</span> Sinogram::generateSino(<a class="code" href="classEventList.html">EventList</a> &amp;eventList, Status &amp;status)
00074 {
00075   
00076   <span class="keywordflow">if</span>(status.proc == 0){
00077     <span class="comment">//update status file and log file</span>
00078     string comm = <span class="stringliteral">"Starting building sinogram"</span>;
00079     Status::StatusCode code = Status::StatusCode(101); 
00080     status.update(comm, code);
00081     stringstream ss;
00082     ss&lt;&lt;<span class="stringliteral">"=============================="</span>&lt;&lt;endl;
00083     ss&lt;&lt;<span class="stringliteral">"Starting building sinogram"</span>&lt;&lt;endl;
00084     <a class="code" href="classLog.html">Log</a> *log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00085     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00086   }
00087 
00088   <span class="keywordtype">int</span> numSets = eventList.<a class="code" href="classEventList.html#a11">getNumSet</a>(); <span class="comment">//num of sublist in an eventList</span>
00089   <a class="code" href="classEventPacket.html">EventPacket</a> event, sentry;
00090   <span class="keywordtype">int</span> zIndex, phiIndex, rIndex; <span class="comment">//index of sinogram</span>
00091   <span class="keywordtype">float</span> r, phi;
00092   <a class="code" href="structParams_1_1Geometry.html">Params::Geometry</a> g;
00093   g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a> = nr; g.<a class="code" href="structParams_1_1Geometry.html#o1">nY</a> = nphi; g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a> = numSinos;
00094   g.<a class="code" href="structParams_1_1Geometry.html#o5">dX</a> = g.<a class="code" href="structParams_1_1Geometry.html#o6">dY</a> = g.<a class="code" href="structParams_1_1Geometry.html#o7">dZ</a> = 1;
00095   g.<a class="code" href="structParams_1_1Geometry.html#o8">offsetX</a> = g.<a class="code" href="structParams_1_1Geometry.html#o9">offsetY</a> = g.<a class="code" href="structParams_1_1Geometry.html#o10">offsetZ</a> = 0;
00096   string fileType =<span class="stringliteral">"xml"</span>, dataType = <span class="stringliteral">"Float"</span>;
00097   <a class="code" href="classImage.html">Image</a> sinoGramNodes(g, fileType, dataType);
00098 
00099   sentry = eventList.<a class="code" href="classEventList.html#a6">getSentry</a>();
00100   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numSets; i++) {
00101     event = eventList.<a class="code" href="classEventList.html#a3">getFirst</a>(i); <span class="comment">//get an event from eventlist</span>
00102     <span class="keywordflow">while</span>(!(event == sentry)){
00103       <span class="keywordtype">float</span> z0 = (event.<a class="code" href="classEventPacket.html#o14">z1</a> + event.<a class="code" href="classEventPacket.html#o17">z2</a>)/2;
00104       <span class="keywordflow">if</span>(thetaMin&lt;=acos(event.<a class="code" href="classEventPacket.html#o24">costheta</a>)&amp;&amp; 
00105          acos(event.<a class="code" href="classEventPacket.html#o24">costheta</a>)&lt;=thetaMax) {
00106         <span class="keywordflow">if</span>( z0Min&lt;=z0 &amp;&amp; z0&lt;=z0Max){
00107           <span class="comment">//zIndex = reBin(z0,z0Min, z0Max, numSinos);</span>
00108           solveRPhi(event,r,phi); <span class="comment">//sovle for r and phi</span>
00109           <span class="comment">//phiIndex = reBin(phi,0, 180,nphi);</span>
00110           <span class="comment">//rIndex = reBin(r+rMax/2,0, rMax, nr);</span>
00111           <span class="comment">//sinoGramNodes(rIndex, phiIndex, zIndex)+=event.numEvents; </span>
00112           <span class="comment">//calculate sinogram</span>
00113           linearRebin(r, phi, z0, event,sinoGramNodes);
00114 
00115         }
00116       }
00117       event = eventList.<a class="code" href="classEventList.html#a4">getNext</a>(i); <span class="comment">//get another event</span>
00118     }
00119   }
00120   <span class="comment">//normalize sinogram by the total weight of each bin</span>
00121   
00122   MPI::COMM_WORLD.Barrier(); <span class="comment">//prepare processes</span>
00123   <span class="comment">//Sum the sinoGram together</span>
00124   MPI::COMM_WORLD.Allreduce(&amp;sinoGramNodes(0,0,0), &amp;(*sinoGram)(0,0,0),
00125                             getSinoSize(), MPI::FLOAT, MPI::SUM);
00126   <a class="code" href="classArray3D.html">Array3D&lt;float&gt;</a> binWeightGlobal(nr, nphi, numSinos);
00127   MPI::COMM_WORLD.Allreduce(&amp;binWeight(0,0,0), &amp; binWeightGlobal(0,0,0),
00128                             getSinoSize(), MPI::FLOAT, MPI::SUM);
00129   <span class="comment">//normalize sinogram by the total weight of each bin</span>
00130   <span class="keywordflow">if</span>(type == ATTENUATION){
00131     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ir = 0; ir&lt;nr; ir++)
00132       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iphi = 0; iphi&lt;nphi; iphi++)
00133         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0; iz&lt;numSinos; iz++)
00134           <span class="keywordflow">if</span>(binWeightGlobal(ir,iphi,iz) != 0) 
00135             (*sinoGram)(ir,iphi,iz) /= binWeightGlobal(ir,iphi,iz);
00136   }
00137   <span class="comment">//for test purpose, get bin number for each slice</span>
00138   <span class="keywordflow">if</span>(status.proc == 0){
00139     <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> binPerSlice(numSinos);
00140     binPerSlice =0;
00141     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0; iz&lt;numSinos; iz++){
00142       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ir = 0; ir&lt;nr; ir++)
00143         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iphi = 0; iphi&lt;nphi; iphi++)
00144           binPerSlice(iz) +=  binWeightGlobal(ir,iphi,iz);
00145       cout&lt;&lt;<span class="stringliteral">"On slice "</span>&lt;&lt;iz&lt;&lt;<span class="stringliteral">" total bin number is "</span>&lt;&lt;binPerSlice(iz)&lt;&lt;endl;
00146     }
00147   } 
00148 
00149   this-&gt;write();
00150 }
00151 
00152 <span class="keywordtype">void</span> Sinogram::solveRPhi(<a class="code" href="classEventPacket.html">EventPacket</a> &amp; event, <span class="keywordtype">float</span> &amp; r, <span class="keywordtype">float</span> &amp; phi)
00153 {
00154 
00155   <span class="keywordtype">double</span> a, b,c, area;
00156   a=-sqrt(POW2(event.<a class="code" href="classEventPacket.html#o16">y2</a>)+POW2(event.<a class="code" href="classEventPacket.html#o15">x2</a>));
00157   b=-sqrt(POW2(event.<a class="code" href="classEventPacket.html#o13">y1</a>)+POW2(event.<a class="code" href="classEventPacket.html#o12">x1</a>));
00158   c=-sqrt(POW2((event.<a class="code" href="classEventPacket.html#o16">y2</a>-event.<a class="code" href="classEventPacket.html#o13">y1</a>))+POW2((event.<a class="code" href="classEventPacket.html#o15">x2</a>-event.<a class="code" href="classEventPacket.html#o12">x1</a>)));
00159   area = 0.25*sqrt(fabs((a+b+c)*(b+c-a)*(c+a-b)*(a+b-c)));
00160   r = (<span class="keywordtype">float</span>) 2*area/c;
00161   <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o15">x2</a>!=event.<a class="code" href="classEventPacket.html#o12">x1</a>){
00162     b=(event.<a class="code" href="classEventPacket.html#o15">x2</a>*event.<a class="code" href="classEventPacket.html#o13">y1</a>-event.<a class="code" href="classEventPacket.html#o12">x1</a>*event.<a class="code" href="classEventPacket.html#o16">y2</a>)/(event.<a class="code" href="classEventPacket.html#o15">x2</a>-event.<a class="code" href="classEventPacket.html#o12">x1</a>);
00163     r=(b&gt;=0) ? r:-r;
00164   }
00165 
00166 
00167   <span class="comment">//calculate phi</span>
00168   phi= (<span class="keywordtype">float</span>) atan2(event.<a class="code" href="classEventPacket.html#o15">x2</a>-event.<a class="code" href="classEventPacket.html#o12">x1</a>, event.<a class="code" href="classEventPacket.html#o16">y2</a>-event.<a class="code" href="classEventPacket.html#o13">y1</a>);
00169   <span class="comment">// (deltax,deltay) returns (-pi,pi)</span>
00170   <span class="comment">//calculate r</span>
00171   <span class="comment">//r = event.x1*cos(phi)-event.y1*sin(phi);</span>
00172   <span class="keywordflow">if</span> (phi &lt; 0.0) phi += Constant::PI; <span class="comment">// phi in (0 pi)</span>
00173   phi = phi/Constant::PI*180; <span class="comment">//transform to degree;</span>
00174 
00175 }
00176 
00177 <span class="comment">//rebin using nearest neighborhood method</span>
00178 <span class="keywordtype">int</span> Sinogram::reBin(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> xMin, <span class="keywordtype">float</span> xMax, <span class="keywordtype">int</span> nx)
00179 {
00180   <span class="keywordtype">float</span> resid= (x - xMin)/(xMax - xMin)*(nx-1)-
00181     floor((x - xMin)/(xMax - xMin)*(nx-1));
00182   <span class="keywordtype">int</span> xIndex = resid&lt;=0.5 ? floor((x - xMin)/(xMax - xMin)*(nx-1)):
00183     ceil((x - xMin)/(xMax - xMin)*(nx-1));
00184 
00185   <span class="keywordflow">return</span> xIndex;
00186 }
00187 
00188 <span class="comment">//rebin using linear intoperlation</span>
00189 <span class="keywordtype">void</span> Sinogram::linearRebin(<span class="keywordtype">float</span> r, <span class="keywordtype">float</span> phi, <span class="keywordtype">float</span> z,
00190                            <a class="code" href="classEventPacket.html">EventPacket</a> &amp;event, <a class="code" href="classArray3D.html">Array3D&lt;float&gt;</a> &amp;sino)
00191 {
00192   <span class="keywordtype">int</span> rIndex=getIndex(r+rMax/2, 0, rMax, nr);
00193   <span class="keywordtype">int</span> phiIndex = getIndex(phi,0, 180, nphi);
00194   <span class="keywordtype">int</span> zIndex = getIndex(z,z0Min, z0Max, numSinos);
00195 
00196   <a class="code" href="classMOLAR.html">MOLAR</a> *molar;
00197   House *house;
00198   molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00199   house = molar-&gt;<a class="code" href="classMOLAR.html#a24">getHouse</a>();
00200 
00201   <span class="keywordtype">float</span> duration; 
00202   <a class="code" href="classFrameInfo.html">FrameInfo</a> &amp;fi = house-&gt;getFrameInfo();
00203   duration = fi.<a class="code" href="classFrameInfo.html#o3">Duration</a>;
00204 
00205   <span class="keywordflow">if</span>(rIndex == (nr-1)) rIndex--;
00206   <span class="keywordflow">if</span>(phiIndex == (nphi-1)) phiIndex --;
00207   <span class="keywordflow">if</span>(numSinos!=1) 
00208     <span class="keywordflow">if</span>(zIndex == (numSinos - 1)) zIndex --;
00209     
00210   <span class="keywordflow">if</span>(numSinos !=1){
00211     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> rI=rIndex; rI&lt;=rIndex+1; rI++)
00212       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> phiI=phiIndex; phiI&lt;=phiIndex+1; phiI++)
00213         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> zI=zIndex; zI&lt;=zIndex+1; zI++){
00214           <span class="keywordtype">float</span> zWeight;
00215           <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o0">jstart</a>&gt;event.<a class="code" href="classEventPacket.html#o1">jstop</a> &amp;&amp; type!=RANDOMS &amp;&amp; type != SCATTER)
00216             zWeight=0;
00217           <span class="keywordflow">else</span>
00218             zWeight = getZWeight(z, zI, z0Min, z0Max, numSinos);
00219           <span class="keywordtype">float</span> rWeight= getWeight(r+rMax/2, rI, 0, rMax, nr);
00220           <span class="keywordtype">float</span> phiWeight = getWeight(phi, phiI,0, 180, nphi);
00221           binWeight(rI, phiI, zI) += zWeight*phiWeight*rWeight;
00222           <span class="keywordflow">switch</span>(type) {
00223           <span class="keywordflow">case</span> DATA: <span class="comment">//for data and delayed type</span>
00224             sino(rI, phiI, zI) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o19">numEvents</a>;
00225             <span class="keywordflow">break</span>;
00226           <span class="keywordflow">case</span> RANDOMS:
00227             sino(rI, phiI, zI) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o8">rand</a>*duration/1000.;
00228             <span class="keywordflow">break</span>;
00229           <span class="keywordflow">case</span> SCATTER:
00230             sino(rI, phiI, zI) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o11">scatter</a>*duration/1000.;
00231             <span class="keywordflow">break</span>;
00232           <span class="keywordflow">case</span> EXPECTED:
00233             sino(rI, phiI, zI) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o18">yhat</a>;
00234             <span class="keywordflow">break</span>;
00235           <span class="keywordflow">case</span> CORRECTED:
00236             sino(rI, phiI, zI) +=zWeight*phiWeight*rWeight*
00237               ((event.<a class="code" href="classEventPacket.html#o19">numEvents</a>-event.<a class="code" href="classEventPacket.html#o8">rand</a>-event.<a class="code" href="classEventPacket.html#o11">scatter</a>)/
00238                (event.<a class="code" href="classEventPacket.html#o10">atten</a>*event.<a class="code" href="classEventPacket.html#o9">norm</a>));
00239             <span class="keywordflow">break</span>;
00240           <span class="keywordflow">case</span> ATTENUATION:
00241             sino(rI, phiI, zI) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o10">atten</a>;
00242             <span class="keywordflow">break</span>;
00243           <span class="keywordflow">case</span> SUBSET_SPECIFIC:
00244             <span class="comment">//TBD</span>
00245             <span class="keywordflow">break</span>;
00246           }
00247         }
00248   }
00249   <span class="keywordflow">else</span> {
00250     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> rI=rIndex; rI&lt;=rIndex+1; rI++)
00251       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> phiI=phiIndex; phiI&lt;=phiIndex+1; phiI++) {
00252         <span class="keywordtype">float</span> zWeight= 1;
00253         <span class="keywordtype">float</span> rWeight= getWeight(r+rMax/2, rI, 0, rMax, nr);
00254         <span class="keywordtype">float</span> phiWeight = getWeight(phi, phiI,0, 180, nphi);
00255         binWeight(rI, phiI, 0) += zWeight*phiWeight*rWeight;
00256 
00257         <span class="keywordflow">switch</span>(type)  {
00258         <span class="keywordflow">case</span> DATA:<span class="comment">//data and delayed type</span>
00259           sino(rI, phiI, 0) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o19">numEvents</a>;
00260           <span class="keywordflow">break</span>;
00261         <span class="keywordflow">case</span> RANDOMS:
00262           sino(rI, phiI, 0) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o8">rand</a>*duration/1000.;
00263           <span class="keywordflow">break</span>;
00264         <span class="keywordflow">case</span> SCATTER:
00265           sino(rI, phiI, 0) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o11">scatter</a>*duration/1000.;
00266           <span class="keywordflow">break</span>;
00267         <span class="keywordflow">case</span> EXPECTED:
00268           sino(rI, phiI, 0) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o18">yhat</a>;
00269           <span class="keywordflow">break</span>;
00270         <span class="keywordflow">case</span> CORRECTED:
00271           sino(rI, phiI, 0) +=zWeight*phiWeight*rWeight*
00272             ((event.<a class="code" href="classEventPacket.html#o19">numEvents</a>-event.<a class="code" href="classEventPacket.html#o8">rand</a>-event.<a class="code" href="classEventPacket.html#o11">scatter</a>)/
00273              (event.<a class="code" href="classEventPacket.html#o10">atten</a>*event.<a class="code" href="classEventPacket.html#o9">norm</a>));
00274           <span class="keywordflow">break</span>;
00275         <span class="keywordflow">case</span> ATTENUATION:
00276           sino(rI, phiI, 0) += zWeight*phiWeight*rWeight*event.<a class="code" href="classEventPacket.html#o10">atten</a>;
00277           <span class="keywordflow">break</span>;
00278 
00279         <span class="keywordflow">case</span> SUBSET_SPECIFIC:
00280           <span class="comment">//TBD</span>
00281           <span class="keywordflow">break</span>;
00282         }
00283       }
00284   }
00285 }
00286 
00287 <span class="comment">//get the lower bound index of x</span>
00288 <span class="keywordtype">int</span> Sinogram::getIndex(<span class="keywordtype">float</span> x, <span class="keywordtype">float</span> xMin, <span class="keywordtype">float</span> xMax, <span class="keywordtype">int</span> nx)
00289 {
00290   <span class="keywordflow">return</span> floor((x - xMin)/(xMax - xMin)*(nx-1));
00291 }
00292 
00293 <span class="comment">//get the weight of x on the index</span>
00294 <span class="keywordtype">float</span> Sinogram::getWeight(<span class="keywordtype">float</span> x, <span class="keywordtype">int</span> xIndex, <span class="keywordtype">float</span> xMin, 
00295                           <span class="keywordtype">float</span> xMax, <span class="keywordtype">int</span> nx)
00296 {
00297   <span class="keywordflow">return</span>  (1-fabs(xIndex-(x-xMin)*(nx-1)/(xMax-xMin)));
00298 }
00299 
00300 
00301 <span class="comment">//get the weight of z on the index</span>
00302 <span class="keywordtype">float</span> Sinogram::getZWeight(<span class="keywordtype">float</span> x, <span class="keywordtype">int</span> xIndex, <span class="keywordtype">float</span> xMin, 
00303                            <span class="keywordtype">float</span> xMax, <span class="keywordtype">int</span> nx)
00304 {
00305   <span class="keywordtype">float</span> weight=fabs(xIndex-(x-xMin)*(nx-1)/(xMax-xMin));
00306   <span class="keywordtype">float</span> zWeight = (weight&lt;=0.5) ? 1 :0 ;
00307   <span class="keywordflow">return</span> zWeight;
00308 }
00309 
00310 
00311 <span class="keywordtype">int</span> Sinogram::setSinoGramType(string sType)
00312 {
00313   <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"data"</span>) == 0)
00314     <span class="keywordflow">return</span> DATA;
00315   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"delayed"</span>) == 0)
00316     <span class="keywordflow">return</span> DELAYED;
00317   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"corrected"</span>) == 0)
00318     <span class="keywordflow">return</span> CORRECTED;
00319   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"expected"</span>) == 0)
00320     <span class="keywordflow">return</span> EXPECTED;
00321   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"attenuation"</span>) == 0)
00322     <span class="keywordflow">return</span> ATTENUATION;
00323   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"randoms"</span>) == 0)
00324     <span class="keywordflow">return</span> RANDOMS;
00325   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"scatter"</span>) == 0)
00326     <span class="keywordflow">return</span> SCATTER;
00327   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(stricmp(sType.c_str(), <span class="stringliteral">"subset-specific"</span>) == 0)
00328     <span class="keywordflow">return</span> SUBSET_SPECIFIC;
00329   <span class="keywordflow">else</span>
00330     {
00331       cout&lt;&lt;<span class="stringliteral">" You input an invalid sinogram type :"</span>&lt;&lt;sType&lt;&lt;endl;
00332       cout&lt;&lt;<span class="stringliteral">" Use DATA type instead"</span>&lt;&lt;endl;
00333       <span class="keywordflow">return</span> DATA;
00334     }
00335 }
00336 
00337 <span class="keywordtype">bool</span> Sinogram::write( )
00338 {
00339   Status *status = Status::getStatus();
00340   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00341   <span class="keywordtype">bool</span> flag;
00342   <span class="keywordflow">if</span>(status-&gt;proc == 0){
00343     flag= sinoGram-&gt;write(fileName,ext);
00344     <span class="keywordflow">if</span>(!flag) {
00345       stringstream ss;
00346       ss&lt;&lt;<span class="stringliteral">"Sinogram data write to "</span>&lt;&lt;fileName&lt;&lt;<span class="stringliteral">"  fail"</span>&lt;&lt;endl;
00347       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00348       
00349       <span class="comment">//update status file</span>
00350       string comm = <span class="stringliteral">"Sinogram data write fail"</span>;
00351       Status::StatusCode code = Status::StatusCode(104); 
00352       status-&gt;update(comm, code);
00353     }
00354     <span class="keywordflow">else</span>{
00355       stringstream ss;
00356       ss&lt;&lt;<span class="stringliteral">"=================================================="</span>&lt;&lt;endl;
00357       ss&lt;&lt;<span class="stringliteral">"Sinogram written to "</span>&lt;&lt;fileName&lt;&lt;<span class="stringliteral">" successfully"</span>&lt;&lt;endl;
00358       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00359       <span class="comment">//update status file</span>
00360       string comm = <span class="stringliteral">"Sinogram written to "</span>+fileName+<span class="stringliteral">" successfully"</span>;
00361       Status::StatusCode code = Status::StatusCode(101); 
00362       status-&gt;update(comm, code);
00363     }
00364   }
00365   <span class="keywordflow">return</span> flag;
00366 
00367 }
00368 
00369 <span class="keywordtype">void</span> Sinogram::writeTxt(string fileName)
00370 {
00371   ofstream fsinoGram(fileName.c_str());
00372   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =0; i&lt;nr; i++){
00373     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nphi; j++){
00374       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;numSinos; k++) {   
00375         fsinoGram&lt;&lt;(*sinoGram)(i,j,k) &lt;&lt;<span class="stringliteral">"  "</span>;
00376       }
00377     }
00378     fsinoGram&lt;&lt;endl;
00379   }
00380 }
00381 
00382 <span class="keywordtype">void</span> Sinogram::outPutGeo()
00383 {
00384   stringstream ss;
00385   ss&lt;&lt;<span class="stringliteral">"---------------------------------------------------------------"</span>
00386     &lt;&lt;endl;
00387   ss&lt;&lt;endl&lt;&lt;<span class="stringliteral">"Sinogram inited with geometry: "</span>&lt;&lt;endl;
00388   ss&lt;&lt;<span class="stringliteral">"nr="</span>&lt;&lt;nr&lt;&lt;<span class="stringliteral">" nphi="</span>&lt;&lt;nphi&lt;&lt;<span class="stringliteral">" numSinos="</span>&lt;&lt;numSinos&lt;&lt;endl;
00389   ss&lt;&lt;<span class="stringliteral">"theta range "</span>&lt;&lt;<span class="stringliteral">"["</span>&lt;&lt;thetaMin*180/Constant::PI&lt;&lt;<span class="stringliteral">" "</span>
00390     &lt;&lt;(thetaMax*180/Constant::PI)&lt;&lt;<span class="stringliteral">"]"</span>&lt;&lt;endl;
00391   ss&lt;&lt;<span class="stringliteral">"z range "</span>&lt;&lt;<span class="stringliteral">"["</span>&lt;&lt;z0Min&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;z0Max&lt;&lt;<span class="stringliteral">"]"</span>&lt;&lt;endl;
00392   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00393   log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(), SINOGRAM, 1);
00394 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:48 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
