<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: FourDReconstruction.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>FourDReconstruction.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "FourDReconstruction.hpp"</span>
00002 <span class="preprocessor">#include "Utilities.hpp"</span>
00003 <span class="preprocessor">#include "Constant.hpp"</span>
00004 <span class="preprocessor">#include "array.hpp"</span>
00005 <span class="preprocessor">#include "Status.hpp"</span>
00006 <span class="preprocessor">#include "Image.hpp"</span>
00007 <span class="preprocessor">#include "EventPacket.hpp"</span>
00008 <span class="preprocessor">#include &lt;fstream.h&gt;</span>
00009 <span class="preprocessor">#include &lt;iomanip.h&gt;</span>
00010 
00011 <span class="comment">/* define function 4D Reconstruction that updates lambda image at each frame read. </span>
00012 <span class="comment">whl - 04/15/07</span>
00013 <span class="comment">*/</span>
00014 
<a name="l00015"></a><a class="code" href="classFourDReconstruction.html#a0">00015</a> <a class="code" href="classFourDReconstruction.html#a0">FourDReconstruction :: FourDReconstruction</a>()
00016 {
00017 }
00018 
00019 <span class="comment">// 4D Reconstruction initializer/reader:</span>
00020 <span class="keywordtype">void</span> FourDReconstruction :: init(string filename, 
00021                                      Status &amp; status,
00022                                      <span class="keywordtype">int</span> scanStartTime,
00023                                      <span class="keywordtype">int</span> frameStartTime,
00024                                      <span class="keywordtype">int</span> requestedDuration,
00025                                      <span class="keywordtype">int</span> decayCorrectionTime)
00026 {
00027 
00028        cout &lt;&lt; <span class="stringliteral">"initializing init function"</span> &lt;&lt; endl;
00029        lambdaT = <span class="keyword">new</span> LambdaT[requestedDuration];
00030        
00031         index = 0;
00032         lastindex = -1;
00033         firstpass=1;
00034    
00035    <span class="keywordtype">int</span> startTime = scanStartTime+frameStartTime;
00036    <span class="keywordtype">int</span> endTime = startTime + requestedDuration;
00037    
00038    <span class="comment">// Open kinetics file at beginning of scan:</span>
00039    <span class="keywordflow">if</span> (status.proc == 0) {
00040       cout &lt;&lt; <span class="stringliteral">" reading kinetics file"</span> &lt;&lt;filename.c_str()&lt;&lt; endl;
00041       <span class="comment">// open kinetics file</span>
00042       ifstream Kinetics(filename.c_str());
00043       
00044       <span class="comment">// error message: </span>
00045       <span class="keywordflow">if</span> (!Kinetics) {
00046          cout &lt;&lt; <span class="stringliteral">"missing or corrupt kinetics file!"</span> &lt;&lt; endl;
00047          string msg = <span class="stringliteral">"error in opening file."</span> +filename;
00048          <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00049          <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00050       }
00051       
00052       <span class="comment">// declarations:</span>
00053       <span class="keywordtype">float</span> tempTime, tempError;
00054       <span class="comment">// find numregion variable from data:</span>
00055       Kinetics &gt;&gt; numregion;
00056       
00057       cout &lt;&lt; <span class="stringliteral">"the number of regions detected: "</span> &lt;&lt; numregion &lt;&lt; endl;      
00058         <span class="comment">// initialization:</span>
00059         <span class="comment">//int numconc = 0;</span>
00060         numconc = 0;
00061         lambdaT[0].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o1">conc</a>.<a class="code" href="classArray1D.html#a8">init</a>(numregion);
00062         lambdaT[1].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o1">conc</a>.<a class="code" href="classArray1D.html#a8">init</a>(numregion);
00063         <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> tempMatrix;
00064         tempMatrix.<a class="code" href="classArray1D.html#a8">init</a>(numregion);              
00065                   
00066    <span class="keywordflow">while</span> (!Kinetics.eof()) {            
00067       cout &lt;&lt; <span class="stringliteral">"reading kinetics file..."</span> &lt;&lt; endl;
00068       
00069       <span class="comment">// read in first time point:</span>
00070       Kinetics &gt;&gt; lambdaT[0].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o0">time</a>;   
00071       
00072       <span class="comment">// initialize and read for time = 0 concentration profile at each region:</span>
00073       tempTime = lambdaT[0].time;
00074       tempMatrix = lambdaT[0].conc;         
00075       
00076       <span class="comment">// update concentration profile by reading through matrix     </span>
00077       <span class="keywordtype">int</span> i;
00078       <span class="keywordflow">for</span> (i =0; i &lt; numregion; i++) {
00079          Kinetics &gt;&gt; lambdaT[0].conc[i];
00080          cout &lt;&lt; <span class="stringliteral">"Reading in concentration data at first time point: "</span> &lt;&lt; lambdaT[0].conc[i] &lt;&lt; endl;
00081       }
00082       
00083       cout &lt;&lt; <span class="stringliteral">"The first time point in file is: "</span> &lt;&lt; tempTime &lt;&lt; endl;
00084 
00085       <span class="comment">// time in the Kinetics file is in min past injection</span>
00086       <span class="comment">// convert to seconds past midnight</span>
00087       lambdaT[0].time *= 60.*1000.;     <span class="comment">// msec from injection</span>
00088       lambdaT[0].time += decayCorrectionTime;   <span class="comment">//msec from midnight</span>
00089                    
00090       <span class="comment">// sync kinetics time file with the frame time:</span>
00091       <span class="keywordflow">if</span> (lambdaT[0].time == startTime) {
00092               lambdaT[0].time -= scanStartTime; <span class="comment">//msec since scan start</span>
00093       <span class="keywordflow">break</span>;}
00094 
00095       <span class="comment">// if greater than the start time and no files read, display error message:</span>
00096       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lambdaT[0].time &gt; startTime) &amp;&amp; numconc == 0) {
00097               string msg = <span class="stringliteral">"First time in Kinetics File"</span>;
00098               <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00099               <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR); }
00100 
00101       <span class="comment">// if greater than start time, and files have been read, make that the start:</span>
00102       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((lambdaT[0].time &gt; startTime) &amp;&amp; numconc != 0) {
00103               lambdaT[1].time = lambdaT[0].time - scanStartTime;
00104               lambdaT[1].conc = lambdaT[0].conc;
00105               lambdaT[0].time = tempTime - scanStartTime;
00106               lambdaT[0].conc = tempMatrix;
00107               numconc=1;                
00108               }
00109    }
00110         
00111    <span class="comment">// initialize for file read:</span>
00112    tempTime = 0;
00113 
00114    <span class="comment">// read in the rest of the data:             </span>
00115    <span class="keywordflow">while</span>( !Kinetics.eof()) {    
00116       Kinetics &gt;&gt; tempTime;        
00117       <span class="keywordflow">if</span>( tempTime == 0) {<span class="keywordflow">break</span>;}          
00118 
00119 
00120       <span class="keywordflow">if</span>( endTime &gt;= tempTime) {
00121          numconc++;
00122         lambdaT[numconc].conc.init(numregion);
00123         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numregion; i++) {        
00124                 Kinetics &gt;&gt; lambdaT[numconc].conc[i];
00125         }
00126       <span class="comment">// time in the Kinetics file is in min past injection</span>
00127       <span class="comment">// convert to seconds past midnight</span>
00128              lambdaT[numconc].time = tempTime*60.*1000.;        <span class="comment">// msec from injection</span>
00129              lambdaT[numconc].time += decayCorrectionTime;      <span class="comment">//msec from midnight    </span>
00130              lambdaT[numconc].time -= scanStartTime;     
00131          tempTime = 0;
00132       }
00133       <span class="keywordflow">if</span> (endTime &lt; tempTime) {<span class="keywordflow">break</span>;}
00134    }    
00135     
00136    cout &lt;&lt; <span class="stringliteral">"last index of time points read: "</span> &lt;&lt; numconc &lt;&lt; endl;
00137    <span class="comment">// wrap next output with a verbosity check</span>
00138 
00139    cout&lt;&lt;<span class="stringliteral">"Read 0..."</span>&lt;&lt;numconc&lt;&lt;<span class="stringliteral">" values from the kinetics file on processor "</span>&lt;&lt;status.proc&lt;&lt;endl;
00140    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;=numconc; j++) {
00141     cout&lt;&lt; lambdaT[j].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o0">time</a>;
00142     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numregion; i++) 
00143      cout&lt;&lt;  <span class="stringliteral">" "</span>&lt;&lt;lambdaT[j].conc[i]; 
00144     cout&lt;&lt; endl;
00145    }
00146   } <span class="comment">// end for processor 0      </span>
00147   <span class="comment">// Now pass these results to other processor (received by them in initplayer)</span>
00148   <span class="keywordflow">if</span> (status.numProcs &gt; 1) {
00149    initplayer(status);
00150   }
00151 }
00152 <span class="keywordtype">void</span> FourDReconstruction :: initplayer(Status &amp;status)
00153 {
00154      MPI::COMM_WORLD.Barrier();
00155    MPI::COMM_WORLD.Bcast(&amp;numregion, 1, MPI::INT, 0);
00156    MPI::COMM_WORLD.Bcast(&amp;numconc, 1, MPI::INT, 0);
00157     cout&lt;&lt;<span class="stringliteral">"In FourDReconstruction::initplayer, processor "</span>&lt;&lt;status.proc&lt;&lt;<span class="stringliteral">" numregion,numconc="</span>&lt;&lt;numregion&lt;&lt;
00158         <span class="stringliteral">" "</span>&lt;&lt;numconc&lt;&lt;endl;
00159     <span class="keywordflow">if</span> (status.proc != 0) {
00160        index=0;
00161        firstpass=1;
00162        lambdaT = <span class="keyword">new</span> LambdaT[numconc+1];
00163     }
00164    <span class="keywordtype">float</span> tempconc[numconc];
00165    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> iconc=0; iconc&lt;=numconc;iconc++) {
00166     MPI::COMM_WORLD.Bcast(&amp;(lambdaT[iconc].time), 1, MPI::FLOAT, 0);
00167     <span class="comment">// copy conc to temporary vector</span>
00168     <span class="keywordflow">if</span> (status.proc == 0) {
00169      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numregion; i++) {
00170       tempconc[i]=lambdaT[iconc].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o1">conc</a>[i];
00171      }
00172     } 
00173     MPI::COMM_WORLD.Bcast(&amp;tempconc, numregion, MPI::FLOAT, 0);
00174     <span class="keywordflow">if</span> (status.proc != 0) {
00175      lambdaT[iconc].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o1">conc</a>.<a class="code" href="classArray1D.html#a8">init</a>(numregion);
00176      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numregion; i++) {
00177       lambdaT[iconc].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o1">conc</a>[i]=tempconc[i];
00178      }
00179     } 
00180    }
00181   <span class="keywordflow">if</span> (status.proc != 0) {
00182    cout&lt;&lt;<span class="stringliteral">"Read 0..."</span>&lt;&lt;numconc&lt;&lt;<span class="stringliteral">" values from the kinetics file on processor "</span>&lt;&lt;status.proc&lt;&lt;endl;
00183   }
00184   <span class="comment">// check if got here ok</span>
00185   <span class="keywordflow">if</span> (status.proc == status.numProcs-1) {
00186     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;=numconc; j++) {
00187      cout&lt;&lt; lambdaT[j].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o0">time</a>;
00188      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;numregion; i++) 
00189       cout&lt;&lt;  <span class="stringliteral">" "</span>&lt;&lt;lambdaT[j].conc[i]; 
00190      cout&lt;&lt; endl;
00191     }
00192    }   
00193 }
00194                 
00195 <span class="keywordtype">void</span> FourDReconstruction ::  updatelambda(<a class="code" href="classImage.html">Image</a> &amp;lambda,<a class="code" href="classEventPacket.html">EventPacket</a> &amp;event, Params &amp;params) { 
00196 <span class="comment">/****</span>
00197 <span class="comment">  this is the update lambda function. First, copy the initial lambda image into variable matrix </span>
00198 <span class="comment">  defined as "regionnum(ix,iy,iz)." </span>
00199 <span class="comment">  modified- whl 04/27/07</span>
00200 <span class="comment">****/</span> 
00201   <span class="comment">// For the first run, copy the initial lambda(ix,iy,iz) image into newly created regionnum matrix:</span>
00202    <span class="keywordflow">if</span> (firstpass) { 
00203        Status *status = Status::getStatus();
00204      
00205       cout &lt;&lt; <span class="stringliteral">"updatelambda function initialized on processor "</span> &lt;&lt; status-&gt;proc&lt;&lt;endl;
00206   <span class="comment">//cout &lt;&lt; "numconc=" &lt;&lt; numconc &lt;&lt; endl;</span>
00207       <span class="comment">// initialize regionnum matrix:</span>
00208          regionnum.<a class="code" href="classArray3D.html#a8">init</a>(params.geometry.nX, params.geometry.nY, 
00209                         params.geometry.nZ);
00210 
00211       <span class="comment">// copy lambda to regionnum for each pixel values ix,iy,and iz:                </span>
00212       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0;iz &lt; params.geometry.nZ; iz++)
00213        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0;iy &lt; params.geometry.nY; iy++)
00214         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0;ix &lt; params.geometry.nX; ix++) {
00215            regionnum(ix,iy,iz)=lambda(ix,iy,iz);
00216       }    
00217       
00218       firstpass=0; <span class="comment">// make sure this loop goes through once.       </span>
00219       lastTimeStamp=event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>;
00220         
00221       <span class="comment">// check to see if, for each region, number of pixels have been read correctly:     </span>
00222       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=1; j&lt;=numregion; j++) {
00223          <span class="keywordtype">int</span> npix=0;
00224          <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0;iz &lt; params.geometry.nZ; iz++) 
00225           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0;iy &lt; params.geometry.nY; iy++)
00226            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0;ix &lt; params.geometry.nX; ix++) 
00227             <span class="keywordflow">if</span> (regionnum(ix,iy,iz)==j) npix++;
00228             <span class="keywordflow">if</span> (status-&gt;proc == status-&gt;numProcs-1) 
00229              cout&lt;&lt;<span class="stringliteral">"Number of pixels of region "</span>&lt;&lt;j&lt;&lt;<span class="stringliteral">" is "</span>&lt;&lt;npix&lt;&lt;endl;
00230       }
00231    } <span class="keywordflow">else</span> {
00232    
00233     <span class="comment">// if the time of the current event still between index and index+1</span>
00234     <span class="comment">// index had been initialized to 0.</span>
00235     <span class="comment">// for each concentration time point, given that the time point in the kinetics file is less than</span>
00236     <span class="comment">// the event time stamp, copy numconc into index:</span>
00237     <span class="comment">//if (event.timeStamp != lastTimeStamp) {</span>
00238     <span class="comment">// cout&lt;&lt;"Time stamp "&lt;&lt;event.timeStamp&lt;&lt;endl;</span>
00239     <span class="comment">// lastTimeStamp=event.timeStamp;</span>
00240     <span class="comment">//}</span>
00241     lastindex=index;
00242     <span class="comment">// numconc is last valid index</span>
00243     <span class="keywordflow">while</span>(index &lt;= numconc){
00244       <span class="comment">//if (event.timeStamp%1000 == 0) {</span>
00245       <span class="comment">// cout&lt;&lt;"A Time stamp "&lt;&lt;event.timeStamp&lt;&lt;" index++ "&lt;&lt;index&lt;&lt;endl;</span>
00246      <span class="comment">// }</span>
00247     
00248        <span class="keywordflow">if</span>(lambdaT[index].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o0">time</a> == event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>){
00249         <span class="keywordflow">break</span>;
00250        }
00251       <span class="comment">//if (event.timeStamp%1000 == 0) {</span>
00252       <span class="comment">// cout&lt;&lt;"B Time stamp "&lt;&lt;event.timeStamp&lt;&lt;" index++ "&lt;&lt;index&lt;&lt;endl;</span>
00253       <span class="comment">//}</span>
00254        <span class="keywordflow">if</span> (lambdaT[index].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o0">time</a> &gt; event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>){
00255          index--;
00256          <span class="keywordflow">break</span>;
00257        }
00258       <span class="comment">//if (event.timeStamp%1000 == 0) {</span>
00259       <span class="comment">// cout&lt;&lt;"C Time stamp "&lt;&lt;event.timeStamp&lt;&lt;" index++ "&lt;&lt;index&lt;&lt;endl;</span>
00260       <span class="comment">//}</span>
00261        <span class="keywordflow">if</span> ((lambdaT[index].<a class="code" href="structFourDReconstruction_1_1LambdaT.html#o0">time</a> &lt; event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>) &amp;&amp; 
00262                 (index == (numconc))){
00263         <span class="keywordflow">break</span>;
00264        }
00265        index++;        
00266        <span class="comment">//if (event.timeStamp%1000 == 0) {</span>
00267        <span class="comment">//cout&lt;&lt;"D Time stamp "&lt;&lt;event.timeStamp&lt;&lt;" index++ "&lt;&lt;index&lt;&lt;endl;</span>
00268       <span class="comment">//}</span>
00269    }
00270     <span class="comment">//if (event.timeStamp%1000 == 0) {</span>
00271     <span class="comment">// cout&lt;&lt;"Time stamp "&lt;&lt;event.timeStamp&lt;&lt;" index "&lt;&lt;index&lt;&lt;" numconc="&lt;&lt;numconc&lt;&lt;endl;</span>
00272     <span class="comment">//}</span>
00273 
00274     <span class="keywordflow">if</span> (index == lastindex) {
00275         <span class="keywordflow">return</span>;
00276     }
00277    }
00278    <span class="comment">// need to update lambda, for every pixel:</span>
00279    <span class="keywordtype">double</span> totlambda=0;
00280    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0;iz &lt; params.geometry.nZ; iz++){
00281     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0;iy &lt; params.geometry.nY; iy++){
00282      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0;ix &lt; params.geometry.nX; ix++) {
00283 
00284          <span class="comment">// if the regionnum matrix value points to zero, lambda image = 0;</span>
00285          <span class="keywordflow">if</span> (regionnum(ix,iy,iz) == 0) {
00286            lambda(ix,iy,iz)=0.;
00287          }
00288 
00289          <span class="comment">// otherwise, update lambda image for every pixel with respect to kinetics file:</span>
00290             <span class="keywordflow">else</span> {
00291             lambda(ix,iy,iz)=lambdaT[index].conc[regionnum(ix,iy,iz)-1];
00292             totlambda+=lambda(ix,iy,iz);
00293             }
00294      }
00295     } 
00296    }
00297    Status *status = Status::getStatus();
00298    <span class="keywordflow">if</span> (status-&gt;proc == status-&gt;numProcs-1) 
00299     cout&lt;&lt;<span class="stringliteral">"**Updating lambda at timeStamp "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>&lt;&lt;<span class="stringliteral">" picking from lambdaT("</span>&lt;&lt;index&lt;&lt;<span class="stringliteral">").time="</span>&lt;&lt;
00300         lambdaT[index].time&lt;&lt;<span class="stringliteral">" total of lambda="</span>&lt;&lt;totlambda&lt;&lt;endl;
00301     
00302 }       
00303    
00304    
00305    
00306    
00307    
00308    
00309    
00310    
00311    
00312    
00313    
00314    
00315    
00316    
00317    
00318    
00319    
00320    
00321    
00322    
00323    
00324    
00325    
00326    
00327    
00328    
00329    
00330    
00331    
00332    
00333    
00334    
00335    
00336    
00337    
00338    
00339    
00340    
00341    
00342    
00343    
00344    
00345    
00346    
00347    
00348                                     
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
