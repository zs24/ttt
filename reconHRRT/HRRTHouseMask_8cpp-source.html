<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: HRRTHouseMask.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>HRRTHouseMask.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include &lt;sstream&gt;</span>
00004 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00005 <span class="preprocessor">#include "HRRTHouse.hpp"</span>
00006 <span class="preprocessor">#include "Status.hpp"</span>
00007 <span class="preprocessor">#include "ResolutionFunction.hpp"</span>
00008 <span class="preprocessor">#include "IsoGaussian.hpp"</span>
00009 <span class="preprocessor">#include "Utilities.hpp"</span>
00010 <span class="preprocessor">#include "Constant.hpp"</span>
00011 <span class="preprocessor">#include "TOC.hpp"</span>
00012 
00013 
00014 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00015 
00016 
00022 <span class="keywordtype">void</span> HRRTHouseMask::processMask(string attr[])
00023 {
00024   <span class="comment">//check if the pointer initialized when use it</span>
00025   <span class="keywordflow">if</span>(!checkValid()){
00026     cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseMask"</span>
00027         &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00028         &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00029     cout.flush();
00030     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00031   }
00032   Params &amp;params = *Params::getInstance();
00033   string dtct, layer, bank, ring;
00034   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> loc, loc1, loc2;
00035   <span class="keywordtype">bool</span> fDtct, fLayer, fBank, fRing; <span class="comment">//flags, if the attrs found</span>
00036   cout&lt;&lt;<span class="stringliteral">"Processing the "</span>&lt;&lt;nMask&lt;&lt;<span class="stringliteral">" masks"</span>&lt;&lt;endl;
00037   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = 0 ; i&lt;nMask; i++) {
00038     <span class="comment">//if mask attr is empty, none of detectors masked out</span>
00039     <span class="keywordflow">if</span>(attr[i].find(<span class="stringliteral">"dtct"</span>,0)==string::npos &amp;&amp;
00040        attr[i].find(<span class="stringliteral">"layer"</span>,0)==string::npos &amp;&amp;
00041        attr[i].find(<span class="stringliteral">"bank"</span>,0)==string::npos &amp;&amp;
00042        attr[i].find(<span class="stringliteral">"ring"</span>,0)==string::npos){
00043       mask[i].nDtctMask = 0;
00044       mask[i].nLayerMask = 0;
00045       mask[i].nBankMask = 0;
00046       mask[i].nRingMask = 0;
00047       <span class="keywordflow">continue</span>;
00048     }
00049 
00050 
00051     <span class="comment">//if attr specified dtct field</span>
00052     <span class="keywordflow">if</span>(fDtct=((loc=attr[i].find(<span class="stringliteral">"dtct"</span>,0)) != string::npos)){
00053       loc1 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc);
00054       loc2 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc1+1);
00055       dtct = attr[i].substr(loc1+1, loc2-loc1-1);
00056       processMaskField(mask[i].dtct, mask[i].nDtctMask, dtct);
00057       <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5) {
00058         cout&lt;&lt;<span class="stringliteral">"dtct tag: "</span>&lt;&lt;dtct&lt;&lt;endl;
00059       }
00060     }
00061     <span class="keywordflow">else</span>{ <span class="comment">//all dtct masked out{</span>
00062       mask[i].nDtctMask = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>;
00063       mask[i].dtct.init(mask[i].nDtctMask);
00064       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;mask[i].nDtctMask; j++)
00065         mask[i].dtct(j)=j;
00066     }
00067     <span class="comment">//if layer specifed</span>
00068     <span class="keywordflow">if</span>(fLayer=((loc=attr[i].find(<span class="stringliteral">"layer"</span>,0)) != string::npos)) {
00069       loc1 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc);
00070       loc2 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc1+1);
00071       layer = attr[i].substr(loc1+1, loc2-loc1-1);
00072       processMaskField(mask[i].layer, mask[i].nLayerMask, layer);
00073       <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5) {
00074         cout&lt;&lt;<span class="stringliteral">"layer tag: "</span>&lt;&lt;layer&lt;&lt;endl;
00075       }
00076     }
00077     <span class="keywordflow">else</span>  {<span class="comment">//all layer masked out</span>
00078       
00079       mask[i].nLayerMask = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>;
00080       mask[i].layer.init(mask[i].nLayerMask);
00081       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;mask[i].nLayerMask; j++)
00082         mask[i].layer(j)=j;
00083     }
00084 
00085     <span class="comment">//if bank specified</span>
00086     <span class="keywordflow">if</span>(fBank=((loc=attr[i].find(<span class="stringliteral">"bank"</span>,0)) != string::npos)){
00087        
00088       loc1 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc);
00089       loc2 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc1+1);
00090       bank = attr[i].substr(loc1+1, loc2-loc1-1);
00091       processMaskField(mask[i].bank, mask[i].nBankMask, bank);
00092       <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5) {
00093         cout&lt;&lt;<span class="stringliteral">"mask "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">" bank tag: "</span>&lt;&lt;bank&lt;&lt;endl;
00094       }
00095     }
00096     <span class="keywordflow">else</span> { <span class="comment">//all bank masked out</span>
00097      
00098       mask[i].nBankMask = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>;
00099       mask[i].bank.init(mask[i].nBankMask);
00100       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;mask[i].nBankMask; j++)
00101         mask[i].bank(j)=j;
00102     }
00103     <span class="comment">//if ring specifed</span>
00104     <span class="keywordflow">if</span>(fRing=((loc=attr[i].find(<span class="stringliteral">"ring"</span>,0)) != string::npos)){
00105       loc1 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc);
00106       loc2 = attr[i].find_first_of(<span class="stringliteral">"\""</span>,loc1+1);
00107       ring = attr[i].substr(loc1+1, loc2-loc1-1);
00108       processMaskField(mask[i].ring, mask[i].nRingMask, ring);
00109       <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5) {
00110             cout&lt;&lt;<span class="stringliteral">"ring tag: "</span>&lt;&lt;ring&lt;&lt;endl;
00111       }
00112     }
00113     <span class="keywordflow">else</span>{ <span class="comment">//all ring masked out</span>
00114       
00115       mask[i].nRingMask = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>;
00116       mask[i].ring.init(mask[i].nRingMask);
00117       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;mask[i].nRingMask; j++)
00118         mask[i].ring(j)=j;
00119     }
00120 
00121   }
00122 }
00123 
00130 <span class="keywordtype">void</span> HRRTHouseMask::processMaskField(<a class="code" href="classArray1D.html">Array1D&lt;int&gt;</a> &amp; field, <span class="keywordtype">int</span> &amp;dim, string s)
00131 {
00132   Params &amp;params = *Params::getInstance();
00133   <span class="keywordtype">int</span> loc = 0, loc1;
00134   <span class="keywordtype">int</span> i; <span class="comment">//loop index</span>
00135   dim = 0;
00136   <span class="comment">//The string is either separated by "," which means several indivadual ones</span>
00137   <span class="comment">//or separated by "-" which means from ?? to ??</span>
00138   <span class="comment">//or not separated which means only one</span>
00139   <span class="keywordflow">while</span>((loc=s.find_first_of(<span class="stringliteral">","</span>,loc+1))!=string::npos){
00140     dim ++;
00141   }
00142   loc = 0;
00143   <span class="keywordflow">if</span>( dim!=0) {
00144     loc = 0; dim++;
00145     field.<a class="code" href="classArray1D.html#a8">init</a>(dim);
00146     <span class="keywordflow">for</span>(i=0; i&lt;dim-1; i++) {
00147       loc1 = s.find_first_of(<span class="stringliteral">","</span>,loc+1);
00148       field(i) = atoi(s.substr(loc,loc1-loc).c_str());
00149       loc = loc1+1;
00150     }
00151     field(i) = atoi(s.substr(loc).c_str());
00152   }
00153   <span class="keywordflow">else</span> <span class="keywordflow">if</span>((loc=s.find(<span class="stringliteral">"-"</span>,0))!=string::npos){
00154     <span class="keywordtype">int</span> nBegin = atoi(s.substr(0,loc).c_str());
00155     <span class="keywordtype">int</span> nEnd = atoi(s.substr(loc+1).c_str());
00156     dim = nEnd -nBegin + 1;
00157     assert(dim&gt;0);
00158     <span class="keywordflow">if</span>(params.frame.verbosity&gt;=5) {
00159       cout&lt;&lt;<span class="stringliteral">"nBegin :"</span>&lt;&lt;nBegin&lt;&lt;<span class="stringliteral">" nEnd :"</span>&lt;&lt;nEnd&lt;&lt;endl;
00160     }
00161     field.<a class="code" href="classArray1D.html#a8">init</a>(dim);
00162     <span class="keywordflow">for</span>(i = 0; i&lt;dim; i++)
00163       field(i) = nBegin + i;
00164     }
00165   <span class="keywordflow">else</span>{
00166     dim = 1;
00167     field.<a class="code" href="classArray1D.html#a8">init</a>(dim);
00168     field(0) = atoi(s.c_str());
00169   }
00170 }
00171 
00172 
00173         
00181 <span class="keywordtype">bool</span> HRRTHouseMask::maskOut(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e1, 
00182                         <span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e2)
00183 {
00184   <span class="keywordflow">if</span>(nMask == 0) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//no detectors masked out</span>
00185   <span class="keywordtype">bool</span> bDtct=<span class="keyword">false</span>,bLayer=<span class="keyword">false</span>,bBank=<span class="keyword">false</span>,bRing=<span class="keyword">false</span>;
00186   <span class="comment">// see if either e1 or e2 has been removed</span>
00187   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =0 ; i&lt;nMask ; i++)
00188     {
00189       bDtct=<span class="keyword">false</span>;
00190       bLayer=<span class="keyword">false</span>;
00191       bBank=<span class="keyword">false</span>;
00192       bRing=<span class="keyword">false</span>;
00193       <span class="comment">//is e1 in  this masked group</span>
00194       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nDtctMask; j++)
00195         bDtct=(e1.<a class="code" href="structCrystalID.html#o0">dtct</a> == mask[i].dtct(j))||bDtct;
00196       <span class="comment">//if layer in masked detectors</span>
00197       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nLayerMask; j++)
00198         bLayer=(e1.<a class="code" href="structCrystalID.html#o3">layer</a> == mask[i].layer(j))||bLayer;
00199       <span class="comment">//if bank in masked detectors</span>
00200       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nBankMask; j++)
00201         bBank=(e1.<a class="code" href="structCrystalID.html#o2">bank</a> == mask[i].bank(j))||bBank;
00202       <span class="comment">//if ring in masked detectors</span>
00203       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nRingMask; j++)
00204         bRing=(e1.<a class="code" href="structCrystalID.html#o1">ring</a> == mask[i].ring(j))||bRing;
00205       <span class="comment">//combine the results</span>
00206       <span class="keywordflow">if</span> (bDtct&amp;&amp;bLayer&amp;&amp;bBank&amp;&amp;bRing)  <span class="keywordflow">return</span> <span class="keyword">true</span>; 
00207       <span class="comment">//is e2 in  this masked group</span>
00208       bDtct=<span class="keyword">false</span>;
00209       bLayer=<span class="keyword">false</span>;
00210       bBank=<span class="keyword">false</span>;
00211       bRing=<span class="keyword">false</span>;
00212       <span class="comment">//if dtct in masked detectors</span>
00213       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nDtctMask; j++)
00214         bDtct=(e2.<a class="code" href="structCrystalID.html#o0">dtct</a> == mask[i].dtct(j))||bDtct;
00215       <span class="comment">//if layer in masked detectors</span>
00216       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nLayerMask; j++)
00217         bLayer=(e2.<a class="code" href="structCrystalID.html#o3">layer</a> == mask[i].layer(j))||bLayer;
00218       <span class="comment">//if bank in masked detectors</span>
00219       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nBankMask; j++)
00220         bBank=(e2.<a class="code" href="structCrystalID.html#o2">bank</a> == mask[i].bank(j))||bBank;
00221       <span class="comment">//if ring in masked detectors</span>
00222       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;mask[i].nRingMask; j++)
00223         bRing=(e2.<a class="code" href="structCrystalID.html#o1">ring</a> == mask[i].ring(j))||bRing;
00224       <span class="comment">//combine the results</span>
00225       <span class="keywordflow">if</span> (bDtct&amp;&amp;bLayer&amp;&amp;bBank&amp;&amp;bRing)  <span class="keywordflow">return</span> <span class="keyword">true</span>; 
00226     }
00227   <span class="keywordflow">return</span> <span class="keyword">false</span>;
00228 }
00229 
00230 
00231 
00232 <span class="comment">// We require that the HRRTScannerParams object be initialized first.</span>
00233 <span class="keywordtype">void</span> HRRTHouseMask::init()
00234 {
00235   scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00236   <span class="keywordflow">if</span>(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o29">filled</a> == <span class="keyword">false</span>){
00237     cout &lt;&lt; <span class="stringliteral">"Fatal error encountered in HRRTHouseMask::init()"</span> 
00238          &lt;&lt; <span class="stringliteral">", scanner-&gt;filled==false "</span> &lt;&lt; endl;
00239     cout &lt;&lt; <span class="stringliteral">"Programmer: make sure that the "</span>
00240          &lt;&lt;<span class="stringliteral">" HRRTScannerParams::readScannerParams() has been called "</span>
00241          &lt;&lt;<span class="stringliteral">" prior to calling HRRTHouseMask::init()"</span>&lt;&lt;endl;
00242    }
00243    <span class="keywordflow">if</span>(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o30">nMask</a> &gt; 0 ){
00244      cout&lt;&lt;<span class="stringliteral">"Processing "</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o30">nMask</a>&lt;&lt;<span class="stringliteral">" scanner masks"</span>&lt;&lt;endl;
00245      nMask = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o30">nMask</a>;
00246      mask = <span class="keyword">new</span> <a class="code" href="classMask.html">Mask</a>[nMask];
00247   cout&lt;&lt;<span class="stringliteral">" mask attributes: "</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o31">maskAttributes</a>[0]&lt;&lt;endl;
00248      processMask(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o31">maskAttributes</a>);
00249      write();
00250    }
00251 
00252 }
00253 
00254 
00255 
00256 <span class="keywordtype">void</span> HRRTHouseMask::write()
00257 {
00258   <span class="keywordflow">if</span>(nMask&gt;0){
00259     cout&lt;&lt;<span class="stringliteral">"The following detectors has been masked out"</span>&lt;&lt;endl;
00260     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =0 ; i&lt;this-&gt;nMask ; i++){
00261       cout&lt;&lt;<span class="stringliteral">"Mask "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;endl;
00262       <span class="keywordflow">if</span> (mask[i].nDtctMask &gt; 0) {
00263        cout&lt;&lt;<span class="stringliteral">" Dtct :"</span>;
00264        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;this-&gt;mask[i].nDtctMask; j++)
00265          cout&lt;&lt;this-&gt;mask[i].dtct(j)&lt;&lt;<span class="stringliteral">" "</span>;
00266        cout&lt;&lt;endl;
00267       }
00268       <span class="keywordflow">if</span> (mask[i].nLayerMask &gt; 0) {
00269        cout&lt;&lt;<span class="stringliteral">" Layer :"</span>;
00270        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;this-&gt;mask[i].nLayerMask; j++)
00271          cout&lt;&lt;this-&gt;mask[i].layer(j)&lt;&lt;<span class="stringliteral">" "</span>;
00272        cout&lt;&lt;endl;
00273       }
00274       <span class="keywordflow">if</span> (mask[i].nBankMask &gt; 0) {
00275        cout&lt;&lt;<span class="stringliteral">" Bank :"</span>;
00276        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;this-&gt;mask[i].nBankMask; j++)
00277          cout&lt;&lt;this-&gt;mask[i].bank(j)&lt;&lt;<span class="stringliteral">" "</span>;
00278        cout&lt;&lt;endl;
00279       }
00280       <span class="keywordflow">if</span> (mask[i].nRingMask &gt; 0) {
00281        cout&lt;&lt;<span class="stringliteral">" Ring :"</span>;
00282        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j= 0; j&lt;this-&gt;mask[i].nRingMask; j++)
00283          cout&lt;&lt;this-&gt;mask[i].ring(j)&lt;&lt;<span class="stringliteral">" "</span>;
00284        cout&lt;&lt;endl;
00285       }
00286     }
00287   }
00288 }
00289 
00290 
00291 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
