<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: PolarisMotionCorrection.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>PolarisMotionCorrection.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "PolarisMotionCorrection.hpp"</span>
00002 <span class="preprocessor">#include "Utilities.hpp"</span>
00003 <span class="preprocessor">#include "Constant.hpp"</span>
00004 
<a name="l00005"></a><a class="code" href="classPolarisMotionCorrection.html#a0">00005</a> <a class="code" href="classPolarisMotionCorrection.html#a0">PolarisMotionCorrection::PolarisMotionCorrection</a>(string fileName, 
00006                                                  Status &amp; status, 
00007                                                  <span class="keywordtype">int</span> scanStartTime, 
00008                                                  <span class="keywordtype">int</span> frameStartTime, 
00009                                                  <span class="keywordtype">int</span> requestedDuration,
00010                                                  <span class="keywordtype">bool</span> parallelFlag)
00011 : <a class="code" href="classMotionCorrection.html">MotionCorrection</a>(fileName, status, scanStartTime, frameStartTime, 
00012                    requestedDuration)
00013 {
00014   <span class="keywordtype">int</span> startTime = scanStartTime+frameStartTime;
00015   <span class="keywordtype">int</span> endTime = startTime + requestedDuration;
00016 
00017   <span class="keywordflow">if</span>(status.proc ==0){
00018     <span class="comment">//Open the transformation file</span>
00019     ifstream fTransform(fileName.c_str());
00020     <span class="keywordflow">if</span>(!fTransform){
00021       string msg = <span class="stringliteral">"Error in opening file: "</span>+fileName;
00022       <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00023       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00024     }
00025   
00026     <span class="comment">//declare some local variables</span>
00027     <span class="keywordtype">char</span> ch;  <span class="comment">//store the comma read in</span>
00028     Array2D&lt;float&gt; tempMatrix;
00029     <span class="keywordtype">float</span> tempTime, tempError;
00030     <span class="keywordtype">int</span> numRead = 0;
00031 
00032     numMatrix = 0;
00033     averageMatrix.init(Constant::POLARISMATRIXSIZE,
00034                        Constant::POLARISMATRIXSIZE );
00035     motion[0].matrix.init(Constant::POLARISMATRIXSIZE,
00036                           Constant::POLARISMATRIXSIZE );
00037     motion[1].matrix.init(Constant::POLARISMATRIXSIZE,
00038                           Constant::POLARISMATRIXSIZE );
00039     tempMatrix.init(Constant::POLARISMATRIXSIZE,
00040                           Constant::POLARISMATRIXSIZE );
00041    
00042     <span class="keywordflow">while</span>(!fTransform.eof()) {
00043       
00044       tempTime = motion[0].time;
00045       tempMatrix = motion[0].matrix;
00046       
00047       <span class="comment">// Read a line from the Polaris transformation file and parse it</span>
00048       
00049       fTransform&gt;&gt;motion[0].time&gt;&gt;ch;
00050       <span class="comment">// 2006-03-17 check for EOF</span>
00051       <span class="keywordflow">if</span> (fTransform.eof()) {
00052        <span class="comment">// last line in file is before frame start time</span>
00053        motion[0].time = tempTime - scanStartTime;       <span class="comment">// put the value back</span>
00054        averageMatrix = motion[0].matrix;
00055        <span class="keywordflow">break</span>;
00056       }
00057       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i= 0; i&lt;Constant::POLARISMATRIXSIZE-1; i++)
00058         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0; j&lt;Constant::POLARISMATRIXSIZE; j++)
00059           fTransform&gt;&gt;motion[0].matrix(i,j)&gt;&gt;ch;
00060       fTransform&gt;&gt;motion[0].error;
00061 
00062       <span class="comment">// Check if the time falls within the frame time</span>
00063       <span class="keywordflow">if</span> (motion[0].time == startTime){
00064         motion[0].time -= scanStartTime;
00065         averageMatrix = motion[0].matrix;
00066         <span class="keywordflow">break</span>;}
00067       <span class="keywordflow">else</span> <span class="keywordflow">if</span>((motion[0].time &gt; startTime) &amp;&amp; numRead == 0){
00068         string msg = <span class="stringliteral">"First time in motion correction file"</span>+fileName+<span class="stringliteral">" is past frame start time"</span>;
00069         <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00070         <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);}
00071       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((motion[0].time &gt; startTime) &amp;&amp; numRead != 0 ){
00072         motion[1].time = motion[0].time - scanStartTime;
00073         motion[1].matrix = motion[0].matrix;
00074         motion[0].time = tempTime - scanStartTime;
00075         motion[0].matrix = tempMatrix;
00076         averageMatrix = motion[0].matrix;
00077         averageMatrix += motion[1].matrix;
00078         numMatrix++;
00079         <span class="keywordflow">break</span>;}
00080       numRead++;
00081     }
00082     
00083     tempTime = 0;
00084     
00085     <span class="keywordflow">while</span>(!fTransform.eof()) {
00086 
00087       <span class="comment">// Read a line from the Polaris transformation file and parse it</span>
00088       
00089       fTransform&gt;&gt;tempTime&gt;&gt;ch;
00090       
00091       <span class="keywordflow">if</span>(tempTime == 0) {<span class="keywordflow">break</span>;}
00092       
00093       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i= 0; i&lt;Constant::POLARISMATRIXSIZE-1; i++)
00094         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j = 0; j&lt;Constant::POLARISMATRIXSIZE; j++)
00095           fTransform&gt;&gt;tempMatrix(i,j)&gt;&gt;ch;
00096       fTransform&gt;&gt;tempError;
00097       
00098       <span class="keywordflow">if</span> (endTime &gt;= tempTime){
00099         numMatrix++;
00100       <span class="comment">// Initialize a matrix to hold the data</span>
00101       motion[numMatrix].matrix.init(Constant::POLARISMATRIXSIZE,
00102                                     Constant::POLARISMATRIXSIZE );
00103       motion[numMatrix].time =tempTime-scanStartTime;
00104       motion[numMatrix].matrix = tempMatrix;
00105       averageMatrix += tempMatrix;
00106       tempTime = 0;
00107       }
00108       <span class="keywordflow">if</span> (endTime &lt; tempTime){<span class="keywordflow">break</span>;}
00109     } 
00110     numMatrix++;
00111     averageMatrix /= numMatrix;
00112   }     
00113 
00114   <span class="comment">//if in parallel, broadcast all information to the rest processors</span>
00115   <span class="keywordflow">if</span>(parallelFlag){
00116     MPI::COMM_WORLD.Barrier();
00117     <span class="comment">//broadcast to the rest processors</span>
00118     MPI::COMM_WORLD.Bcast(&amp;numMatrix, 1, MPI::INT, 0);
00119     <span class="keywordflow">if</span>(status.proc !=0){
00120       <span class="comment">//init the matrices</span>
00121       averageMatrix.init(Constant::POLARISMATRIXSIZE,
00122                          Constant::POLARISMATRIXSIZE); 
00123       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numMatrix; i++)
00124         motion[i].matrix.init(Constant::POLARISMATRIXSIZE,
00125                               Constant::POLARISMATRIXSIZE);
00126     }
00127     <span class="keywordtype">int</span> sizeMatrix =Constant::POLARISMATRIXSIZE*
00128       Constant::POLARISMATRIXSIZE;
00129 
00130     MPI::COMM_WORLD.Bcast(&amp;(averageMatrix(0,0)),sizeMatrix,MPI::FLOAT, 0);
00131     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;numMatrix; i++)
00132       MPI::COMM_WORLD.Bcast(&amp;(motion[i].matrix(0,0)), sizeMatrix,
00133                             MPI::FLOAT, 0);
00134   }
00135 }
00136 
<a name="l00137"></a><a class="code" href="classPolarisMotionCorrection.html#a1">00137</a> <span class="keywordtype">int</span> <a class="code" href="classPolarisMotionCorrection.html#a1">PolarisMotionCorrection::transform</a>(<a class="code" href="classEventPacket.html">EventPacket</a> &amp;event, 
00138                                       <span class="keywordtype">float</span> &amp; errorEstimate)
00139 {
00140   <span class="comment">//Move index to the right place</span>
00141   <span class="comment">// RC 2006-10-11 the next line was resetting the index ot 0 each time</span>
00142   <span class="comment">// This made things horrendously slow with big files</span>
00143   <span class="comment">// removed</span>
00144   <span class="comment">//index = 0;</span>
00145   <span class="keywordflow">while</span>(index &lt; numMatrix){
00146     <span class="keywordflow">if</span>(motion[index].time == event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>){<span class="keywordflow">break</span>;}
00147     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (motion[index].time &gt; event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>){index--; <span class="keywordflow">break</span>;}
00148     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((motion[index].time &lt; event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>) &amp;&amp; 
00149              (index == (numMatrix-1))){<span class="keywordflow">break</span>;}
00150     <span class="keywordflow">else</span>
00151       index++;
00152   }
00153 
00154   <span class="comment">//out of range, return error code -1</span>
00155   <span class="keywordflow">if</span>(index == numMatrix) <span class="keywordflow">return</span> -1;
00156   <span class="comment">//assign the detector coordinates to arrays</span>
00157   <span class="keywordtype">float</span> dtctCoordinate1[]={event.<a class="code" href="classEventPacket.html#o12">x1</a>, event.<a class="code" href="classEventPacket.html#o13">y1</a>, event.<a class="code" href="classEventPacket.html#o14">z1</a>, 1};
00158   <span class="keywordtype">float</span> dtctCoordinate2[]={event.<a class="code" href="classEventPacket.html#o15">x2</a>, event.<a class="code" href="classEventPacket.html#o16">y2</a>, event.<a class="code" href="classEventPacket.html#o17">z2</a>, 1};
00159 
00160   <span class="comment">//store the transformed coordinates</span>
00161   <span class="keywordtype">float</span> *dtctCoordinateResult;
00162 
00163   <span class="comment">//Multiply the transformation matrix by the detector </span>
00164   <span class="comment">//coordinates</span>
00165   dtctCoordinateResult = motion[index].matrix*dtctCoordinate1;
00166   <span class="comment">//save the result</span>
00167   event.<a class="code" href="classEventPacket.html#o12">x1</a> = dtctCoordinateResult[0];
00168   event.<a class="code" href="classEventPacket.html#o13">y1</a> = dtctCoordinateResult[1];
00169   event.<a class="code" href="classEventPacket.html#o14">z1</a> = dtctCoordinateResult[2];
00170   <span class="keyword">delete</span> []dtctCoordinateResult;
00171   <span class="comment">//multiply</span>
00172   dtctCoordinateResult =motion[index].matrix*dtctCoordinate2;
00173   <span class="comment">//save the result</span>
00174   event.<a class="code" href="classEventPacket.html#o15">x2</a> = dtctCoordinateResult[0];
00175   event.<a class="code" href="classEventPacket.html#o16">y2</a> = dtctCoordinateResult[1];
00176   event.<a class="code" href="classEventPacket.html#o17">z2</a> = dtctCoordinateResult[2];
00177   <span class="keyword">delete</span> []dtctCoordinateResult;
00178   <span class="comment">//save the error</span>
00179   errorEstimate = motion[index].error;
00180 
00181   <span class="comment">//successful, return 1</span>
00182   <span class="keywordflow">return</span> 1;
00183 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:48 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
