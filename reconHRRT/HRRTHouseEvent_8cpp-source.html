<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: HRRTHouseEvent.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>HRRTHouseEvent.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include &lt;sstream&gt;</span>
00004 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00005 <span class="preprocessor">#include "HRRTHouse.hpp"</span>
00006 <span class="preprocessor">#include "Status.hpp"</span>
00007 <span class="preprocessor">#include "ResolutionFunction.hpp"</span>
00008 <span class="preprocessor">#include "IsoGaussian.hpp"</span>
00009 <span class="preprocessor">#include "Utilities.hpp"</span>
00010 <span class="preprocessor">#include "Constant.hpp"</span>
00011 <span class="preprocessor">#include "TOC.hpp"</span>
00012 <span class="preprocessor">#include "FrameInfo.hpp"</span>
00013 <span class="preprocessor">#include "MOLAR.hpp"</span>
00014 
00015 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00016 
00017 HRRTHouseEvent::HRRTHouseEvent(){
00018   
00019   checkSum = <span class="keyword">sizeof</span>(<a class="code" href="classHRRTHouseEvent.html">HRRTHouseEvent</a>);
00020   <span class="comment">//get instances of the singleton classes</span>
00021   params = Params::getInstance();
00022   scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00023   houseNorm = HRRTHouseNorm::getInstance();
00024   houseList = HRRTHouseList::getInstance();
00025   houseSingles = HRRTHouseSingles::getInstance();
00026   houseMask = HRRTHouseMask::getInstance();
00027   houseResolution = HRRTHouseResolution::getInstance();
00028 
00029 
00030   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seed = std::time(NULL); <span class="comment">//seed for random events</span>
00031   srand(seed); 
00032 
00033   nQ = 0; <span class="comment">//init number of randomized event generated</span>
00034   sentry = NULLEVENT; <span class="comment">//init sentry</span>
00035 
00036   <span class="comment">//initialize debug variables</span>
00037   debugData.sStartMin =debugData.zStartMin = 1000;
00038   debugData.sStartMax = debugData.zStartMax = -1000;
00039   debugData.sStartAvg = debugData.zStartAvg = debugData.nonVio = 0;
00040   debugData.nsStart=debugData.nsStop=debugData.nzStart
00041     = debugData.nzStop=debugData.njStart=0;
00042   debugData.nsStart2=debugData.nsStop2=debugData.nzStart2= debugData.nzStop2=0;
00043   debugData.numjStop=debugData.totalNumjStop=0;
00044 }
00045 
00046 
00047 <span class="comment">//----------------------------------------------------------------------------</span>
00048 <span class="comment">//get a randomized event</span>
00049 <span class="comment">//-----------------------------------------------------------------------------</span>
00050 <span class="keywordtype">void</span> HRRTHouseEvent::getRandomizedEvent(<span class="keywordtype">int</span> totalD, <a class="code" href="structCrystalID.html">CrystalID</a>&amp; p1, 
00051                                <a class="code" href="structCrystalID.html">CrystalID</a>&amp; p2)
00052 {
00053   scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00054   <span class="keywordtype">bool</span> legal = <span class="keyword">false</span>;<span class="comment">//flag for nighboring banks</span>
00055   <span class="keywordflow">while</span> (!legal){ <span class="comment">//if two banks not nighboring, exist</span>
00056     <span class="comment">//random number between 0 to total detector number</span>
00057     <span class="keywordtype">int</span> d1 = static_cast&lt;int&gt; (totalD*(((<span class="keywordtype">float</span>)rand())/RAND_MAX));
00058     <span class="comment">//random number between 0 to total detector number</span>
00059     <span class="keywordtype">int</span> d2 = static_cast&lt;int&gt; (totalD*(((<span class="keywordtype">float</span>) rand())/RAND_MAX));
00060     p1 = getHrrtId(d1);<span class="comment">//get a detector</span>
00061     p2 = getHrrtId(d2); <span class="comment">//get another detector</span>
00062     <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00063       cout&lt;&lt;<span class="stringliteral">"d1 : "</span>&lt;&lt;d1&lt;&lt;<span class="stringliteral">", d2 : "</span>&lt;&lt;d2&lt;&lt;endl;
00064       cout&lt;&lt;<span class="stringliteral">"p1.dtct : "</span>&lt;&lt;p1.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;&lt;<span class="stringliteral">", p1.layer : "</span>&lt;&lt;p1.<a class="code" href="structCrystalID.html#o3">layer</a>
00065           &lt;&lt;<span class="stringliteral">", p1.bank : "</span>&lt;&lt;p1.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;<span class="stringliteral">", p1.ring : "</span>&lt;&lt;p1.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;endl;
00066       cout&lt;&lt;<span class="stringliteral">"p2.dtct : "</span>&lt;&lt;p2.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;&lt;<span class="stringliteral">", p2.layer : "</span>&lt;&lt;p2.<a class="code" href="structCrystalID.html#o3">layer</a>
00067           &lt;&lt;<span class="stringliteral">", p2.bank : "</span>
00068           &lt;&lt;p2.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;<span class="stringliteral">", p2.ring : "</span>&lt;&lt;p2.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;endl;
00069     }
00070     <span class="comment">// If there is no masking, choose events in a structured fashion</span>
00071     <span class="comment">// Put 3 times as many events in the front layer</span>
00072     <span class="keywordflow">if</span> (scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o30">nMask</a> == 0){
00073       <span class="keywordtype">float</span> l = (((<span class="keywordtype">float</span>)rand())/RAND_MAX);
00074       <span class="keywordflow">if</span> (l &gt;= 0 &amp;&amp; l &lt;= 0.5625) {
00075         p1.<a class="code" href="structCrystalID.html#o3">layer</a> = 0;
00076         p2.<a class="code" href="structCrystalID.html#o3">layer</a> = 0;
00077       }
00078       <span class="keywordflow">if</span> (l &gt; 0.5625 &amp;&amp; l &lt;= 0.75) {
00079         p1.<a class="code" href="structCrystalID.html#o3">layer</a> = 0;
00080         p2.<a class="code" href="structCrystalID.html#o3">layer</a> = 1;
00081       }
00082       <span class="keywordflow">if</span> (l &gt; 0.75 &amp;&amp; l &lt;= 0.9375) {
00083         p1.<a class="code" href="structCrystalID.html#o3">layer</a> = 1;
00084         p2.<a class="code" href="structCrystalID.html#o3">layer</a> = 0;
00085       }
00086       <span class="keywordflow">if</span> (l &gt; 0.9375 &amp;&amp; l &lt;= 1) {
00087         p1.<a class="code" href="structCrystalID.html#o3">layer</a> = 1;
00088         p2.<a class="code" href="structCrystalID.html#o3">layer</a> = 1;
00089       }
00090       <span class="comment">//not sure if nedxt 2 lines are necessary.s          </span>
00091       p1.<a class="code" href="structCrystalID.html#o9">block</a> = houseList-&gt;<a class="code" href="classHRRTHouseList.html#d17">getBlockNumber</a>(p1);
00092       p2.<a class="code" href="structCrystalID.html#o9">block</a> = houseList-&gt;<a class="code" href="classHRRTHouseList.html#d17">getBlockNumber</a>(p2);
00093     }
00094     <span class="keywordflow">if</span>(fabs((<span class="keywordtype">float</span>)(p1.<a class="code" href="structCrystalID.html#o2">bank</a>-p2.<a class="code" href="structCrystalID.html#o2">bank</a>))&gt;=2 and 
00095        fabs((<span class="keywordtype">float</span>)(p1.<a class="code" href="structCrystalID.html#o2">bank</a>-p2.<a class="code" href="structCrystalID.html#o2">bank</a>))&lt;=6)  
00096      <span class="comment">//if not neighboring panels, then it is a legal event</span>
00097      legal = <span class="keyword">true</span>;
00098   }
00099  }
00100 
00101 
00102 <span class="comment">//---------------------------------------------------------------------</span>
00103 <span class="comment">/* Fills in geometry information for forward and backprojection</span>
00104 <span class="comment">   start with x1,y1,z1 and x2,y2,z2 - locations of 2 detectors</span>
00105 <span class="comment">   calculates the following:</span>
00106 <span class="comment">   short jstart, jstop;</span>
00107 <span class="comment">   image indices in primary direction of region of support,</span>
00108 <span class="comment">   jstop &gt; jstart&lt;</span>
00109 <span class="comment">   float secondaryStart, zStart;</span>
00110 <span class="comment">   starting secondary  and z locations</span>
00111 <span class="comment">   float secondaryStep, zStep;</span>
00112 <span class="comment">   step size in secondary and z directions per unit step in</span>
00113 <span class="comment">   primary direction</span>
00114 <span class="comment">   float sinphi, cosphi;</span>
00115 <span class="comment">   determines orientation; used by forward-back projection;</span>
00116 <span class="comment">   absolute value</span>
00117 <span class="comment">   float costheta;</span>
00118 <span class="comment">   used by fwd-back projection; absolute value</span>
00119 <span class="comment"></span>
00120 <span class="comment">   Orientation information with respect to scanner FOV</span>
00121 <span class="comment">   x is increasing from left to right (as viewed from front of scanner)</span>
00122 <span class="comment">   y is increasing from bottom to top</span>
00123 <span class="comment">   z is increasing from back of scanner to front of scanner</span>
00124 <span class="comment">   for detector position, values are in mm with (0,0,0)</span>
00125 <span class="comment">   in center of scanner FOV</span>
00126 <span class="comment">   for image space, indices are nonnegative so 0,0,0 is towards</span>
00127 <span class="comment">   left, bottom, back of scanner</span>
00128 <span class="comment">   ------------------------------------------------------------ */</span>
00129 <span class="keywordtype">bool</span> HRRTHouseEvent::determineLORcoordinates(<a class="code" href="classEventPacket.html">EventPacket</a> &amp;event)
00130 {
00131 
00132   <a class="code" href="structParams_1_1Geometry.html">Params::Geometry</a> g;<span class="comment">//geometry struct, to define the geometry of image</span>
00133 
00134   <span class="comment">//intermediate variables</span>
00135   <span class="keywordtype">float</span> phi,theta; 
00136 
00137 
00138   <span class="keywordtype">float</span> xmin,xmax,ymin,ymax,zmin,zmax;
00139   <span class="keywordtype">float</span> x1,y1,z1,x2,y2,z2,xcen,ycen,zcen;
00140   <span class="keywordtype">float</span> xA,yA,zA,xB,yB,zB;
00141   <span class="comment">// computed intersection points of LOR with cylinder</span>
00142   <span class="keywordtype">float</span> x,y,z,t,tdiff; <span class="comment">// intermediate variables</span>
00143   <span class="keywordtype">float</span> a,b,c,d;
00144   <span class="comment">// coeffients of the quadratic (a,b,c) and d=b^2-4ac</span>
00145   <span class="keywordtype">float</span> tval[4];      
00146   <span class="comment">//to hold interesection points of LOR with cylinder</span>
00147   <span class="keywordtype">int</span> itval;       <span class="comment">// counter of number of intersection points</span>
00148   <span class="keywordtype">int</span> ii,jj;       <span class="comment">//loop variables</span>
00149   <span class="keyword">static</span> <span class="keywordtype">int</span> numReported;
00150   <span class="keyword">static</span> <span class="keywordtype">bool</span> firstTimeFlag = <span class="keyword">true</span>;
00151 
00152   <span class="keywordflow">if</span>(firstTimeFlag){
00153     numReported=0;
00154     firstTimeFlag = <span class="keyword">false</span>;
00155   }
00156 
00157   g = params-&gt;geometry;   <span class="comment">// to save typing</span>
00158   <span class="comment">// calculate angles:</span>
00159   <span class="comment">// 0 &lt;= phi &lt;= pi  phi=0 is  a vertical projection</span>
00160   <span class="comment">// Use atan2 backwards from regular way</span>
00161   phi= (<span class="keywordtype">float</span>) atan2(event.<a class="code" href="classEventPacket.html#o15">x2</a>-event.<a class="code" href="classEventPacket.html#o12">x1</a>, event.<a class="code" href="classEventPacket.html#o16">y2</a>-event.<a class="code" href="classEventPacket.html#o13">y1</a>);
00162   <span class="comment">// (deltax,deltay) returns (-pi,pi)</span>
00163   <span class="keywordflow">if</span> (phi &lt; 0.0) phi += Constant::PI; 
00164   event.<a class="code" href="classEventPacket.html#o22">sinphi</a> = sin(phi);  <span class="comment">// must be positive</span>
00165   event.<a class="code" href="classEventPacket.html#o23">cosphi</a> = fabs(cos(phi)); <span class="comment">//</span>
00166  
00167   <span class="comment">// now break based on primary direction</span>
00168   <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o22">sinphi</a> &gt; Constant::SIN45) {
00169     <span class="comment">// primary direction is x</span>
00170     <span class="comment">// calculate the polar angle: z with respect to x</span>
00171     <span class="comment">// -pi/2 &lt;= theta &lt;= pi/2  theta=0 is  a straight slice   </span>
00172     <span class="comment">//(delta z = 0)</span>
00173     <span class="comment">// in this case, we want a positive step so the sign of this</span>
00174     <span class="comment">//angle is irrelevant</span>
00175     <span class="comment">// next result can theoretically be (0,pi/2). for current scanners,</span>
00176     <span class="comment">//the angle is &lt; pi/4</span>
00177     theta= atan2(fabs(event.<a class="code" href="classEventPacket.html#o17">z2</a>-event.<a class="code" href="classEventPacket.html#o14">z1</a>), fabs(event.<a class="code" href="classEventPacket.html#o15">x2</a>-event.<a class="code" href="classEventPacket.html#o12">x1</a>));
00178     <span class="comment">// (deltaz,deltax) returns (0,pi/2)</span>
00179     <span class="comment">// rearrange the start and stop points so x1 &lt; x2</span>
00180     <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o12">x1</a> &lt; event.<a class="code" href="classEventPacket.html#o15">x2</a>){
00181       x1=event.<a class="code" href="classEventPacket.html#o12">x1</a>; x2=event.<a class="code" href="classEventPacket.html#o15">x2</a>;
00182       y1=event.<a class="code" href="classEventPacket.html#o13">y1</a>; y2=event.<a class="code" href="classEventPacket.html#o16">y2</a>;
00183       z1=event.<a class="code" href="classEventPacket.html#o14">z1</a>; z2=event.<a class="code" href="classEventPacket.html#o17">z2</a>;
00184     }
00185     <span class="keywordflow">else</span>{
00186       x1=event.<a class="code" href="classEventPacket.html#o15">x2</a>; x2=event.<a class="code" href="classEventPacket.html#o12">x1</a>;
00187       y1=event.<a class="code" href="classEventPacket.html#o16">y2</a>; y2=event.<a class="code" href="classEventPacket.html#o13">y1</a>;
00188       z1=event.<a class="code" href="classEventPacket.html#o17">z2</a>; z2=event.<a class="code" href="classEventPacket.html#o14">z1</a>;
00189     }
00190   }
00191   <span class="keywordflow">else</span> {
00192     <span class="comment">// primary direction is y</span>
00193     <span class="comment">// calculate the polar angle: z with respect to y</span>
00194     theta= atan2(fabs(event.<a class="code" href="classEventPacket.html#o17">z2</a>-event.<a class="code" href="classEventPacket.html#o14">z1</a>), fabs(event.<a class="code" href="classEventPacket.html#o16">y2</a>-event.<a class="code" href="classEventPacket.html#o13">y1</a>));
00195     <span class="comment">// (deltaz,deltay) returns (0,pi/2)</span>
00196     <span class="comment">// rearrange the start and stop points so y1 &lt; y2</span>
00197     <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o13">y1</a> &lt; event.<a class="code" href="classEventPacket.html#o16">y2</a>){
00198       x1=event.<a class="code" href="classEventPacket.html#o12">x1</a>;x2=event.<a class="code" href="classEventPacket.html#o15">x2</a>;
00199       y1=event.<a class="code" href="classEventPacket.html#o13">y1</a>;y2=event.<a class="code" href="classEventPacket.html#o16">y2</a>;
00200       z1=event.<a class="code" href="classEventPacket.html#o14">z1</a>;z2=event.<a class="code" href="classEventPacket.html#o17">z2</a>;
00201     }
00202     <span class="keywordflow">else</span>{
00203       x1=event.<a class="code" href="classEventPacket.html#o15">x2</a>; x2=event.<a class="code" href="classEventPacket.html#o12">x1</a>;
00204       y1=event.<a class="code" href="classEventPacket.html#o16">y2</a>; y2=event.<a class="code" href="classEventPacket.html#o13">y1</a>;
00205       z1=event.<a class="code" href="classEventPacket.html#o17">z2</a>; z2=event.<a class="code" href="classEventPacket.html#o14">z1</a>;
00206     }
00207   }
00208 
00209   <span class="comment">/* the purpose of the theta calculation is to properly calculate</span>
00210 <span class="comment">     the step in indexing through  resFunU.kernel as we move away from</span>
00211 <span class="comment">     the LOR in the z direction</span>
00212 <span class="comment">     *** The following logic assumes that the sampling of resFunU is in</span>
00213 <span class="comment">     steps of g.dZ/resFunU.magnification</span>
00214 <span class="comment">     (see inner loop of forwardproject code)</span>
00215 <span class="comment">     One voxel in Z changes the resFunU.kernel index by</span>
00216 <span class="comment">     event.costheta*resFunU.magnification</span>
00217 <span class="comment">     Stepping one voxel (g.dZ mm) in z, moves away from the LOR by</span>
00218 <span class="comment">     g.dZ*cos(theta) mm</span>
00219 <span class="comment">     Thus we need (event.costheta*resFunU.magnification) *</span>
00220 <span class="comment">     (g.dZ/resFunU.magnification) to =</span>
00221 <span class="comment">     g.dZ*cos(theta), thus the variable is well named, i.e.,</span>
00222 <span class="comment">  */</span>
00223 
00224   event.<a class="code" href="classEventPacket.html#o24">costheta</a> = cos(theta); <span class="comment">//</span>
00225 
00226   <span class="comment">// Convert the coordinates of the detectors into floating point</span>
00227   <span class="comment">// image index space</span>
00228   <span class="comment">// old code: removed 2006-11-30</span>
00229   <span class="comment">//xcen=((g.nX-1)/2.); // center of image volume</span>
00230   <span class="comment">//ycen=((g.nY-1)/2.);</span>
00231   <span class="comment">//zcen=((g.nZ-1)/2.);</span>
00232   <span class="comment">// 2006-11-30 rc</span>
00233   <span class="comment">// The projection code treats the center of each pixel as 0.5, 1.5, ..., nX-0.5</span>
00234   <span class="comment">// Thus the center of the volume is nX/2 not (nX-1)/2</span>
00235   xcen=((g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>)/2.); <span class="comment">// center of image volume</span>
00236   ycen=((g.<a class="code" href="structParams_1_1Geometry.html#o1">nY</a>)/2.);
00237   zcen=((g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>)/2.);
00238   
00239   <span class="comment">// offsetX (mm) corresponds to xcen (pixel indices)  </span>
00240   <span class="comment">// dX is mm/pixel index</span>
00241   x1=(x1-g.<a class="code" href="structParams_1_1Geometry.html#o8">offsetX</a>)/g.<a class="code" href="structParams_1_1Geometry.html#o5">dX</a> + xcen;
00242   x2=(x2-g.<a class="code" href="structParams_1_1Geometry.html#o8">offsetX</a>)/g.<a class="code" href="structParams_1_1Geometry.html#o5">dX</a> + xcen;
00243   y1=(y1-g.<a class="code" href="structParams_1_1Geometry.html#o9">offsetY</a>)/g.<a class="code" href="structParams_1_1Geometry.html#o6">dY</a> + ycen;
00244   y2=(y2-g.<a class="code" href="structParams_1_1Geometry.html#o9">offsetY</a>)/g.<a class="code" href="structParams_1_1Geometry.html#o6">dY</a> + ycen;
00245   z1=(z1-g.<a class="code" href="structParams_1_1Geometry.html#o10">offsetZ</a>)/g.<a class="code" href="structParams_1_1Geometry.html#o7">dZ</a> + zcen;
00246   z2=(z2-g.<a class="code" href="structParams_1_1Geometry.html#o10">offsetZ</a>)/g.<a class="code" href="structParams_1_1Geometry.html#o7">dZ</a> + zcen;
00247 
00248 
00249   <span class="comment">/* Write the equations for traversing the line starting at (x1,y1,z1)</span>
00250 <span class="comment">     at t=0 and reaching</span>
00251 <span class="comment">     (x2,y2,z2) at t=1</span>
00252 <span class="comment">     x(t)=x1+(x2-x1)t y(t) = y1 + (y2-y1)t  z(t) = z1 + (z2-z1)t     (1)</span>
00253 <span class="comment"></span>
00254 <span class="comment">     find the starting and ending t that intersects the original</span>
00255 <span class="comment">     cylindrical FOV</span>
00256 <span class="comment">     .offsetX is the distance in mm from the center of the scanner FOV</span>
00257 <span class="comment">     Within that rectangular image matrix, we only consider a centered</span>
00258 <span class="comment">     cylinder of diameter g.FOV_r (voxels)</span>
00259 <span class="comment">     and length g.FOV_z (z voxels), i.e., g.FOV_r &lt;= g.nX and g.FOV_z &lt;=</span>
00260 <span class="comment">     g.nZ       write the equations of this cylinder in terms of x,y,z </span>
00261 <span class="comment">     in image index</span>
00262 <span class="comment">     units</span>
00263 <span class="comment">     (x-xcen)^2+(y-ycen)^2 = (FOV_r/2)^2       (2)</span>
00264 <span class="comment">     zcen-FOV_z/2 &lt;= z &lt; zcen+FOV_z/2</span>
00265 <span class="comment">     Calculate the x and y intersections of this LOR with the cylinder</span>
00266 <span class="comment">     This is done by determining th t values from Eqs. (1) above</span>
00267 <span class="comment">     There are 4 possibilities: 2 on the outer circle, and 1 each on</span>
00268 <span class="comment">     either end</span>
00269 <span class="comment">     Since the 2 endpoints range from t=0 to t=1, we are interested in t</span>
00270 <span class="comment">     values     check the ends, i.e., find the intersection of the </span>
00271 <span class="comment">     LOR with</span>
00272 <span class="comment">     z=zcen-FOV_z/2 and z=zcen+FOV_z/2</span>
00273 <span class="comment">  */</span>
00274         
00275   itval=0;        <span class="comment">// counter of number of legal intersections</span>
00276   <span class="keywordflow">if</span> (z2 != z1)  {
00277     <span class="keywordflow">for</span> (ii=-1; ii &lt;=1; ii+=2){
00278       t=(zcen+ii*g.<a class="code" href="structParams_1_1Geometry.html#o4">FOV_z</a>/2.-z1)/(z2-z1);
00279       <span class="keywordflow">if</span> ((t &gt; 0) &amp;&amp; (t &lt; 1)) {
00280         <span class="comment">// If this t is relevant, plug into equation (1) and</span>
00281         <span class="comment">//calculate x and y and and see if the intersection</span>
00282         <span class="comment">// is inside the cylinder</span>
00283         x=x1+(x2-x1)*t;
00284         y=y1+(y2-y1)*t;
00285         <span class="keywordflow">if</span> (POW2((x-xcen))+POW2((y-ycen)) &lt;= POW2((g.<a class="code" href="structParams_1_1Geometry.html#o3">FOV_r</a>/2.))){
00286           tval[itval]=t;
00287           itval++;
00288         } <span class="comment">// point inside the cylinder</span>
00289       } <span class="comment">//point between the detectors</span>
00290     } <span class="comment">// 2 ends of the cylinder  r</span>
00291   } <span class="comment">// if LOR has theta=0, cannot intersect end planes of cylinder</span>
00292 
00293   <span class="comment">// now find the intersections of the LOR with the cylinder. </span>
00294   <span class="comment">// check that theyare within the z borders</span>
00295   <span class="comment">// Plug equations (1) into (2) and solve for t - produces </span>
00296   <span class="comment">// a quadratic equation</span>
00297   a=POW2((x2-x1))+POW2((y2-y1));
00298   b=2.*( (x1-xcen)*(x2-x1)+(y2-y1)*(y1-ycen) );
00299   c=POW2((x1-xcen))+POW2((y1-ycen))-POW2((g.<a class="code" href="structParams_1_1Geometry.html#o3">FOV_r</a>/2.));
00300   d=POW2(b) - 4. * a * c ;
00301   <span class="keywordflow">if</span> (d &gt; 0)  {
00302     <span class="keywordflow">for</span> (ii=-1; ii &lt;=1; ii+=2){
00303       t=(-b+ii*sqrt(d))/(2.*a);
00304       <span class="keywordflow">if</span> ((t &gt; 0) &amp;&amp; (t &lt; 1)) {
00305         <span class="comment">// If this t is relevant, plug into equation (1) and</span>
00306         <span class="comment">//calculate z and and seeif the intersection</span>
00307         <span class="comment">// is inside the cylinder                       </span>
00308         z=z1+(z2-z1)*t;
00309         <span class="keywordflow">if</span> ((z &gt; zcen-g.<a class="code" href="structParams_1_1Geometry.html#o4">FOV_z</a>/2.) &amp;&amp; (z &lt; zcen+g.<a class="code" href="structParams_1_1Geometry.html#o4">FOV_z</a>/2.)){
00310           tval[itval]=t;
00311           itval++;
00312         } <span class="comment">// point is inside the cylinder</span>
00313       } <span class="comment">// point is between the detectors</span>
00314     } <span class="comment">// loop through 2 solutions of the quadratic</span>
00315   } <span class="comment">// real solution to the quadratic</span>
00316   <span class="comment">// Now see how many interesection points we have</span>
00317   <span class="comment">// if 0, return false - line does not touch the cylinder</span>
00318   <span class="comment">// if 1, it just touches one edge of the cylinder - skip this LOR</span>
00319   <span class="keywordflow">if</span> (itval &lt; 2) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00320   <span class="comment">// sort the tvalues to be in increasing order</span>
00321   <span class="keywordflow">for</span> (ii=0; ii&lt;itval-1; ii++)   {
00322     <span class="keywordflow">for</span> (jj=ii+1; jj&lt;itval; jj++){
00323       <span class="keywordflow">if</span> (tval[jj] &lt; tval[ii]) {
00324         t=tval[jj];
00325         tval[jj]=tval[ii];
00326         tval[ii]=t;
00327       }
00328     }
00329   }
00330   <span class="comment">// Ideally we now have 2 intersection points</span>
00331   <span class="comment">// It is theoretically possible to get  3 or 4, </span>
00332   <span class="comment">// with slight rounding problems</span>
00333   <span class="comment">// when the LOR just touches the edges of the cylinder</span>
00334   <span class="keywordflow">while</span> (itval &gt; 2) {
00335     <span class="comment">// in this case, 2 of the tval values should be very close.</span>
00336     <span class="comment">// Find the smallest difference</span>
00337     <span class="comment">// and replace them with the average of the 2 values</span>
00338     <span class="comment">// if this difference is &gt; .001, then there is probably a </span>
00339     <span class="comment">// logic error here</span>
00340     tdiff=1.0;
00341     <span class="keywordflow">for</span> (jj=1; jj&lt;itval; jj++){
00342       <span class="keywordflow">if</span> (tval[jj] - tval[jj-1] &lt; tdiff) {
00343         tdiff=tval[jj] - tval[jj-1];
00344         ii=jj;  <span class="comment">// remember which pair</span>
00345       }
00346     }   <span class="comment">//end of search for min difference</span>
00347     <span class="keywordflow">if</span> (tdiff &gt; 0.001){
00348       printf( <span class="stringliteral">"\ndetermineLORcoordinates: Logic error. tdiff too large: %f \n"</span>,tdiff );
00349       printf(<span class="stringliteral">"\n Event coordonates: %f  %f %f  %f %f %f\n"</span>,
00350              event.<a class="code" href="classEventPacket.html#o12">x1</a>,event.<a class="code" href="classEventPacket.html#o13">y1</a>,event.<a class="code" href="classEventPacket.html#o14">z1</a>,event.<a class="code" href="classEventPacket.html#o15">x2</a>,event.<a class="code" href="classEventPacket.html#o16">y2</a>,event.<a class="code" href="classEventPacket.html#o17">z2</a>);
00351       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00352     }
00353     <span class="comment">// average ii and ii-1</span>
00354     tval[ii-1]=0.5*(tval[ii]+tval[ii-1]);
00355     <span class="comment">// slide the rest down</span>
00356     <span class="keywordflow">for</span> (jj=ii; jj &lt; itval; jj++){
00357       tval[jj] = tval[jj+1];
00358     }
00359     itval--;
00360   }     <span class="comment">// more than 2 intersection points</span>
00361         
00362         <span class="comment">// Now we have 2 intersection points</span>
00363   <span class="comment">// Calculate their x,y,z .</span>
00364   <span class="comment">// We already sorted the order of these values earlier so,</span>
00365   <span class="comment">// if x is the primary index x1&lt; xA &lt; xB &lt; x2</span>
00366   <span class="comment">// If y is the primary index y1&lt;yA&lt;yB&lt;y2</span>
00367   xA=x1+tval[0]*(x2-x1);
00368   xB=x1+tval[1]*(x2-x1);
00369   yA=y1+tval[0]*(y2-y1);
00370   yB=y1+tval[1]*(y2-y1);
00371   zA=z1+tval[0]*(z2-z1);
00372   zB=z1+tval[1]*(z2-z1);
00373   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00374     cout&lt;&lt;<span class="stringliteral">"x1 : "</span>&lt;&lt;x1&lt;&lt;<span class="stringliteral">", y1 : "</span>&lt;&lt;y1&lt;&lt;<span class="stringliteral">", z1 : "</span>&lt;&lt;z1&lt;&lt;endl;
00375     cout&lt;&lt;<span class="stringliteral">"x2 : "</span>&lt;&lt;x2&lt;&lt;<span class="stringliteral">", y2 : "</span>&lt;&lt;y2&lt;&lt;<span class="stringliteral">", z2 : "</span>&lt;&lt;z2&lt;&lt;endl;
00376     cout&lt;&lt;<span class="stringliteral">"xA : "</span>&lt;&lt;xA&lt;&lt;<span class="stringliteral">", yA : "</span>&lt;&lt;yA&lt;&lt;<span class="stringliteral">", zA : "</span>&lt;&lt;zA&lt;&lt;endl;
00377     cout&lt;&lt;<span class="stringliteral">"xB : "</span>&lt;&lt;xB&lt;&lt;<span class="stringliteral">", yB : "</span>&lt;&lt;yB&lt;&lt;<span class="stringliteral">", zB : "</span>&lt;&lt;zB&lt;&lt;endl;
00378   }
00379   <span class="comment">// fill in the event packet</span>
00380   <span class="keywordtype">float</span> sStop2, zStop2;
00381   <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o22">sinphi</a> &gt; Constant::SIN45) {
00382     <span class="comment">// primary direction is x</span>
00383     <span class="comment">// round xA and xB out to integers</span>
00384     <span class="comment">//event.jstart= (short) (xA);</span>
00385     <span class="comment">//event.jstop= (short) (xB+0.99);</span>
00386     event.<a class="code" href="classEventPacket.html#o0">jstart</a>= (<span class="keywordtype">short</span>) Utilities::Floor(xA);<span class="comment">//nint testing</span>
00387     <span class="comment">//event.jstart = (short) xA;</span>
00388     event.<a class="code" href="classEventPacket.html#o1">jstop</a>= (<span class="keywordtype">short</span>) Utilities::Floor(xB+0.99);
00389     <span class="comment">// recompute the y and z values at the new starting point</span>
00390     <span class="comment">//due to floor effect, jstart sometimes &lt; 0, we need correct it </span>
00391     <span class="keywordflow">while</span>(event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;0) event.<a class="code" href="classEventPacket.html#o0">jstart</a>++;
00392     t=(event.<a class="code" href="classEventPacket.html#o0">jstart</a>-x1)/(x2-x1);
00393     event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>=y1+t*(y2-y1);
00394     event.<a class="code" href="classEventPacket.html#o3">zStart</a>=z1+t*(z2-z1);
00395     <span class="comment">// step in y and z with respect to x</span>
00396     event.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>= (y2-y1)/(x2-x1);
00397     event.<a class="code" href="classEventPacket.html#o5">zStep</a>=(z2-z1)/(x2-x1);
00398     event.<a class="code" href="classEventPacket.html#o28">jmid</a> = (x1+x2)/2.0;
00399     t = (event.<a class="code" href="classEventPacket.html#o1">jstop</a> - x1)/(x2-x1);
00400     sStop2 = y1+t*(y2-y1);
00401     zStop2 = z1+t*(z2-z1);
00402   }
00403   <span class="keywordflow">else</span> {
00404     <span class="comment">// primary direction is y</span>
00405     <span class="comment">// round yA and yB out to integers</span>
00406     <span class="comment">//event.jstart= (short) (yA);</span>
00407     <span class="comment">//event.jstop= (short) (yB+0.99);</span>
00408     event.<a class="code" href="classEventPacket.html#o0">jstart</a> = (<span class="keywordtype">short</span>)Utilities::Floor(yA);<span class="comment">//nint test</span>
00409     <span class="comment">//event.jstart = (short) yA;</span>
00410     event.<a class="code" href="classEventPacket.html#o1">jstop</a> = (<span class="keywordtype">short</span>)Utilities::Floor(yB+.99);
00411     <span class="comment">// recompute the x and z values at the new starting point</span>
00412     <span class="comment">//due to floor effect, jstart sometimes &lt; 0, we need correct it </span>
00413     <span class="keywordflow">while</span>(event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;0) event.<a class="code" href="classEventPacket.html#o0">jstart</a>++;
00414     t=(event.<a class="code" href="classEventPacket.html#o0">jstart</a>-y1)/(y2-y1);
00415     event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>=x1+t*(x2-x1);
00416     event.<a class="code" href="classEventPacket.html#o3">zStart</a>=z1+t*(z2-z1);
00417     <span class="comment">// step in x and z with respect to y</span>
00418     event.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>= (x2-x1)/(y2-y1);
00419     event.<a class="code" href="classEventPacket.html#o5">zStep</a>=(z2-z1)/(y2-y1);
00420     event.<a class="code" href="classEventPacket.html#o28">jmid</a> = (y1+y2)/2.0;    
00421     t = (event.<a class="code" href="classEventPacket.html#o1">jstop</a> - y1)/(y2-y1);
00422     sStop2 = x1+t*(x2-x1);
00423     zStop2 = z1+t*(z2-z1);
00424 
00425   }
00426   
00427   <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o1">jstop</a>&gt;g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1)debugData.numjStop++;
00428   <span class="keywordflow">while</span>((event.<a class="code" href="classEventPacket.html#o1">jstop</a>) &gt;g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1) {
00429     event.<a class="code" href="classEventPacket.html#o1">jstop</a> --;
00430     debugData.totalNumjStop++;
00431   }
00432 
00433   
00434   <span class="comment">//check for coordinate</span>
00435   <span class="keywordflow">if</span>(numReported&lt;=200 &amp;&amp; params-&gt;frame.verbosity &gt;= 
00436      Constant::PROBCOORDINATE){
00437     numReported ++;
00438     <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o22">sinphi</a>&gt;Constant::SIN45){
00439       cout&lt;&lt;<span class="stringliteral">"X is primary direction"</span>&lt;&lt;endl;
00440       cout&lt;&lt;<span class="stringliteral">"event.jstart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;&lt;endl;
00441       cout&lt;&lt;<span class="stringliteral">"event.secondaryStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>&lt;&lt;
00442         <span class="stringliteral">", yA : "</span>&lt;&lt;yA&lt;&lt;endl;
00443       cout&lt;&lt;<span class="stringliteral">"  event.zStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o3">zStart</a>&lt;&lt;<span class="stringliteral">", zA : "</span>&lt;&lt;zA&lt;&lt;endl;
00444       cout&lt;&lt;<span class="stringliteral">"  event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl;
00445       cout&lt;&lt;<span class="stringliteral">"  event.x1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;<span class="stringliteral">" event.x2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;endl;
00446       cout&lt;&lt;<span class="stringliteral">"  event.y1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;<span class="stringliteral">" event.y2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;endl;
00447       cout&lt;&lt;<span class="stringliteral">"  event.z1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;<span class="stringliteral">" event.z2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00448       cout&lt;&lt;<span class="stringliteral">"  xA : "</span>&lt;&lt;xA&lt;&lt;<span class="stringliteral">" xB : "</span>&lt;&lt;xB&lt;&lt;endl;
00449       cout&lt;&lt;<span class="stringliteral">"  tval[0] : "</span>&lt;&lt;tval[0]&lt;&lt;<span class="stringliteral">" tavl[1] : "</span>&lt;&lt;tval[1]&lt;&lt;endl&lt;&lt;endl;
00450     }
00451     <span class="keywordflow">else</span>{
00452       cout&lt;&lt;<span class="stringliteral">"Y is primary direction"</span>&lt;&lt;endl;
00453       cout&lt;&lt;<span class="stringliteral">"event.jstart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;&lt;endl;
00454       cout&lt;&lt;<span class="stringliteral">"event.secondaryStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>&lt;&lt;
00455         <span class="stringliteral">", xA : "</span>&lt;&lt;xA&lt;&lt;endl;
00456       cout&lt;&lt;<span class="stringliteral">"  event.zStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o3">zStart</a>&lt;&lt;<span class="stringliteral">", zA : "</span>&lt;&lt;zA&lt;&lt;endl;
00457       cout&lt;&lt;<span class="stringliteral">"  event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl;
00458       cout&lt;&lt;<span class="stringliteral">"  event.x1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;<span class="stringliteral">" event.x2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;endl;
00459       cout&lt;&lt;<span class="stringliteral">"  event.y1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;<span class="stringliteral">" event.y2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;endl;
00460       cout&lt;&lt;<span class="stringliteral">"  event.z1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;<span class="stringliteral">" event.z2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00461       cout&lt;&lt;<span class="stringliteral">"  yA : "</span>&lt;&lt;yA&lt;&lt;<span class="stringliteral">" yB : "</span>&lt;&lt;yB&lt;&lt;endl;
00462       cout&lt;&lt;<span class="stringliteral">"  tval[0] : "</span>&lt;&lt;tval[0]&lt;&lt;<span class="stringliteral">" tavl[1] : "</span>&lt;&lt;tval[1]
00463           &lt;&lt;endl&lt;&lt;endl;
00464     }
00465   }
00466   <span class="keywordflow">else</span>{ 
00467     <span class="keywordflow">if</span>(numReported&gt;200  &amp;&amp; params-&gt;frame.verbosity &gt;= 
00468        Constant::PROBCOORDINATE)    
00469       MPI::COMM_WORLD.Abort(-1);
00470   }
00471 
00472   <span class="comment">//check the if secondary start out of boundary, </span>
00473   <span class="comment">//the reason to do this is that</span>
00474   <span class="comment">//will caused segment fault in fwdprojection</span>
00475   <span class="keywordflow">while</span>(((Utilities::Floor(event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>)&lt;0)||
00476          (Utilities::Floor(event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>)&gt;g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1)) &amp;&amp; 
00477         event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;=event.<a class="code" href="classEventPacket.html#o1">jstop</a>){
00478     event.<a class="code" href="classEventPacket.html#o0">jstart</a>++;
00479     
00480     <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o22">sinphi</a> &gt; Constant::SIN45) {
00481       t=(event.<a class="code" href="classEventPacket.html#o0">jstart</a>-x1)/(x2-x1);
00482       event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>=y1+t*(y2-y1);
00483       event.<a class="code" href="classEventPacket.html#o3">zStart</a>=z1+t*(z2-z1);
00484     }
00485     <span class="keywordflow">else</span> {
00486       t=(event.<a class="code" href="classEventPacket.html#o0">jstart</a>-y1)/(y2-y1);
00487       event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>=x1+t*(x2-x1);
00488       event.<a class="code" href="classEventPacket.html#o3">zStart</a>=z1+t*(z2-z1);
00489     }
00490   }
00491   
00492   <span class="comment">//check the if the z start out of boundary, </span>
00493   <span class="comment">//the reason to do this is that</span>
00494   <span class="comment">//will caused segment fault in fwdprojection</span>
00495   <span class="keywordflow">while</span>(((Utilities::Floor(event.<a class="code" href="classEventPacket.html#o3">zStart</a>)&lt;0)||
00496          (Utilities::Floor(event.<a class="code" href="classEventPacket.html#o3">zStart</a>)&gt;g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>-1))&amp;&amp; 
00497         event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;=event.<a class="code" href="classEventPacket.html#o1">jstop</a>){
00498     event.<a class="code" href="classEventPacket.html#o0">jstart</a>++;
00499     <span class="keywordflow">if</span> (event.<a class="code" href="classEventPacket.html#o22">sinphi</a> &gt; Constant::SIN45) {
00500       t=(event.<a class="code" href="classEventPacket.html#o0">jstart</a>-x1)/(x2-x1);
00501       event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>=y1+t*(y2-y1);
00502       event.<a class="code" href="classEventPacket.html#o3">zStart</a>=z1+t*(z2-z1);
00503     }
00504     <span class="keywordflow">else</span> {
00505       t=(event.<a class="code" href="classEventPacket.html#o0">jstart</a>-y1)/(y2-y1);
00506       event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>=x1+t*(x2-x1);
00507       event.<a class="code" href="classEventPacket.html#o3">zStart</a>=z1+t*(z2-z1);
00508     }
00509   }
00510   
00511   <span class="comment">//check the if secondary stop and z stop out of boundary, </span>
00512   <span class="comment">//the reason to do this is that</span>
00513   <span class="comment">//will caused segment fault in fwdprojection</span>
00514   <span class="keywordtype">float</span> sStop = (event.<a class="code" href="classEventPacket.html#o1">jstop</a>-event.<a class="code" href="classEventPacket.html#o0">jstart</a>+1)*
00515     event.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>+event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>;
00516   <span class="keywordtype">float</span> zStop = (event.<a class="code" href="classEventPacket.html#o1">jstop</a>-event.<a class="code" href="classEventPacket.html#o0">jstart</a>+1)*event.<a class="code" href="classEventPacket.html#o5">zStep</a>+event.<a class="code" href="classEventPacket.html#o3">zStart</a>;
00517 
00518   <span class="keywordflow">while</span>(((Utilities::Floor(sStop) &gt; g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1)||
00519          (Utilities::Floor(sStop)&lt;0))&amp;&amp; event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;=event.<a class="code" href="classEventPacket.html#o1">jstop</a>){
00520     event.<a class="code" href="classEventPacket.html#o1">jstop</a>--;
00521     sStop = (event.<a class="code" href="classEventPacket.html#o1">jstop</a>-event.<a class="code" href="classEventPacket.html#o0">jstart</a>+1)*event.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>+
00522       event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>;
00523   }
00524 
00525   <span class="keywordflow">while</span>(((Utilities::Floor(zStop) &gt; g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>-1)||
00526          (Utilities::Floor(zStop)&lt;0)) &amp;&amp; event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;=event.<a class="code" href="classEventPacket.html#o1">jstop</a>){
00527     event.<a class="code" href="classEventPacket.html#o1">jstop</a>--;
00528     zStop = (event.<a class="code" href="classEventPacket.html#o1">jstop</a>-event.<a class="code" href="classEventPacket.html#o0">jstart</a>+1)*event.<a class="code" href="classEventPacket.html#o5">zStep</a>+event.<a class="code" href="classEventPacket.html#o3">zStart</a>;    
00529   }
00530 
00531   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5){
00532     <span class="keywordflow">if</span>(Utilities::Floor(sStop)&gt;g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1){
00533       numReported++;
00534       <span class="keywordflow">if</span>((numReported&lt;300)&amp;&amp;(params-&gt;frame.verbosity&gt;=5)){
00535         cout&lt;&lt;<span class="stringliteral">"event.secondaryStop : "</span>&lt;&lt;sStop;
00536         cout&lt;&lt;<span class="stringliteral">"   secondary stop 2 : "</span>&lt;&lt;sStop2;
00537         cout&lt;&lt;<span class="stringliteral">"   event.jstart "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>;
00538         cout&lt;&lt;<span class="stringliteral">"   event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl&lt;&lt;endl;
00539       }
00540       debugData.nsStop++;
00541   }
00542     
00543     <span class="keywordflow">if</span>(Utilities::Floor(zStop)&gt;g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>-1){
00544       numReported++;
00545       <span class="keywordflow">if</span>((numReported&lt;300)&amp;&amp;(params-&gt;frame.verbosity&gt;=5)){
00546         cout&lt;&lt;<span class="stringliteral">"event.zStop : "</span>&lt;&lt;zStop&lt;&lt;endl;
00547         cout&lt;&lt;<span class="stringliteral">" z stop 2 : "</span>&lt;&lt;zStop2&lt;&lt;endl;
00548         cout&lt;&lt;<span class="stringliteral">"event.jstart "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>;
00549         cout&lt;&lt;<span class="stringliteral">" event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl&lt;&lt;endl;
00550       }
00551       debugData.nzStop++;
00552     }
00553   
00554     <span class="keywordflow">if</span>(Utilities::Floor(sStop)&lt;0)
00555       debugData.nsStop2++;
00556     <span class="keywordflow">if</span>(Utilities::Floor(zStop)&lt;0)
00557       debugData.nzStop2++;
00558     <span class="keywordflow">if</span>(Utilities::Floor(event.<a class="code" href="classEventPacket.html#o3">zStart</a>)&gt;g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>-1)
00559       debugData.nzStart2++;
00560     <span class="keywordflow">if</span>(Utilities::Floor(event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>)&gt;g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1)
00561       debugData.nsStart2++;
00562     
00563     <span class="keywordflow">if</span>(Utilities::Floor(event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>)&lt;0 ){
00564       numReported++;
00565       <span class="keywordflow">if</span>((numReported&lt;300)&amp;&amp;(params-&gt;frame.verbosity&gt;=5)){
00566         cout&lt;&lt;<span class="stringliteral">"event.seondaryStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>&lt;&lt;endl;
00567         cout&lt;&lt;<span class="stringliteral">"event.jstart "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>;
00568         cout&lt;&lt;<span class="stringliteral">" event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl&lt;&lt;endl;
00569       }
00570       debugData.sStartMin = min(debugData.sStartMin, event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>);
00571       debugData.sStartMax = max(debugData.sStartMax, event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>);
00572       debugData.sStartAvg += event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>;
00573       debugData.nsStart++;
00574     }
00575     
00576     
00577     <span class="keywordflow">if</span>(Utilities::Floor(event.<a class="code" href="classEventPacket.html#o3">zStart</a>)&lt;0 ){
00578       numReported++;
00579       <span class="keywordflow">if</span>((numReported&lt;300)&amp;&amp;(params-&gt;frame.verbosity&gt;=5)){
00580         cout&lt;&lt;<span class="stringliteral">"event.zStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o3">zStart</a>;
00581         cout&lt;&lt;<span class="stringliteral">"  event.jstart "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>;
00582         cout&lt;&lt;<span class="stringliteral">"  event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl&lt;&lt;endl;
00583       }
00584       debugData.nzStart++;
00585       debugData.zStartMin = min(debugData.zStartMin, event.<a class="code" href="classEventPacket.html#o3">zStart</a>);
00586       debugData.zStartMax = max(debugData.zStartMax, event.<a class="code" href="classEventPacket.html#o3">zStart</a>);
00587       debugData.zStartAvg += event.<a class="code" href="classEventPacket.html#o3">zStart</a>;
00588     }
00589     <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;0 ){
00590       <span class="keywordflow">if</span>((params-&gt;frame.verbosity&gt;=5)){
00591         <span class="keywordflow">if</span>(event.<a class="code" href="classEventPacket.html#o22">sinphi</a>&gt;Constant::SIN45){
00592           cout&lt;&lt;<span class="stringliteral">" X is primary direction : "</span>;
00593           cout&lt;&lt;<span class="stringliteral">"  event.jstart "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>;
00594           cout&lt;&lt;<span class="stringliteral">"  event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl&lt;&lt;endl;
00595           cout&lt;&lt;<span class="stringliteral">"  event.x1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;<span class="stringliteral">" event.x2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;endl;
00596           cout&lt;&lt;<span class="stringliteral">"  event.y1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;<span class="stringliteral">" event.y2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;endl;
00597           cout&lt;&lt;<span class="stringliteral">"  event.z1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;<span class="stringliteral">" event.z2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00598           cout&lt;&lt;<span class="stringliteral">"  xA : "</span>&lt;&lt;xA&lt;&lt;<span class="stringliteral">" xB : "</span>&lt;&lt;xB&lt;&lt;endl;
00599           cout&lt;&lt;<span class="stringliteral">"  tval[0] : "</span>&lt;&lt;tval[0]&lt;&lt;<span class="stringliteral">" tavl[1] : "</span>&lt;&lt;tval[1]&lt;&lt;endl;
00600         }
00601         <span class="keywordflow">else</span>{
00602           cout&lt;&lt;<span class="stringliteral">" Y is primary direction : "</span>;
00603           cout&lt;&lt;<span class="stringliteral">"  event.jstart "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>;
00604           cout&lt;&lt;<span class="stringliteral">"  event.jstop "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl&lt;&lt;endl;
00605           cout&lt;&lt;<span class="stringliteral">"  event.x1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;<span class="stringliteral">" event.x2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;endl;
00606           cout&lt;&lt;<span class="stringliteral">"  event.y1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;<span class="stringliteral">" event.y2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;endl;
00607           cout&lt;&lt;<span class="stringliteral">"  event.z1 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;<span class="stringliteral">" event.z2 : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00608           cout&lt;&lt;<span class="stringliteral">"  yA : "</span>&lt;&lt;yA&lt;&lt;<span class="stringliteral">" yB : "</span>&lt;&lt;yB&lt;&lt;endl;
00609           cout&lt;&lt;<span class="stringliteral">"  tval[0] : "</span>&lt;&lt;tval[0]&lt;&lt;<span class="stringliteral">" tavl[1] : "</span>&lt;&lt;tval[1]&lt;&lt;endl;
00610         }
00611         
00612       }
00613       debugData.njStart++;
00614     }
00615 
00616     <span class="keywordflow">if</span>((Utilities::Floor(event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>) &gt;=0 &amp;&amp; 
00617         Utilities::Floor(event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>)&lt;=g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1) &amp;&amp;
00618        (Utilities::Floor(sStop) &gt;=0 &amp;&amp; Utilities::Floor(sStop)&lt;=g.<a class="code" href="structParams_1_1Geometry.html#o0">nX</a>-1) 
00619        &amp;&amp;(Utilities::Floor(event.<a class="code" href="classEventPacket.html#o3">zStart</a>)&gt;=0 &amp;&amp; 
00620           Utilities::Floor(event.<a class="code" href="classEventPacket.html#o3">zStart</a>)&lt;=g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>-1)
00621        &amp;&amp;(Utilities::Floor(zStop)&gt;=0 &amp;&amp; Utilities::Floor(zStop)&lt;=g.<a class="code" href="structParams_1_1Geometry.html#o2">nZ</a>-1))
00622       debugData.nonVio ++;
00623     <span class="comment">//cout&lt;&lt;endl;</span>
00624     
00625     <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00626       cout&lt;&lt;<span class="stringliteral">"event.jstart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o0">jstart</a>&lt;&lt;<span class="stringliteral">", event.jstop : "</span>
00627           &lt;&lt;event.<a class="code" href="classEventPacket.html#o1">jstop</a>&lt;&lt;endl;
00628       cout&lt;&lt;<span class="stringliteral">"event.secondaryStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o2">secondaryStart</a>
00629           &lt;&lt;<span class="stringliteral">", event.zStart : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o3">zStart</a>&lt;&lt;endl;
00630       cout&lt;&lt;<span class="stringliteral">"event.secondaryStep : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o4">secondaryStep</a>
00631           &lt;&lt;<span class="stringliteral">", event.zStep : "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o5">zStep</a>&lt;&lt;endl;
00632     }
00633   }
00634   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00635 }
00636 
00642 <span class="keywordtype">void</span> HRRTHouseEvent::getEventCoordinates(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e1, 
00643                          <span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e2,
00644                          <a class="code" href="classEventPacket.html">EventPacket</a> &amp;event)
00645 {
00646   <span class="comment">//coordinates</span>
00647   event.<a class="code" href="classEventPacket.html#o12">x1</a> = houseNorm-&gt;xd(e1.<a class="code" href="structCrystalID.html#o0">dtct</a>,e1.<a class="code" href="structCrystalID.html#o3">layer</a>,e1.<a class="code" href="structCrystalID.html#o2">bank</a>);
00648   event.<a class="code" href="classEventPacket.html#o15">x2</a> = houseNorm-&gt;xd(e2.<a class="code" href="structCrystalID.html#o0">dtct</a>,e2.<a class="code" href="structCrystalID.html#o3">layer</a>,e2.<a class="code" href="structCrystalID.html#o2">bank</a>);
00649   event.<a class="code" href="classEventPacket.html#o13">y1</a> = houseNorm-&gt;yd(e1.<a class="code" href="structCrystalID.html#o0">dtct</a>,e1.<a class="code" href="structCrystalID.html#o3">layer</a>,e1.<a class="code" href="structCrystalID.html#o2">bank</a>);
00650   event.<a class="code" href="classEventPacket.html#o16">y2</a> = houseNorm-&gt;yd(e2.<a class="code" href="structCrystalID.html#o0">dtct</a>,e2.<a class="code" href="structCrystalID.html#o3">layer</a>,e2.<a class="code" href="structCrystalID.html#o2">bank</a>);
00651   event.<a class="code" href="classEventPacket.html#o14">z1</a> = houseNorm-&gt;zd(e1.<a class="code" href="structCrystalID.html#o1">ring</a>);
00652   event.<a class="code" href="classEventPacket.html#o17">z2</a> = houseNorm-&gt;zd(e2.<a class="code" href="structCrystalID.html#o1">ring</a>);
00653 }
00654 <span class="comment">//----------------------------------------------------------------------</span>
00655 <span class="comment">//NAME</span>
00656 <span class="comment">//              calculateEventParams</span>
00657 <span class="comment">//DESCRIPTION</span>
00658 <span class="comment">//              Calculate the parameters of the struct EventPacket event</span>
00659 <span class="comment">//INPUT</span>
00660 <span class="comment">//              CrystalID e1, CrytalID e2, from readListMode(), </span>
00661 <span class="comment">//                 or getReandomizedEvent()</span>
00662 <span class="comment">//              4th argument t is 0 for listmode and 1 for randomized mode</span>
00663 <span class="comment">//OUTPUT</span>
00664 <span class="comment">//              EventPacket event, all parameters of the event are </span>
00665 <span class="comment">//             set in this function</span>
00666 <span class="comment">//----------------------------------------------------------------------</span>
00667 <span class="keywordtype">bool</span> HRRTHouseEvent::calculateEventParams(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e1, 
00668                                           <span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e2, 
00669                                           <a class="code" href="classEventPacket.html">EventPacket</a> &amp; event, <span class="keywordtype">int</span> t)
00670 {
00671   <span class="keywordtype">bool</span> flagAccept = <span class="keyword">false</span>;
00672 
00673   <span class="comment">//index check</span>
00674   flagAccept = (e1.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>) &amp;&amp; (e1.<a class="code" href="structCrystalID.html#o3">layer</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>) &amp;&amp;
00675     (e1.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>) &amp;&amp; (e1.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>) &amp;&amp;
00676     (e2.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>) &amp;&amp; (e2.<a class="code" href="structCrystalID.html#o3">layer</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>) &amp;&amp;
00677     (e2.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>) &amp;&amp; (e2.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>);
00678   <span class="keywordflow">if</span>(!flagAccept)    {
00679     cout&lt;&lt;<span class="stringliteral">"Index error...("</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o3">layer</a>&lt;&lt;<span class="stringliteral">","</span>
00680         &lt;&lt;e1.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;<span class="stringliteral">")"</span>;
00681     cout&lt;&lt;<span class="stringliteral">" out of range ("</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>
00682         &lt;&lt;<span class="stringliteral">","</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>&lt;&lt;<span class="stringliteral">")"</span>;
00683     cout&lt;&lt;endl&lt;&lt;<span class="stringliteral">"or "</span>&lt;&lt;endl;
00684     cout&lt;&lt;<span class="stringliteral">"Index error...("</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o3">layer</a>&lt;&lt;<span class="stringliteral">","</span>
00685         &lt;&lt;e2.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;<span class="stringliteral">")"</span>;
00686     cout&lt;&lt;<span class="stringliteral">" out of range ("</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>
00687         &lt;&lt;<span class="stringliteral">","</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>&lt;&lt;<span class="stringliteral">")"</span>;
00688     cout&lt;&lt;endl;
00689     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00690   }
00691   <span class="comment">//the getEventCoordinates is seperated out</span>
00692   <span class="comment">//since the scatter correction need it</span>
00693   getEventCoordinates(e1, e2, event);
00694   event.<a class="code" href="classEventPacket.html#o19">numEvents</a> = 1;
00695   event.<a class="code" href="classEventPacket.html#o20">timeStamp</a> = houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag;
00696   <span class="comment">//motion correction</span>
00697   <span class="keywordflow">if</span>(params-&gt;motionCorrection.enable){
00698     <span class="keywordtype">float</span> errorEstimate;
00699     <span class="keywordflow">if</span>(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r8">motion</a>-&gt;<a class="code" href="classMotionCorrection.html#a2">transform</a>(event, errorEstimate)==-1){
00700       string msg =<span class="stringliteral">"Error in motion correction transformation"</span>;
00701       <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00702       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::MOTIONCORRECTIONERROR);
00703     }
00704   }
00705     
00706   flagAccept = determineLORcoordinates(event);
00707   <span class="keywordflow">if</span>(!flagAccept){ <span class="comment">//if fails, write to log file, and return directly</span>
00708     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00709   }
00710   event.<a class="code" href="classEventPacket.html#o26">crystalNumber1</a> = 
00711     getCrystalNumber(e1.<a class="code" href="structCrystalID.html#o0">dtct</a>, e1.<a class="code" href="structCrystalID.html#o3">layer</a>, e1.<a class="code" href="structCrystalID.html#o2">bank</a>, e1.<a class="code" href="structCrystalID.html#o1">ring</a>);
00712   <span class="comment">//ID number of detector1</span>
00713   event.<a class="code" href="classEventPacket.html#o27">crystalNumber2</a> = 
00714     getCrystalNumber(e2.<a class="code" href="structCrystalID.html#o0">dtct</a>, e2.<a class="code" href="structCrystalID.html#o3">layer</a>, e2.<a class="code" href="structCrystalID.html#o2">bank</a>, e2.<a class="code" href="structCrystalID.html#o1">ring</a>);
00715   <span class="comment">//ID number of detector2</span>
00716   <span class="comment">//calculate the index of this event into resolution functions</span>
00717   event.<a class="code" href="classEventPacket.html#o6">resModelCodeR</a> = houseResolution-&gt;getResFunRIndex(e1,e2);
00718   event.<a class="code" href="classEventPacket.html#o7">resModelCodeZ</a> = houseResolution-&gt;getResFunZIndex(e1,e2);
00719    <span class="comment">//fill in the hrrt event packet</span>
00720   event.<a class="code" href="classEventPacket.html#o10">atten</a>=1;
00721   event.<a class="code" href="classEventPacket.html#o21">CijNorm</a> = 1;
00722   event.<a class="code" href="classEventPacket.html#o11">scatter</a> = 0;
00723   <span class="comment">//random factor</span>
00724   <span class="keywordflow">if</span>(params-&gt;randoms.enable)
00725     event.<a class="code" href="classEventPacket.html#o8">rand</a> =houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#d7">getRandoms</a>(e1, e2); <span class="comment">//random factor</span>
00726   <span class="keywordflow">else</span>
00727     event.<a class="code" href="classEventPacket.html#o8">rand</a> = 0;
00728   event.<a class="code" href="classEventPacket.html#o25">livetime_decay</a> = houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#d3">getDecayFctr</a>();
00729   houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nDecayFactor += houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#d3">getDecayFctr</a>();
00730 
00731   <span class="keywordflow">if</span>(params-&gt;frame.positronFraction&gt;0)
00732     event.<a class="code" href="classEventPacket.html#o25">livetime_decay</a> *= params-&gt;frame.positronFraction;
00733   <span class="keywordflow">if</span>(params-&gt;randoms.deadTimeCorrection ==1) {
00734     <span class="comment">//living time factor</span>
00735     <span class="keywordtype">float</span> lfctr = houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#d2">getLiveTime</a>(e1, e2);
00736     event.<a class="code" href="classEventPacket.html#o25">livetime_decay</a> *=  lfctr ;
00737     houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nLiveTimeFactor += lfctr;
00738 
00739     <span class="keywordflow">if</span>(params-&gt;randoms.verbosity&gt;=5){
00740       <span class="keywordflow">if</span>(e1.<a class="code" href="structCrystalID.html#o9">block</a> == 100) {
00741         cout&lt;&lt;<span class="stringliteral">"LLD:"</span>&lt;&lt;params-&gt;modelBasedScatter.reconLLD&lt;&lt;<span class="stringliteral">" p0,p1,p2"</span>&lt;&lt;
00742           scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o13">liveTimeParam0</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o14">liveTimeParam1</a>&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;
00743           scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o15">liveTimeParam2</a>&lt;&lt;endl;
00744         cout&lt;&lt;<span class="stringliteral">" rates "</span>&lt;&lt;houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>(e1.<a class="code" href="structCrystalID.html#o9">block</a>)&lt;&lt;<span class="stringliteral">" "</span>
00745             &lt;&lt;houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>(e2.<a class="code" href="structCrystalID.html#o9">block</a>)&lt;&lt;endl;      
00746         cout&lt;&lt;<span class="stringliteral">" Block 100 event livetime fraction "</span>&lt;&lt;lfctr&lt;&lt;endl;
00747       }
00748     }
00749   }
00750   houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nLiveTime_Decay +=  event.<a class="code" href="classEventPacket.html#o25">livetime_decay</a>;
00751   
00752   <span class="keywordtype">float</span> eventweight [] = {0.4444,1.3333,4};  
00753   <span class="comment">// weighting events depending on the layer combination</span>
00754   <span class="comment">// These are used to correct for the oversampling in the randomization</span>
00755   <span class="comment">// They scale the sampling fraction down to 0.25 (i.e., 1/4 of the</span>
00756   <span class="comment">// contribution should be FF, FB, BF, and BB</span>
00757   <span class="comment">// FF was sampled 9/16, so 9/16 * 0.444 = 1/4</span>
00758   <span class="comment">// FB and BF were sampled 3/16, so 3/16 * 1.333 = 1/4</span>
00759   <span class="comment">// BB was sampled 1/16 so 1/16 * 4 = 1/4</span>
00760   <span class="comment">// To avoid creeating a new field, scale the event livetime value which contributes</span>
00761   <span class="comment">// in the Q backprojection</span>
00762   <span class="keywordflow">if</span>(scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o30">nMask</a> == 0  &amp;&amp; t == 1){
00763    event.<a class="code" href="classEventPacket.html#o25">livetime_decay</a> *= eventweight[e1.<a class="code" href="structCrystalID.html#o3">layer</a>+e2.<a class="code" href="structCrystalID.html#o3">layer</a>];
00764   }
00765   <span class="keywordflow">if</span>(params-&gt;normalization.enable){
00766     event.<a class="code" href="classEventPacket.html#o9">norm</a> =  houseNorm-&gt;getNormFctr(e1, e2); <span class="comment">//nomaliztion factor</span>
00767   }
00768   <span class="keywordflow">else</span>
00769     event.<a class="code" href="classEventPacket.html#o9">norm</a> = 1;
00770   event.<a class="code" href="classEventPacket.html#o18">yhat</a> = 0;
00771   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00772     <span class="comment">//ouput to screen</span>
00773     cout &lt;&lt; <span class="stringliteral">"envet.norm: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o9">norm</a>&lt;&lt;endl;
00774     cout &lt;&lt; <span class="stringliteral">"envet.rand: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o8">rand</a>&lt;&lt;endl;
00775     cout &lt;&lt; <span class="stringliteral">"envet.x1: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o12">x1</a>&lt;&lt;endl;
00776     cout &lt;&lt; <span class="stringliteral">"envet.x2: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o15">x2</a>&lt;&lt;endl;
00777     cout &lt;&lt; <span class="stringliteral">"envet.y1: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o13">y1</a>&lt;&lt;endl;
00778     cout &lt;&lt; <span class="stringliteral">"envet.y2: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o16">y2</a>&lt;&lt;endl;
00779     cout &lt;&lt; <span class="stringliteral">"envet.z1: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o14">z1</a>&lt;&lt;endl;
00780     cout &lt;&lt; <span class="stringliteral">"envet.z2: "</span>&lt;&lt;event.<a class="code" href="classEventPacket.html#o17">z2</a>&lt;&lt;endl;
00781     cout &lt;&lt; <span class="stringliteral">"event.resModelCodeR: "</span> &lt;&lt; event.<a class="code" href="classEventPacket.html#o6">resModelCodeR</a>&lt;&lt;endl;
00782     cout &lt;&lt; <span class="stringliteral">"event.resModelCodeZ: "</span> &lt;&lt; event.<a class="code" href="classEventPacket.html#o7">resModelCodeZ</a>&lt;&lt;endl;
00783   }
00784   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00785 
00786 }
00787 
00788 
00789 
00790 
00791 <span class="comment">//-----------------------------------------------------------------------------</span>
00792 <span class="comment">/* - Returns the next event (which could be of real list-mode data or</span>
00793 <span class="comment">   randomized data depending on initialization).  This method is called</span>
00794 <span class="comment">   repeatedly and the events are returned in the same order that they</span>
00795 <span class="comment">   appear in the list file.  Returns null when the end of the list has</span>
00796 <span class="comment">   been reached, i.e., when the end of the list mode file is reached or</span>
00797 <span class="comment">   when the end time of this frame is reached.  The House reads the</span>
00798 <span class="comment">   list-mode file while getNextEvent() calls are made.  It uses an</span>
00799 <span class="comment">   internal buffering system.* * It fills in values for most of the</span>
00800 <span class="comment">   EventPacket. Depending on the parameter set, it calculates the</span>
00801 <span class="comment">   coordinates of the detector pair, applies motion correction,</span>
00802 <span class="comment">   converts to image corrdinates, finds the intersection of this LOR</span>
00803 <span class="comment">   with the FOV and defines sinphi, cosphi, costheta, jstart,jstop,</span>
00804 <span class="comment">   secondaryStart, zStart, secondaryStep, zStep,. It calculates the</span>
00805 <span class="comment">   randoms estimate, rand, the normalization estimate norm, and defines</span>
00806 <span class="comment">   the resolution model codes resModelCodeR and resModelCodeU. It also</span>
00807 <span class="comment">   fills in the LOR information for the scatter correction</span>
00808 <span class="comment">   psi1,psi2,zeta1,zeta. **</span>
00809 <span class="comment">*/</span>
00810 <span class="comment">//--------------------------------------------------------------------------</span>
00811 <a class="code" href="classEventPacket.html">EventPacket</a> HRRTHouseEvent::getNextEvent()
00812 {
00813   <span class="keywordtype">float</span> ff,fb,bf,bb;
00814   <a class="code" href="classEventPacket.html">EventPacket</a> event;
00815   <a class="code" href="structCrystalID.html">CrystalID</a> e1, e2;
00816   <span class="keyword">static</span> <span class="keywordtype">int</span> totalD;
00817   <span class="comment">//total number of detectors</span>
00818   <span class="keyword">static</span> <span class="keywordtype">bool</span> firstCall = <span class="keyword">true</span>;
00819   <span class="keywordflow">if</span>(firstCall){
00820     firstCall = <span class="keyword">false</span>;
00821     totalD = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>*scanner-&gt;
00822     nLayer*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a>*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>-1; 
00823   }
00824   <span class="keywordtype">float</span> nQTimes; <span class="comment">//number of time tag passed</span>
00825   <span class="keywordtype">bool</span> flagAccept = <span class="keyword">false</span>;
00826   <span class="keywordflow">switch</span>(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r4">mode</a>) {
00827   <span class="keywordflow">case</span> HRRTHouseList::ListMode:{<span class="comment">// return list mode event</span>
00828       
00829      <span class="keywordflow">while</span>(!flagAccept) {<span class="comment">//Read till LOR inside the FOV</span>
00830           
00831       <span class="keywordflow">if</span>(!feof(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r6">lun</a>)&amp;&amp; !ferror(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r6">lun</a>) &amp;&amp; 
00832          (houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag&lt;houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.requestedFrameStopTimeTag
00833           || params-&gt;frame.processWholeFile)){
00834         <span class="keywordflow">if</span>(houseList-&gt;<a class="code" href="classHRRTHouseList.html#d5">readListMode</a>(e1,e2)){ <span class="comment">//read listmode file</span>
00835           <span class="comment">//calculate EventPacket event parameters        </span>
00836           flagAccept= calculateEventParams(e1, e2, event, 0);
00837           <span class="keywordflow">if</span> (flagAccept) flagAccept = !houseMask-&gt;maskOut(e1, e2);
00838           <span class="keywordflow">if</span>(flagAccept ){
00839             houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nAccept ++;
00840             <span class="keywordflow">return</span> event;
00841           }
00842           <span class="keywordflow">else</span>
00843             houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nReject ++;
00844         }
00845       }
00846       <span class="keywordflow">else</span> {
00847         <span class="keywordflow">if</span>(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag &gt;= houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.requestedFrameStopTimeTag
00848            &amp;&amp;!params-&gt;frame.processWholeFile)
00849           cout&lt;&lt;<span class="stringliteral">"Duration reached ... "</span>&lt;&lt;endl;
00850         <span class="keywordflow">else</span>
00851           cout&lt;&lt;<span class="stringliteral">"No more events ..."</span>&lt;&lt;endl;
00852         <span class="comment">//adjust time parameters</span>
00853         houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStopTimeTag = houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag;
00854         houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration = (houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStopTimeTag - 
00855                                     houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStartTimeTag);
00856         houseList-&gt;<a class="code" href="classHRRTHouseList.html#d21">outPutStatistics</a>();
00857         fclose(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r6">lun</a>);
00858         <span class="comment">//write frame info file</span>
00859         <a class="code" href="classFrameInfo.html">FrameInfo</a> &amp; frameInfo =* FrameInfo::getInstance();
00860         frameInfo.<a class="code" href="classFrameInfo.html#a1">init</a>();
00861         frameInfo.<a class="code" href="classFrameInfo.html#a0">writeFrameInfo</a>();
00862         <span class="keywordflow">return</span> sentry;
00863       }
00864     }
00865     <span class="keywordflow">break</span>;
00866   }
00867   <span class="keywordflow">case</span> HRRTHouseList::RandListMode: {<span class="comment">//randominzed list mode</span>
00868     <span class="comment">//2002-02-22 rc used to output Q information every 100K events, now every 1M events</span>
00869     <span class="comment">//if((nQ%Constant::VERBFCTR)==0) houseList-&gt;outPutRandomStatistics();</span>
00870     <span class="keywordflow">if</span>((nQ%1000000)==0) houseList-&gt;<a class="code" href="classHRRTHouseList.html#d22">outPutRandomStatistics</a>();
00871     <span class="keywordtype">int</span> nQPerTimeTag = params-&gt;algorithm.n_Q/houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration;
00872     <span class="keywordflow">if</span>(nQPerTimeTag == 0) {
00873       stringstream ss;
00874       ss&lt;&lt;<span class="stringliteral">" Error in process randomized events: too small n_Q specified"</span>
00875         &lt;&lt;<span class="stringliteral">" Please make n_Q greater than "</span>&lt;&lt;houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.duration;
00876       <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(ss.str());
00877       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::INPUTERROR);
00878     }
00879 
00880     <span class="comment">// If we have already generated enough randomized events for the</span>
00881     <span class="comment">// last time stamp, then continue to read the list-mode file and</span>
00882     <span class="comment">// process non-events until the next time stamp is read in</span>
00883     <span class="keywordflow">if</span>( (nQ%nQPerTimeTag)==0 &amp;&amp;
00884         (houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag&lt;houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStopTimeTag)
00885         &amp;&amp;!feof(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r6">lun</a>)) {
00886       <span class="keywordtype">int</span>  errCode = houseList-&gt;<a class="code" href="classHRRTHouseList.html#d18">readRandomizedListMode</a>();
00887       <span class="keywordflow">if</span>(errCode&lt;0){
00888         stringstream ss;
00889         ss&lt;&lt; <span class="stringliteral">"ERROR: Error Code "</span>&lt;&lt;errCode
00890           &lt;&lt; <span class="stringliteral">" has been reported by "</span>
00891           &lt;&lt; <span class="stringliteral">" readRandomizedListMode(), aborting "</span>&lt;&lt;endl;
00892         <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(ss.str());
00893         <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(errCode);
00894       }
00895       
00896        <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5){
00897         cout&lt;&lt;<span class="stringliteral">"time tag is "</span>&lt;&lt;houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag&lt;&lt;endl;
00898       }
00899     }
00900 
00901     <span class="keywordflow">while</span>(!flagAccept){ <span class="comment">//Read till LOR inside the FOV</span>
00902           
00903       <span class="comment">//nQTimes =(float) (time - firstTimeTag+1)/scanner-&gt;timeStampsPerSecond;</span>
00904       <span class="comment">//cout&lt;&lt;nQTimes&lt;&lt;" "&lt;&lt;nQ&lt;&lt;endl;</span>
00905       getRandomizedEvent(totalD, e1, e2); <span class="comment">//get a randomized event</span>
00906       <span class="comment">//calculate EventPacket event parameters</span>
00907       flagAccept = calculateEventParams(e1, e2, event, 1);
00908       <span class="comment">// if doing scatter correction, bin the accepted events</span>
00909       <span class="comment">// 2006-01-20 changed to only bin if accepted</span>
00910       <span class="keywordflow">if</span>(flagAccept &amp;&amp; params-&gt;modelBasedScatter.enable) {
00911           <a class="code" href="classMOLAR.html">MOLAR</a> *molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>(); 
00912           ScatterCorrection *scatterCorrection =
00913              molar-&gt;<a class="code" href="classMOLAR.html#a26">getScatterCorrection</a>();
00914           scatterCorrection-&gt;binRandomizedEvent(event);  
00915       }
00916       <span class="keywordflow">if</span> (flagAccept) flagAccept = !houseMask-&gt;maskOut(e1, e2);
00917       
00918       <span class="keywordflow">if</span>(flagAccept) nQ++; 
00919 
00920        <span class="comment">//count number of randimed events generated</span>
00921       <span class="comment">//if((nQ) &gt;= nQTimes*params-&gt;algorithm.n_Q) { //if enough for a frame</span>
00922       <span class="keywordflow">if</span>((nQ) &gt;= params-&gt;algorithm.n_Q) { <span class="comment">//if enough for a frame</span>
00923         <span class="keywordflow">if</span>(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.thisTimeTag &gt;= 
00924            houseList-&gt;<a class="code" href="classHRRTHouseList.html#r7">time</a>.frameStopTimeTag)
00925           cout&lt;&lt;<span class="stringliteral">"Duration reached ... "</span>&lt;&lt;endl;
00926         <span class="keywordflow">else</span>
00927           cout&lt;&lt;<span class="stringliteral">"No more events ..."</span>&lt;&lt;endl;
00928         houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nAccept ++;
00929 
00930         houseList-&gt;<a class="code" href="classHRRTHouseList.html#d22">outPutRandomStatistics</a>();
00931         fclose(houseList-&gt;<a class="code" href="classHRRTHouseList.html#r6">lun</a>);
00932         <span class="keywordflow">return</span> sentry;
00933       }
00934       <span class="keywordflow">if</span>(flagAccept ) {
00935                  
00936         houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nAccept ++;
00937         <span class="keywordflow">return</span> event;
00938       }
00939       <span class="keywordflow">else</span>
00940         houseList-&gt;<a class="code" href="classHRRTHouseList.html#r5">stat</a>.nReject ++;
00941     }
00942     <a class="code" href="classFrameInfo.html">FrameInfo</a> &amp; frameInfo =* FrameInfo::getInstance();
00943     frameInfo.<a class="code" href="classFrameInfo.html#a1">init</a>();
00944     <span class="keywordflow">break</span>;
00945   }
00946   
00947   }
00948   <span class="comment">//This return is not necessary, just to make compiler happy</span>
00949   <span class="keywordflow">return</span> event;
00950 }
00951 
00952 <span class="comment">//---------------------------------------------------------------------</span>
00953 <span class="comment">//return detector number from:</span>
00954 <span class="comment">// dtct: detector number in transaxle direction in a bank, 0: 71</span>
00955 <span class="comment">// layer: layer number, 0:1</span>
00956 <span class="comment">// bank: bank number, 0:7</span>
00957 <span class="comment">// ring: detector number in axle direction in a bank, 0:103</span>
00958 <span class="comment">//---------------------------------------------------------------------</span>
00959 <span class="keywordtype">int</span> HRRTHouseEvent::getCrystalNumber(<span class="keywordtype">int</span> dtct, <span class="keywordtype">int</span> layer, <span class="keywordtype">int</span> bank, <span class="keywordtype">int</span> ring)
00960 { 
00961   <span class="comment">//static variables only inited once</span>
00962   <span class="keyword">static</span> <span class="keywordtype">int</span> nBank = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>;
00963   <span class="keyword">static</span> <span class="keywordtype">int</span> nLayer = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>;
00964   <span class="keyword">static</span> <span class="keywordtype">int</span> nDtct = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>;
00965   <span class="keyword">static</span> <span class="keywordtype">int</span> ringDenominator = nDtct*nBank*nLayer;
00966   <span class="keyword">static</span> <span class="keywordtype">int</span> layerDenominator = nDtct*nBank;
00967   <span class="keyword">static</span> <span class="keywordtype">int</span> bankDenominator = nDtct;
00968 
00969   <span class="keywordflow">return</span> (ring*ringDenominator +
00970           layer*layerDenominator +
00971           bank*bankDenominator + dtct) ;
00972 }
00973 
00974 
00975 <span class="comment">//---------------------------------------------------------------------</span>
00976 <span class="comment">//get detector parameters from detector number</span>
00977 <span class="comment">//      dtct: detector number in transaxle direction in a bank, 0: 71</span>
00978 <span class="comment">//      layer: layer number, 0:1</span>
00979 <span class="comment">//      bank: bank number, 0:7</span>
00980 <span class="comment">//      ring: detector number in axle direction in a bank, 0:103</span>
00981 <span class="comment">//---------------------------------------------------------------------</span>
00982 <a class="code" href="structCrystalID.html">CrystalID</a> HRRTHouseEvent::getHrrtId(<span class="keywordtype">int</span> n)
00983 {
00984   <a class="code" href="structCrystalID.html">CrystalID</a> id;
00985   <span class="comment">//static variables only inited once</span>
00986   <span class="keyword">static</span> <span class="keywordtype">int</span> dtctPerBlock = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o0">dtctPerBlock</a>;
00987   <span class="keyword">static</span> <span class="keywordtype">int</span> nBank = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o4">nBank</a>;
00988   <span class="keyword">static</span> <span class="keywordtype">int</span> nLayer = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>;
00989   <span class="keyword">static</span> <span class="keywordtype">int</span> nDtct = scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>;
00990   <span class="keyword">static</span> <span class="keywordtype">int</span> ringDenominator = nDtct*nBank*nLayer;
00991   <span class="keyword">static</span> <span class="keywordtype">int</span> layerDenominator = nDtct*nBank;
00992   <span class="keyword">static</span> <span class="keywordtype">int</span> bankDenominator = nDtct;
00993   <span class="keywordtype">int</span> ring = n/ringDenominator; <span class="comment">//ring index</span>
00994   <span class="keywordtype">int</span> layer = (n%ringDenominator)/(layerDenominator);<span class="comment">//layer index</span>
00995   <span class="keywordtype">int</span> bank = (n %layerDenominator)/ bankDenominator ; <span class="comment">//bank index</span>
00996   <span class="keywordtype">int</span> dtct = n% bankDenominator; <span class="comment">//detector index</span>
00997   id.<a class="code" href="structCrystalID.html#o0">dtct</a> = dtct;
00998   id.<a class="code" href="structCrystalID.html#o3">layer</a> = layer;
00999   id.<a class="code" href="structCrystalID.html#o2">bank</a> = bank;
01000   id.<a class="code" href="structCrystalID.html#o1">ring</a> = ring;
01001   id.<a class="code" href="structCrystalID.html#o9">block</a> = houseList-&gt;<a class="code" href="classHRRTHouseList.html#d17">getBlockNumber</a>(id);<span class="comment">//calculate corresponding block number</span>
01002   <span class="keywordflow">return</span> id;
01003 }
01004 
01009 <span class="keywordtype">float</span> HRRTHouseEvent::getTotalPossibleEvents()
01010 {
01011 
01012   <span class="keywordflow">return</span> scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o16">numLOR</a>;
01013 }
01014 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
