<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: HRRTHouseList.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>HRRTHouseList.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00002 <span class="preprocessor">#include &lt;string.h&gt;</span>
00003 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00004 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00005 <span class="preprocessor">#include &lt;sstream&gt;</span>
00006 <span class="preprocessor">#include &lt;iomanip&gt;</span>
00007 <span class="preprocessor">#include "HRRTHouse.hpp"</span>
00008 <span class="preprocessor">#include "Status.hpp"</span>
00009 <span class="preprocessor">#include "ResolutionFunction.hpp"</span>
00010 <span class="preprocessor">#include "FourDReconstruction.hpp"</span>
00011 <span class="preprocessor">#include "IsoGaussian.hpp"</span>
00012 <span class="preprocessor">#include "Utilities.hpp"</span>
00013 <span class="preprocessor">#include "Constant.hpp"</span>
00014 <span class="preprocessor">#include "TOC.hpp"</span>
00015 <span class="preprocessor">#include "MOLAR.hpp"</span>
00016 <span class="preprocessor">#include "ScatterCorrection.hpp"</span>
00017 
00018 
00019 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00020 
00021 HRRTHouseList::HRRTHouseList()
00022 {
00023   checkSum = <span class="keyword">sizeof</span>(<a class="code" href="classHRRTHouseList.html">HRRTHouseList</a>);
00024   params = Params::getInstance();
00025   houseSingles= HRRTHouseSingles::getInstance();
00026   scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00027   status = Status::getStatus();
00028   fi = FrameInfo::getInstance();
00029   <span class="comment">//get the decay correction time from params objects, </span>
00030   <span class="comment">//transform it from hh:mm:ss to int, in milliseconds</span>
00031   string hours = params-&gt;frame.decayCorrectionTime.substr(11,2);
00032   string minutes = params-&gt;frame.decayCorrectionTime.substr(14,2);
00033   string seconds = params-&gt;frame.decayCorrectionTime.substr(17,2);
00034   time.decayCorrectionTime = (atoi(hours.c_str())*60*60
00035                               +atoi(minutes.c_str())*60+ 
00036                               atoi(seconds.c_str()))*1000;
00037   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5){
00038     cout&lt;&lt;<span class="stringliteral">"Decay corretion time "</span>&lt;&lt;params-&gt;frame.decayCorrectionTime;
00039     cout&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;time.decayCorrectionTime&lt;&lt;endl;
00040   }
00041   <span class="comment">//init required duration, in ms</span>
00042   <span class="comment">//frame duration, seconds from the reference time, </span>
00043   <span class="comment">//transfered to milliseconds</span>
00044   hours=params-&gt;frame.duration.substr(0,2);
00045   minutes=params-&gt;frame.duration.substr(3,2);
00046   seconds=params-&gt;frame.duration.substr(6,2);
00047   time.requestedDuration = (atoi(hours.c_str())*60*60+
00048                             atoi(minutes.c_str())*60
00049                             +atoi(seconds.c_str()))*1000; 
00050   <span class="comment">//set motion correction to 0</span>
00051   <span class="comment">//to indicate that it's not initialized</span>
00052   motion = 0;
00053 
00054 
00055 }
00056 
00057 
00058 <span class="comment">//-----------------------------------------------------------------------------</span>
00059 <span class="comment">//Read list mode header file</span>
00060 <span class="comment">//find the study time </span>
00061 <span class="comment">//calculate the user specified start time tag</span>
00062 <span class="comment">//return false if the study time not found or user specified start time is</span>
00063 <span class="comment">// before the study time</span>
00064 <span class="comment">//return true if successful</span>
00065 <span class="comment">//-----------------------------------------------------------------------------</span>
00066 <span class="keywordtype">void</span> HRRTHouseList::getFrameStartTimeTag()
00067 {
00068   <span class="comment">//check if the pointer of the singleton is proper inited </span>
00069   <span class="keywordflow">if</span>(!checkValid()){
00070     cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseList"</span>
00071         &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00072         &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00073     cout.flush();
00074     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00075   }
00076 
00077   <span class="comment">//get reference time from params</span>
00078   string years(params-&gt;frame.frameStartTime,0,4), 
00079     months(params-&gt;frame.frameStartTime,5,2),
00080     days(params-&gt;frame.frameStartTime,8,2);
00081   string hours(params-&gt;frame.frameStartTime,11,2),
00082     minutes(params-&gt;frame.frameStartTime,14,2),
00083     seconds(params-&gt;frame.frameStartTime,17,2);
00084   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00085     cout&lt;&lt;params-&gt;frame.frameStartTime&lt;&lt;endl;
00086     cout&lt;&lt;years&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;months&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;days&lt;&lt;endl;
00087     cout&lt;&lt;hours&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;minutes&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;seconds&lt;&lt;endl;
00088   }
00089 
00090   tm tmFrame;
00091   <a class="code" href="classUtilities.html#e9">Utilities::setTm</a>(tmFrame, years, months, days, hours, minutes, seconds);       
00092   time_t tFrameTime = mktime(&amp;tmFrame);
00093   <span class="comment">//get scan starting time from params</span>
00094   years = params-&gt;frame.scanStartTime.substr(0,4);
00095   months =params-&gt;frame.scanStartTime.substr(5,2) ;
00096   days=params-&gt;frame.scanStartTime.substr(8,2);
00097   hours=params-&gt;frame.scanStartTime.substr(11,2);
00098   minutes=params-&gt;frame.scanStartTime.substr(14,2);
00099   seconds=params-&gt;frame.scanStartTime.substr(17,2);
00100   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00101     cout&lt;&lt;years&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;months&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;days&lt;&lt;endl;
00102     cout&lt;&lt;hours&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;minutes&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;seconds&lt;&lt;endl;
00103   }
00104  <span class="comment">//transfer study date and study time to time_t type</span>
00105   tm tmStudyTime;
00106   <a class="code" href="classUtilities.html#e9">Utilities::setTm</a>(tmStudyTime, years, months, days, hours, minutes, seconds);
00107   time_t tStudyTime = mktime(&amp;tmStudyTime);
00108   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00109     cout&lt;&lt;tFrameTime&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;tStudyTime&lt;&lt;endl;
00110   }
00111   <span class="comment">//calculate frame start time and requested frame start time tag</span>
00112   <span class="keywordtype">int</span> frameStartTime=difftime(tFrameTime, tStudyTime)*1000; <span class="comment">//in milliseconds</span>
00113 
00114   <span class="comment">// 2006-04-10 RC  adjust the starttime in the case when decimals are added to the seconds</span>
00115   <span class="keywordtype">int</span> imsec = 0;
00116   <span class="keywordflow">if</span> (params-&gt;frame.frameStartTime.length() &gt; 19) {
00117    <span class="keywordflow">if</span> (params-&gt;frame.frameStartTime.substr(19,1) == <span class="stringliteral">"."</span>) {
00118     string msec = params-&gt;frame.frameStartTime.substr(20);
00119     imsec = atoi(msec.c_str());
00120     <span class="keywordflow">if</span> (msec.length() == 1) {
00121      imsec *=100;
00122     }
00123     <span class="keywordflow">if</span> (msec.length() == 2) {
00124      imsec*=10;
00125     }
00126     cout &lt;&lt; <span class="stringliteral">"Frame start time msec = "</span>&lt;&lt;imsec&lt;&lt;endl;
00127     frameStartTime+= (<span class="keywordtype">float</span>)imsec / 1000.;
00128    }
00129   }
00130   imsec=0;
00131   <span class="keywordflow">if</span> (params-&gt;frame.scanStartTime.length() &gt; 19) {
00132    <span class="keywordflow">if</span> (params-&gt;frame.scanStartTime.substr(19,1) == <span class="stringliteral">"."</span>) {
00133     string msec = params-&gt;frame.scanStartTime.substr(20);
00134     imsec = atoi(msec.c_str());
00135     <span class="keywordflow">if</span> (msec.length() == 1) {
00136      imsec *=100;
00137     }
00138     <span class="keywordflow">if</span> (msec.length() == 2) {
00139      imsec*=10;
00140     }
00141     cout &lt;&lt; <span class="stringliteral">"Scan start time msec = "</span>&lt;&lt;imsec&lt;&lt;endl;
00142     frameStartTime-= (<span class="keywordtype">float</span>)imsec / 1000.;
00143    }
00144   }
00145   
00146  <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5)
00147     cout&lt;&lt;<span class="stringliteral">"frame start time "</span>&lt;&lt;frameStartTime&lt;&lt;endl;
00148   time.requestedFrameStartTimeTag = frameStartTime;
00149 
00150   <span class="comment">//calculate study start time in the time struct, in milliseconds</span>
00151   time.studyStartTime =(atoi(hours.c_str())*60*60+atoi(minutes.c_str())
00152                         *60+atoi(seconds.c_str()))*1000 + imsec;
00153   <span class="keywordflow">return</span>;
00154 }
00155  
00156 
00157 <span class="comment">//-------------------------------------------------------------------------</span>
00158 <span class="comment">//read to frameTime tag in list mode file</span>
00159 <span class="comment">//------------------------------------------------------------------------</span>
00160 <span class="keywordtype">void</span> HRRTHouseList::gotoFrameStartTimeTag()
00161 {
00162   <span class="comment">//check if the pointer of the singleton is proper inited </span>
00163   <span class="keywordflow">if</span>(!checkValid()){
00164     cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseList"</span>
00165         &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00166         &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00167     cout.flush();
00168     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00169   }
00170 
00171 
00172 
00173   OFF_T offset; <span class="comment">//offset pointer of the list mode file</span>
00174   OFF_T zeroOffset; <span class="comment">//offset of the time tag zero</span>
00175   <span class="comment">// Estimate where to start according to the table of content file</span>
00176  
00177   <span class="comment">//head curve file name</span>
00178   string fileNameHC = params-&gt;frame.listmodeFilename;
00179   <span class="keywordtype">int</span> index = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00180   fileNameHC.replace(index,4,<span class="stringliteral">".hc"</span>);
00181   <span class="keywordflow">if</span>(params-&gt;frame.verbosity &gt;= 2)
00182     cout&lt;&lt;<span class="stringliteral">"In gotoFrameStartTimeTag, initializing TOC "</span>&lt;&lt;fileNameHC&lt;&lt;endl;
00183   <span class="comment">//init toc object</span>
00184   <a class="code" href="classTOC.html">TOC</a> toc(fileNameHC, params-&gt;frame.scratchPath);
00185   <span class="comment">// get singles fix data</span>
00186   sing_fix_time=toc.<a class="code" href="classTOC.html#a6">get_fix_sing_time</a>();
00187   sing_fix_constant=toc.<a class="code" href="classTOC.html#a7">get_fix_sing_constant</a>();
00188   sing_fix_last_report=0.;
00189    cout&lt;&lt;<span class="stringliteral">"HRRTHouseList:Will correct singles after "</span>&lt;&lt;sing_fix_time&lt;&lt;<span class="stringliteral">" msec with constant "</span>&lt;&lt;sing_fix_constant&lt;&lt;endl;
00190   <span class="keywordflow">if</span>(params-&gt;frame.verbosity &gt;= 2)
00191     cout&lt;&lt;<span class="stringliteral">"In gotoFrameStartTimeTag, completed initializing TOC "</span>&lt;&lt;endl;
00192   <span class="keywordtype">bool</span> foundItFlag = <span class="keyword">false</span>;
00193   <span class="keywordflow">if</span>(params-&gt;frame.verbosity &gt;= 5)
00194     cout&lt;&lt; <span class="stringliteral">"lookForZero from toc: "</span>&lt;&lt;toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>()&lt;&lt;endl;
00195   <span class="keywordflow">if</span>(params-&gt;frame.processWholeFile){
00196     <span class="keywordflow">if</span>(toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>()) {
00197         offset = toc.<a class="code" href="classTOC.html#a3">getZeroOffset</a>();
00198         time.thisTimeTag = 0;   
00199     } <span class="keywordflow">else</span> 
00200         time.thisTimeTag = toc.<a class="code" href="classTOC.html#d1">findFirstTimeTag</a>(params-&gt;frame.listmodeFilename,
00201                                             offset);
00202     foundItFlag = <span class="keyword">true</span>;
00203   }
00204   <span class="keywordflow">else</span>{
00205     <span class="comment">//For cases when there is a zeroTag &amp;&amp; a HC file</span>
00206     <span class="keywordflow">if</span>(toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>() &amp;&amp; time.requestedFrameStartTimeTag &gt;= 0) { 
00207      <span class="comment">//Note that, the requestedframestarttimetag &amp; requestedframestoptimetag &gt;0 only when </span>
00208      <span class="comment">//there is a HC file associatded with the l64 file</span>
00209        offset = toc.<a class="code" href="classTOC.html#a1">estimateOffset</a>(time.requestedFrameStartTimeTag);
00210     } <span class="keywordflow">else</span> {
00211        time.thisTimeTag = toc.<a class="code" href="classTOC.html#d1">findFirstTimeTag</a>(params-&gt;frame.listmodeFilename,
00212                                             offset);
00213     }
00214   }
00215   
00216   OFF_T fileLength = <a class="code" href="classUtilities.html#e6">Utilities::getFileLength</a>(lun);
00217   <span class="keywordflow">if</span>(params-&gt;frame.verbosity &gt;= 2)
00218     cout&lt;&lt;<span class="stringliteral">"In gotoFrameStartTimeTag, the file "</span>
00219         &lt;&lt;params-&gt;frame.listmodeFilename&lt;&lt;<span class="stringliteral">" length is "</span>&lt;&lt;fileLength&lt;&lt;endl;
00220   <span class="comment">//if errors happens in the estimate offset, it returns -1</span>
00221   <span class="keywordflow">if</span>((offset&lt;0 ) || offset&gt;fileLength){
00222     Status *status = Status::getStatus();
00223     <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00224     string msg = 
00225      <span class="stringliteral">"Error in calculation of offset of the list mode file, program aborted"</span>;
00226     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00227     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00228   }
00229   <span class="keywordflow">if</span>(toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>()){
00230     zeroOffset = toc.<a class="code" href="classTOC.html#a3">getZeroOffset</a>();
00231     <span class="keywordflow">if</span>((zeroOffset&lt;0 ) || zeroOffset&gt;fileLength){
00232       Status *status = Status::getStatus();
00233       <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00234       string msg = 
00235         string(<span class="stringliteral">"Error in calculation of zero offset of the list mode file, "</span>)
00236         +string(<span class="stringliteral">"program aborted"</span>);
00237       <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00238       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00239     }
00240   }
00241 
00242   <span class="comment">//go to the right position of the list mode file</span>
00243   fseeko(lun,offset, SEEK_SET);
00244   
00245   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4]; <span class="comment">//buffer to hold 64 bits read from list mode file</span>
00246   <span class="keywordtype">bool</span> success;
00247   <span class="comment">// Find actual starting time tag</span>
00248   <span class="keywordtype">bool</span> reverseFlag = <span class="keyword">false</span>;
00249   <span class="keywordflow">while</span>(!foundItFlag) {
00250     <span class="keywordflow">do</span> {
00251       <span class="keywordflow">if</span>(reverseFlag)
00252         <span class="comment">//find backward</span>
00253         success = findPreviousEvent(b);
00254       <span class="keywordflow">else</span>
00255         <span class="comment">//find forward</span>
00256         success = findNextEvent(b);
00257       <span class="keywordflow">if</span>(toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>()){
00258         OFF_T curOffset = ftello(lun);
00259         <span class="keywordflow">if</span>(curOffset &lt; zeroOffset){
00260           string msg = 
00261             <span class="stringliteral">"Error in refining the location of the time tag, program aborted"</span>;
00262           <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00263           <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00264         }
00265       } 
00266         
00267       <span class="keywordflow">if</span>(!success ){
00268         <span class="keywordflow">if</span>(!toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>() &amp;&amp; reverseFlag){
00269           <span class="comment">//reach the beginning of the file but didn't find the </span>
00270           <span class="comment">//specified time tag</span>
00271           <span class="comment">//use the first time tag in the file as the frame start time</span>
00272           foundItFlag = <span class="keyword">true</span>;
00273           offset = 0;
00274           fseeko(lun,offset, SEEK_SET);
00275         }
00276         <span class="keywordflow">else</span>{
00277           Status *status = Status::getStatus();
00278           <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00279           string msg;
00280           msg = <span class="stringliteral">"Error in looking for frame start time,  program aborted"</span>;
00281           <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(msg);
00282           <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00283         }
00284       }
00285         
00286     } <span class="keywordflow">while</span>(!isTimeTag(b) &amp;&amp; success);
00287       
00288     <span class="keywordflow">if</span>(isTimeTag(b))
00289       time.thisTimeTag = processTimeTag(b);
00290     <span class="keywordflow">if</span>(time.thisTimeTag &gt; max(0,time.requestedFrameStartTimeTag))
00291       <span class="comment">//go backward</span>
00292       reverseFlag = <span class="keyword">true</span>;
00293 
00294     <span class="keywordflow">if</span>((time.thisTimeTag == max(0,time.requestedFrameStartTimeTag))<span class="comment">//find it </span>
00295        ||(reverseFlag 
00296             &amp;&amp;(time.thisTimeTag &lt;max(0,time.requestedFrameStartTimeTag)))
00297          <span class="comment">//the requested time tag missing</span>
00298          ||(reverseFlag &amp;&amp; !success)<span class="comment">//requestedTimeTag &lt; first time tag in file</span>
00299          )
00300         <span class="comment">//found it</span>
00301       foundItFlag = <span class="keyword">true</span>;
00302 
00303   }
00304   
00305   <span class="comment">//Adjust time parameters</span>
00306   time.frameStartTimeTag = time.thisTimeTag;
00307   time.requestedFrameStopTimeTag = time.requestedFrameStartTimeTag 
00308     + time.requestedDuration;
00309     <span class="keywordflow">if</span>(params-&gt;frame.verbosity &gt;= 5) {
00310         cout &lt;&lt;<span class="stringliteral">"Requested duration: "</span>&lt;&lt;time.requestedDuration&lt;&lt;endl;
00311         cout &lt;&lt;<span class="stringliteral">"Requested Framestarttime: "</span>&lt;&lt;time.requestedFrameStartTimeTag&lt;&lt;endl;
00312         cout &lt;&lt;<span class="stringliteral">"Framestarttime: "</span>&lt;&lt;time.frameStartTimeTag&lt;&lt;endl;
00313         cout &lt;&lt;<span class="stringliteral">"Requested Framestoptime: "</span>&lt;&lt;time.requestedFrameStopTimeTag&lt;&lt;endl;
00314         cout &lt;&lt;<span class="stringliteral">"Framestopttime: "</span>&lt;&lt;time.frameStopTimeTag&lt;&lt;endl;
00315     }
00316   <span class="keywordflow">if</span>(!toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>() &amp;&amp; time.requestedFrameStopTimeTag &lt;= time.frameStartTimeTag) {
00317     time.requestedFrameStopTimeTag = time.frameStartTimeTag 
00318       + time.requestedDuration;
00319   }
00320   <span class="keywordflow">if</span>(time.requestedFrameStopTimeTag&lt;time.requestedFrameStartTimeTag){
00321     cout&lt;&lt;<span class="stringliteral">"Requested frame stop time tag : "</span>&lt;&lt;time.requestedFrameStopTimeTag
00322         &lt;&lt;<span class="stringliteral">" must be greater than the requested frame start time tag : "</span>
00323         &lt;&lt;time.requestedFrameStartTimeTag&lt;&lt;endl;
00324     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::UNKNOWN);
00325   }
00326 
00327   
00328   <span class="comment">// If possible move backwards and fill in singles</span>
00329   offset = ftello(lun) -Constant::BYTESPERCOUNT;
00330   <span class="keywordflow">if</span>(toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>()){
00331     success = <span class="keyword">true</span>;
00332     <span class="keywordtype">int</span> nTagsRead = 0;
00333     <span class="keywordflow">while</span>(nTagsRead&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o5">nBlock</a> &amp;&amp; success){
00334       <span class="keywordflow">do</span> {
00335         success = findPreviousEvent(b);
00336         <span class="keywordflow">if</span>(!success){
00337           Status *status = Status::getStatus();
00338           <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
00339           string msg = 
00340             <span class="stringliteral">"Beginning of file reached, singles are not filled completely"</span>;
00341           log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 1);
00342         }
00343       }<span class="keywordflow">while</span>(!isSinglesTag(b) &amp;&amp; success);
00344       <span class="keywordflow">if</span> (success) {
00345        processSinglesTag(b);
00346        nTagsRead ++;
00347       }
00348     }
00349     <span class="keywordflow">if</span> (nTagsRead&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o5">nBlock</a>) {
00350      cout&lt;&lt;<span class="stringliteral">"Filled in only "</span>&lt;&lt;nTagsRead&lt;&lt;<span class="stringliteral">" out of "</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o5">nBlock</a>&lt;&lt;<span class="stringliteral">" singles values"</span>&lt;&lt;
00351         endl;
00352      <span class="keywordtype">float</span> totSingles = 0.;
00353      <span class="keywordflow">if</span> (nTagsRead == 0) {
00354       totSingles=params-&gt;normalization.normSinglesRate;
00355       cout&lt;&lt;<span class="stringliteral">"Singles set to params.normalization.normSinglesRate: "</span>&lt;&lt;params-&gt;normalization.normSinglesRate&lt;&lt;endl;
00356      } <span class="keywordflow">else</span> {
00357       <span class="keywordtype">int</span> nTagsRead = 0;
00358       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> block = 0; block &lt; scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o5">nBlock</a>; block++) {
00359        <span class="keywordflow">if</span> (houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>[block] &gt; 0) {
00360         totSingles += houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>[block];
00361         nTagsRead ++;
00362        }
00363       }
00364       totSingles /= nTagsRead;
00365       cout&lt;&lt;<span class="stringliteral">"Replacing "</span>&lt;&lt;scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o5">nBlock</a>-nTagsRead&lt;&lt;<span class="stringliteral">" with value "</span>&lt;&lt;totSingles&lt;&lt;endl;
00366      }
00367      <span class="keywordflow">for</span> (<span class="keywordtype">int</span> block = 0; block &lt; scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o5">nBlock</a>; block++) {
00368       <span class="keywordflow">if</span> (houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>[block] &lt;= 0) {
00369        houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>[block]=totSingles;
00370       }
00371      }
00372       
00373     }
00374     <span class="comment">//goto previous position</span>
00375     fseeko(lun,offset,SEEK_SET);
00376   }
00377 
00378   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=3) {
00379     cout&lt;&lt;<span class="stringliteral">"Study start Time from midnight in ms is : "</span>
00380         &lt;&lt;time.studyStartTime&lt;&lt;endl;
00381     cout&lt;&lt;<span class="stringliteral">"Actual frame start time tag is: "</span>&lt;&lt;time.frameStartTimeTag&lt;&lt;endl;
00382     cout&lt;&lt;<span class="stringliteral">"Actual frame start time from midnight in ms is : "</span>
00383         &lt;&lt;time.studyStartTime+time.frameStartTimeTag&lt;&lt;endl;
00384   }
00385 
00386 }
00387 
00388 <span class="comment">//-----------------------------------------------------------</span>
00389 <span class="comment">//check if the two 32 bit words synchronized</span>
00390 <span class="comment">//------------------------------------------------------------ </span>
00391 <span class="keywordtype">bool</span> HRRTHouseList::checkSync(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00392 {
00393   <span class="keywordflow">return</span> <a class="code" href="classTOC.html#e4">TOC::checkSync</a>(b, lun,  stat.nSkip);
00394 }       
00395 
00396 
00397 <span class="comment">//---------------------------------------------------------------------------</span>
00398   <span class="comment">//read the list mode file, decode the 64 bit data to two detector</span>
00399   <span class="comment">//structures, e1 and e2</span>
00400   <span class="comment">//return true as it gets a prompt</span>
00401   <span class="comment">//or it gets a random when calculating the random sinogram</span>
00402   <span class="comment">//return false when there is i/o error or end of file reached</span>
00403 
00404 <span class="comment">//----------------------------------------------------------------------------</span>
00405 <span class="keywordtype">bool</span> HRRTHouseList::readListMode(<a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2)
00406 {
00407    <span class="comment">//check if the pointer of the singleton is proper inited </span>
00408   <span class="keywordflow">if</span>(!checkValid()){
00409     cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseList"</span>
00410         &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00411         &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00412     cout.flush();
00413     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00414   }
00415 
00416   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4]; <span class="comment">//64 bits</span>
00417   <span class="keywordtype">bool</span> flagPrompt = <span class="keyword">false</span>; <span class="comment">//if it is a prompt</span>
00418   <span class="keywordflow">while</span>(!flagPrompt &amp;&amp; (!feof(lun)&amp;&amp; !ferror(lun))){
00419     <span class="comment">//read in 64 bits    </span>
00420     <span class="keywordflow">if</span>(fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun)!=4) <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00421     
00422     stat.nRead ++;<span class="comment">//number of read in</span>
00423     checkSync(b); <span class="comment">// check if the two words synchronized</span>
00424     <span class="keywordflow">if</span> (isEvent(b)){ <span class="comment">//an event</span>
00425         
00426       <span class="keywordflow">if</span> (processEvent(b,e1,e2)) { <span class="comment">//decode the bits</span>
00427         stat.nEvent ++; <span class="comment">//count the number of events</span>
00428 
00429         <span class="keywordflow">if</span> (e2.<a class="code" href="structCrystalID.html#o7">tag</a> ==1) { <span class="comment">//a real event or prompt</span>
00430            
00431           <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00432             cout&lt;&lt;<span class="stringliteral">"A prompt ..."</span>&lt;&lt;endl;
00433           }
00434           stat.nPrompt ++;
00435           <span class="comment">//for most cases exit</span>
00436           <span class="keywordflow">if</span>((params-&gt;algorithm.name != <span class="stringliteral">"sinogram"</span>)||
00437            (params-&gt;sinogram.type != <span class="stringliteral">"delayed"</span>))
00438             flagPrompt = <span class="keyword">true</span>;
00439         }
00440         <span class="keywordflow">else</span>{<span class="comment">//a delayed random</span>
00441            
00442           <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=5) {
00443             cout&lt;&lt;<span class="stringliteral">"A delayed random ..."</span>&lt;&lt;endl;
00444           }
00445           <span class="comment">//if need calculate delayed sinogram, exit</span>
00446           <span class="keywordflow">if</span>((params-&gt;algorithm.name == <span class="stringliteral">"sinogram"</span>)&amp;&amp;
00447            (params-&gt;sinogram.type == <span class="stringliteral">"delayed"</span>))
00448             flagPrompt = <span class="keyword">true</span>;
00449 
00450           stat.nRandom ++;
00451         }
00452       }
00453     }
00454     <span class="keywordflow">else</span>{  <span class="comment">//nonevent, continue reading</span>
00455         
00456       processNonEvent(b); <span class="comment">//decode the bits</span>
00457       stat.nNonEvent ++;
00458     }
00459   }
00460   <span class="keywordflow">return</span> flagPrompt;
00461 }
00462 
00463 <span class="comment">//process the time tag</span>
00464 <span class="keywordtype">int</span> HRRTHouseList::processTimeTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00465 {
00466   
00467   <span class="keywordtype">int</span> timeTag = <a class="code" href="classTOC.html#e1">TOC::processTimeTag</a>(b);
00468   <span class="keywordflow">return</span> timeTag;
00469 }
00470 
00471 
00472 
00473 <span class="comment">//process the singles tag</span>
00474 <span class="keywordtype">void</span> HRRTHouseList::processSinglesTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00475 {
00476   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> b2 = b[2];
00477   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> b0 = b[0];
00478   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> block = (b[2] &amp; 0x1ff8) &gt;&gt;3; <span class="comment">//block number</span>
00479   <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> countrates = ((b2 &amp; 0x7)&lt;&lt;16) + b0; <span class="comment">//counter rates</span>
00480   <span class="keywordflow">if</span>(params-&gt;randoms.singlesScaleFactor==0)
00481     params-&gt;randoms.singlesScaleFactor=1;<span class="comment">//default is 1</span>
00482   <span class="comment">// 2006-08-30 now also correct for stuck singles</span>
00483   houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r0">singles</a>[block] = static_cast&lt;int&gt; 
00484     ( countrates*params-&gt;randoms.singlesScaleFactor* 
00485      (fixSinglesFactor(time.thisTimeTag)));
00486   
00487 
00488 }
00489 
00490 <span class="comment">//open list mode file and put the file pointer in the right place</span>
00491 <span class="comment">//init some parameters in the time struct</span>
00492 <span class="keywordtype">bool</span> HRRTHouseList::prepareListModeFile()
00493 {
00494   
00495   <span class="comment">//check if the pointer of the singleton is proper inited </span>
00496   <span class="keywordflow">if</span>(!checkValid()){
00497     cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseList"</span>
00498         &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00499         &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00500     cout.flush();
00501     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00502   }
00503 
00504   <span class="keywordflow">if</span>((lun=fopen((params-&gt;frame.listmodeFilename).c_str(),<span class="stringliteral">"rb"</span>))==0){
00505     printf(<span class="stringliteral">"Cannot open %s to read list mode data"</span>,
00506            (params-&gt;frame.listmodeFilename).c_str());
00507     <span class="comment">//update status file</span>
00508     string comm = <span class="stringliteral">"Cannot open list mode data file, aborted"</span>;
00509     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(comm);
00510     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00511   }
00512   <span class="comment">//calculate the frame start time tag</span>
00513   <span class="comment">//frameStartTimeTag = params-&gt;frame.frameStartTime-params-&gt;frame.scanStartTime</span>
00514   getFrameStartTimeTag();
00515   <span class="comment">//go to frame start time tag</span>
00516   gotoFrameStartTimeTag();
00517     
00518   <span class="keywordtype">int</span> startTime = (time.frameStartTimeTag+time.studyStartTime)/1000; <span class="comment">//seconds</span>
00519   <span class="keywordtype">int</span> hours, minutes, seconds;
00520   hours = startTime/3600;
00521   minutes = (startTime - hours*3600)/60;
00522   seconds = startTime - hours*3600 - minutes*60;
00523   <span class="comment">//output to log</span>
00524   stringstream ss, ss1;
00525   ss&lt;&lt;setfill(<span class="charliteral">'0'</span>)&lt;&lt;setw(2)&lt;&lt;hours&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;setfill(<span class="charliteral">'0'</span>)&lt;&lt;setw(2)
00526     &lt;&lt;minutes&lt;&lt;<span class="stringliteral">":"</span>&lt;&lt;setfill(<span class="charliteral">'0'</span>)&lt;&lt;setw(2)&lt;&lt;seconds;
00527   ss1&lt;&lt;<span class="stringliteral">"====================================="</span>&lt;&lt;endl;
00528   ss1&lt;&lt;<span class="stringliteral">"Frame start time is "</span>&lt;&lt;ss.str()&lt;&lt;endl;
00529   <a class="code" href="classLog.html">Log</a> * log= <a class="code" href="classLog.html#e0">Log::getLog</a>();
00530   log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss1.str(),FRAME,0);
00531   
00532   <span class="keywordflow">if</span>(!feof(lun) &amp;&amp; !ferror(lun)) 
00533     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00534   <span class="keywordflow">else</span> 
00535     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00536 }
00537 <span class="comment">/* Performs the required initialization in advance of</span>
00538 <span class="comment">   event-by-event requests for randomized list-mode data.  Returns true</span>
00539 <span class="comment">   if successful, false if not.  The numRandom parameter specifies the</span>
00540 <span class="comment">   number of random events for each event in the event list.  This call</span>
00541 <span class="comment">   causes the HRRTHouse to open the event list file.  The event list file</span>
00542 <span class="comment">   is read as successive calls to getNextEvent are called.</span>
00543 <span class="comment">*/</span>
00544 <span class="comment">//-----------------------------------------------------------------------------</span>
00545 <span class="keywordtype">bool</span> HRRTHouseList::prepareRandomizedListData()
00546 {
00547   <span class="comment">//check if the pointer of the singleton is proper inited </span>
00548   <span class="keywordflow">if</span>(!checkValid()){
00549     cout&lt;&lt;<span class="stringliteral">"Error in use of HRRTHouseList"</span>
00550         &lt;&lt;<span class="stringliteral">"Programmer make sure call the getInstance"</span>
00551         &lt;&lt;<span class="stringliteral">"Program aborted"</span>&lt;&lt;endl;
00552     cout.flush();
00553     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::POINTERERROR);
00554   }
00555 <span class="comment">//set the mode to Randomized ListMode, prepare list mode data</span>
00556   mode = RandListMode;
00557   stat.nRead = 0; <span class="comment">//number of packets read</span>
00558   stat.nEvent = 0; <span class="comment">//number of events read</span>
00559   stat.nPrompt = 0;<span class="comment">//number of prompts read</span>
00560   stat.nRandom = 0;<span class="comment">//number of randoms read</span>
00561   stat.nNonEvent = 0;<span class="comment">//number of nonevent read</span>
00562   stat.nT = stat.nS = 0;
00563   stat.nAccept = stat.nReject = 0;
00564   stat.nSkip = stat.nBadEvents = stat.nBadNonEvents = 0;
00565   stat.nDecayFactor = stat.nLiveTimeFactor =  stat.nLiveTime_Decay = 0.0;
00566   <span class="keywordtype">bool</span> success = prepareListModeFile();
00567   
00568   <span class="comment">// TOC::getFrameStopTimeTag returns a negative number in the event of an </span>
00569   <span class="comment">// error condition.  When this hapens, we exit with exit code that</span>
00570   <span class="comment">// is the negative inversion of the returned value, and hence a</span>
00571   <span class="comment">// positive number.</span>
00572   string fileNameHC = params-&gt;frame.listmodeFilename;
00573   <span class="keywordtype">int</span> index = fileNameHC.find_last_of(<span class="stringliteral">"."</span>);
00574   fileNameHC.replace(index,4,<span class="stringliteral">".hc"</span>);
00575   <a class="code" href="classTOC.html">TOC</a> toc(fileNameHC, params-&gt;frame.scratchPath);
00576   <span class="keywordflow">if</span>(params-&gt;frame.processWholeFile){
00577     OFF_T offset;
00578     time.frameStopTimeTag = toc.<a class="code" href="classTOC.html#d2">findLastTimeTag</a>(params-&gt;frame.listmodeFilename,
00579                                                 offset);
00580   }
00581   <span class="keywordflow">else</span>{
00582     <span class="keywordflow">if</span>(time.requestedFrameStopTimeTag &lt;= time.frameStartTimeTag &amp;&amp; !toc.<a class="code" href="classTOC.html#a4">isLookForZero</a>()) { <span class="comment">//For cases when there is no zeroTag &amp;&amp; no HC file</span>
00583        time.requestedFrameStopTimeTag = time.frameStartTimeTag+time.requestedDuration;  
00584     }
00585  
00586     time.frameStopTimeTag = 
00587       toc.<a class="code" href="classTOC.html#a2">getFrameStopTimeTag</a>(time.requestedFrameStopTimeTag);
00588   }
00589   <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=3) {
00590      cout&lt;&lt;<span class="stringliteral">"Actual Frame stop time tag is "</span>&lt;&lt; time.frameStopTimeTag&lt;&lt;endl;
00591      cout&lt;&lt;<span class="stringliteral">"Actual frame stop time from midnight in ms is : "</span>
00592         &lt;&lt;time.studyStartTime+time.frameStopTimeTag&lt;&lt;endl;
00593   }
00594 
00595   <span class="keywordflow">if</span>(time.frameStopTimeTag &lt; 0){
00596     stringstream ss;
00597     ss&lt;&lt;<span class="stringliteral">"Error: TOC::findLastTimeTag returned code "</span> &lt;&lt;  
00598       time.frameStopTimeTag &lt;&lt; <span class="stringliteral">"&lt; aborting."</span>&lt;&lt;endl;
00599     <a class="code" href="classUtilities.html#e7">Utilities::logError</a>(ss.str());
00600     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(time.frameStopTimeTag);
00601   }
00602   time.duration = (time.frameStopTimeTag - time.frameStartTimeTag);
00603   
00604   <span class="comment">// Allocate an array of fi.duration singles packets.  </span>
00605   <span class="comment">// We need the singles packets for the simulation</span>
00606   <span class="keywordflow">if</span>(params-&gt;algorithm.name == <span class="stringliteral">"simulation"</span>)
00607     houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#d8">initSinglesPackets</a>();
00608 
00609   <span class="comment">//motion correction initialization</span>
00610   <span class="keywordflow">if</span>(params-&gt;motionCorrection.enable){
00611     <span class="comment">//make sure motion correction file exists and nonempty</span>
00612     <span class="keyword">const</span> <span class="keywordtype">char</span> *filename=params-&gt;motionCorrection.motionCorrectionFile.c_str();
00613     <span class="keywordtype">int</span> mc_file_size = FileSize(filename);
00614     <span class="keywordflow">if</span> (mc_file_size==0){
00615       cout&lt;&lt;<span class="stringliteral">"Warning :  Motion Correction is enable, "</span>&lt;&lt;
00616       <span class="stringliteral">"but motion correction file doesn't exit or empty. Please check!"</span>&lt;&lt;endl;
00617     }
00618     motion = <span class="keyword">new</span> <a class="code" href="classPolarisMotionCorrection.html">PolarisMotionCorrection</a>
00619       (params-&gt;motionCorrection.motionCorrectionFile, *Status::getStatus(),
00620        time.studyStartTime, time.frameStartTimeTag, time.requestedDuration,
00621        <span class="keyword">false</span>);
00622     <span class="keywordflow">if</span>(params-&gt;motionCorrection.verbosity&gt;=5){
00623       cout&lt;&lt;<span class="stringliteral">"Motion correction is initialized with "</span>
00624           &lt;&lt;params-&gt;motionCorrection.motionCorrectionFile&lt;&lt;<span class="stringliteral">" "</span>
00625           &lt;&lt;time.studyStartTime&lt;&lt;<span class="stringliteral">" "</span>
00626           &lt;&lt;time.frameStartTimeTag&lt;&lt;<span class="stringliteral">" "</span>
00627           &lt;&lt;time.requestedDuration&lt;&lt;endl;
00628     }
00629   }
00630 
00631   <span class="comment">// 4D Reconstruction initialization (whl- 04-04-07) </span>
00632         <span class="keywordflow">if</span>(params-&gt;algorithm.name == <span class="stringliteral">"simulation"</span> &amp;&amp; params-&gt;algorithm.algorithmKeys == <span class="stringliteral">"4D"</span>) {
00633         string filename;
00634         cout &lt;&lt; <span class="stringliteral">"identified 4D Key. Proceeding with 4D Simulation."</span> &lt;&lt; endl;
00635         
00636         
00637          <span class="keywordflow">if</span>(params-&gt;frame.simulationTimeFile != <span class="stringliteral">""</span>) {
00638             cout &lt;&lt; <span class="stringliteral">"simulation time file read correctly."</span> &lt;&lt; endl;
00639             filename=params-&gt;frame.simulationTimeFile;
00640             
00641          } <span class="keywordflow">else</span> {
00642            <span class="comment">// make the filename from simulation image file , changing extension </span>
00643            <span class="comment">// to .dat</span>
00644            cout &lt;&lt; <span class="stringliteral">"simulation time file not detected. modifying read from simulation image file."</span> &lt;&lt; endl;
00645            filename=params-&gt;frame.simulationImageFile;
00646            <span class="keywordtype">int</span> index1 = filename.find_last_of(<span class="stringliteral">"."</span>);
00647            filename = filename.substr(0,index1)+<span class="stringliteral">".dat"</span>;
00648            cout&lt;&lt;<span class="stringliteral">"SimulationImageFile not specified and you asked for 4D"</span>&lt;&lt;endl;
00649            cout&lt;&lt;<span class="stringliteral">" will use "</span>&lt;&lt;filename&lt;&lt;endl;
00650          }
00651 
00652           <a class="code" href="classFourDReconstruction.html">FourDReconstruction</a> *fourd = <a class="code" href="classFourDReconstruction.html#e0">FourDReconstruction::getFourD</a>();
00653           fourd-&gt;<a class="code" href="classFourDReconstruction.html#a1">init</a>( 
00654          filename, *Status::getStatus(),
00655        time.studyStartTime, time.frameStartTimeTag, time.requestedDuration,
00656        time.decayCorrectionTime);  
00657         }
00658         
00659 
00660   <span class="keywordflow">return</span> success;
00661 }
00662 
00664 <span class="comment">/*   Performs the required initialization in advance of</span>
00665 <span class="comment">     event-by-event requests for list-mode data.  Opens the list-mode</span>
00666 <span class="comment">     file specified in params-&gt; "Search" forward to find the appropriate</span>
00667 <span class="comment">     starting position based on frame time. Returns true if successful,</span>
00668 <span class="comment">     false if unsuccessful. </span>
00669 <span class="comment">*/</span>
00670 <span class="comment">//-----------------------------------------------------------------------------</span>
00671 <span class="keywordtype">bool</span> HRRTHouseList::prepareListData()
00672 {
00673   <span class="comment">//set the mode to ListMode, prepare list mode data</span>
00674   mode = ListMode;
00675   stat.nAccept = stat.nReject =0;
00676   stat.nRead = 0; <span class="comment">//number of packets read</span>
00677   stat.nEvent = 0; <span class="comment">//number of events read</span>
00678   stat.nPrompt = 0;<span class="comment">//number of prompts read</span>
00679   stat.nRandom = 0;<span class="comment">//number of randoms read</span>
00680   stat.nNonEvent = 0;<span class="comment">//number of nonevent read</span>
00681   stat.nT = stat.nS = 0;
00682   stat.nSkip = stat.nBadEvents = stat.nBadNonEvents = 0;
00683   stat.nDecayFactor = stat.nLiveTimeFactor =  stat.nLiveTime_Decay = 0.0;
00684   <span class="comment">//initialize motion correction if it is not initialized</span>
00685   <span class="comment">//reset it otherwise</span>
00686   <span class="keywordtype">bool</span> success =  prepareListModeFile();
00687   <span class="keywordflow">if</span>(params-&gt;motionCorrection.enable &amp;&amp; !motion){
00688     motion = <span class="keyword">new</span> <a class="code" href="classPolarisMotionCorrection.html">PolarisMotionCorrection</a>
00689       (params-&gt;motionCorrection.motionCorrectionFile, *Status::getStatus(),
00690        time.studyStartTime, time.frameStartTimeTag, time.requestedDuration,
00691        <span class="keyword">false</span>);
00692     <span class="keywordflow">if</span>(params-&gt;motionCorrection.verbosity&gt;=5){
00693       cout&lt;&lt;<span class="stringliteral">"Motion correction is initialized with "</span>
00694           &lt;&lt;params-&gt;motionCorrection.motionCorrectionFile&lt;&lt;<span class="stringliteral">" "</span>
00695           &lt;&lt;time.studyStartTime&lt;&lt;<span class="stringliteral">" "</span>
00696           &lt;&lt;time.frameStartTimeTag&lt;&lt;<span class="stringliteral">" "</span>
00697           &lt;&lt;time.requestedDuration&lt;&lt;endl;
00698     }
00699 
00700   }
00701   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(params-&gt;motionCorrection.enable){
00702     motion-&gt;<a class="code" href="classMotionCorrection.html#a3">reset</a>();
00703     <span class="keywordflow">if</span>(params-&gt;motionCorrection.verbosity&gt;=5){
00704       cout&lt;&lt;<span class="stringliteral">"Motion correction is reset"</span>&lt;&lt;endl;
00705     }
00706 
00707   }
00708   <span class="keywordflow">return</span> success;
00709 
00710 }
00711 
00712 
00729 <span class="keywordtype">int</span> HRRTHouseList::readRandomizedListMode()
00730 {
00731 
00732   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4]; <span class="comment">//64 bits</span>
00733   <span class="keywordtype">bool</span> finished = <span class="keyword">false</span>;    <span class="comment">// flag to indicate whether or not we are finished</span>
00734   <span class="keywordtype">int</span> returnCode = Constant::UNKNOWN;
00735   <a class="code" href="classMOLAR.html">MOLAR</a> * molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00736   ScatterCorrection * scatterCorrection= molar -&gt; getScatterCorrection();
00737  
00738 
00739   <span class="keywordflow">while</span>(!finished &amp;&amp; (!feof(lun)&amp;&amp; !ferror(lun))){
00740 
00741     <span class="comment">//read in 64 bits    </span>
00742     fread(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, lun); 
00743     <span class="keywordflow">if</span>(ferror(lun)){
00744       cout &lt;&lt; <span class="stringliteral">"Error:  List-mode file "</span>&lt;&lt; params-&gt;frame.listmodeFilename
00745            &lt;&lt; <span class="stringliteral">" is indicating ferror status"</span> &lt;&lt;endl;
00746       returnCode = Constant::IOERROR;
00747       <span class="keywordflow">return</span> returnCode;
00748     }
00749     <span class="keywordflow">if</span>(feof(lun)){
00750       cout &lt;&lt; <span class="stringliteral">"End-of file reached in list-mode file "</span> 
00751            &lt;&lt; params-&gt;frame.listmodeFilename &lt;&lt; endl;
00752       returnCode = 0; <span class="comment">// should be zero (normal operation)</span>
00753       <span class="keywordflow">return</span> returnCode;
00754     }
00755 
00756     stat.nRead ++;<span class="comment">//number of read in</span>
00757 
00758     <span class="keywordtype">bool</span> checkSyncStatus = checkSync(b); <span class="comment">// check if the two words</span>
00759                                       <span class="comment">// synchronized</span>
00760     <span class="keywordflow">if</span>(checkSyncStatus == <span class="keyword">false</span>){
00761       finished = <span class="keyword">true</span>;
00762       fclose(lun);
00763       <span class="keywordflow">return</span> Constant::CHECKSYNC_ERROR;
00764     }
00765     <span class="comment">//scatter correction - pass current singles fix factor</span>
00766     <span class="keywordflow">if</span>(params-&gt;modelBasedScatter.enable || params-&gt;randoms.enable) {
00767       scatterCorrection -&gt;randomsScatterPrep(b,sing_fix);
00768     }
00769     
00770     <span class="keywordflow">if</span> (isEvent(b)){ <span class="comment">//an event</span>
00771         
00772       <span class="comment">// Do nothing; we skip over the prompts and delays in randomized mode</span>
00773     }
00774 
00775     <span class="keywordflow">else</span>{  <span class="comment">//nonevent</span>
00776       
00777       processNonEvent(b); <span class="comment">//decode the bits</span>
00778       stat.nNonEvent ++;
00779       
00780       <span class="keywordflow">if</span>(isTimeTag(b)){
00781         finished = <span class="keyword">true</span>;     <span class="comment">// stop reading</span>
00782         returnCode = 0;      <span class="comment">// indicate normal return</span>
00783       }
00784     }
00785     
00786   }
00787     
00788 
00789   <span class="keywordflow">return</span> returnCode;
00790 }
00791 
00792 <span class="comment">//-------------------------------------------------------------------------</span>
00793 <span class="comment">//decode the bits for an event</span>
00794 <span class="comment">//-------------------------------------------------------------------------</span>
00795 <span class="keywordtype">bool</span> HRRTHouseList::processEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, 
00796                                  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, 
00797                                  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2)
00798 {
00799   <span class="keywordtype">int</span> headIdA[32] = {10,0,0,0,0,0,1,1,1,1,1,2,2,2,2,3,3,3,
00800                      4,4,5,10,10,10,10,10,10,10,10,10,10,10};<span class="comment">//header coding</span>
00801   <span class="keywordtype">int</span> headIdB[32] = {10,2,3,4,5,6,3,4,5,6,7,4,5,6,7,5,6,7,
00802                      6,7,7,10,10,10,10,10,10,10,10,10,10,10}; <span class="comment">//header coding</span>
00803 
00804   <span class="keywordtype">int</span> bank = ((b[3] &amp; 0x7)&lt;&lt;3) + (b[1] &amp; 0x7); <span class="comment">//bits 16-18</span>
00805   assert(bank&lt;32);
00806 
00807   <span class="comment">//first word for first detector</span>
00808   e1.<a class="code" href="structCrystalID.html#o0">dtct</a> = (b[0]&amp; 0x00ff); <span class="comment">//bits 0-7</span>
00809   e1.<a class="code" href="structCrystalID.html#o1">ring</a> = (b[0]&gt;&gt;8); <span class="comment">//bits 8-15</span>
00810   e1.<a class="code" href="structCrystalID.html#o2">bank</a> = headIdA[bank];
00811   e1.<a class="code" href="structCrystalID.html#o4">energy</a> = ((b[1] &amp; 0x38)&gt;&gt;3); <span class="comment">//bits 19-21</span>
00812   e1.<a class="code" href="structCrystalID.html#o3">layer</a> = 1-((b[1] &amp; 0x01c0)&gt;&gt;6); <span class="comment">//bits 22-24</span>
00813   e1.<a class="code" href="structCrystalID.html#o5">tof</a> = ((b[1] &amp; 0x0e00)&gt;&gt;9); <span class="comment">//bits 25-27</span>
00814   e1.<a class="code" href="structCrystalID.html#o6">resv</a> = ((b[1] &amp; 0x3000)&gt;&gt;12); <span class="comment">//bits 28-29</span>
00815   e1.<a class="code" href="structCrystalID.html#o7">tag</a> = ((b[1] &amp; 0x4000)&gt;&gt;14); <span class="comment">//bit 30</span>
00816   e1.<a class="code" href="structCrystalID.html#o8">ps</a> = (b[1]&gt;&gt;15); <span class="comment">//bit 31</span>
00817   e1.<a class="code" href="structCrystalID.html#o9">block</a> = getBlockNumber(e1);
00818   <span class="comment">//calculate corresponding block number</span>
00819 
00820   <span class="comment">//second word for second detector</span>
00821   e2.<a class="code" href="structCrystalID.html#o0">dtct</a> = (b[2]&amp; 0x00ff); <span class="comment">//bits 0-7</span>
00822   e2.<a class="code" href="structCrystalID.html#o1">ring</a> = (b[2]&gt;&gt;8); <span class="comment">//bits 8-15</span>
00823   e2.<a class="code" href="structCrystalID.html#o2">bank</a> = headIdB[bank];
00824   e2.<a class="code" href="structCrystalID.html#o4">energy</a> = ((b[3]&amp; 0x38)&gt;&gt;3); <span class="comment">//bits 19-21</span>
00825   e2.<a class="code" href="structCrystalID.html#o3">layer</a> = 1-((b[3]&amp; 0x01c0)&gt;&gt;6); <span class="comment">//bits 22-24</span>
00826   e2.<a class="code" href="structCrystalID.html#o5">tof</a> = ((b[3]&amp; 0x0e00)&gt;&gt;9); <span class="comment">//bits 25-27</span>
00827   e2.<a class="code" href="structCrystalID.html#o6">resv</a> = ((b[3]&amp; 0x3000)&gt;&gt;12); <span class="comment">//bits 28-29</span>
00828   e2.<a class="code" href="structCrystalID.html#o7">tag</a> = ((b[3]&amp; 0x4000)&gt;&gt;14); <span class="comment">//bit 30</span>
00829   e2.<a class="code" href="structCrystalID.html#o8">ps</a> = (b[3]&gt;&gt;15); <span class="comment">//bit 31</span>
00830   e2.<a class="code" href="structCrystalID.html#o9">block</a> = getBlockNumber(e2);
00831   <span class="comment">//calculate corresponding block number</span>
00832   <span class="comment">// if(e1.ring==e2.ring) zHist(e1.ring)++;</span>
00833 
00834   <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scanner = <a class="code" href="classHRRTScannerParams.html#e0">HRRTScannerParams::getInstance</a>();
00835   
00836   <span class="keywordflow">if</span>(e1.<a class="code" href="structCrystalID.html#o2">bank</a> == 10 || e2.<a class="code" href="structCrystalID.html#o2">bank</a> == 10 
00837      || e1.<a class="code" href="structCrystalID.html#o0">dtct</a> &gt;= scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a> ||e2.<a class="code" href="structCrystalID.html#o0">dtct</a> &gt;= scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o11">nDtct</a>
00838      || e1.<a class="code" href="structCrystalID.html#o3">layer</a> &gt;= scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a> || e2.<a class="code" href="structCrystalID.html#o3">layer</a> &gt;= scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o3">nLayer</a>
00839      || e1.<a class="code" href="structCrystalID.html#o1">ring</a> &gt;= scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a> || e2.<a class="code" href="structCrystalID.html#o1">ring</a> &gt;= scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o12">nRing</a> ) {
00840      printErrEvent(b,e1,e2,bank);
00841     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00842   }
00843   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00844 }
00845 
00849 <span class="keywordtype">bool</span> HRRTHouseList::unProcessEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, 
00850                                        <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, 
00851                                        <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2)
00852 {
00853   <span class="keywordtype">int</span> headIdA[32] = {10,0,0,0,0,0,1,1,1,1,1,2,2,2,2,3,3,3,
00854                      4,4,5,10,10,10,10,10,10,10,10,10,10,10};<span class="comment">//header coding</span>
00855   <span class="keywordtype">int</span> headIdB[32] = {10,2,3,4,5,6,3,4,5,6,7,4,5,6,7,5,6,7,
00856                      6,7,7,10,10,10,10,10,10,10,10,10,10,10}; <span class="comment">//header coding</span>
00857   <span class="keywordtype">int</span> bank = -1; <span class="comment">//index in the header coding array</span>
00858   <span class="keywordtype">int</span> bank1, bank2;
00860   b[0]=b[1]=b[2]=b[3] = 0;
00861   <span class="comment">//switch e1 and e2 if necessary</span>
00862   <span class="keywordflow">if</span>(e1.<a class="code" href="structCrystalID.html#o2">bank</a>&gt;e2.<a class="code" href="structCrystalID.html#o2">bank</a>){
00863     <a class="code" href="structCrystalID.html">CrystalID</a> eTemp = e1;
00864     e1 = e2;
00865     e2 = eTemp;
00866   }
00867   <span class="comment">//first word for first detector</span>
00868   b[0] = b[0] | e1.<a class="code" href="structCrystalID.html#o0">dtct</a>;   <span class="comment">//bits 0-7</span>
00869   b[0] = b[0] | (e1.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;8); <span class="comment">//bits 8-15</span>
00870   <span class="comment">//find the bank number</span>
00871   <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i =0 ; i&lt;32; i++){
00872     <span class="keywordflow">if</span>(e1.<a class="code" href="structCrystalID.html#o2">bank</a> == headIdA[i] &amp;&amp; e2.<a class="code" href="structCrystalID.html#o2">bank</a> == headIdB[i]){
00873       bank=i;
00874       <span class="keywordflow">break</span>;
00875     }
00876   }
00877   <span class="keywordflow">if</span>(bank&lt;0){
00878     cout&lt;&lt;<span class="stringliteral">"Error in find header coding "</span>&lt;&lt;endl;
00879     cout&lt;&lt;<span class="stringliteral">"bank 1 is "</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;endl;
00880     cout&lt;&lt;<span class="stringliteral">"bank 2 is "</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;endl;
00881     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00882   }
00883   bank1 = bank &amp; 0x7; <span class="comment">//bits  0-2 of bank to bank1</span>
00884   b[1] = b[1] | bank1; <span class="comment">//bits 16-18</span>
00885   <span class="keywordtype">int</span> layer = 1- e1.<a class="code" href="structCrystalID.html#o3">layer</a>; <span class="comment">//inverse</span>
00886   b[1] = b[1] | (layer&lt;&lt;6); <span class="comment">//bits 22-24</span>
00887   <span class="comment">//done the first word</span>
00888   
00889   <span class="comment">//second word for second detector</span>
00890   b[2] = b[2]|e2.<a class="code" href="structCrystalID.html#o0">dtct</a>; <span class="comment">//bits 0-7</span>
00891   b[2] = b[2]|(e2.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;8); <span class="comment">//bits 8-15 </span>
00892   bank2 = bank&gt;&gt;3;<span class="comment">//bits 3-5 of bank to bank2</span>
00893   b[3] = b[3] | bank2; <span class="comment">//bits 16-18</span>
00894   layer = 1- e2.<a class="code" href="structCrystalID.html#o3">layer</a>; <span class="comment">//inverse</span>
00895   b[3] = b[3] | (layer&lt;&lt;6); <span class="comment">//bits 22-24</span>
00896   b[3] = b[3] | 0x4000; <span class="comment">//bit 30 is 1, for prompt</span>
00897   b[3] = b[3] | 0x8000; <span class="comment">//bit 31 is 1, for synchronize</span>
00898   <span class="keywordflow">return</span> <span class="keyword">true</span>;
00899 }
00900 
00901 <span class="comment">//-------------------------------------------------------------------------</span>
00902 <span class="comment">//decode the bits for a non event</span>
00903 <span class="comment">//-------------------------------------------------------------------------</span>
00904 <span class="keywordtype">void</span> HRRTHouseList::processNonEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00905 {
00906   <span class="keywordflow">if</span> (isTimeTag(b)) {<span class="comment">//Time tag</span>
00907     time.thisTimeTag = processTimeTag(b);
00908     stat.nT ++;
00909     <span class="keywordflow">if</span>(mode ==ListMode) outPutStatistics();
00910   }
00911 
00912   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isSinglesTag(b)){ <span class="comment">//Single Tag</span>
00913    processSinglesTag(b);
00914    <span class="keywordflow">if</span>(params-&gt;algorithm.name == <span class="stringliteral">"simulation"</span>){
00915      <span class="comment">// Assign the current block singles tag to the appropriate array</span>
00916      <span class="comment">// element in the singles packet array.</span>
00917      <span class="keywordtype">int</span> index = time.thisTimeTag - time.frameStartTimeTag;
00918      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;4; i++){
00919        houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r6">singlesPackets</a>(index).b[i] = b[i];
00920      }
00921    }
00922    stat.nS ++;
00923     
00924   }
00925   <span class="keywordflow">else</span>  {
00926     <span class="keywordflow">if</span>(params-&gt;frame.verbosity&gt;=2)
00927       cout&lt;&lt;<span class="stringliteral">"Unknown non-event tag ..."</span>&lt;&lt;endl;
00928     stat.nBadNonEvents++;
00929   }
00930 }
00931 
00938 <span class="keywordtype">void</span> HRRTHouseList::unProcessTimeTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, <span class="keywordtype">int</span> timeTag)
00939 {
00940   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> mask = 0xffff;
00941   <span class="comment">//init b</span>
00942   b[0]=b[1]=b[2]=b[3] = 0;
00943   <span class="comment">//word 1</span>
00944   b[0] = timeTag &amp; mask; <span class="comment">//bits 0-15</span>
00945   b[1] = b[1] | 0x4000; <span class="comment">//bit 30 indicates a non event</span>
00946   <span class="comment">//end of word1</span>
00947 
00948   <span class="comment">//word2</span>
00949   b[2] = timeTag &gt;&gt;16; <span class="comment">//bits 0-12</span>
00950   b[2] |= 0x8000; <span class="comment">//bits 13 -15 indicate a time tag</span>
00951   b[3] = b[3] | 0x8000; <span class="comment">//bit 31 is 1, for synchronize</span>
00952   <span class="comment">//end of word2</span>
00953 }
00954 
00955 <span class="comment">//get an event from the list mode file backward</span>
00956 <span class="keywordtype">bool</span> HRRTHouseList::findPreviousEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00957 {
00958   <span class="keywordflow">return</span> <a class="code" href="classTOC.html#e2">TOC::findPreviousEvent</a>(b, lun); 
00959 }
00960 
00961 
00962 
00963 <span class="comment">//get an event from the list mode file</span>
00964 <span class="keywordtype">bool</span> HRRTHouseList::findNextEvent(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b)
00965 {
00966   <span class="keywordflow">return</span> <a class="code" href="classTOC.html#e3">TOC::findNextEvent</a>(b,lun); 
00967 }
00968 
00969 <span class="comment">//-----------------------------------------------------------------------------</span>
00970 <span class="comment">//calculate the block number in which the detecter is from detecter info</span>
00971 <span class="comment">//i.e., detector axial index in the bank, layer index, bank index, </span>
00972 <span class="comment">//detector tranxial index in the bank</span>
00973 <span class="comment">//-----------------------------------------------------------------------------</span>
00974 <span class="keywordtype">int</span> HRRTHouseList::getBlockNumber(<span class="keyword">const</span> <a class="code" href="structCrystalID.html">CrystalID</a> &amp; e1)
00975 {
00976   <span class="keywordtype">int</span> blockNumber =e1.<a class="code" href="structCrystalID.html#o2">bank</a>*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o1">blockPerBankX</a>*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o2">blockPerBankZ</a>
00977     + (e1.<a class="code" href="structCrystalID.html#o1">ring</a>/scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o0">dtctPerBlock</a>)*scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o1">blockPerBankX</a>
00978     + e1.<a class="code" href="structCrystalID.html#o0">dtct</a>/scanner-&gt;<a class="code" href="classHRRTScannerParams.html#o0">dtctPerBlock</a>;
00979   <span class="keywordflow">return</span> blockNumber;
00980 }
00981 <span class="comment">//---------------------------------------------------------------------</span>
00982 <span class="comment">//output to users</span>
00983 <span class="comment">//---------------------------------------------------------------------</span>
00984 <span class="keywordtype">void</span> HRRTHouseList::outPutStatistics()
00985 {
00986   <span class="keywordtype">int</span> vv; <span class="comment">//verbosity value</span>
00987   stringstream ss;
00988   ss&lt;&lt;<span class="stringliteral">"---------------------------------------------------"</span>&lt;&lt;endl;
00989   ss&lt;&lt;<span class="stringliteral">"Current time tag is "</span>&lt;&lt;this-&gt;time.thisTimeTag&lt;&lt;endl;
00990   ss&lt;&lt;<span class="stringliteral">"Totally "</span>&lt;&lt;this-&gt;stat.nRead&lt;&lt;<span class="stringliteral">" events read in"</span>&lt;&lt;endl;
00991   ss&lt;&lt;<span class="stringliteral">"Among them "</span>&lt;&lt;this-&gt;stat.nEvent&lt;&lt;<span class="stringliteral">" are events"</span>&lt;&lt;endl;
00992   ss&lt;&lt;<span class="stringliteral">"           "</span>&lt;&lt;this-&gt;stat.nPrompt&lt;&lt;<span class="stringliteral">" are prompts"</span>&lt;&lt;endl;
00993   ss&lt;&lt;<span class="stringliteral">"           "</span>&lt;&lt;this-&gt;stat.nRandom&lt;&lt;<span class="stringliteral">" are randoms"</span>&lt;&lt;endl;
00994   ss&lt;&lt;<span class="stringliteral">"           "</span>&lt;&lt;this-&gt;stat.nAccept&lt;&lt;<span class="stringliteral">" prompts accepted"</span>&lt;&lt;endl;
00995   ss&lt;&lt;<span class="stringliteral">"           "</span>&lt;&lt;this-&gt;stat.nReject&lt;&lt;<span class="stringliteral">" prompts rejected"</span>&lt;&lt;endl;
00996   ss&lt;&lt;<span class="stringliteral">"           "</span>&lt;&lt;this-&gt;stat.nNonEvent&lt;&lt;<span class="stringliteral">" are nonevents"</span>&lt;&lt;endl;
00997   ss&lt;&lt;<span class="stringliteral">"Totally "</span>&lt;&lt;this-&gt;stat.nSkip
00998     &lt;&lt;<span class="stringliteral">" 32-bit words are skipped due to synchronization"</span>&lt;&lt;endl;
00999   ss&lt;&lt;<span class="stringliteral">"---------------------------------------------------"</span>&lt;&lt;endl;
01000   <span class="comment">//ss&lt;&lt;stat.nAccept&lt;&lt;" events appended to event lists"&lt;&lt;endl;</span>
01001   ss&lt;&lt;stat.nAccept&lt;&lt;<span class="stringliteral">" events appended to event lists"</span>;
01002   <span class="comment">//ss&lt;&lt;endl;</span>
01003   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
01004   <span class="keywordflow">if</span>((time.thisTimeTag&gt;=this-&gt;time.requestedFrameStopTimeTag
01005       &amp;&amp; ! params-&gt;frame.processWholeFile)
01006      || feof(this-&gt;lun))
01007     {
01008       vv = 0;
01009       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME,vv);
01010       <span class="keywordflow">return</span>;
01011     }
01012                 
01013   stringstream ss1;
01014   ss1&lt;&lt;stat.nAccept&lt;&lt;<span class="stringliteral">" events appended to event lists"</span>&lt;&lt;endl;
01015   vv = params-&gt;frame.verbosity;
01016   <span class="keywordflow">if</span> (vv&gt;0) {
01017    <span class="keywordflow">if</span>(vv&gt;=5) vv=5;
01018    <span class="keywordflow">if</span>(vv&lt;3){
01019      <span class="keywordflow">if</span>((this-&gt;time.thisTimeTag%(Constant::VERBFCTR/vv)) == 0 )
01020        log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss1.str(),FRAME,vv);
01021    }
01022    <span class="keywordflow">else</span>
01023      <span class="keywordflow">if</span>(this-&gt;time.thisTimeTag%(Constant::VERBFCTR/(vv)) == 0){
01024        log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME,vv);
01025        <span class="keywordflow">return</span>;
01026      }
01027   }
01028 }
01029 
01030 <span class="comment">//--------------------------------------------------------------------</span>
01031 <span class="comment">//output to users</span>
01032 <span class="comment">//--------------------------------------------------------------------</span>
01033 <span class="keywordtype">void</span> HRRTHouseList::outPutRandomStatistics()
01034 {
01035   <span class="keywordtype">int</span> vv; <span class="comment">//verbosity value</span>
01036   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();
01037   
01038   stringstream ss1;
01039   <span class="comment">//ss1&lt;&lt;stat.nAccept&lt;&lt;" events appended to event lists"&lt;&lt;endl;</span>
01040   ss1&lt;&lt;stat.nAccept&lt;&lt;<span class="stringliteral">" events appended to event lists"</span>;
01041 
01042   vv = params-&gt;frame.verbosity;
01043   <span class="keywordflow">if</span>(vv&gt;=5) vv=5;
01044   log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss1.str(),FRAME,vv);
01045 
01046 }
01047 
01048 
01049     
01050 
01051 <span class="comment">/******************************************************</span>
01052 <span class="comment"> * putNextEvent() - Called from</span>
01053 <span class="comment"> * AlgorithmSimulation::collectDistribute()</span>
01054 <span class="comment"> * This function takes a fully-formed event packet, extracts the</span>
01055 <span class="comment"> * fundamental identifying variables, and decodes them into a</span>
01056 <span class="comment"> * raw-event (a 64-bit word) for output to a list-mode file</span>
01057 <span class="comment"> * representing a simulation  realization.  It keeps track of the</span>
01058 <span class="comment"> * current (or, actually "previous") time tag for a particular</span>
01059 <span class="comment"> * realization.  When the time tag changes, this function also writes</span>
01060 <span class="comment"> * out a time stamp event and a block singles event.</span>
01061 <span class="comment"> *@param event the event to be written</span>
01062 <span class="comment"> *@param realiz - The realization number which identifies the file to</span>
01063 <span class="comment"> *be written .  </span>
01064 <span class="comment"> *@return true if everything OK, false if errors in I/O or unProcessEvent</span>
01065 <span class="comment"></span>
01066 <span class="comment"> */</span>
01067 <span class="keywordtype">bool</span> HRRTHouseList::putNextEvent(<a class="code" href="classEventPacket.html">EventPacket</a> &amp; event, <span class="keywordtype">int</span> realiz)
01068 {
01069   <span class="keyword">static</span> <span class="keywordtype">bool</span> firstCall = <span class="keyword">true</span>;
01070   <span class="keyword">static</span> <span class="keywordtype">int</span> * previousTimeTag;
01071   <a class="code" href="classHRRTHouseEvent.html">HRRTHouseEvent</a> *houseEvent= HRRTHouseEvent::getInstance();
01072   <a class="code" href="structCrystalID.html">CrystalID</a> e1, e2;
01073   <span class="keywordtype">int</span> timeTag;
01074   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> b[4];
01075   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> btime[4];    <span class="comment">// raw event to contain time tag</span>
01076   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> bsingles[4]; <span class="comment">// raw event to store block singles</span>
01077   <span class="comment">//get crystal ID from the event</span>
01078   e1 = houseEvent-&gt;<a class="code" href="classHRRTHouseEvent.html#d7">getHrrtId</a>(event.<a class="code" href="classEventPacket.html#o26">crystalNumber1</a>);
01079   e2 = houseEvent-&gt;<a class="code" href="classHRRTHouseEvent.html#d7">getHrrtId</a>(event.<a class="code" href="classEventPacket.html#o27">crystalNumber2</a>);
01080   timeTag = event.<a class="code" href="classEventPacket.html#o20">timeStamp</a>;
01081   <a class="code" href="classFrameInfo.html">FrameInfo</a> &amp;frameInfo = *FrameInfo::getInstance();
01082   <span class="keywordtype">int</span> frameStartTimeTag =  frameInfo.<a class="code" href="classFrameInfo.html#o15">frameStartTimeTag</a>;
01083   <span class="keywordflow">if</span>(firstCall){
01084     <span class="comment">// Allocate and initialize the previous time tags.</span>
01085     previousTimeTag = (<span class="keywordtype">int</span> *)calloc(params-&gt;algorithm.numRealizations, 
01086                                     <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
01087     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ir=0;ir &lt; params-&gt;algorithm.numRealizations;ir++)
01088       previousTimeTag[ir]=timeTag;
01089     <span class="comment">// Since we are in the first invocation of this function, we need to</span>
01090     <span class="comment">// write out the first time tag and block singles tag for every</span>
01091     <span class="comment">// realization-file that this processor is responsible for. </span>
01092     unProcessTimeTag(btime, timeTag);
01093     <span class="comment">//write the first time tag</span>
01094     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ir = 0; ir &lt; params-&gt;algorithm.numRealizations; ir++){
01095       <span class="keywordflow">if</span>((ir% status-&gt;numProcs)==status-&gt;proc){
01096         <span class="keywordflow">if</span>(fwrite(btime, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, 
01097                   outfp[realiz/status-&gt;numProcs])!=4){
01098           cout &lt;&lt; <span class="stringliteral">"*****  Fatal error in HRRTHouseList::putNextEvent() writing"</span>
01099                &lt;&lt; <span class="stringliteral">" the first time stamp to realization "</span> &lt;&lt; realiz &lt;&lt; endl;
01100           <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01101         }
01102       
01103         <span class="comment">// Now write out the appropriate block-singles packet</span>
01104         <span class="keywordtype">int</span> spIndex = timeTag -frameStartTimeTag;
01105         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=0;ii&lt;4;ii++)
01106           bsingles[ii]=houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r6">singlesPackets</a>(spIndex).b[ii];
01107         <span class="keywordflow">if</span>(bsingles[0] == 0 &amp;&amp; bsingles[1] == 0 &amp;&amp; bsingles[2] == 0 &amp;&amp; bsingles[3] == 0) {
01108           <span class="keywordflow">if</span>(params-&gt;algorithm.verbosity &gt;=2)
01109             cout&lt;&lt;<span class="stringliteral">"singles packet missing for timeTag :"</span>&lt;&lt;timeTag&lt;&lt;
01110                   <span class="stringliteral">" singles packet Index : "</span>&lt;&lt;spIndex&lt;&lt;endl;    
01111         } <span class="keywordflow">else</span> 
01112         <span class="keywordflow">if</span>(fwrite(bsingles, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4,
01113                   outfp[realiz/status-&gt;numProcs])!=4){
01114           cout &lt;&lt; <span class="stringliteral">"Fatal error: Failure to write a time tag in putNextEvent"</span> 
01115                &lt;&lt; <span class="stringliteral">", realization "</span>&lt;&lt; realiz &lt;&lt; <span class="stringliteral">", processor "</span> &lt;&lt; status-&gt;proc
01116                &lt;&lt; endl;
01117           <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01118         }
01119       }
01120     }
01121     firstCall = <span class="keyword">false</span>;
01122   }
01123 
01124   <span class="keywordflow">else</span>{  <span class="comment">// Not the first call, so we only put the time tag and</span>
01125          <span class="comment">// singles in if the time tag has actually changed.</span>
01126     <span class="comment">//update time tag if necessary</span>
01127     <span class="keywordflow">if</span>(previousTimeTag[realiz] &lt; timeTag){
01128       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> btime[4], bsingle[4];
01129       <span class="comment">//write a time tag</span>
01130       unProcessTimeTag(btime, timeTag);
01131       <span class="keywordflow">if</span>(fwrite(btime, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4,
01132                  outfp[realiz/status-&gt;numProcs])!=4){
01133         cout &lt;&lt; <span class="stringliteral">"Fatal error: Failure to write a time tag in putNextEvent"</span> 
01134              &lt;&lt; <span class="stringliteral">", realization "</span>&lt;&lt; realiz &lt;&lt; <span class="stringliteral">", processor "</span> &lt;&lt; status-&gt;proc
01135              &lt;&lt; endl;
01136         <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01137       }
01138       <span class="comment">// Now write out the appropriate block-singles packet</span>
01139       <span class="keywordtype">int</span> spIndex = timeTag - frameStartTimeTag;
01140       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=0;ii&lt;4;ii++)
01141         bsingles[ii]=houseSingles-&gt;<a class="code" href="classHRRTHouseSingles.html#r6">singlesPackets</a>(spIndex).b[ii];
01142       <span class="keywordflow">if</span>(bsingles[0] == 0 &amp;&amp; bsingles[1] == 0 &amp;&amp; bsingles[2] == 0 &amp;&amp; bsingles[3] == 0) {
01143         <span class="keywordflow">if</span>(params-&gt;algorithm.verbosity &gt;=2)
01144           cout&lt;&lt;<span class="stringliteral">"singles packet missing for timeTag :"</span>&lt;&lt;timeTag&lt;&lt;
01145               <span class="stringliteral">" singles packet Index : "</span>&lt;&lt;spIndex&lt;&lt;endl;        
01146       } <span class="keywordflow">else</span> 
01147       <span class="keywordflow">if</span>(fwrite(bsingles, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4,
01148                  outfp[realiz/status-&gt;numProcs])!=4){
01149         cout &lt;&lt; <span class="stringliteral">"Fatal error: Failure to write a time tag in putNextEvent"</span> 
01150              &lt;&lt; <span class="stringliteral">", realization "</span>&lt;&lt; realiz &lt;&lt; <span class="stringliteral">", processor "</span> &lt;&lt; status-&gt;proc
01151              &lt;&lt; endl;
01152         <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01153       }
01154 
01155     }
01156   
01157     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(previousTimeTag[realiz] &gt;timeTag){
01158       cout&lt;&lt;<span class="stringliteral">"Fatal error in HRRTHouseList::putNextEvent() on processor "</span>
01159           &lt;&lt; status-&gt;proc &lt;&lt; <span class="stringliteral">"processing realization "</span> &lt;&lt; realiz&lt;&lt;endl
01160           &lt;&lt; <span class="stringliteral">"A situation has been encountered where previousTimeTag = "</span>
01161           &lt;&lt; previousTimeTag[realiz] &lt;&lt; <span class="stringliteral">" is greater than current timeTag = "</span>
01162           &lt;&lt; timeTag &lt;&lt; endl;
01163       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01164     }
01165   }
01166  
01167   <span class="comment">// Now we do the things that we do every time this function is</span>
01168   <span class="comment">// called.  Specifically, we unprocess the EventPacket and write the</span>
01169   <span class="comment">// raw event to the realization-specific output file.  We also</span>
01170   <span class="comment">// assign the previous time tag to the current one, in preparation</span>
01171   <span class="comment">// for the next call to this function/</span>
01172 
01173   previousTimeTag[realiz] = timeTag;
01174   <span class="comment">//write the event to the file</span>
01175   <span class="keywordflow">if</span>(!unProcessEvent(b, e1, e2)){
01176     cout &lt;&lt; <span class="stringliteral">"Failure in houseList-&gt;unProcsssEvent call from putNextEvent"</span>
01177          &lt;&lt; <span class="stringliteral">", processing "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">", realization "</span>
01178          &lt;&lt; realiz &lt;&lt;<span class="stringliteral">", terminating execution."</span>
01179          &lt;&lt; endl;
01180     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01181   }
01182   <span class="keywordflow">if</span>(fwrite(b, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>), 4, 
01183             outfp[realiz/status-&gt;numProcs])!=4){
01184     cout &lt;&lt; <span class="stringliteral">"Fatal error in HRRTHouseList::putNextEvent() on processor "</span>
01185          &lt;&lt; status-&gt;proc &lt;&lt; endl &lt;&lt; <span class="stringliteral">"Failure writing a raw event, "</span>
01186          &lt;&lt; <span class="stringliteral">"realization "</span> &lt;&lt; realiz &lt;&lt; endl;
01187     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-realiz);
01188   }
01189   
01190 
01191   <span class="keywordflow">return</span> <span class="keyword">true</span>;
01192 }
01193 
01194 
01195 
01196 <span class="comment">/**************************************************</span>
01197 <span class="comment"> * prepareOutput</span>
01198 <span class="comment"> * This is a public function that needs to be called from</span>
01199 <span class="comment"> * AlgorithmSimulation::collectDistribute() prior to the actual</span>
01200 <span class="comment"> * redistribution of events.  It opens the output file corresponding</span>
01201 <span class="comment"> * to realization irealiz.  The filename is formed from the listmode</span>
01202 <span class="comment"> * filename in params-&gt;frame.listmodeFilename, with a substring</span>
01203 <span class="comment"> * inserted identifying the realization in front of the last "."</span>
01204 <span class="comment"> * In the event of an error condition, Utilities::cleanUp() is called.</span>
01205 <span class="comment"> *@param irealiz - Identifies the realization number</span>
01206 <span class="comment"> ***************************/</span>
01207 
01208 <span class="keywordtype">void</span> HRRTHouseList::prepareOutput(<span class="keywordtype">int</span> irealiz)
01209 {
01210   <span class="keyword">static</span> <span class="keywordtype">bool</span> firstcall = <span class="keyword">true</span>;
01211 
01212   <span class="keywordflow">if</span>((irealiz%status-&gt;numProcs)!=status-&gt;proc){
01213     cout&lt;&lt;<span class="stringliteral">"Terminal error conditionin HRRTHouseList::prepareOutput() running"</span>
01214         &lt;&lt;<span class="stringliteral">" on processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" for realization "</span>&lt;&lt;irealiz&lt;&lt;endl
01215         &lt;&lt; <span class="stringliteral">"irealiz%status-&gt;numProcs = "</span>&lt;&lt;irealiz&lt;&lt;<span class="stringliteral">"%"</span>&lt;&lt;status-&gt;numProcs
01216         &lt;&lt;<span class="stringliteral">" = "</span>&lt;&lt;irealiz%status-&gt;numProcs&lt;&lt;<span class="stringliteral">", should be "</span>&lt;&lt; status-&gt;proc
01217         &lt;&lt; endl;
01218     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-1022);
01219   }
01220       
01221   <span class="comment">// 2005-11-29 The next line of code is very funny</span>
01222   <span class="keywordflow">if</span>(firstcall){
01223     outfp = (FILE **)calloc(params-&gt;algorithm.numRealizations/status-&gt;numProcs,
01224                             <span class="keyword">sizeof</span>(FILE *));
01225     firstcall = <span class="keyword">false</span>;
01226   }
01227 
01228   string filename = params-&gt;frame.listmodeFilename;
01229   <span class="keywordtype">int</span> slash=filename.find_last_of(<span class="stringliteral">"/"</span>);
01230   filename=params-&gt;frame.frameDirectory + <span class="stringliteral">"/"</span> + filename.substr(slash+1);
01231   <span class="keywordtype">int</span> index = filename.find_last_of(<span class="stringliteral">"."</span>);
01232   stringstream realizStr;
01233   realizStr&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt; irealiz;
01234   filename.insert(index,realizStr.str());
01235   <span class="keywordflow">if</span>((outfp[irealiz/status-&gt;numProcs]=fopen(filename.c_str(),<span class="stringliteral">"wb"</span>))==0){
01236     cout &lt;&lt; <span class="stringliteral">"Fatal error encountered in HRRTHouseList::prepareOutput "</span>
01237          &lt;&lt; <span class="stringliteral">", processor "</span> &lt;&lt; status-&gt;proc &lt;&lt; endl
01238          &lt;&lt; <span class="stringliteral">", Attemp to open output file "</span> &lt;&lt; filename &lt;&lt; <span class="stringliteral">"failed."</span>&lt;&lt;endl;
01239     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-1023);
01240   }
01241   <span class="keywordflow">if</span>(params-&gt;algorithm.verbosity &gt;=2){
01242     cout &lt;&lt; <span class="stringliteral">"Processor "</span> &lt;&lt; status-&gt;proc &lt;&lt; <span class="stringliteral">" Opened output file "</span> 
01243          &lt;&lt; filename &lt;&lt;<span class="stringliteral">" for realization "</span> 
01244          &lt;&lt; irealiz &lt;&lt; endl;
01245   }
01246 }
01247 
01248 
01249 <span class="comment">/*************************************************************************</span>
01250 <span class="comment"> * finalizeOutput</span>
01251 <span class="comment"> * Called toward the end of AlgorithmSimulation::collectDistribute,</span>
01252 <span class="comment"> * this function closes the output list-mode realization files</span>
01253 <span class="comment"> * assigned to the processor.</span>
01254 <span class="comment"> * If the realization number is not assigned to the current processor,</span>
01255 <span class="comment"> * this function will generate an error condition and call </span>
01256 <span class="comment"> * Utilities::cleanUp()</span>
01257 <span class="comment"> ********************************************/</span>
01258 
01259 <span class="keywordtype">void</span> HRRTHouseList::finalizeOutput(<span class="keywordtype">int</span> irealiz)
01260 {
01261   <span class="keywordflow">if</span>((irealiz%status-&gt;numProcs)!=status-&gt;proc){
01262     cout&lt;&lt;<span class="stringliteral">"Terminal error conditionin HRRTHouseList::prepareOutput() running"</span>
01263         &lt;&lt;<span class="stringliteral">" on processor "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" for realization "</span>&lt;&lt;irealiz&lt;&lt;endl
01264         &lt;&lt; <span class="stringliteral">"irealiz%status-&gt;numProcs = "</span>&lt;&lt;irealiz&lt;&lt;<span class="stringliteral">"%"</span>&lt;&lt;status-&gt;numProcs
01265         &lt;&lt;<span class="stringliteral">" = "</span>&lt;&lt;irealiz%status-&gt;numProcs&lt;&lt;<span class="stringliteral">", should be "</span>&lt;&lt; status-&gt;proc
01266         &lt;&lt; endl;
01267     <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-1022);
01268   }
01269       
01270   
01271   fclose(outfp[irealiz/status-&gt;numProcs]);
01272   <span class="keywordflow">if</span>(params-&gt;algorithm.verbosity &gt;= 2){
01273     cout &lt;&lt; <span class="stringliteral">"Processor "</span>&lt;&lt;status-&gt;proc &lt;&lt; <span class="stringliteral">" closed outputfile pointer number "</span>
01274          &lt;&lt; irealiz/status-&gt;numProcs &lt;&lt; <span class="stringliteral">" for realization "</span> &lt;&lt; irealiz
01275          &lt;&lt; endl;
01276   }
01277   string filename = params-&gt;frame.listmodeFilename;
01278   <span class="keywordtype">int</span> slash=filename.find_last_of(<span class="stringliteral">"/"</span>);
01279   filename=params-&gt;frame.frameDirectory + <span class="stringliteral">"/"</span> + filename.substr(slash+1);
01280   <span class="keywordtype">int</span> index = filename.find_last_of(<span class="stringliteral">"."</span>);
01281   stringstream realizStr;
01282   realizStr&lt;&lt;<span class="stringliteral">"-"</span>&lt;&lt; irealiz;
01283   filename.insert(index,realizStr.str());
01284   string pathTOC = <span class="stringliteral">""</span>;
01285   cout&lt;&lt;<span class="stringliteral">"Creating TOC "</span>&lt;&lt;pathTOC&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;filename&lt;&lt;endl;
01286   <a class="code" href="classTOC.html">TOC</a> toc = <a class="code" href="classTOC.html">TOC</a>(filename,pathTOC);
01287 }
01288 
01289 <span class="keywordtype">void</span> HRRTHouseList::printErrEvent( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, 
01290                                  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e1, 
01291                                  <a class="code" href="structCrystalID.html">CrystalID</a> &amp;e2, <span class="keywordtype">int</span> bank) {
01292    Params &amp;params = *Params::getInstance();
01293    ++stat.nBadEvents;
01294    <span class="keywordflow">if</span>((stat.nBadEvents &lt; 10 || (stat.nBadEvents &lt; 1000 &amp;&amp; (stat.nBadEvents % 100 == 0))
01295       || (stat.nBadEvents &lt; 10000 &amp;&amp; (stat.nBadEvents % 1000 == 0))
01296       || (stat.nBadEvents % 100000 == 0)) &amp;&amp; params.frame.verbosity &gt;= 2) {
01297      cout&lt;&lt;<span class="stringliteral">" Bad 64-bit packet found : "</span>&lt;&lt;endl
01298      &lt;&lt;<span class="stringliteral">" e1.dtct : "</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;&lt;<span class="stringliteral">" e2.dtct : "</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o0">dtct</a>&lt;&lt;endl
01299      &lt;&lt;<span class="stringliteral">" e1.layer : "</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o3">layer</a>&lt;&lt;<span class="stringliteral">" e2.layer : "</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o3">layer</a>&lt;&lt;endl
01300      &lt;&lt;<span class="stringliteral">" e1.ring : "</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;<span class="stringliteral">" e2.ring : "</span>&lt;&lt;e2.<a class="code" href="structCrystalID.html#o1">ring</a>&lt;&lt;endl
01301      &lt;&lt;<span class="stringliteral">" e1.bank : "</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;<span class="stringliteral">" e2.bank : "</span>&lt;&lt;e1.<a class="code" href="structCrystalID.html#o2">bank</a>&lt;&lt;<span class="stringliteral">" bank : "</span>&lt;&lt;bank&lt;&lt;endl;
01302      printf(<span class="stringliteral">"64-bit packet : b0 : %x b1 : %x b2 : %x b3 : %x\n"</span>,b[0],b[1],b[2],b[3]);
01303      cout&lt;&lt;<span class="stringliteral">"No. of error packets found so far: "</span>&lt;&lt;stat.nBadEvents&lt;&lt;endl;
01304    } 
01305 }
01306 
01307 <span class="keywordtype">float</span> HRRTHouseList::fixSinglesFactor(<span class="keywordtype">int</span> timeTag)
01308   {
01309     <span class="keywordflow">if</span> ((sing_fix_time &lt;= 0.) || (timeTag &lt; sing_fix_time)) {
01310         sing_fix=1.;
01311     } <span class="keywordflow">else</span> {
01312         sing_fix=exp(-sing_fix_constant*(timeTag - sing_fix_time));
01313         <span class="comment">// report value every 5 min or 300000 msec</span>
01314         <span class="keywordflow">if</span> (timeTag &gt; sing_fix_last_report+ 60000) {
01315          cout&lt;&lt;<span class="stringliteral">"Singles fix factor at "</span>&lt;&lt;timeTag&lt;&lt;<span class="stringliteral">" msec is "</span>&lt;&lt;sing_fix&lt;&lt;endl;
01316          sing_fix_last_report=timeTag;
01317         } 
01318    }
01319    <span class="keywordflow">return</span> (sing_fix);
01320    }
01321 
01322 <span class="keywordtype">int</span> HRRTHouseList::FileSize(<span class="keyword">const</span> <span class="keywordtype">char</span>* sFileName)
01323 {
01324   std::ifstream f;
01325   f.open(sFileName, std::ios_base::binary | std::ios_base::in);
01326   <span class="keywordflow">if</span> (!f.good() || f.eof() || !f.is_open()) { <span class="keywordflow">return</span> 0; }
01327   f.seekg(0, std::ios_base::beg);
01328   std::ifstream::pos_type begin_pos = f.tellg();
01329   f.seekg(0, std::ios_base::end);
01330   <span class="keywordflow">return</span> static_cast&lt;int&gt;(f.tellg() - begin_pos);
01331 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
