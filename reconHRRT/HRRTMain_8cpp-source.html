<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: HRRTMain.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>HRRTMain.cpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#include "IOConfig.hpp"</span>
00002 <span class="preprocessor">#include &lt;mpi.h&gt;</span>
00003 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00004 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00005 <span class="preprocessor">#include "House.hpp"</span>
00006 <span class="preprocessor">#include "Params.hpp"</span>
00007 <span class="preprocessor">#include "EventList.hpp"</span>
00008 <span class="preprocessor">#include "MOLAR.hpp"</span>
00009 <span class="preprocessor">#include "Image.hpp"</span>
00010 <span class="preprocessor">#include "Log.hpp"</span>
00011 <span class="preprocessor">#include "Algorithm.hpp"</span>
00012 <span class="preprocessor">#include "AlgorithmOSEM.hpp"</span>
00013 
00014 <span class="comment">// 2004-07-26 Avoided Q computation for sinogram</span>
00015 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
00016 {
00017   MPI::Init(argc, argv); <span class="comment">//MPI init</span>
00018 
00019   time_t time_HRRT1 = time((time_t *)0);
00020   string xmlFilename=argv[1];
00021   Params &amp;params = *Params::getInstance();
00022   <span class="comment">//parse the params xml file</span>
00023   params.parse(xmlFilename);
00024   <span class="comment">//init status</span>
00025   Status * status=Status::getStatus();
00026   status-&gt;init(params, argc, argv);   <span class="comment">// status init</span>
00027   <span class="keywordflow">if</span>((params.frame.useStartingImage || params.frame.usePreviousResult)
00028      &amp;&amp;params.frame.startingIteration == -1)
00029     status-&gt;read();
00030   <a class="code" href="classLog.html">Log</a> * log = <a class="code" href="classLog.html#e0">Log::getLog</a>();<span class="comment">//set log</span>
00031   log-&gt;<a class="code" href="classLog.html#a0">setVerbosity</a>(params);<span class="comment">//set verbosity</span>
00032 
00033      <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00034            status-&gt;printMemInfo();
00035       }
00036 
00037   <span class="comment">//init MOLAR</span>
00038   <a class="code" href="classMOLAR.html">MOLAR</a> *molar = <a class="code" href="classMOLAR.html#e0">MOLAR::getInstance</a>();
00039 
00040   <span class="comment">//scatter needs mu</span>
00041   <a class="code" href="classImage.html">Image</a> mu(params.geometry, <span class="stringliteral">"RAW"</span>, params.frame.outputDataType);
00042   <a class="code" href="structParams_1_1Extensions.html">Params::Extensions</a> ext;
00043   ext.<a class="code" href="structParams_1_1Extensions.html#o2">raw</a> = params.extensions.raw;
00044   <span class="comment">// try to read mu image if needed</span>
00045   <span class="keywordflow">if</span>(params.attenuation.enable || params.modelBasedScatter.enable || params.frame.enableBoundsCheck ){
00046    <span class="keywordflow">if</span> (params.attenuation.muImageFilename == <span class="stringliteral">""</span>)  {
00047      string messg = <span class="stringliteral">"No attenuation file specified. Required because either attenuation, scatter, or bounds check enabled"</span>;
00048      log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(messg,FRAME, 0);
00049      Status::StatusCode code=Status::ERROR;
00050      status-&gt;update(messg,code);
00051      <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00052    }
00053    <span class="keywordtype">bool</span> muExist=mu.<a class="code" href="classImage.html#a7">read</a>(params.attenuation.muImageFilename, ext);
00054    <span class="comment">//Error in reading mu image, program aborted</span>
00055    <span class="keywordflow">if</span>(!muExist ){
00056      string messg = <span class="stringliteral">"Error in reading mu image ("</span>+params.attenuation.muImageFilename+
00057          <span class="stringliteral">"), program aborted"</span>;
00058      log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(messg,FRAME, 0);
00059      Status::StatusCode code=Status::ERROR;
00060      status-&gt;update(messg,code);
00061      <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00062    }
00063    <span class="keywordflow">if</span> (params.attenuation.muScale &lt;= 0.0) {
00064      string messg = <span class="stringliteral">"muScale value is &lt;= 0. This is inappropriate: program aborted"</span>;
00065      log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(messg,FRAME, 0);
00066      Status::StatusCode code=Status::ERROR;
00067      status-&gt;update(messg,code);
00068      <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00069    }
00070    mu.<a class="code" href="classImage.html#a16">scale</a>(params, params.attenuation.muScale);
00071    <span class="comment">// 2007-08-28 rc - shift transmission scan based on geometry values, if necessary</span>
00072    <span class="keywordflow">if</span> ((params.geometry.offsetX != 0.0) || (params.geometry.offsetY != 0.0) || (params.geometry.offsetZ != 0.0) ) {
00073      <span class="keywordflow">if</span>(status-&gt;proc == 0)
00074       cout&lt;&lt;<span class="stringliteral">"Shifting transmission image by "</span>&lt;&lt;params.geometry.offsetX&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;params.geometry.offsetY&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;
00075         params.geometry.offsetZ&lt;&lt;<span class="stringliteral">" mm"</span>&lt;&lt;endl;
00076      <span class="comment">// being lazy - shifting by an integer</span>
00077      <span class="keywordtype">int</span> idx=<a class="code" href="classUtilities.html#e3">Utilities::nint</a> (params.geometry.offsetX / params.geometry.dX);
00078      <span class="keywordtype">int</span> idy=<a class="code" href="classUtilities.html#e3">Utilities::nint</a>  (params.geometry.offsetY / params.geometry.dY);
00079      <span class="keywordtype">int</span> idz=<a class="code" href="classUtilities.html#e3">Utilities::nint</a> (params.geometry.offsetZ / params.geometry.dZ);
00080      <span class="keywordflow">if</span>(status-&gt;proc == 0)
00081       cout&lt;&lt;<span class="stringliteral">"Shifting transmission image by "</span>&lt;&lt;idx&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;idy&lt;&lt;<span class="stringliteral">" "</span>&lt;&lt;
00082         idz&lt;&lt;<span class="stringliteral">" pixels"</span>&lt;&lt;endl;
00083     <a class="code" href="classImage.html">Image</a> mutemp(params.geometry, <span class="stringliteral">"RAW"</span>, params.frame.outputDataType);
00084     mutemp = mu;        <span class="comment">// copy in</span>
00085     <span class="comment">// zero mu image</span>
00086     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0;iz &lt; params.geometry.nZ; iz++)
00087      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0;iy &lt; params.geometry.nY; iy++)
00088       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix = 0;ix &lt; params.geometry.nX; ix++)
00089        mu(ix,iy,iz)=0.0;
00090     <span class="comment">// offsets are subtracted from detector locations (see HRRTHouseEvent.cpp)</span>
00091     <span class="comment">//  so positive offset means move a coordinate to a lower position  </span>
00092     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = max(0,-idz);iz &lt; params.geometry.nZ-max(0,idz); iz++)
00093      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = max(0,-idy);iy &lt; params.geometry.nY-max(0,idy); iy++)
00094       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix = max(0,-idx);ix &lt; params.geometry.nX-max(0,idx); ix++)
00095        mu(ix,iy,iz)=mutemp(ix+idx,iy+idy,iz+idz);
00096    }
00097     
00098   }
00099   <span class="comment">//init the scatter correction</span>
00100   ScatterCorrection * scatterCorrection = molar-&gt; getScatterCorrection();
00101   <span class="keywordflow">if</span>(params.randoms.enable || params.modelBasedScatter.enable)
00102     <span class="keywordflow">if</span>(!scatterCorrection-&gt;init(mu)){
00103       cout&lt;&lt;<span class="stringliteral">"Error in scatterCorrection init"</span>;
00104       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00105     }
00106 
00107   <span class="comment">//init Q to zero</span>
00108   string fileType =params.frame.outputFileType, 
00109     dataType = params.frame.outputDataType;
00110   <span class="comment">//Q image</span>
00111   <a class="code" href="classImage.html">Image</a> Q(params.geometry,fileType, dataType);
00112   <span class="comment">//lamda image</span>
00113   <a class="code" href="classImage.html">Image</a> lambda(params.geometry,fileType, dataType);
00114   <span class="comment">//mask image for Q calculation - only used if attenuation is present</span>
00115   <a class="code" href="classArray3D.html">Array3D&lt;char&gt;</a> QMask(params.geometry.nX, params.geometry.nY, 
00116                      params.geometry.nZ);
00117   <span class="comment">//mask image for lambda</span>
00118   <a class="code" href="classArray3D.html">Array3D&lt;char&gt;</a> lambdaMask(params.geometry.nX, params.geometry.nY, 
00119                      params.geometry.nZ);
00120   <span class="keywordflow">if</span> (params.frame.enableBoundsCheck) {
00121    <span class="comment">// pass mu to calculate QMask and lambdaMask</span>
00122    molar-&gt;<a class="code" href="classMOLAR.html#a22">calculateMaskMu</a>(QMask, lambdaMask, mu, params);
00123   }
00124   
00125       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00126            status-&gt;printMemInfo();
00127       }
00128   <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 3) {
00129    cout&lt;&lt;<span class="stringliteral">"Returned from calculateMaskMu: process "</span>&lt;&lt;status-&gt;proc&lt;&lt;endl;
00130   }
00131   <span class="comment">//pointer to eventlist</span>
00132   <a class="code" href="classEventList.html">EventList</a> *eventList=0;
00133   <span class="comment">// This is not correct now - sinogram is not an algorithm</span>
00134   <span class="keywordflow">if</span>(params.algorithm.name != <span class="stringliteral">"sinogram"</span>) {
00135     <span class="comment">// refine region of support, enscribing cylinder</span>
00136     <span class="comment">//molar-&gt;initializeMu(params, mu);</span>
00137     <span class="comment">//if Q exists, read it</span>
00138     string outPutExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00139     string fileNameQ=params.frame.frameDirectory+<span class="stringliteral">"/Q"</span>+
00140       params.frame.outputFileNameBase+<span class="stringliteral">"."</span>+outPutExt;
00141     ifstream QImg(fileNameQ.c_str());
00142     <span class="keywordflow">if</span>(QImg &amp;&amp; !params.randoms.enable &amp;&amp; ! params.modelBasedScatter.enable){
00143       <span class="keywordflow">if</span>(status-&gt;proc == 0)
00144         cout&lt;&lt;<span class="stringliteral">"Reading Q image from "</span>&lt;&lt;fileNameQ&lt;&lt;endl;
00145       <span class="keywordflow">if</span>(!Q.<a class="code" href="classImage.html#a7">read</a>(fileNameQ, params.extensions)){
00146         cout&lt;&lt;<span class="stringliteral">"Error in reading Q image "</span>&lt;&lt;fileNameQ&lt;&lt;endl;
00147         <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00148       }
00149     }
00150     <span class="keywordflow">else</span> { <span class="comment">// using randomized event list to generate Q</span>
00151       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 3) {
00152        cout&lt;&lt;<span class="stringliteral">"Beginning building of Q: process "</span>&lt;&lt;status-&gt;proc&lt;&lt;endl;
00153       }
00154       eventList = <span class="keyword">new</span> <a class="code" href="classEventList.html">EventList</a>(params.algorithm.numSets);
00155       molar-&gt;<a class="code" href="classMOLAR.html#o5">timeReadBuildEventList1</a> = time((time_t *) 0);
00156       <span class="comment">//building randomized event list</span>
00157       <span class="comment">// In the case of simulation, the meaning of nSimEvents is synonymous</span>
00158       <span class="comment">// with n_Q.  The House functions use n_Q</span>
00159       <span class="keywordflow">if</span>(params.algorithm.name==<span class="stringliteral">"simulation"</span>)  <span class="comment">// NEW - CAJ</span>
00160         params.algorithm.n_Q = params.algorithm.nSimEvents;
00161       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00162            status-&gt;printMemInfo();
00163       }
00164       <span class="keywordflow">if</span>(status-&gt;proc==0){
00165         molar-&gt;<a class="code" href="classMOLAR.html#a0">dealerPlayer</a>(<span class="keyword">true</span>, params,*eventList, *status);
00166       }
00167       <span class="keywordflow">else</span>
00168         molar-&gt;<a class="code" href="classMOLAR.html#a1">player</a>(<span class="keyword">true</span>,params, *eventList, *status);
00169       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00170            status-&gt;printMemInfo();
00171       }
00172       <span class="comment">//count the number of events on each node </span>
00173       <span class="keywordflow">if</span>(params.frame.verbosity&gt;=2){
00174         <span class="keywordtype">int</span> listSizeLocal = eventList-&gt;<a class="code" href="classEventList.html#a13">getTotalSize</a>();
00175         cout&lt;&lt;<span class="stringliteral">"Proc "</span>&lt;&lt;status-&gt;proc&lt;&lt;<span class="stringliteral">" Events "</span>&lt;&lt;listSizeLocal&lt;&lt;
00176                 <span class="stringliteral">" subset events: "</span>;
00177         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;params.algorithm.numSets; i++)
00178           cout&lt;&lt;eventList-&gt;<a class="code" href="classEventList.html#a12">getNumEvents</a>(i)&lt;&lt;<span class="stringliteral">" "</span>;
00179         cout&lt;&lt;endl;
00180         <span class="keywordtype">int</span> listSize;
00181         MPI::COMM_WORLD.Allreduce(&amp;listSizeLocal,&amp;listSize,1,MPI::INT,MPI::SUM);
00182         <span class="keywordflow">if</span>(status-&gt;proc == 0)
00183           cout&lt;&lt;<span class="stringliteral">"Total events number on all event lists are "</span>&lt;&lt;listSize&lt;&lt;endl;
00184       }
00185       <span class="comment">//broad cast the frameinfo</span>
00186       <a class="code" href="classFrameInfo.html">FrameInfo</a> * frameInfo = FrameInfo::getInstance();
00187       <a class="code" href="classUtilities.html#e2">Utilities::mpiBcast</a>(0, frameInfo, <span class="keyword">sizeof</span>(<a class="code" href="classFrameInfo.html">FrameInfo</a>));
00188  
00189       <span class="comment">//broadcast singlepacket for simulation</span>
00190       <span class="keywordflow">if</span>(params.algorithm.name == <span class="stringliteral">"simulation"</span>)
00191         molar-&gt;<a class="code" href="classMOLAR.html#a24">getHouse</a>()-&gt;bcastSinglesPackets();
00192       <span class="comment">//time for building the event list</span>
00193       molar-&gt;<a class="code" href="classMOLAR.html#o8">timeReadBuildEventList2</a> = time((time_t *) 0);
00194       molar-&gt;<a class="code" href="classMOLAR.html#o11">timeReadBuildEventList</a> =difftime(molar-&gt;<a class="code" href="classMOLAR.html#o8">timeReadBuildEventList2</a>,
00195                                           molar-&gt;<a class="code" href="classMOLAR.html#o5">timeReadBuildEventList1</a>);
00196       <span class="keywordflow">if</span>(status-&gt;proc==0 &amp;&amp; params.frame.verbosity&gt;=2){
00197         stringstream ss;
00198         ss&lt;&lt;<span class="stringliteral">"Reading and building randomized event list totally use : "</span>
00199           &lt;&lt;molar-&gt;<a class="code" href="classMOLAR.html#o11">timeReadBuildEventList</a>&lt;&lt;<span class="stringliteral">" s"</span>&lt;&lt;endl;
00200         log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00201       }
00202       <span class="comment">//boundary check for randomized event list</span>
00203       <span class="comment">//2002-02-08 try to discard outside events (last arg changed from false to true- does nothing</span>
00204       <span class="keywordflow">if</span>(params.frame.enableBoundsCheck &amp;&amp;
00205          params.algorithm.name !=<span class="stringliteral">"simulation"</span>)
00206         molar-&gt;<a class="code" href="classMOLAR.html#a2">boundaryCheckingFwdProject</a>(mu,QMask,lambdaMask, params,*eventList,<span class="keyword">false</span>,<span class="keyword">false</span>);
00207       <span class="comment">//forward projection for event.atten and event.CijNorm with </span>
00208       <span class="comment">//params.attenutation.enable on</span>
00209       <span class="comment">//or for the event.CijNorm only with params.attenutation.enable off</span>
00210       molar-&gt;<a class="code" href="classMOLAR.html#a5">fwdProject</a>(mu,params, *eventList, 
00211                         params.attenuation.enable);
00212 
00213       <span class="comment">//back projection Q</span>
00214       <span class="keywordflow">if</span>(params.algorithm.name != <span class="stringliteral">"simulation"</span>){
00215         molar-&gt;<a class="code" href="classMOLAR.html#a18">computeQ</a>(Q,params,*eventList);
00216         <span class="keywordflow">if</span>(status-&gt;proc==0){
00217           stringstream ss;
00218           ss&lt;&lt;<span class="stringliteral">"================================="</span>&lt;&lt;endl;
00219           ss&lt;&lt;<span class="stringliteral">"Back projection finished"</span>&lt;&lt;endl;
00220           ss&lt;&lt;<span class="stringliteral">"Back projection Q totally uses "</span>&lt;&lt;molar-&gt;<a class="code" href="classMOLAR.html#o9">timeBackProjQ</a>
00221             &lt;&lt;<span class="stringliteral">" s"</span>&lt;&lt;endl;
00222 
00223           ss&lt;&lt;<span class="stringliteral">"Global sum totally uses "</span>&lt;&lt;molar-&gt;<a class="code" href="classMOLAR.html#o10">timeGlobalSum</a>&lt;&lt;<span class="stringliteral">" s"</span>
00224             &lt;&lt;endl&lt;&lt;endl;
00225           log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00226         }
00227  
00228         <span class="comment">/*if(status-&gt;proc == status-&gt;numProcs-1 &amp;&amp; params.frame.verbosity&gt;=2){</span>
00229 <span class="comment">          stringstream ss;</span>
00230 <span class="comment">          ss&lt;&lt;"On prccessor "&lt;&lt;status-&gt;proc&lt;&lt;endl;</span>
00231 <span class="comment">          ss&lt;&lt;"Reading and building randomized event list totally use : "</span>
00232 <span class="comment">          &lt;&lt;molar-&gt;timeReadBuildEventList&lt;&lt;" s"&lt;&lt;endl;</span>
00233 <span class="comment">          ss&lt;&lt;"Back projection Q totally uses "&lt;&lt;molar-&gt;timeBackProjQ</span>
00234 <span class="comment">          &lt;&lt;" s"&lt;&lt;endl;</span>
00235 <span class="comment"></span>
00236 <span class="comment">          ss&lt;&lt;"Global sum totally uses "&lt;&lt;molar-&gt;timeGlobalSum&lt;&lt;" s"&lt;&lt;endl</span>
00237 <span class="comment">          &lt;&lt;endl;</span>
00238 <span class="comment">          log-&gt;outputMessage(ss.str(),FRAME, params.frame.verbosity);</span>
00239 <span class="comment">          }*/</span>
00240         
00241 
00242         <span class="keywordflow">if</span>(status-&gt;proc==0 &amp;&amp; !QImg &amp;&amp; 
00243                 (params.algorithm.outputIterationIncrement &gt; 0)){
00244           stringstream ss;
00245           ss&lt;&lt;<span class="stringliteral">"Writing image Q to "</span>&lt;&lt;fileNameQ;
00246           log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00247           
00248           Q.<a class="code" href="classImage.html#a8">write</a>(fileNameQ,params.extensions);
00249           ss.str(<span class="stringliteral">""</span>);
00250           ss&lt;&lt;<span class="stringliteral">"======================================="</span>&lt;&lt;endl;
00251           ss&lt;&lt;<span class="stringliteral">"Q image outputed to "</span>&lt;&lt;fileNameQ&lt;&lt;<span class="stringliteral">" successfully"</span>;
00252           log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00253           
00254         }
00255     
00256       }<span class="comment">//no- simulation block</span>
00257     }<span class="comment">//randomized event list generated </span>
00258 
00259     <span class="comment">// calling the gaussian smoothing to smooth Q if the smoothing parameters are non-zero</span>
00260     <span class="comment">// if no smoothing parameters are defined, the default is a isotropic smoothing</span>
00261     <span class="comment">// of 5 pixels </span>
00262     molar-&gt;<a class="code" href="classMOLAR.html#a19">smoothQ</a>(Q,mu);
00263     time_t time_HRRT2 = time((time_t *) 0);
00264     <span class="keywordtype">double</span> time_HRRT = difftime(time_HRRT2, time_HRRT1);
00265     <span class="keywordflow">if</span>(status-&gt;proc==0){
00266       cout&lt;&lt;<span class="stringliteral">"The Q computation took "</span>&lt;&lt;time_HRRT&lt;&lt;<span class="stringliteral">" s"</span>&lt;&lt;endl;
00267     }
00268 
00269   }  <span class="comment">// no sinogram branch to create Q</span>
00270   <span class="comment">// build lambdaMask in case of no mu image</span>
00271   <span class="keywordflow">if</span> (!params.frame.enableBoundsCheck) {
00272     <span class="comment">// determine lambdaMask based on Q image </span>
00273    molar-&gt;<a class="code" href="classMOLAR.html#a21">calculateMask</a>( lambdaMask, Q, params);
00274   }
00275   <span class="comment">// check that Q and the lambdaMask are consistent, i.e., that Q is &gt; 0 everywhere lambdaMask is true</span>
00276   <span class="comment">// Inconsistencies can occur due to motion, i.e., part of the image could have moved out of the</span>
00277   <span class="comment">// scanner FOV, so there are no possible LORs intersecting certain voxels. Ideally these</span>
00278   <span class="comment">// are all on one edge or another of the FOV</span>
00279   <span class="keywordflow">if</span> ((params.frame.verbosity &gt;= 2) &amp;&amp;(status-&gt;proc==0)) {
00280    <span class="comment">// save bounding box of number of bad points</span>
00281    <span class="keywordtype">int</span> minz=params.geometry.nZ; <span class="keywordtype">int</span> maxz=0;
00282    <span class="keywordtype">int</span> miny=params.geometry.nY; <span class="keywordtype">int</span> maxy=0;
00283    <span class="keywordtype">int</span> minx=params.geometry.nX; <span class="keywordtype">int</span> maxx=0;
00284    <span class="keywordtype">int</span> numbad=0;
00285    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iz = 0;iz &lt; params.geometry.nZ; iz++)
00286     <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iy = 0;iy &lt; params.geometry.nY; iy++)
00287      <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ix =0;ix &lt; params.geometry.nX; ix++)
00288       <span class="keywordflow">if</span> (lambdaMask(ix,iy,iz) &amp;&amp; (Q(ix,iy,iz) &lt;= 0.0)) {
00289        numbad++;
00290        <span class="keywordflow">if</span> (iz &gt; maxz) maxz=iz; <span class="keywordflow">if</span> (iz &lt; minz) minz=iz;
00291        <span class="keywordflow">if</span> (iy &gt; maxy) maxy=iy; <span class="keywordflow">if</span> (iy &lt; miny) miny=iy;
00292        <span class="keywordflow">if</span> (ix &gt; maxx) maxx=ix; <span class="keywordflow">if</span> (ix &lt; minx) minx=ix;
00293       }
00294     <span class="keywordflow">if</span> (numbad &gt; 0) {
00295      cout&lt;&lt;<span class="stringliteral">"*** lambdaMask true but Q &lt;= 0 in "</span>&lt;&lt;numbad&lt;&lt;<span class="stringliteral">" voxels"</span>&lt;&lt;endl;
00296      cout&lt;&lt;<span class="stringliteral">"*** Bounding box ("</span>&lt;&lt;minx&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;miny&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;minz&lt;&lt;<span class="stringliteral">"),("</span>&lt;&lt;
00297          maxx&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;maxy&lt;&lt;<span class="stringliteral">","</span>&lt;&lt;maxz&lt;&lt;<span class="stringliteral">")"</span>&lt;&lt;endl;
00298      <span class="keywordflow">if</span> (params.motionCorrection.enable) {
00299       cout&lt;&lt;<span class="stringliteral">"*** This is probably ok since you have motion correction on ***"</span>&lt;&lt;endl;
00300       <span class="comment">// It would be good to decide if these are reasonable voxel (like all on the edge slices)</span>
00301       <span class="comment">// if reasonable, I could set lambdamask to 0 at all or some of these voxels. </span>
00302       <span class="comment">// I might want to set lambdaMask to 0 even further in than where Q goes to 0</span>
00303       <span class="comment">// Need ot investigate further</span>
00304      } <span class="keywordflow">else</span> {
00305       cout&lt;&lt;<span class="stringliteral">"************************************************"</span>&lt;&lt;endl;
00306       cout&lt;&lt;<span class="stringliteral">"*** This is probably a bad sign since you do not have motion correction on ***"</span>&lt;&lt;endl;
00307       cout&lt;&lt;<span class="stringliteral">"*** Maybe the geometry information is wrong"</span>&lt;&lt;endl;
00308       cout&lt;&lt;<span class="stringliteral">"************************************************"</span>&lt;&lt;endl;
00309      }
00310     }
00311   }
00312   <span class="comment">//scatter correction proc</span>
00313   <span class="keywordflow">if</span>(params.randoms.enable || params.modelBasedScatter.enable)
00314     scatterCorrection-&gt;randomsScatterProc();
00315   <span class="comment">//temporary here for test purpose</span>
00316   <span class="comment">//scatterCorrection-&gt;update(mu, lambda, eventList);</span>
00317   <span class="comment">//MPI::COMM_WORLD.Barrier();</span>
00318   <span class="comment">//MPI::Finalize();</span>
00319   <span class="comment">//return 0;</span>
00320   <span class="comment">//build true event list </span>
00321   <span class="keywordflow">if</span>(params.algorithm.name != <span class="stringliteral">"simulation"</span>){
00322     <span class="comment">//update status file</span>
00323     <span class="keywordflow">if</span>(status-&gt;proc == 0){
00324       string comm=<span class="stringliteral">"Start building true event list"</span>;
00325       Status::StatusCode code=Status::RUNNING;
00326       status-&gt;update(comm,code);
00327     }           
00328     <span class="comment">//destroy the randomzied event list</span>
00329     <span class="keywordflow">if</span>(eventList!=0)
00330       <span class="keyword">delete</span> eventList;
00331     <span class="comment">// real event list</span>
00332     eventList= <span class="keyword">new</span> EventList(params.algorithm.numSets);
00333 
00334       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00335            status-&gt;printMemInfo();
00336       }
00337     <span class="keywordflow">if</span>(status-&gt;proc==0){
00338       molar-&gt;<a class="code" href="classMOLAR.html#a0">dealerPlayer</a>(<span class="keyword">false</span>, params,*eventList, *status);
00339     }
00340     <span class="keywordflow">else</span>
00341       molar-&gt;<a class="code" href="classMOLAR.html#a1">player</a>(<span class="keyword">false</span>, params,*eventList, *status);
00342     <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00343           status-&gt;printMemInfo();
00344     }
00345     <span class="comment">//boundary checking</span>
00346     <span class="comment">// last 2 args false mean no exponentiate and false meando not discard</span>
00347     <span class="comment">// Why are we not discarding from the list?????</span>
00348     <span class="comment">// 2006-02-08 (10AM) try to discard events - last arg changed from false to true - does nothing</span>
00349     <span class="keywordflow">if</span>( params.frame.enableBoundsCheck)
00350       molar-&gt;<a class="code" href="classMOLAR.html#a2">boundaryCheckingFwdProject</a>(mu,QMask,lambdaMask,params,
00351                                         *eventList,<span class="keyword">false</span>,<span class="keyword">false</span>);
00352     <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00353           status-&gt;printMemInfo();
00354     }
00355     <span class="comment">//forward projection for event.atten and event.CijNorm with </span>
00356     <span class="comment">//params.attenutation.enable on</span>
00357     <span class="comment">//or for the event.CijNorm only with params.attenutation.enable off</span>
00358     molar-&gt;<a class="code" href="classMOLAR.html#a5">fwdProject</a>(mu,params, *eventList, 
00359                       params.attenuation.enable);
00360     <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00361           status-&gt;printMemInfo();
00362     }
00363   }<span class="comment">//non simulation block</span>
00364   <span class="comment">//if(params.algorithm.name == "sinogram")</span>
00365   <span class="keywordflow">if</span> (params.sinogram.enable) 
00366     molar-&gt;<a class="code" href="classMOLAR.html#a17">generateSinoGram</a>(*eventList, params, *status);
00367 
00368   <span class="comment">//use previous result, read in lambda</span>
00369   <span class="keywordflow">if</span>(params.frame.usePreviousResult) {
00370     <span class="comment">//get the iteration number</span>
00371     <span class="keywordflow">if</span>(params.frame.startingIteration&gt;0)
00372       status-&gt;iter = params.frame.startingIteration;
00373     string outputExt;<span class="comment">//extension of output image file</span>
00374     outputExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00375     <span class="comment">//read in lambda</span>
00376     stringstream filename;
00377     <span class="keywordtype">bool</span> lambdaExist = <span class="keyword">false</span>;
00378     <span class="comment">//find the lamda image </span>
00379     <span class="keywordflow">while</span>(!lambdaExist &amp;&amp; status-&gt;iter&gt;1){
00380       filename.str(<span class="stringliteral">""</span>);
00381       filename&lt;&lt; params.frame.frameDirectory&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;
00382         params.frame.outputFileNameBase&lt;&lt; <span class="stringliteral">"-"</span>&lt;&lt; status-&gt;iter;
00383       filename &lt;&lt; <span class="stringliteral">"."</span>&lt;&lt; outputExt;
00384       <span class="keywordflow">if</span>(status-&gt;proc ==0 ){
00385         string msg = <span class="stringliteral">"Initing lambda image from file "</span>+filename.str();
00386         log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00387       }
00388       lambdaExist = lambda.<a class="code" href="classImage.html#a7">read</a>(filename.str(),params.extensions);
00389       <span class="keywordflow">if</span>(!lambdaExist){
00390         status-&gt;iter --;
00391       }
00392     }
00393     <span class="keywordflow">if</span>(!lambdaExist &amp;&amp; status-&gt;proc ==0 ){
00394       string msg = <span class="stringliteral">"Error in reading lambda image from file "</span>+
00395         filename.str();
00396       msg += <span class="stringliteral">", program aborted"</span>;
00397       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00398       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00399     }
00400     <span class="keywordflow">if</span>(lambdaExist &amp;&amp; status-&gt;proc ==0 ){
00401       string msg = <span class="stringliteral">"Init lambda image from file "</span>+filename.str();
00402       msg += <span class="stringliteral">" done"</span>;
00403       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00404     }
00405   }
00406   <span class="comment">//not use previous result, but starting from an existing image</span>
00407   <span class="keywordflow">else</span> <span class="keywordflow">if</span>(params.frame.startingImage != <span class="stringliteral">""</span> || params.frame.useStartingImage){
00408     string outputExt;<span class="comment">//extension of output image file</span>
00409     outputExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00410     <span class="comment">//get the iteration number</span>
00411     <span class="keywordflow">if</span>(params.frame.startingIteration&gt;0)
00412       status-&gt;iter = params.frame.startingIteration;
00413     <span class="comment">//read in lambda</span>
00414     stringstream filename;
00415     <span class="keywordtype">bool</span> lambdaExist = <span class="keyword">false</span>;
00416     <span class="keywordflow">if</span>(params.frame.startingImage != <span class="stringliteral">""</span>) {
00417        filename&lt;&lt;params.frame.startingImage;
00418        lambdaExist = lambda.<a class="code" href="classImage.html#a7">read</a>(filename.str(),params.extensions);
00419     }
00420     <span class="keywordflow">if</span>(!lambdaExist &amp;&amp; params.frame.useStartingImage) {
00421        filename&lt;&lt; params.frame.frameDirectory&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;
00422          params.frame.outputFileNameBase&lt;&lt; <span class="stringliteral">"-"</span>&lt;&lt; status-&gt;iter;
00423        filename &lt;&lt; <span class="stringliteral">"."</span>&lt;&lt; outputExt;
00424     }
00425     lambdaExist = lambda.<a class="code" href="classImage.html#a7">read</a>(filename.str(),params.extensions);
00426     <span class="keywordflow">if</span>(!lambdaExist &amp;&amp; status-&gt;proc ==0 ){
00427       string msg = <span class="stringliteral">"Error in reading lambda image from file "</span>+
00428         filename.str();
00429       msg += <span class="stringliteral">", program aborted"</span>;
00430       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00431       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00432     }
00433     <span class="keywordflow">if</span>(lambdaExist &amp;&amp; status-&gt;proc ==0 ){
00434       string msg = <span class="stringliteral">"Initing lambda image from file "</span>+filename.str();
00435       msg += <span class="stringliteral">"..., done"</span>;
00436       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00437     }
00438   }
00439   <span class="comment">//otherwise init lambda</span>
00440   <span class="keywordflow">else</span>
00441     molar-&gt;<a class="code" href="classMOLAR.html#a20">initializeLambda</a>(lambda,lambdaMask,params);
00442     <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00443           status-&gt;printMemInfo();
00444     }
00445  
00446   <span class="comment">//read lamda for simulation</span>
00447   <span class="keywordflow">if</span>(params.algorithm.name == <span class="stringliteral">"simulation"</span>&amp;&amp;!params.frame.usePreviousResult
00448      &amp;&amp;params.frame.startingImage == <span class="stringliteral">""</span>){
00449     stringstream filename;
00450  
00451     <span class="keywordflow">if</span>(params.frame.simulationImageFile != <span class="stringliteral">""</span>) {
00452        filename&lt;&lt;params.frame.simulationImageFile;
00453     } <span class="keywordflow">else</span> {
00454        string outputExt;<span class="comment">//extension of output image file</span>
00455        outputExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00456        filename&lt;&lt; params.frame.frameDirectory&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;
00457          params.frame.outputFileNameBase;
00458        filename &lt;&lt; <span class="stringliteral">"."</span>&lt;&lt; outputExt;
00459     }
00460 
00461 
00462 
00463 
00464 
00465     <span class="keywordtype">bool</span> lambdaExist = lambda.<a class="code" href="classImage.html#a7">read</a>(filename.str(),params.extensions);
00466     <span class="keywordflow">if</span>(!lambdaExist &amp;&amp; status-&gt;proc ==0 ){
00467       string msg = <span class="stringliteral">"Error in reading lambda image from file "</span>+
00468         filename.str();
00469       msg += <span class="stringliteral">", program aborted"</span>;
00470       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00471       <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(Constant::IOERROR);
00472     }
00473     <span class="keywordflow">if</span>(lambdaExist &amp;&amp; status-&gt;proc ==0 ){
00474       string msg = <span class="stringliteral">"Reading lambda image from file "</span>+filename.str();
00475       msg += <span class="stringliteral">" for simulation..., done"</span>;
00476       log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(msg, FRAME, 0);
00477     }
00478   
00479     <span class="keywordflow">if</span>(status-&gt;proc == 0){
00480       stringstream filename;
00481       string outputExt;<span class="comment">//extension of output image file</span>
00482       outputExt = <a class="code" href="classUtilities.html#e5">Utilities::getOutputExt</a>(params);
00483       filename.str(<span class="stringliteral">""</span>);
00484       filename&lt;&lt; params.frame.frameDirectory&lt;&lt;<span class="stringliteral">"/"</span>&lt;&lt;<span class="stringliteral">"InitLambda"</span>;
00485       filename &lt;&lt; <span class="stringliteral">"."</span>&lt;&lt; outputExt;
00486       <span class="comment">//cout&lt;&lt;filename.str()&lt;&lt;endl;</span>
00487       <span class="keywordflow">if</span>(!lambda.<a class="code" href="classImage.html#a8">write</a>(filename.str(),params.extensions)){
00488         cout&lt;&lt;<span class="stringliteral">"Error in write the lamba file "</span>&lt;&lt;filename.str();
00489         <a class="code" href="classUtilities.html#e8">Utilities::cleanUp</a>(-1);
00490       }
00491       <span class="keywordflow">else</span>
00492         cout&lt;&lt;<span class="stringliteral">"File output to "</span>&lt;&lt;filename.str()&lt;&lt;<span class="stringliteral">" succesfully"</span>&lt;&lt;endl;
00493     }
00494   }
00495 
00496   <a class="code" href="classAlgorithm.html">Algorithm</a> *algorithm=molar-&gt;<a class="code" href="classMOLAR.html#a25">getAlgorithm</a>();
00497   House * house = molar-&gt;<a class="code" href="classMOLAR.html#a24">getHouse</a>();
00498   <span class="comment">//::::::    </span>
00499       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00500            status-&gt;printMemInfo();
00501       }
00502       
00503   
00504   <span class="keywordflow">if</span>(algorithm != 0)
00505     algorithm-&gt;<a class="code" href="classAlgorithm.html#a2">reconstruct</a>(lambda,Q, mu, house,*eventList,params, lambdaMask);
00506 
00507       <span class="keywordflow">if</span>(params.frame.verbosity &gt;= 6) {
00508            status-&gt;printMemInfo();
00509       }
00510   <span class="comment">//if(params.algorithm.name == "simulation")</span>
00511   <span class="comment">//molar-&gt;generateSinoGram(*eventList, params, *status);</span>
00512   MPI::COMM_WORLD.Barrier();
00513   time_t time_HRRT2 = time((time_t *) 0);
00514   <span class="keywordtype">double</span> time_HRRT = difftime(time_HRRT2, time_HRRT1);
00515   <span class="keywordflow">if</span>(status-&gt;proc==0){
00516     stringstream ss;
00517     ss&lt;&lt;<span class="stringliteral">"================================="</span>&lt;&lt;endl;
00518     ss&lt;&lt;<span class="stringliteral">"The reconstruction took "</span>&lt;&lt;time_HRRT&lt;&lt;<span class="stringliteral">" s"</span>&lt;&lt;endl;
00519     ss&lt;&lt;<span class="stringliteral">"Program finished normally"</span>&lt;&lt;endl;
00520     log-&gt;<a class="code" href="classLog.html#a2">outputMessage</a>(ss.str(),FRAME, 0);
00521     string comm=<span class="stringliteral">"Program finished normally"</span>;
00522     Status::StatusCode code=Status::COMPLETED;
00523     status-&gt;update(comm,code);          
00524   }
00525 
00526   <span class="comment">//destroy event list</span>
00527   <span class="keyword">delete</span> eventList;
00528   <span class="comment">//MPI::COMM_WORLD.Barrier();</span>
00529   MPI::Finalize();
00530 
00531   <span class="keywordflow">return</span> 0;
00532 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
