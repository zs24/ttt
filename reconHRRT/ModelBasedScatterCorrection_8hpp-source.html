<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>reconHRRT: ModelBasedScatterCorrection.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.5 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>ModelBasedScatterCorrection.hpp</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef MODELBASEDSCATTERCORRECTION_HPP</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define MODELBASEDSCATTERCORRECTION_HPP</span>
00003 <span class="preprocessor"></span><span class="preprocessor">#include &lt;iostream&gt;</span>
00004 <span class="preprocessor">#include &lt;list&gt;</span>
00005 <span class="preprocessor">#include "House.hpp"</span>
00006 <span class="preprocessor">#include "Params.hpp"</span>
00007 <span class="preprocessor">#include "Status.hpp"</span>
00008 <span class="preprocessor">#include "Image.hpp"</span>
00009 <span class="preprocessor">#include "EventList.hpp"</span>
00010 <span class="preprocessor">#include "DList.hpp"</span>
00011 <span class="preprocessor">#include "ScatterCorrection.hpp"</span>
00012 <span class="preprocessor">#include "MOLAR.hpp"</span>
00013 <span class="preprocessor">#include "HRRTScannerParams.hpp"</span>
00014 <span class="preprocessor">#include "Constant.hpp"</span>
00015 
00016 <span class="keyword">using</span> <span class="keyword">namespace </span>std;
00017 
00018 <span class="keyword">class </span>ModelBasedScatterCorrection : <span class="keyword">public</span> ScatterCorrection {
00019 
00020         <span class="keyword">public</span>:
00021                 <span class="comment">// Called at the start of every iteration; performs all </span>
00022                 <span class="comment">// aspects of updating the scatter estimates in the event list</span>
00023                 <span class="comment">// This method if called from the Algorithm class; a barrier </span>
00024                 <span class="comment">// synchronization is required before this call</span>
00025                 <span class="keywordtype">bool</span> update(<a class="code" href="classImage.html">Image</a> &amp;mu, <a class="code" href="classImage.html">Image</a> &amp;lambda, <a class="code" href="classEventList.html">EventList</a> &amp;eventList);  
00026 
00027                 <span class="comment">//For Algorithm Simulation</span>
00028                 <span class="keywordtype">bool</span> simulate(<a class="code" href="classImage.html">Image</a> &amp;mu, <a class="code" href="classImage.html">Image</a> &amp;lambda, <a class="code" href="classEventList.html">EventList</a> &amp;eventList);
00029 
00030                 ModelBasedScatterCorrection();
00031                 ~ModelBasedScatterCorrection();
00032 
00033                 <span class="comment">// Initializes internal variables</span>
00034                 <span class="keywordtype">bool</span> init(<a class="code" href="classImage.html">Image</a> &amp;muImage);
00035 
00052                 <span class="comment">//Bins randoms and prompts for each listmode event</span>
00053                 <span class="keywordtype">bool</span> randomsScatterPrep(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b,<span class="keywordtype">float</span> sing_fix);
00054 
00055                 <span class="comment">//Bins randomzed events</span>
00056                 <span class="keywordtype">bool</span> binRandomizedEvent(<a class="code" href="classEventPacket.html">EventPacket</a> &amp;event);
00057 
00058                 <span class="comment">//Compute the relative detection efficiencies for random coincidences.</span>
00059                 <span class="keywordtype">bool</span> randomsScatterProc();
00060 
00061         <span class="keyword">private</span>:
00062                 
00063                 <span class="comment">//Statistics test structure</span>
00064                 <span class="keyword">struct </span>EventStats {
00065                         <span class="keywordtype">long</span> nTimeTags;
00066                         <span class="keywordtype">long</span> nSingleTags;
00067                         <span class="keywordtype">long</span> nEvents;
00068                         <span class="keywordtype">long</span> nNonEvents;
00069                         <span class="keywordtype">long</span> binnedPrompts;
00070                         <span class="keywordtype">long</span> binnedDelays;
00071                 } eventStats;
00072 
00073                 <span class="comment">//Initialise the bin Arrays</span>
00074                 <span class="keywordtype">void</span> randomsScatterInit(<a class="code" href="classImage.html">Image</a> &amp;muImage);
00075                 
00076                 <span class="comment">//size of the class, to make sure the class is initialized</span>
00077                 <span class="keywordtype">int</span> checkSum;
00078 
00079                 <span class="comment">//check if the class is intialized, to prevent unsafe use of</span>
00080                 <span class="comment">//the pointer</span>
00081                 <span class="keywordtype">bool</span> checkValid(){
00082                         <span class="keywordflow">return</span> checkSum==<span class="keyword">sizeof</span>(ModelBasedScatterCorrection);
00083                 };
00084 
00085 
00086                 <span class="comment">//Constants</span>
00087 
00088                 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> NBANKS = 8;
00089                 <span class="comment">//static const double r0=(2.81794e-15 * 1.0e3); // (mm) classical electron radius</span>
00090                 <span class="comment">//static const double sigma0 = (66.525e-30  * 1.0e6); // (mm^2) Thomson classical scattering coefficient</span>
00091                 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> DIMENSIONS = 3;
00092                 <span class="comment">//static const float pi = 3.1415627;</span>
00093 
00094                 Params *params;
00095                 House *house;
00096                 <a class="code" href="classHRRTScannerParams.html">HRRTScannerParams</a> *scannerParams;       
00097 
00098                 <a class="code" href="classMOLAR.html">MOLAR</a> *molar;
00099 
00100                 <span class="comment">//detector sensitivity </span>
00101                 <span class="keywordtype">float</span> getSen(<span class="keywordtype">int</span> dtct, <span class="keywordtype">int</span> layer, <span class="keywordtype">int</span> bank, <span class="keywordtype">int</span> ring, <span class="keywordtype">int</span> singles);
00102 
00103                 <a class="code" href="classArray4D.html">Array4D&lt;unsigned short&gt;</a> binDelays;
00104                 <a class="code" href="classArray4D.html">Array4D&lt;unsigned short&gt;</a> binPrompts;
00105                 <a class="code" href="classArray4D.html">Array4D&lt;float&gt;</a> binScatter;
00106                 <a class="code" href="classArray4D.html">Array4D&lt;float&gt;</a> binRandomized;
00107                 <a class="code" href="classArray4D.html">Array4D&lt;char&gt;</a> binInsideMask;
00108                 <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> xtalDelays;
00109                 <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> blockSingles;    <span class="comment">// total block Singles</span>
00110                 <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> blockSingles2;   <span class="comment">// total block singles squared</span>
00111                 <a class="code" href="classArray1D.html">Array1D&lt;int&gt;</a> nblockSingles;     <span class="comment">// number of block Singles recorded</span>
00112                 Array2D&lt;float&gt; layerDelays;
00113                 Array2D&lt;float&gt; tau;
00114 
00115                 <span class="keyword">struct </span>Axial {
00116                         <span class="keywordtype">int</span> dimension;
00117                         <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> efficiency;
00118                         <span class="keywordtype">float</span> stepsize;
00119                 } axial;
00120 
00121                 <span class="keyword">struct </span>Azimuthal {
00122                         <span class="keywordtype">int</span> dimension;
00123                         <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> efficiency;
00124                         <span class="keywordtype">float</span> stepsize;
00125                 } azimuthal;
00126 
00127                 <span class="comment">// Scanner Parameter Structure required by Scatter</span>
00128                 <span class="comment">// Use three points (bank corners) to define each bank plane</span>
00129                 <span class="comment">// Also define a center-bank point to define the normal</span>
00130 
00131                 <span class="keyword">struct </span>BankVector {
00132                         <span class="keywordtype">float</span> x;
00133                         <span class="keywordtype">float</span> y;
00134                         <span class="keywordtype">float</span> z;
00135                 };
00136                 <span class="keyword">struct </span>Bank {
00137                         BankVector q;
00138                         BankVector r;
00139                         BankVector s;
00140                         <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> x;
00141                         <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> y;
00142                         <a class="code" href="classArray1D.html">Array1D&lt;float&gt;</a> z;
00143                 };
00144                 <span class="keyword">struct </span>BankScanner {
00145                         Bank bank[NBANKS];      
00146                 };      
00147                 BankScanner scanner;
00148         
00149 
00150                 <span class="comment">//Point Index</span>
00151                 <span class="keyword">struct </span>imgIndex {
00152                         <span class="keywordtype">int</span> x;
00153                         <span class="keywordtype">int</span> y;
00154                         <span class="keywordtype">int</span> z;
00155                 };
00156                 <span class="keyword">struct </span>coordIndex {
00157                         <span class="keywordtype">float</span> x;
00158                         <span class="keywordtype">float</span> y;
00159                         <span class="keywordtype">float</span> z;
00160                 };
00161 
00162                 <span class="keyword">struct </span>neighborIndex {
00163                         <span class="keywordtype">int</span> iAngleA[3]; 
00164                         <span class="keywordtype">int</span> izA[3]; 
00165                         <span class="keywordtype">int</span> iAngleB[3]; 
00166                         <span class="keywordtype">int</span> izB[3]; 
00167                 };
00168 
00169                 <span class="keyword">struct </span>coordIntersectionIndex {
00170                         <span class="keywordtype">float</span> x[2];
00171                         <span class="keywordtype">float</span> y[2];
00172                         <span class="keywordtype">float</span> z[2];
00173                         <span class="keywordtype">float</span> angle[2];
00174                 };
00175 
00177                 DList&lt;coordIndex&gt; *scatterPointList; 
00178 
00180                 <span class="keyword">struct </span>EndPtList {
00181                         <span class="keywordtype">float</span> angleStep;
00182                         <span class="keywordtype">float</span> sliceThickness;
00183                         <span class="keywordtype">float</span> radius;
00184                         Array2D&lt;float&gt; angle;
00185                         Array2D&lt;float&gt; x;
00186                         Array2D&lt;float&gt; y;
00187                         Array2D&lt;float&gt; z;
00188                         <span class="keywordtype">int</span> nAngles;
00189                         <span class="keywordtype">int</span> nSlices;
00190                 } endPointList;
00191 
00192 
00193                 <span class="comment">//Used to send a sentry scatterPoint</span>
00194                 coordIndex sentryPoint;
00195                                 
00196                 <span class="comment">//Internal Functions</span>
00197                 <span class="keywordtype">void</span> scatterDealerPlayer( DList&lt;coordIndex&gt; *scatterPointSubList);
00198                 <span class="keywordtype">void</span>  scatterPlayer( DList&lt;coordIndex&gt; *scatterPointSubList);
00199                 <span class="keywordtype">bool</span> setupStructs();
00200                 <span class="keywordtype">bool</span> setupScanner();
00201                 <span class="keywordtype">bool</span> defineScatterPoints(<span class="keywordtype">float</span> samplingFactor);
00202                 <span class="keywordtype">bool</span> getNearestEndPoints(coordIndex &amp;A, coordIndex &amp;B, neighborIndex &amp;neighborList);
00203                 <span class="keywordtype">bool</span> isInsideMuMap(coordIndex &amp;A, coordIndex &amp;B, <a class="code" href="classImage.html">Image</a> &amp;muImage);
00204                 <span class="keywordtype">bool</span> updateScatter(<span class="keywordtype">float</span> samplingFactor,<a class="code" href="classImage.html">Image</a> &amp;muImage,<a class="code" href="classImage.html">Image</a> &amp;lambdaImage,<a class="code" href="classEventList.html">EventList</a> &amp;eventList);
00205                 <span class="keywordtype">bool</span> computeScatter (<span class="keywordtype">float</span> samplingFactor,<a class="code" href="classImage.html">Image</a> &amp;muImage, <a class="code" href="classImage.html">Image</a> &amp;emissionImage, 
00206                      DList&lt;coordIndex&gt; *scatterPointList,<a class="code" href="classArray4D.html">Array4D&lt;float&gt;</a> &amp;scatterPartial);
00207                 <span class="keywordtype">bool</span> defineEndPoints();
00208                 <span class="keywordtype">bool</span> convertCoordinatesToImageIndices (coordIndex &amp;coords, imgIndex &amp;index);
00209                 <span class="keywordtype">bool</span> computeRaySum(<a class="code" href="classImage.html">Image</a> &amp;emissionImage,
00210                         <a class="code" href="classImage.html">Image</a> &amp;muImage, coordIndex &amp;endPoint, coordIndex &amp;scatterPoint,
00211                         <span class="keywordtype">float</span> &amp;emissionRaySum, <span class="keywordtype">float</span> &amp;muRaySum);
00212                 <span class="keywordtype">bool</span> getPanelHit( coordIndex &amp;endPoint, coordIndex &amp;scatterPoint,
00213                         coordIndex &amp;panelIntersection, <span class="keywordtype">int</span> &amp;select);
00214                 <span class="keywordtype">bool</span> getPlaneIntersection( Bank &amp;plane, coordIndex &amp;ray0,
00215                          coordIndex &amp;ray1, coordIndex &amp;intersection);
00216                 <span class="keywordtype">bool</span> getIncidenceAngles(coordIndex &amp;sourcePoint, coordIndex &amp;panelIntersection,
00217                         <span class="keywordtype">int</span> select, <span class="keywordtype">float</span> &amp;axialAngleCosine, <span class="keywordtype">float</span> &amp;azimuthalAngleCosine,
00218                         coordIndex &amp;endPoint);
00219                 <span class="keywordtype">bool</span> getCylinderIntersection( <span class="keywordtype">float</span> radius, coordIndex &amp;endPointA, 
00220                         coordIndex &amp;endPointB, coordIntersectionIndex &amp;intersection);
00221                 <span class="keywordtype">float</span> probDetect(<span class="keywordtype">float</span> photonEnergy);
00222                 <span class="keywordtype">int</span> maxOfNum(<span class="keywordtype">int</span> num1, <span class="keywordtype">int</span> num2);
00223                 <span class="keywordtype">int</span> minOfNum(<span class="keywordtype">int</span> num1, <span class="keywordtype">int</span> num2);
00224                 <span class="keywordtype">float</span> meanPartial(<a class="code" href="classImage.html">Image</a> &amp;arr, <span class="keywordtype">int</span> x1, <span class="keywordtype">int</span> x2, <span class="keywordtype">int</span> y1, <span class="keywordtype">int</span> y2,
00225                         <span class="keywordtype">int</span> z1, <span class="keywordtype">int</span> z2);
00226                 <span class="keywordtype">float</span> determ(Array2D&lt;float&gt; &amp;a, <span class="keywordtype">int</span> dim);
00227                 <span class="keywordtype">int</span> round(<span class="keywordtype">float</span> num);
00228                 <span class="keywordtype">bool</span> where(<a class="code" href="classArray1D.html">Array1D&lt;int&gt;</a> &amp;arr, <span class="keywordtype">int</span> element, <a class="code" href="classArray1D.html">Array1D&lt;int&gt;</a> &amp;matches) ;
00229                 <span class="keywordtype">void</span> processSinglesTag(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *b, <span class="keywordtype">float</span> sing_fix);
00230                 
00231                 <span class="comment">//Test Routines</span>
00232                 <span class="keywordtype">void</span> validateEndPoints();
00233                 <span class="keywordtype">void</span> validateScatterPoints();
00234                 <span class="keywordtype">void</span> validateComputeRaySum(<a class="code" href="classImage.html">Image</a> &amp;emissionImage, <a class="code" href="classImage.html">Image</a> &amp;muImage);
00235                 <span class="comment">//SCATTER_DEBUG stuff</span>
00236                 DList&lt;coordIndex&gt; *LORCoords1;
00237                 DList&lt;coordIndex&gt; *LORCoords2;
00238                 DList&lt;coordIndex&gt; *LORIntCoords1;
00239                 DList&lt;coordIndex&gt; *LORIntCoords2;
00240                 DList&lt;coordIndex&gt; *endPointCoords1;
00241                 DList&lt;coordIndex&gt; *endPointCoords2;
00242                 
00243                 <span class="keywordtype">int</span> outputCount;
00244 };
00245 <span class="preprocessor">#endif </span><span class="comment">/*MODELBASEDSCATTERCORRECTION_HPP */</span>
00246 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Thu Dec 13 14:13:47 2007 for reconHRRT by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.5 </small></address>
</body>
</html>
